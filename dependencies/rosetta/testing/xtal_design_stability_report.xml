<ROSETTASCRIPTS>

        <SCOREFXNS>
		<ScoreFunction name="2015" weights="ref2015">
			<Reweight scoretype="coordinate_constraint" weight="%%cst_value%%"/>
			#Reweight scoretype="res_type_constraint" weight="1"/>
		</ScoreFunction>
		<ScoreFunction name="2015_soft" weights="ref2015_soft">
			<Reweight scoretype="coordinate_constraint" weight="%%cst_value%%"/>
			#Reweight scoretype="res_type_constraint" weight="1"/>
		</ScoreFunction>
		#ScoreFunction name="2015_no_pssm" weights="ref2015">
			#Reweight scoretype="coordinate_constraint" weight="%%cst_value%%"/>
		</ScoreFunction>
	</SCOREFXNS>

	<RESIDUE_SELECTORS>
		<Index name="8A_interface" resnums="%%interface%%" error_on_out_of_bounds_index="1" reverse="0"/>
		<Not name="not_interface" selector="8A_interface"/>
	</RESIDUE_SELECTORS>

	<TASKOPERATIONS>
		<InitializeFromCommandline name="init"/>
		<RestrictIdentities name="vrt" identities="XXX" prevent_repacking="1"/>
		#RestrictToRepacking name="rtr"/>
		<DesignRestrictions name="interface_start">
			<Action residue_selector="8A_interface" aas="G"/>   
		</DesignRestrictions>
		<OperateOnResidueSubset name="non_int_res_no_repack" selector="not_interface">		
			<PreventRepackingRLT/>
		</OperateOnResidueSubset>
		<OperateOnResidueSubset name="non_int_res_rtr" selector="not_interface">		
			<RestrictToRepackingRLT/>
		</OperateOnResidueSubset>
		<OperateOnResidueSubset name="int_no_repack" selector="8A_interface">		
			<PreventRepackingRLT/>
		</OperateOnResidueSubset>
		<OperateOnResidueSubset name="int_rtr" selector="8A_interface">		
			<RestrictToRepackingRLT/>
		</OperateOnResidueSubset>
		<SeqprofConsensus name="pssm_cutoff" filename="%%pssm_file%%" min_aa_probability="0" convert_scores_to_probabilities="0" probability_larger_than_current="0" keep_native="1"/>
		<DesignAround name="des_around" design_shell="0.1" resnums="%%interface%%" repack_shell="8.0"/>
	</TASKOPERATIONS>

	<MOVERS>
		<MakeLatticeMover name="make_lattice" contact_dist="%%dist%%"/>
		<ExtractAsymmetricUnit name="extract_asu" keep_virtual="0" keep_unknown_aas="0"/>
                <SymPackRotamersMover name="start_int" scorefxn="2015_soft" task_operations="init,vrt,interface_start,non_int_res_no_repack"/> # set all interface residues to GLY, leave everything else untouched
		<SymPackRotamersMover name="soft_design_int" scorefxn="2015_soft" task_operations="init,vrt,pssm_cutoff,des_around"/> # repack shell around a design residue
		<SymPackRotamersMover name="hard_design_int" scorefxn="2015" task_operations="init,vrt,pssm_cutoff,des_around"/> # repack shell around a design residue read_resfile
                <MinMover name="soft_min" scorefxn="2015_soft" chi="1" bb="0" jump="0"/>
		<MinMover name="hard_min" scorefxn="2015" chi="1" bb="0" jump="0"/>
		<TaskAwareSymMinMover name="soft_min_design_int" scorefxn="2015_soft" bb="1" chi="1" task_operations="init,vrt,non_int_res_rtr"/> # minimize backbones/sc at interface (design), minimize sc elsewhere (packing)
		<TaskAwareSymMinMover name="hard_min_design_int" scorefxn="2015" bb="1" chi="1" task_operations="init,vrt,non_int_res_rtr"/> # minimize backbones/sc at interface, minimize sc elsewhere
		<SymRotamerTrialsMover name="RTmin" scorefxn="2015" task_operations="init,rtr"/>
		<AtomCoordinateCstMover name="add_coord_cst" coord_dev="1" bounded="0" native="0" task_operations="init,vrt,non_int_res_rtr,int_no_repack"/> # add coordinate constraint to residues not at interface
		#FavorSequenceProfile name="fsp" pssm="%%pssm_file%%" scaling="prob" scorefxns="2015,2015_soft" weight="1"/> 
		<RigidBodyTransMover name="tx_out" jump="1" distance="1000" x="1.0" y="0.0" z="0.0"/>
	</MOVERS>

	<FILTERS>
		<Time name="time"/>
		<ScoreType name="full_stability" scorefxn="2015" score_type="total_score" threshold="20000" confidence="1.0"/>
		<ScoreType name="no_pssm_stability" scorefxn="2015_no_pssm" score_type="total_score" threshold="10000" confidence="1.0"/>
		<ScoreType name="cst_weight" scorefxn="2015" score_type="coordinate_constraint" threshold="100000" confidence="1.0"/>
		<ScoreType name="pssm_weight" scorefxn="2015" score_type="res_type_constraint" threshold="100000" confidence="1.0"/>
		<AverageDegree name="int_connectivity" threshold="0" distance_threshold="10.0" task_operations="des_around"/>
		<AtomicContactCount name="contact_count" partition="none" task_operations="int_no_repack,vrt" distance="5.0"/>
		<ShapeComplementarity name="int_sc" min_sc="0.2" min_interface="0" residues1="%%interface1%%" residues2="%%interface2%%" write_int_area="1" write_median_dist="1" max_median_dist="0"/>
		<BuriedSurfaceArea name="bsa_total" filter_out_low="1" cutoff_buried_surface_area="100" atom_mode="all_atoms" residue_selector="8A_interface"/>
		<BuriedSurfaceArea name="bsa_hydrophobic" filter_out_low="1" cutoff_buried_surface_area="100" atom_mode="hydrophobic_atoms" residue_selector="8A_interface"/>
		<BuriedSurfaceArea name="bsa_polar" filter_out_low="1" cutoff_buried_surface_area="100" atom_mode="polar_atoms" residue_selector="8A_interface"/>
		<BuriedUnsatHbonds name="buried_unsat_int" residue_selector="8A_interface" scorefxn="2015" use_ddG_style="true" use_reporter_behavior="true" report_all_heavy_atom_unsats="true" only_interface="false" confidence="1.0"/> #use_hbnet_behavior="true"
		<Rmsd name="rmsd" symmetry="0" chains="AB" threshold="1.0" confidence="1.0"/>
		# For reporting above filters that change upon ASU extraction
		<Report name="rep_buried_unsat_int" filter="buried_unsat_int"/>
		<Report name="rep_cst_weight" filter="cst_weight"/>
		<Report name="rep_full_stability" filter="full_stability"/>
		<Report name="rep_no_pssm_stability" filter="no_pssm_stability"/>
		<Report name="rep_pssm_weight" filter="pssm_weight"/>
	</FILTERS>

	<MOVERS>
		<ParsedProtocol name="design_block">
			<Add mover_name="soft_design_int"/>
			<Add mover_name="soft_min_design_int"/>
			<Add mover_name="soft_design_int"/>
			<Add mover_name="hard_min_design_int"/>
			<Add mover_name="hard_design_int"/>
			<Add mover_name="hard_min_design_int"/>
			<Add mover_name="hard_design_int"/>
			<Add mover_name="RTmin"/>
			<Add mover_name="RTmin"/>
			<Add mover_name="hard_min"/>
		</ParsedProtocol>
                <LoopOver name="design_loop_4" iterations="4" mover_name="design_block"/>
	</MOVERS>

	<PROTOCOLS>
                <Add filter_name="time"/>
		<Add mover_name="add_coord_cst"/>
		<Add mover_name="make_lattice"/>
		#Add mover_name="fsp"/>
		<Add mover_name="start_int"/>
		<Add mover_name="design_loop_4"/>
		<Add filter_name="full_stability" report_at_end="false"/>
		<Add filter_name="rep_full_stability"/>
                <Add filter_name="no_pssm_stability" report_at_end="false"/>
		<Add filter_name="rep_no_pssm_stability"/>
                <Add filter_name="pssm_weight" report_at_end="false"/>
                <Add filter_name="rep_pssm_weight"/>
                <Add filter_name="cst_weight" report_at_end="false"/>
                <Add filter_name="rep_cst_weight"/>
               	<Add filter_name="int_sc"/>
       	        <Add filter_name="int_connectivity"/>
                <Add filter_name="contact_count"/>
                <Add filter_name="bsa_total"/>
                <Add filter_name="bsa_hydrophobic"/>
		<Add filter_name="bsa_polar"/>
               	<Add filter_name="buried_unsat_int" report_at_end="false"/>
                <Add filter_name="rep_buried_unsat_int"/>
		<Add mover_name="extract_asu"/>
                <Add filter_name="rmsd"/>
		<Add filter_name="time"/>
	</PROTOCOLS>

</ROSETTASCRIPTS>
