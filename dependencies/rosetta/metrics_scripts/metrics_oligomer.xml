<ROSETTASCRIPTS>

	<SCOREFXNS>
		<ScoreFunction name="2015" weights="ref2015">
			<Reweight scoretype="coordinate_constraint" weight="%%cst_value%%"/>
		</ScoreFunction>
		<ScoreFunction name="2015_nano" weights="ref2015" patch="%%sym_score_patch%%">
			<Reweight scoretype="coordinate_constraint" weight="%%cst_value_sym%%"/>
		</ScoreFunction>
	</SCOREFXNS>

	<RESIDUE_SELECTORS>
		# used for selecting residues on one side of the interface
		# when using residue numbering all resnums are listed 23A,54A,64A,90A,etc...
		<Index name="A_interface" resnums="%%interface1%%" error_on_out_of_bounds_index="0" reverse="0"/>
		<Index name="B_interface" resnums="%%interface2%%" error_on_out_of_bounds_index="0" reverse="0"/> # can't use pose numbering with chain deletion. need to use residue numbering
		# combined group of all identified interface residues
		<Or name="tot_interface" selectors="A_interface,B_interface"/>
		# select all residues lower than energy 10 invloved in sidechain hydrogen bonding
		<HBond name="hbond_residues" residue_selector="%%chain%%_interface" include_bb_bb="false" hbond_energy_cutoff="10" scorefxn="2015_nano"/>
		# all residues
		<True name="full_pose"/>
	</RESIDUE_SELECTORS>

	<TASKOPERATIONS>
		# standard task operation to pull in commandline options
		<InitializeFromCommandline name="init"/>
		# standard operation to restrict all residues to repacking
		<RestrictToRepacking name="rtr"/>
		<DesignAround name="des_aroundA" design_shell="0.1" resnums="%%interface1%%" repack_shell="8.0"/>
		<DesignAround name="des_aroundB" design_shell="0.1" resnums="%%interface2%%" repack_shell="8.0"/>
	</TASKOPERATIONS>

	<SIMPLE_METRICS>
		# gather the residues involved in a residue selector
		<SelectedResiduesMetric name="M_int_hbonds_res_selector" custom_type="hbonds_res" rosetta_numbering="false" residue_selector="hbond_residues"/>
		# gather the per residue SASA of a residue selection
		<PerResidueSasaMetric name="M_sasa_hydrophobic_per_res" custom_type="per" output_as_pdb_nums="false" residue_selector="%%chain%%_interface" mode="hydrophobic_sasa"/>
		<PerResidueSasaMetric name="M_sasa_polar_per_res" custom_type="per" output_as_pdb_nums="false" residue_selector="%%chain%%_interface" mode="polar_sasa"/>
		<PerResidueSasaMetric name="M_sasa_total_per_res" custom_type="per" output_as_pdb_nums="false" residue_selector="%%chain%%_interface" mode="all_sasa"/>
		# find the per residue energy of residues in a residue_selector 
		<PerResidueEnergyMetric name="M_int_energy_oligomer_per_res" custom_type="per" output_as_pdb_nums="false" residue_selector="%%chain%%_interface" use_native="false" scoretype="total_score" scorefxn="2015_nano"/>
		<!-- <PerResidueEnergyMetric name="M_int_energy_unbound_per_res" custom_type="per" output_as_pdb_nums="false" residue_selector="tot_interface" use_native="false" scoretype="total_score" scorefxn="2015"/> -->
		# summarize the energy metrics from above
		<ResidueSummaryMetric name="M_int_energy_total_oligomer" custom_type="int_energy" metric="M_int_energy_oligomer_per_res" action="sum"/>
		<ResidueSummaryMetric name="M_int_area_hydrophobic" custom_type="int_area" metric="M_sasa_hydrophobic_per_res" action="sum"/>
		<ResidueSummaryMetric name="M_int_area_polar" custom_type="int_area" metric="M_sasa_polar_per_res" action="sum"/> # MOVE CUSTOM TYPE PREFIX FOR ALL SUMMARY DATA TO RunSimpleMetrics Suffix
		<ResidueSummaryMetric name="M_int_area_total" custom_type="int_area" metric="M_sasa_total_per_res" action="sum"/>
		<!-- <ResidueSummaryMetric name="M_int_energy_total_unbound" custom_type="int_energy" metric="M_int_energy_unbound_per_res" action="sum"/> -->
		# calculate the interaction energy metric between residues in two selections. I believe this in only the two body components to understand the interface component of energy
		<!-- <InteractionEnergyMetric name="M_interaction_energy" custom_type="" force_rescore="false" residue_selector="%%chain%%_interface" residue_selector2="full_pose" scorefxn="2015"/> #used to specify certain score terms to calculate on. include_rama_prepro_and_proclose="false". JD2 reports options invalid "scoretypes_only="" scoretypes_skip=""" -->
	</SIMPLE_METRICS>

	<MOVE_MAP_FACTORIES>
		<MoveMapFactory name="design_map" bb="0" chi="1">
			<Backbone residue_selector="%%chain%%_interface" enable="true"/>
		</MoveMapFactory>
	</MOVE_MAP_FACTORIES>

	<MOVERS>
		# generates symmetry for the system in question using %%sdf%% or %%dist%%
		<SetupForSymmetry name="make_point_groupA" definition="%%sdfA%%" set_global_symmetry_at_parsetime="0"/>
		<SetupForSymmetry name="make_point_groupB" definition="%%sdfB%%" set_global_symmetry_at_parsetime="0"/>
		<SetupForSymmetry name="make_point_groupC" definition="%%sdfC%%" set_global_symmetry_at_parsetime="0"/>
		# sample all rotamers to find minimum
		<SymRotamerTrialsMover name="RT" scorefxn="2015_nano" task_operations="init,rtr"/> # Unused in P432
		<SymMinMover name="min" scorefxn="2015_nano" movemap_factory="design_map"/> # bb="0" chi="1"
		# process metrics that are defined in the SimpleMetrics header above
		<RunSimpleMetrics name="run_metrics_hydrophobic_sasa_oligomer" metrics="M_sasa_hydrophobic_per_res" prefix="" suffix="_hydrophobic_%%chain%%_oligomer" override="false"/> # %%chain%%
		<RunSimpleMetrics name="run_metrics_polar_sasa_oligomer" metrics="M_sasa_polar_per_res" prefix="" suffix="_polar_%%chain%%_oligomer" override="false"/> # %%chain%%
		<RunSimpleMetrics name="run_metrics_sasa_oligomer" metrics="M_sasa_total_per_res" prefix="" suffix="_total_%%chain%%_oligomer" override="false"/> # %%chain%%
		<RunSimpleMetrics name="run_metrics_oligomer_per_res" metrics="M_int_energy_oligomer_per_res,M_int_hbonds_res_selector" prefix="" suffix="_%%chain%%_oligomer" override="false"/> # %%chain%%
		<RunSimpleMetrics name="run_metrics_oligomer" metrics="M_int_energy_total_oligomer" prefix="" suffix="_%%chain%%_oligomer" override="false"/> # M_interaction_energy
		<RunSimpleMetrics name="run_metrics_oligomer_sum_hydrophobic" metrics="M_int_area_hydrophobic" prefix="" suffix="_hydrophobic_%%chain%%_oligomer" override="false"/>
		<RunSimpleMetrics name="run_metrics_oligomer_sum_polar" metrics="M_int_area_polar" prefix="" suffix="_polar_%%chain%%_oligomer" override="false"/>
		<RunSimpleMetrics name="run_metrics_oligomer_sum_total" metrics="M_int_area_total" prefix="" suffix="_total_%%chain%%_oligomer" override="false"/>
			<!-- <RunSimpleMetrics name="run_metrics_hydrophobic_sasa_unbound" metrics="M_sasa_hydrophobic_per_res" prefix="" suffix="_hydrophobic_unbound" override="false"/>  -->
			<!-- <RunSimpleMetrics name="run_metrics_polar_sasa_unbound" metrics="M_sasa_polar_per_res" prefix="" suffix="_polar_unbound" override="false"/>  -->
			<!-- <RunSimpleMetrics name="run_metrics_sasa_unbound" metrics="M_sasa_per_res" prefix="" suffix="_total_unbound" override="false"/>  -->
			<!-- <RunSimpleMetrics name="run_metrics_unbound" metrics="M_int_energy_unbound_per_res,M_int_energy_total_unbound,M_interaction_energy,M_int_hbonds_res_selector" prefix="" suffix="_unbound" override="false"/> -->
		<ParsedProtocol name="rotamer_trials_min_mover">
			<Add mover_name="RT"/> # Unused in P432 for minimization of the unbound state
			<Add mover_name="min"/>
		</ParsedProtocol>
		<LoopOver name="repack_loop" iterations="4" mover_name="rotamer_trials_min_mover"/>
	</MOVERS>

	<FILTERS>
		<ScoreType name="full_stability_%%chain%%_oligomer" scorefxn="2015_nano" score_type="total_score" threshold="20000" confidence="1.0"/>
		# find the average degree of connectivity to residues surrounding specified residues
		<AverageDegree name="int_connectivity_%%chain%%" threshold="0" distance_threshold="10.0" task_operations="des_around%%chain%%"/>
		<ScorePoseSegmentFromResidueSelectorFilter name="int_energy_context_%%chain%%_oligomer" in_context="1" residue_selector="%%chain%%_interface" scorefxn="2015_nano" confidence="1.0"/>
		<Report name="R_full_stability_%%chain%%_oligomer" 			filter="full_stability_%%chain%%_oligomer"/>
		<Report name="R_int_connectivity_%%chain%%" 				filter="int_connectivity_%%chain%%"/>
		<Report name="R_int_energy_context_%%chain%%_oligomer" 		filter="int_energy_context_%%chain%%_oligomer"/>
		<!-- <Report name="R_int_connectivityB" 				filter="int_connectivityB"/> -->
	</FILTERS>

	<PROTOCOLS>
		<Add mover_name="make_point_group%%chain%%"/>
		<Add mover_name="repack_loop"/> # Unused in P432 for minimization of the unbound state
		<Add filter_name="R_int_connectivity_%%chain%%"/>
		<Add filter_name="R_full_stability_%%chain%%_oligomer"/>
		<Add filter_name="R_int_energy_context_%%chain%%_oligomer"/>
		<Add mover_name="run_metrics_hydrophobic_sasa_oligomer"/>
		<Add mover_name="run_metrics_polar_sasa_oligomer"/>
		<Add mover_name="run_metrics_sasa_oligomer"/>
		<Add mover_name="run_metrics_oligomer_per_res"/>
		<Add mover_name="run_metrics_oligomer"/>
		<Add mover_name="run_metrics_oligomer_sum_hydrophobic"/>
		<Add mover_name="run_metrics_oligomer_sum_polar"/>
		<Add mover_name="run_metrics_oligomer_sum_total"/>
	</PROTOCOLS>

</ROSETTASCRIPTS>
