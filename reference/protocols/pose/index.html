
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../fragdock/">
      
      
        <link rel="next" href="../select/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.9">
    
    
      
        <title>pose - symdesign Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.f2e4d321.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../css/code_select.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#protocols.pose" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="symdesign Documentation" class="md-header__button md-logo" aria-label="symdesign Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            symdesign Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              pose
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="green"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="deep-purple" data-md-color-accent="green"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="green"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/kylemeador/symdesign" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../user_guide/" class="md-tabs__link">
        
  
    
  
  User Guide

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  API reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="symdesign Documentation" class="md-nav__button md-logo" aria-label="symdesign Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    symdesign Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/kylemeador/symdesign" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user_guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    User Guide
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    API reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    symdesign
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../flags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    flags
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../metrics/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    metrics
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            metrics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../metrics/pose/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pose
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    protocols
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            protocols
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../align/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    align
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cluster
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fragdock/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    fragdock
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    pose
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    pose
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#protocols.pose" class="md-nav__link">
    <span class="md-ellipsis">
      pose
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory" class="md-nav__link">
    <span class="md-ellipsis">
      PoseDirectory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PoseDirectory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.info" class="md-nav__link">
    <span class="md-ellipsis">
      info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.output_modifier" class="md-nav__link">
    <span class="md-ellipsis">
      output_modifier
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.output_pose_path" class="md-nav__link">
    <span class="md-ellipsis">
      output_pose_path
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.output_assembly_path" class="md-nav__link">
    <span class="md-ellipsis">
      output_assembly_path
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.job" class="md-nav__link">
    <span class="md-ellipsis">
      job
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.refined" class="md-nav__link">
    <span class="md-ellipsis">
      refined
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.refined_pdb" class="md-nav__link">
    <span class="md-ellipsis">
      refined_pdb
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.symmetry_definition_files" class="md-nav__link">
    <span class="md-ellipsis">
      symmetry_definition_files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.designed_sequences" class="md-nav__link">
    <span class="md-ellipsis">
      designed_sequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.get_pose_file" class="md-nav__link">
    <span class="md-ellipsis">
      get_pose_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.get_design_files" class="md-nav__link">
    <span class="md-ellipsis">
      get_design_files
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocols.pose.PoseData" class="md-nav__link">
    <span class="md-ellipsis">
      PoseData
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PoseData">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.initial_pose" class="md-nav__link">
    <span class="md-ellipsis">
      initial_pose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.pose" class="md-nav__link">
    <span class="md-ellipsis">
      pose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.protocol" class="md-nav__link">
    <span class="md-ellipsis">
      protocol
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.symmetry_dimension" class="md-nav__link">
    <span class="md-ellipsis">
      symmetry_dimension
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.symmetry" class="md-nav__link">
    <span class="md-ellipsis">
      symmetry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.sym_entry_specification" class="md-nav__link">
    <span class="md-ellipsis">
      sym_entry_specification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.sym_entry_number" class="md-nav__link">
    <span class="md-ellipsis">
      sym_entry_number
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.new_pose_identifier" class="md-nav__link">
    <span class="md-ellipsis">
      new_pose_identifier
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.directives" class="md-nav__link">
    <span class="md-ellipsis">
      directives
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.current_designs" class="md-nav__link">
    <span class="md-ellipsis">
      current_designs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.structure_source" class="md-nav__link">
    <span class="md-ellipsis">
      structure_source
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.sym_entry" class="md-nav__link">
    <span class="md-ellipsis">
      sym_entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.job_kwargs" class="md-nav__link">
    <span class="md-ellipsis">
      job_kwargs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.pose_kwargs" class="md-nav__link">
    <span class="md-ellipsis">
      pose_kwargs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.design_selector" class="md-nav__link">
    <span class="md-ellipsis">
      design_selector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.refined" class="md-nav__link">
    <span class="md-ellipsis">
      refined
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.loop_modeled" class="md-nav__link">
    <span class="md-ellipsis">
      loop_modeled
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.from_path" class="md-nav__link">
    <span class="md-ellipsis">
      from_path
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.from_file" class="md-nav__link">
    <span class="md-ellipsis">
      from_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.from_directory" class="md-nav__link">
    <span class="md-ellipsis">
      from_directory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.from_name" class="md-nav__link">
    <span class="md-ellipsis">
      from_name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.from_pose_identifier" class="md-nav__link">
    <span class="md-ellipsis">
      from_pose_identifier
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.from_pose" class="md-nav__link">
    <span class="md-ellipsis">
      from_pose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.__init_from_db__" class="md-nav__link">
    <span class="md-ellipsis">
      __init_from_db__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.clear_state" class="md-nav__link">
    <span class="md-ellipsis">
      clear_state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.use_specific_designs" class="md-nav__link">
    <span class="md-ellipsis">
      use_specific_designs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.load_initial_pose" class="md-nav__link">
    <span class="md-ellipsis">
      load_initial_pose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.is_symmetric" class="md-nav__link">
    <span class="md-ellipsis">
      is_symmetric
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.get_designs_without_structure" class="md-nav__link">
    <span class="md-ellipsis">
      get_designs_without_structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.transform_entities_to_pose" class="md-nav__link">
    <span class="md-ellipsis">
      transform_entities_to_pose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.transform_structures_to_pose" class="md-nav__link">
    <span class="md-ellipsis">
      transform_structures_to_pose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.get_entities" class="md-nav__link">
    <span class="md-ellipsis">
      get_entities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.report_exception" class="md-nav__link">
    <span class="md-ellipsis">
      report_exception
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.format_see_log_msg" class="md-nav__link">
    <span class="md-ellipsis">
      format_see_log_msg
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.load_pose" class="md-nav__link">
    <span class="md-ellipsis">
      load_pose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.output_pose" class="md-nav__link">
    <span class="md-ellipsis">
      output_pose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.set_up_evolutionary_profile" class="md-nav__link">
    <span class="md-ellipsis">
      set_up_evolutionary_profile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.generate_fragments" class="md-nav__link">
    <span class="md-ellipsis">
      generate_fragments
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol" class="md-nav__link">
    <span class="md-ellipsis">
      PoseProtocol
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PoseProtocol">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.identify_interface" class="md-nav__link">
    <span class="md-ellipsis">
      identify_interface
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.orient" class="md-nav__link">
    <span class="md-ellipsis">
      orient
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.prepare_rosetta_flags" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_rosetta_flags
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.generate_entity_metrics_commands" class="md-nav__link">
    <span class="md-ellipsis">
      generate_entity_metrics_commands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.get_cmd_process_rosetta_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      get_cmd_process_rosetta_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.thread_sequences_to_backbone" class="md-nav__link">
    <span class="md-ellipsis">
      thread_sequences_to_backbone
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.predict_structure" class="md-nav__link">
    <span class="md-ellipsis">
      predict_structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.alphafold_predict_structure" class="md-nav__link">
    <span class="md-ellipsis">
      alphafold_predict_structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.refine" class="md-nav__link">
    <span class="md-ellipsis">
      refine
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.rosetta_interface_design" class="md-nav__link">
    <span class="md-ellipsis">
      rosetta_interface_design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.proteinmpnn_design" class="md-nav__link">
    <span class="md-ellipsis">
      proteinmpnn_design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.update_design_protocols" class="md-nav__link">
    <span class="md-ellipsis">
      update_design_protocols
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.update_design_data" class="md-nav__link">
    <span class="md-ellipsis">
      update_design_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.output_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      output_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.parse_rosetta_scores" class="md-nav__link">
    <span class="md-ellipsis">
      parse_rosetta_scores
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.rosetta_column_combinations" class="md-nav__link">
    <span class="md-ellipsis">
      rosetta_column_combinations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.process_rosetta_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      process_rosetta_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.calculate_pose_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_pose_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.calculate_pose_design_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_pose_design_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_alphafold_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_alphafold_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_design_entities_per_residue" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_design_entities_per_residue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_design_metrics_per_design" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_design_metrics_per_design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_design_metrics_per_residue" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_design_metrics_per_residue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_pose_designs" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_pose_designs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_pose_metrics_per_design" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_pose_metrics_per_design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_proteinmpnn_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_proteinmpnn_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_residue_metrics_per_design" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_residue_metrics_per_design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_sequence_metrics_per_design" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_sequence_metrics_per_design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.interface_design_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      interface_design_analysis
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocols.pose.load_evolutionary_profile" class="md-nav__link">
    <span class="md-ellipsis">
      load_evolutionary_profile
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocols.pose.insert_pose_jobs" class="md-nav__link">
    <span class="md-ellipsis">
      insert_pose_jobs
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../select/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    select
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../resources/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    resources
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            resources
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/database/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    database
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/distribute/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    distribute
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/job/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    job
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/ml/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ml
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/monomer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    monomer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/multimer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    multimer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../resources/query/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    query
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_5_8" id="__nav_3_5_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_8">
            <span class="md-nav__icon md-icon"></span>
            query
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/query/pdb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pdb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/query/uniprot/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    uniprot
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/sql/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sql
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/structure_db/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    structure_db
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/wrapapi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    wrapapi
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../sequence/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    sequence
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            sequence
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sequence/constants/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    constants
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sequence/expression/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    expression
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../structure/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    structure
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7">
            <span class="md-nav__icon md-icon"></span>
            structure
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../structure/base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    base
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../structure/coordinates/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    coordinates
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../structure/fragment/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    fragment
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_7_3" id="__nav_3_7_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7_3">
            <span class="md-nav__icon md-icon"></span>
            fragment
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../structure/fragment/db/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    db
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../structure/fragment/info/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    info
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../structure/fragment/metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    metrics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../structure/fragment/visuals/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    visuals
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../structure/model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../structure/sequence/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sequence
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../structure/utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../tools/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    tools
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/BenchmarkCollapseHydrophobicityScale/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BenchmarkCollapseHydrophobicityScale
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/ConcatenatePDBFiles/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ConcatenatePDBFiles
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/ProfileScripts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ProfileScripts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/SlurmControl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SlurmControl
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/distribute/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    distribute
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/fetch_commands_from_slurm_output/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    fetch_commands_from_slurm_output
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/format_commands/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    format_commands
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/format_pose_ids/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    format_pose_ids
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/generate_reference_docs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    generate_reference_docs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/get_array_numbers_from_identifiers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    get_array_numbers_from_identifiers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/list_files_in_directory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    list_files_in_directory
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/list_overlap/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    list_overlap
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/models_to_multimodel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    models_to_multimodel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/profile_gpu_nodes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    profile_gpu_nodes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/retrieve_oligomers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    retrieve_oligomers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/retrieve_pdbs_by_advanced_query/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    retrieve_pdbs_by_advanced_query
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/write_indices_for_C1_docking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    write_indices_for_C1_docking
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_9" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../utils/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    utils
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_9" id="__nav_3_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_9">
            <span class="md-nav__icon md-icon"></span>
            utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/SymEntry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SymEntry
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/cluster/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cluster
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    guide
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/nanohedra_parsing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nanohedra_parsing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/path/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    path
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/query/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    query
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/rosetta/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    rosetta
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/symmetry/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    symmetry
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/types/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    types
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_10" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../visualization/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    visualization
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_10" id="__nav_3_10_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_10">
            <span class="md-nav__icon md-icon"></span>
            visualization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../visualization/SymmetryMates/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SymmetryMates
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../visualization/VisualizeUtils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VisualizeUtils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../visualization/shapes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    shapes
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#protocols.pose" class="md-nav__link">
    <span class="md-ellipsis">
      pose
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory" class="md-nav__link">
    <span class="md-ellipsis">
      PoseDirectory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PoseDirectory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.info" class="md-nav__link">
    <span class="md-ellipsis">
      info
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.output_modifier" class="md-nav__link">
    <span class="md-ellipsis">
      output_modifier
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.output_pose_path" class="md-nav__link">
    <span class="md-ellipsis">
      output_pose_path
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.output_assembly_path" class="md-nav__link">
    <span class="md-ellipsis">
      output_assembly_path
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.job" class="md-nav__link">
    <span class="md-ellipsis">
      job
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.refined" class="md-nav__link">
    <span class="md-ellipsis">
      refined
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.refined_pdb" class="md-nav__link">
    <span class="md-ellipsis">
      refined_pdb
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.symmetry_definition_files" class="md-nav__link">
    <span class="md-ellipsis">
      symmetry_definition_files
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.designed_sequences" class="md-nav__link">
    <span class="md-ellipsis">
      designed_sequences
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.get_pose_file" class="md-nav__link">
    <span class="md-ellipsis">
      get_pose_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseDirectory.get_design_files" class="md-nav__link">
    <span class="md-ellipsis">
      get_design_files
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocols.pose.PoseData" class="md-nav__link">
    <span class="md-ellipsis">
      PoseData
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PoseData">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.initial_pose" class="md-nav__link">
    <span class="md-ellipsis">
      initial_pose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.pose" class="md-nav__link">
    <span class="md-ellipsis">
      pose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.protocol" class="md-nav__link">
    <span class="md-ellipsis">
      protocol
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.symmetry_dimension" class="md-nav__link">
    <span class="md-ellipsis">
      symmetry_dimension
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.symmetry" class="md-nav__link">
    <span class="md-ellipsis">
      symmetry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.sym_entry_specification" class="md-nav__link">
    <span class="md-ellipsis">
      sym_entry_specification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.sym_entry_number" class="md-nav__link">
    <span class="md-ellipsis">
      sym_entry_number
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.new_pose_identifier" class="md-nav__link">
    <span class="md-ellipsis">
      new_pose_identifier
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.directives" class="md-nav__link">
    <span class="md-ellipsis">
      directives
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.current_designs" class="md-nav__link">
    <span class="md-ellipsis">
      current_designs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.structure_source" class="md-nav__link">
    <span class="md-ellipsis">
      structure_source
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.sym_entry" class="md-nav__link">
    <span class="md-ellipsis">
      sym_entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.job_kwargs" class="md-nav__link">
    <span class="md-ellipsis">
      job_kwargs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.pose_kwargs" class="md-nav__link">
    <span class="md-ellipsis">
      pose_kwargs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.design_selector" class="md-nav__link">
    <span class="md-ellipsis">
      design_selector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.refined" class="md-nav__link">
    <span class="md-ellipsis">
      refined
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.loop_modeled" class="md-nav__link">
    <span class="md-ellipsis">
      loop_modeled
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.from_path" class="md-nav__link">
    <span class="md-ellipsis">
      from_path
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.from_file" class="md-nav__link">
    <span class="md-ellipsis">
      from_file
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.from_directory" class="md-nav__link">
    <span class="md-ellipsis">
      from_directory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.from_name" class="md-nav__link">
    <span class="md-ellipsis">
      from_name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.from_pose_identifier" class="md-nav__link">
    <span class="md-ellipsis">
      from_pose_identifier
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.from_pose" class="md-nav__link">
    <span class="md-ellipsis">
      from_pose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.__init_from_db__" class="md-nav__link">
    <span class="md-ellipsis">
      __init_from_db__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.clear_state" class="md-nav__link">
    <span class="md-ellipsis">
      clear_state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.use_specific_designs" class="md-nav__link">
    <span class="md-ellipsis">
      use_specific_designs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.load_initial_pose" class="md-nav__link">
    <span class="md-ellipsis">
      load_initial_pose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.is_symmetric" class="md-nav__link">
    <span class="md-ellipsis">
      is_symmetric
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.get_designs_without_structure" class="md-nav__link">
    <span class="md-ellipsis">
      get_designs_without_structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.transform_entities_to_pose" class="md-nav__link">
    <span class="md-ellipsis">
      transform_entities_to_pose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.transform_structures_to_pose" class="md-nav__link">
    <span class="md-ellipsis">
      transform_structures_to_pose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.get_entities" class="md-nav__link">
    <span class="md-ellipsis">
      get_entities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.report_exception" class="md-nav__link">
    <span class="md-ellipsis">
      report_exception
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.format_see_log_msg" class="md-nav__link">
    <span class="md-ellipsis">
      format_see_log_msg
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.load_pose" class="md-nav__link">
    <span class="md-ellipsis">
      load_pose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.output_pose" class="md-nav__link">
    <span class="md-ellipsis">
      output_pose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.set_up_evolutionary_profile" class="md-nav__link">
    <span class="md-ellipsis">
      set_up_evolutionary_profile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseData.generate_fragments" class="md-nav__link">
    <span class="md-ellipsis">
      generate_fragments
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol" class="md-nav__link">
    <span class="md-ellipsis">
      PoseProtocol
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PoseProtocol">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.identify_interface" class="md-nav__link">
    <span class="md-ellipsis">
      identify_interface
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.orient" class="md-nav__link">
    <span class="md-ellipsis">
      orient
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.prepare_rosetta_flags" class="md-nav__link">
    <span class="md-ellipsis">
      prepare_rosetta_flags
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.generate_entity_metrics_commands" class="md-nav__link">
    <span class="md-ellipsis">
      generate_entity_metrics_commands
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.get_cmd_process_rosetta_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      get_cmd_process_rosetta_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.thread_sequences_to_backbone" class="md-nav__link">
    <span class="md-ellipsis">
      thread_sequences_to_backbone
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.predict_structure" class="md-nav__link">
    <span class="md-ellipsis">
      predict_structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.alphafold_predict_structure" class="md-nav__link">
    <span class="md-ellipsis">
      alphafold_predict_structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.refine" class="md-nav__link">
    <span class="md-ellipsis">
      refine
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.rosetta_interface_design" class="md-nav__link">
    <span class="md-ellipsis">
      rosetta_interface_design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.proteinmpnn_design" class="md-nav__link">
    <span class="md-ellipsis">
      proteinmpnn_design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.update_design_protocols" class="md-nav__link">
    <span class="md-ellipsis">
      update_design_protocols
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.update_design_data" class="md-nav__link">
    <span class="md-ellipsis">
      update_design_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.output_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      output_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.parse_rosetta_scores" class="md-nav__link">
    <span class="md-ellipsis">
      parse_rosetta_scores
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.rosetta_column_combinations" class="md-nav__link">
    <span class="md-ellipsis">
      rosetta_column_combinations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.process_rosetta_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      process_rosetta_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.calculate_pose_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_pose_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.calculate_pose_design_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_pose_design_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_alphafold_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_alphafold_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_design_entities_per_residue" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_design_entities_per_residue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_design_metrics_per_design" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_design_metrics_per_design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_design_metrics_per_residue" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_design_metrics_per_residue
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_pose_designs" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_pose_designs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_pose_metrics_per_design" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_pose_metrics_per_design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_proteinmpnn_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_proteinmpnn_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_residue_metrics_per_design" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_residue_metrics_per_design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.analyze_sequence_metrics_per_design" class="md-nav__link">
    <span class="md-ellipsis">
      analyze_sequence_metrics_per_design
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#protocols.pose.PoseProtocol.interface_design_analysis" class="md-nav__link">
    <span class="md-ellipsis">
      interface_design_analysis
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocols.pose.load_evolutionary_profile" class="md-nav__link">
    <span class="md-ellipsis">
      load_evolutionary_profile
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocols.pose.insert_pose_jobs" class="md-nav__link">
    <span class="md-ellipsis">
      insert_pose_jobs
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>pose</h1>

<div class="doc doc-object doc-module">



<a id="protocols.pose"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="protocols.pose.PoseDirectory" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">PoseDirectory</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">PoseDirectory</span><span class="p">(</span><span class="n">root_directory</span><span class="p">:</span> <span class="n"><span title="typing.AnyStr">AnyStr</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">

  



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>root_directory</code></b>
            (<code><span title="typing.AnyStr">AnyStr</span></code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The base of the directory tree that houses all project directories</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>project</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The name of the project where the files should be stored in the root_directory</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>name</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The name of the pose, which becomes the final dirname where all files are stored</p>
        </div>
      </li>
  </ul>

                <details class="quote">
                  <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
                  <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_directory</span><span class="p">:</span> <span class="n">AnyStr</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct the instance</span>

<span class="sd">    Args:</span>
<span class="sd">        root_directory: The base of the directory tree that houses all project directories</span>
<span class="sd">        project: The name of the project where the files should be stored in the root_directory</span>
<span class="sd">        name: The name of the pose, which becomes the final dirname where all files are stored</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Internal state info&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Internal state info at load time&quot;&quot;&quot;</span>

    <span class="c1"># try:</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_directory</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="c1"># except TypeError:  # Can&#39;t pass None</span>
    <span class="c1">#     missing_args = &quot;, &quot;.join((str_ for str_, arg in ((&quot;root_directory&quot;, root_directory),</span>
    <span class="c1">#                                                     (&quot;project&quot;, project), (&quot;name&quot;, name))</span>
    <span class="c1">#                               if arg is None))</span>
    <span class="c1">#     raise TypeError(f&#39;{PoseDirectory.__name__} is missing the required arguments {missing_args}&#39;)</span>
    <span class="c1"># if directory is not None:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pose_directory</span> <span class="o">=</span> <span class="n">directory</span>
    <span class="c1"># PoseDirectory attributes. Set after finding correct path</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_directory</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.log&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_directory</span><span class="p">,</span> <span class="s1">&#39;designs&#39;</span><span class="p">)</span>
    <span class="c1"># /root/Projects/project_Poses/design/designs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scripts_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_directory</span><span class="p">,</span> <span class="s1">&#39;scripts&#39;</span><span class="p">)</span>
    <span class="c1"># /root/Projects/project_Poses/design/scripts</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">frags_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_directory</span><span class="p">,</span> <span class="n">putils</span><span class="o">.</span><span class="n">frag_dir</span><span class="p">)</span>
    <span class="c1"># /root/Projects/project_Poses/design/matching_fragments</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scripts_path</span><span class="p">,</span> <span class="s1">&#39;flags&#39;</span><span class="p">)</span>
    <span class="c1"># /root/Projects/project_Poses/design/scripts/flags</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_directory</span><span class="p">,</span> <span class="n">putils</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># /root/Projects/project_Poses/design/data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scores_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.sc&#39;</span><span class="p">)</span>
    <span class="c1"># /root/Projects/project_Poses/design/data/name.sc</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">serialized_info</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;info.pkl&#39;</span><span class="p">)</span>
    <span class="c1"># /root/Projects/project_Poses/design/data/info.pkl</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pose_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_directory</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.pdb&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">asu_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_directory</span><span class="p">,</span> <span class="s1">&#39;asu.pdb&#39;</span><span class="p">)</span>
    <span class="c1"># /root/Projects/project_Poses/design/asu.pdb</span>
    <span class="c1"># self.asu_path: str | Path = os.path.join(self.pose_directory, f&#39;{self.name}_{putils.asu}&#39;)</span>
    <span class="c1"># # /root/Projects/project_Poses/design/design_name_asu.pdb</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assembly_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_directory</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_assembly.pdb&#39;</span><span class="p">)</span>
    <span class="c1"># /root/Projects/project_Poses/design/design_name_assembly.pdb</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">refine_pdb</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_path</span><span class="p">))</span>
    <span class="c1"># /root/Projects/project_Poses/design/data/design_name.pdb</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">consensus_pdb</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">_for_consensus.pdb&#39;</span>
    <span class="c1"># /root/Projects/project_Poses/design/design_name_for_consensus.pdb</span>
    <span class="c1"># self.consensus_design_pdb: str | Path = os.path.join(self.designs_path, os.path.basename(self.consensus_pdb))</span>
    <span class="c1"># # /root/Projects/project_Poses/design/designs/design_name_for_consensus.pdb</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">design_profile_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;design.pssm&#39;</span><span class="p">)</span>
    <span class="c1"># /root/Projects/project_Poses/design/data/design.pssm</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">evolutionary_profile_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;evolutionary.pssm&#39;</span><span class="p">)</span>
    <span class="c1"># /root/Projects/project_Poses/design/data/evolutionary.pssm</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fragment_profile_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;fragment.pssm&#39;</span><span class="p">)</span>
    <span class="c1"># /root/Projects/project_Poses/design/data/fragment.pssm</span>
    <span class="c1"># These next two files may be present from NanohedraV1 outputs</span>
    <span class="c1"># self.pose_file = os.path.join(self.pose_directory, putils.pose_file)</span>
    <span class="c1"># self.frag_file = os.path.join(self.frags_path, putils.frag_text_file)</span>
    <span class="c1"># These files are used as output from analysis protocols</span>
    <span class="c1"># self.designs_metrics_csv = os.path.join(self.job.all_scores, f&#39;{self}_Trajectories.csv&#39;)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">designs_metrics_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;designs.csv&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">residues_metrics_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;residues.csv&#39;</span><span class="p">)</span>
    <span class="c1"># self.designed_sequences_file = os.path.join(self.job.all_scores, f&#39;{self}_Sequences.pkl&#39;)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">designed_sequences_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sequences.fasta&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_script</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">output_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_modifier</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">project</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;string with contents &#39;{self.project}-{self.name}&#39;&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_pose_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_modifier</span><span class="si">}</span><span class="s1">.pdb&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/output_path/{self.output_modifier}.pdb&quot;&quot;&quot;</span>
        <span class="c1"># self.output_asu_path: str | Path = os.path.join(self.output_path, f&#39;{self.output_modifier}_{putils.asu}&#39;)</span>
        <span class="c1"># &quot;&quot;&quot;/output_path/{self.output_modifier}_asu.pdb&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_assembly_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> \
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_modifier</span><span class="si">}</span><span class="s1">_assembly.pdb&#39;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;/output_path/{self.output_modifier}_{putils.assembly}.pdb &quot;&quot;&quot;</span>
        <span class="c1"># pose_directory = self.job.output_directory  # /output_directory &lt;- self.pose_directory/design.pdb</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseDirectory.info" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">info</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">info</span><span class="p">:</span> <span class="n">dict</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Internal state info</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseDirectory.output_modifier" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">output_modifier</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">output_modifier</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">project</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>string with contents '{self.project}-{self.name}'</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseDirectory.output_pose_path" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">output_pose_path</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">output_pose_path</span> <span class="o">=</span> <span class="n"><span title="os.path.join">join</span></span><span class="p">(</span><span class="n"><span title="self.output_path">output_path</span></span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n"><span title="self.output_modifier">output_modifier</span></span><span class="si">}</span><span class="s1">.pdb&#39;</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>/output_path/{self.output_modifier}.pdb</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseDirectory.output_assembly_path" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">output_assembly_path</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">output_assembly_path</span><span class="p">:</span> <span class="n">str</span> <span class="o">|</span> <span class="n"><span title="pathlib.Path">Path</span></span> <span class="o">=</span> <span class="n"><span title="os.path.join">join</span></span><span class="p">(</span><span class="n"><span title="self.output_path">output_path</span></span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n"><span title="self.output_modifier">output_modifier</span></span><span class="si">}</span><span class="s1">_assembly.pdb&#39;</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>/output_path/{self.output_modifier}_{putils.assembly}.pdb</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseDirectory.job" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">job</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">job</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseDirectory.refined" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">refined</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">refined</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseDirectory.refined_pdb" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">refined_pdb</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">refined_pdb</span><span class="p">:</span> <span class="n">str</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Access the file which holds refined coordinates. These are not necessaryily refined, but if a file exists in
the designs_path with the pose name, it was generated from either Rosetta energy function minimization or from
structure prediction, which is assumed to be refined. If none, exists, use the self.pose_path</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseDirectory.symmetry_definition_files" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">symmetry_definition_files</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">symmetry_definition_files</span><span class="p">:</span> <span class="n">list</span><span class="p">[</span><span class="n"><span title="typing.AnyStr">AnyStr</span></span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Retrieve the symmetry definition files name from PoseJob</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseDirectory.designed_sequences" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">designed_sequences</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">designed_sequences</span><span class="p">:</span> <span class="n">list</span><span class="p">[</span><span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Return the designed sequences for the entire Pose associated with the PoseJob</p>
  </div>

</div>




<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseDirectory.get_pose_file" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">get_pose_file</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">get_pose_file</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n"><span title="typing.AnyStr">AnyStr</span></span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Retrieve the pose file name from PoseJob</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_pose_file</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AnyStr</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve the pose file name from PoseJob&quot;&quot;&quot;</span>
    <span class="c1"># glob_target = os.path.join(self.pose_directory, f&#39;{self.name}*.pdb&#39;)</span>
    <span class="n">glob_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_path</span>
    <span class="n">source</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">glob_target</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="si">}</span><span class="s1"> files matching the path &quot;</span><span class="si">{</span><span class="n">glob_target</span><span class="si">}</span><span class="s1">&quot;. No more than one expected&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># glob found no files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t find any structural files matching the path &#39;</span><span class="si">{</span><span class="n">glob_target</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="n">file</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span>

    <span class="k">return</span> <span class="n">file</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseDirectory.get_design_files" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">get_design_files</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">get_design_files</span><span class="p">(</span><span class="n">design_type</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="p">[</span><span class="n"><span title="typing.AnyStr">AnyStr</span></span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Return the paths of all design files in a PoseJob</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>design_type</code></b>
            (<code>str</code>, default:
                <code>&#39;&#39;</code>
)
        
        <div class="doc-md-description">
          <p>Specify if a particular type of design should be selected by a "type" string</p>
        </div>
      </li>
  </ul>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
            <code>list[<span title="typing.AnyStr">AnyStr</span>]</code>
        
        <div class="doc-md-description">
          <p>The sorted design files found in the designs directory with an absolute path</p>
      </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_design_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">design_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the paths of all design files in a PoseJob</span>

<span class="sd">    Args:</span>
<span class="sd">        design_type: Specify if a particular type of design should be selected by a &quot;type&quot; string</span>

<span class="sd">    Returns:</span>
<span class="sd">        The sorted design files found in the designs directory with an absolute path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;*</span><span class="si">{</span><span class="n">design_type</span><span class="si">}</span><span class="s1">*.pdb*&#39;</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>


</div>

<div class="doc doc-object doc-class">



<h2 id="protocols.pose.PoseData" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">PoseData</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">PoseData</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">source_path</span><span class="p">:</span> <span class="n"><span title="typing.AnyStr">AnyStr</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pose</span><span class="p">:</span> <span class="n"><span title="symdesign.structure.model.Pose">Pose</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pose_source</span><span class="p">:</span> <span class="n"><span title="symdesign.resources.sql.DesignData">DesignData</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><a class="autorefs autorefs-internal" title="protocols.pose.PoseDirectory" href="#protocols.pose.PoseDirectory">PoseDirectory</a></code>, <code><span title="symdesign.resources.sql.PoseMetadata">PoseMetadata</span></code></p>

  



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>name</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The identifier</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>project</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The project which this work belongs too</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>source_path</code></b>
            (<code><span title="typing.AnyStr">AnyStr</span></code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>If a path exists, where is structure files information stored?</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>protocol</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>If a protocol was used to generate this Pose, which protocol?</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>pose_source</code></b>
            (<code><span title="symdesign.resources.sql.DesignData">DesignData</span></code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>If this is a descendant of another Design, which one?</p>
        </div>
      </li>
  </ul>

                <details class="quote">
                  <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
                  <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">source_path</span><span class="p">:</span> <span class="n">AnyStr</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pose</span><span class="p">:</span> <span class="n">Pose</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pose_source</span><span class="p">:</span> <span class="n">sql</span><span class="o">.</span><span class="n">DesignData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="c1"># pose_transformation: Sequence[types.TransformationMapping] = None,</span>
             <span class="c1"># entity_metadata: list[sql.EntityData] = None,</span>
             <span class="c1"># entity_names: Sequence[str] = None,</span>
             <span class="c1"># specific_designs: Sequence[str] = None, directives: list[dict[int, str]] = None,</span>
             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct the instance</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The identifier</span>
<span class="sd">        project: The project which this work belongs too</span>
<span class="sd">        source_path: If a path exists, where is structure files information stored?</span>
<span class="sd">        protocol: If a protocol was used to generate this Pose, which protocol?</span>
<span class="sd">        pose_source: If this is a descendant of another Design, which one?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># PoseJob attributes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="n">source_path</span>

    <span class="c1"># Most __init__ code is called in __init_from_db__() according to sqlalchemy needs and DRY principles</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__init_from_db__</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">pose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># It should be saved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span> <span class="o">=</span> <span class="n">pose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_path</span>

    <span class="c1"># Save job variables to the state during initialization</span>
    <span class="n">sym_entry</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sym_entry&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sym_entry</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span> <span class="o">=</span> <span class="n">sym_entry</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_dimension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span><span class="o">.</span><span class="n">dimension</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The dimension of the SymEntry&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span><span class="o">.</span><span class="n">resulting_symmetry</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The resulting symmetry of the SymEntry&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry_specification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span><span class="o">.</span><span class="n">specification</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The specification string of the SymEntry&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span><span class="o">.</span><span class="n">number</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The SymEntry entry number&quot;&quot;&quot;</span>

    <span class="c1"># Set up original DesignData entry for the pose baseline</span>
    <span class="k">if</span> <span class="n">pose_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pose_source</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">DesignData</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">pose</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">design_parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># , structure_path=source_path)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pose_source</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">DesignData</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">pose</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">design_parent</span><span class="o">=</span><span class="n">pose_source</span><span class="p">,</span>
                                     <span class="n">structure_path</span><span class="o">=</span><span class="n">pose_source</span><span class="o">.</span><span class="n">structure_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">protocol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pose_source</span><span class="o">.</span><span class="n">protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">DesignProtocol</span><span class="p">(</span><span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
                </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.initial_pose" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">initial_pose</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">initial_pose</span><span class="p">:</span> <span class="n"><span title="symdesign.structure.model.Pose">Pose</span></span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Used if the structure has never been initialized previously</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.pose" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">pose</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">pose</span><span class="p">:</span> <span class="n"><span title="symdesign.structure.model.Pose">Pose</span></span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Contains the Pose object</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.protocol" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">protocol</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">protocol</span><span class="p">:</span> <span class="n">str</span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>The name of the currently utilized protocol for file naming and metric results</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.symmetry_dimension" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">symmetry_dimension</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">symmetry_dimension</span> <span class="o">=</span> <span class="n"><span title="self.sym_entry.dimension">dimension</span></span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>The dimension of the SymEntry</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.symmetry" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">symmetry</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">symmetry</span> <span class="o">=</span> <span class="n"><span title="self.sym_entry.resulting_symmetry">resulting_symmetry</span></span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>The resulting symmetry of the SymEntry</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.sym_entry_specification" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">sym_entry_specification</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">sym_entry_specification</span> <span class="o">=</span> <span class="n"><span title="self.sym_entry.specification">specification</span></span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>The specification string of the SymEntry</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.sym_entry_number" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">sym_entry_number</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">sym_entry_number</span> <span class="o">=</span> <span class="n"><span title="self.sym_entry.number">number</span></span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>The SymEntry entry number</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.new_pose_identifier" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">new_pose_identifier</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">new_pose_identifier</span><span class="p">:</span> <span class="n">str</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Return the pose_identifier when the PoseData isn't part of the database</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.directives" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">directives</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">directives</span><span class="p">:</span> <span class="n">list</span><span class="p">[</span><span class="n">dict</span><span class="p">[</span><span class="n">int</span><span class="p">,</span> <span class="n">str</span><span class="p">]]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>The design directives given to each design in current_designs to guide further sampling</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.current_designs" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">current_designs</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">current_designs</span><span class="p">:</span> <span class="n">list</span><span class="p">[</span><span class="n"><span title="symdesign.resources.sql.DesignData">DesignData</span></span><span class="p">]</span> <span class="o">|</span> <span class="n">list</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>DesignData instances which were generated in the scope of this job and serve as a pool for additional work</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.structure_source" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">structure_source</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">structure_source</span><span class="p">:</span> <span class="n"><span title="typing.AnyStr">AnyStr</span></span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Return the source of the Pose structural information for the PoseJob</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.sym_entry" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">sym_entry</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">sym_entry</span><span class="p">:</span> <span class="n"><span title="symdesign.utils.SymEntry.SymEntry">SymEntry</span></span> <span class="o">|</span> <span class="kc">None</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>The SymEntry</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.job_kwargs" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">job_kwargs</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">job_kwargs</span><span class="p">:</span> <span class="n">dict</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Returns the keyword args that initialize the Pose given program input and PoseJob state</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.pose_kwargs" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">pose_kwargs</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">pose_kwargs</span><span class="p">:</span> <span class="n">dict</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="n"><span title="typing.Any">Any</span></span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Returns the keyword args that initialize the Pose given program input and PoseJob state</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.design_selector" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">design_selector</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">design_selector</span><span class="p">:</span> <span class="n"><span title="symdesign.structure.model.PoseSpecification">PoseSpecification</span></span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Provide the design_selector parameters for the design in question</p>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
            <code><span title="symdesign.structure.model.PoseSpecification">PoseSpecification</span></code>
        
        <div class="doc-md-description">
          <p>A mapping of the selection criteria for StructureBase objects in the Pose</p>
      </div>
      </li>
  </ul>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.refined" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">refined</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">refined</span><span class="p">:</span> <span class="n">bool</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Provide the state attribute regarding the source files status as "previously refined"</p>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
            <code>bool</code>
        
        <div class="doc-md-description">
          <p>Whether refinement has occurred</p>
      </div>
      </li>
  </ul>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="protocols.pose.PoseData.loop_modeled" class="doc doc-heading">
          <span class="doc doc-object-name doc-attribute-name">loop_modeled</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">loop_modeled</span><span class="p">:</span> <span class="n">bool</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Provide the state attribute regarding the source files status as "previously loop modeled"</p>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
            <code>bool</code>
        
        <div class="doc-md-description">
          <p>Whether loop modeling has occurred</p>
      </div>
      </li>
  </ul>
  </div>

</div>




<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.from_path" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">from_path</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">from_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">str</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Load the PoseJob from a path with file types or a directory</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>path</code></b>
            (<code>str</code>)
        
        <div class="doc-md-description">
          <p>The path where the PoseJob instance should load structural data</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>project</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The project where the file should be included</p>
        </div>
      </li>
  </ul>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
        
        <div class="doc-md-description">
          <p>The PoseJob instance</p>
      </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the PoseJob from a path with file types or a directory</span>

<span class="sd">    Args:</span>
<span class="sd">        path: The path where the PoseJob instance should load structural data</span>
<span class="sd">        project: The project where the file should be included</span>

<span class="sd">    Returns:</span>
<span class="sd">        The PoseJob instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The specified </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; wasn&#39;t found&quot;</span><span class="p">)</span>
    <span class="n">filename</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="c1"># if &#39;pdb&#39; in extension or &#39;cif&#39; in extension:  # Initialize from input file</span>
    <span class="k">if</span> <span class="n">extension</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># Initialize from input file</span>
        <span class="n">project_path</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">remainder</span><span class="p">,</span> <span class="n">project</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">project</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t get the project from the path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;. Please provide &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;project name with </span><span class="si">{</span><span class="n">flags</span><span class="o">.</span><span class="n">format_args</span><span class="p">(</span><span class="n">flags</span><span class="o">.</span><span class="n">project_name_args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span> <span class="n">source_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="c1"># Same as from_directory. This is an existing pose_identifier that hasn&#39;t been initialized</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># Only got 1 value during unpacking... This isn&#39;t a &quot;pose_directory&quot; identifier</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t coerce </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> to a </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">. The directory must contain the &quot;</span>
                <span class="sa">f</span><span class="s1">&#39;&quot;project</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s1">pose_name&quot; string&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> couldn&#39;t load the specified source path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.from_file" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">from_file</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">from_file</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="n">str</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Load the PoseJob from a structural file including .pdb/.cif file types</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>file</code></b>
            (<code>str</code>)
        
        <div class="doc-md-description">
          <p>The file where the PoseJob instance should load structure files</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>project</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The project where the file should be included</p>
        </div>
      </li>
  </ul>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
        
        <div class="doc-md-description">
          <p>The PoseJob instance</p>
      </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the PoseJob from a structural file including .pdb/.cif file types</span>

<span class="sd">    Args:</span>
<span class="sd">        file: The file where the PoseJob instance should load structure files</span>
<span class="sd">        project: The project where the file should be included</span>

<span class="sd">    Returns:</span>
<span class="sd">        The PoseJob instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># file = os.path.abspath(file)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The specified </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> structure source file &#39;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&#39; wasn&#39;t found!&quot;</span><span class="p">)</span>
    <span class="n">filename</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="c1"># if &#39;pdb&#39; in extension or &#39;cif&#39; in extension:  # Initialize from input file</span>
    <span class="k">if</span> <span class="n">extension</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># Initialize from input file</span>
        <span class="n">project_path</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="c1"># elif os.path.isdir(design_path):  # This is a pose_name that hasn&#39;t been initialized</span>
    <span class="c1">#     file = None</span>
    <span class="c1">#     # self.project_path = os.path.dirname(design_path)</span>
    <span class="c1">#     # self.project = os.path.basename(self.project_path)</span>
    <span class="c1">#     # self.pose_identifier = f&#39;{self.project}{os.sep}{self.name}&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> couldn&#39;t load the specified source file &#39;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># if self.job.nanohedra_outputV1:</span>
    <span class="c1">#     # path/to/design_symmetry/building_blocks/degen/rot/tx</span>
    <span class="c1">#     # path_components[-4] are the oligomeric (building_blocks) names</span>
    <span class="c1">#     name = &#39;-&#39;.join(path_components[-4:])</span>
    <span class="c1">#     project = path_components[-5]  # if root is None else root</span>
    <span class="c1">#     file = os.path.join(file, putils.asu)</span>

    <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">remainder</span><span class="p">,</span> <span class="n">project</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">project</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t get the project from the path &#39;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&#39;. Please provide &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;project name with </span><span class="si">{</span><span class="n">flags</span><span class="o">.</span><span class="n">format_args</span><span class="p">(</span><span class="n">flags</span><span class="o">.</span><span class="n">project_name_args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span> <span class="n">source_path</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.from_directory" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">from_directory</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">from_directory</span><span class="p">(</span><span class="n">source_path</span><span class="p">:</span> <span class="n">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Assumes the PoseJob is constructed from the pose_name (project/pose_name) and job.projects</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>source_path</code></b>
            (<code>str</code>)
        
        <div class="doc-md-description">
          <p>The path to the directory where PoseJob information is stored</p>
        </div>
      </li>
  </ul>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
        
        <div class="doc-md-description">
          <p>The PoseJob instance</p>
      </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_directory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Assumes the PoseJob is constructed from the pose_name (project/pose_name) and job.projects</span>

<span class="sd">    Args:</span>
<span class="sd">        source_path: The path to the directory where PoseJob information is stored</span>

<span class="sd">    Returns:</span>
<span class="sd">        The PoseJob instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">source_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># Only got 1 value during unpacking... This isn&#39;t a &quot;pose_directory&quot; identifier</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t coerce </span><span class="si">{</span><span class="n">source_path</span><span class="si">}</span><span class="s2"> to a </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">. The directory must contain the &quot;</span>
            <span class="sa">f</span><span class="s1">&#39;&quot;project</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s1">pose_name&quot; string&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.from_name" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">from_name</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">from_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Load the PoseJob from the name and project</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>name</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The name to identify this PoseJob</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>project</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The project where the file should be included</p>
        </div>
      </li>
  </ul>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
        
        <div class="doc-md-description">
          <p>The PoseJob instance</p>
      </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the PoseJob from the name and project</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The name to identify this PoseJob</span>
<span class="sd">        project: The project where the file should be included</span>

<span class="sd">    Returns:</span>
<span class="sd">        The PoseJob instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.from_pose_identifier" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">from_pose_identifier</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">from_pose_identifier</span><span class="p">(</span><span class="n">pose_identifier</span><span class="p">:</span> <span class="n">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Load the PoseJob from the name and project</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>pose_identifier</code></b>
            (<code>str</code>)
        
        <div class="doc-md-description">
          <p>The project and the name concatenated that identify this PoseJob</p>
        </div>
      </li>
  </ul>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
        
        <div class="doc-md-description">
          <p>The PoseJob instance</p>
      </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_pose_identifier</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pose_identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the PoseJob from the name and project</span>

<span class="sd">    Args:</span>
<span class="sd">        pose_identifier: The project and the name concatenated that identify this PoseJob</span>

<span class="sd">    Returns:</span>
<span class="sd">        The PoseJob instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">project</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">pose_identifier</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># We don&#39;t have a pose_identifier</span>
        <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t coerce </span><span class="si">{</span><span class="n">pose_identifier</span><span class="si">}</span><span class="s2"> to &#39;project&#39; </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s2"> &#39;name&#39;. Please ensure the &quot;</span>
            <span class="sa">f</span><span class="s1">&#39;pose_identifier is passed with the &quot;project</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s1">name&quot; string&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.from_pose" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">from_pose</span>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">from_pose</span><span class="p">(</span><span class="n">pose</span><span class="p">:</span> <span class="n"><span title="symdesign.structure.model.Pose">Pose</span></span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Load the PoseJob from an existing Pose</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>pose</code></b>
            (<code><span title="symdesign.structure.model.Pose">Pose</span></code>)
        
        <div class="doc-md-description">
          <p>The Pose to initialize the PoseJob with</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>project</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The project where the file should be included</p>
        </div>
      </li>
  </ul>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
        
        <div class="doc-md-description">
          <p>The PoseJob instance</p>
      </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_pose</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pose</span><span class="p">:</span> <span class="n">Pose</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the PoseJob from an existing Pose</span>

<span class="sd">    Args:</span>
<span class="sd">        pose: The Pose to initialize the PoseJob with</span>
<span class="sd">        project: The project where the file should be included</span>

<span class="sd">    Returns:</span>
<span class="sd">        The PoseJob instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pose</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span> <span class="n">pose</span><span class="o">=</span><span class="n">pose</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.__init_from_db__" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">__init_from_db__</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">__init_from_db__</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Initialize PoseData after the instance is "initialized", i.e. loaded from the database</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@reconstructor</span>
<span class="k">def</span> <span class="nf">__init_from_db__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize PoseData after the instance is &quot;initialized&quot;, i.e. loaded from the database&quot;&quot;&quot;</span>
    <span class="c1"># Design attributes</span>
    <span class="c1"># self.current_designs = []</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">measure_evolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_alignment</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Get the main program options</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">job</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">job_resources_factory</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="c1"># Symmetry attributes</span>
    <span class="c1"># If a new sym_entry is provided it wouldn&#39;t be saved to the state but could be attempted to be used</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">sym_entry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">sym_entry</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design_selector</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">design_selector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design_selector</span>

    <span class="c1"># self.specific_designs_file_paths = []</span>
    <span class="c1"># &quot;&quot;&quot;Contains the various file paths for each design of interest according to self.specific_designs&quot;&quot;&quot;</span>

    <span class="c1"># These arguments are for PoseDirectory</span>
    <span class="c1"># directory = os.path.join(self.job.projects, self.project, self.name)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">root_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">projects</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># Todo **kwargs)</span>

    <span class="n">putils</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_directory</span><span class="p">)</span>  <span class="c1"># , condition=self.job.construct_pose)</span>

    <span class="c1"># Initialize the logger for the PoseJob</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
        <span class="n">log_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Defaults to stdout, debug is level 1</span>
        <span class="c1"># Don&#39;t propagate, emit ourselves</span>
        <span class="n">propagate</span> <span class="o">=</span> <span class="n">no_log_name</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_path</span><span class="p">:</span>
        <span class="n">log_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_path</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># To a file</span>
        <span class="n">propagate</span> <span class="o">=</span> <span class="n">no_log_name</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Log to the __main__ file logger</span>
        <span class="n">log_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># To a file</span>
        <span class="n">propagate</span> <span class="o">=</span> <span class="n">no_log_name</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">skip_logging</span><span class="p">:</span>  <span class="c1"># Set up null_logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;null&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">start_log</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;pose.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">handler</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">,</span>
                             <span class="n">location</span><span class="o">=</span><span class="n">log_path</span><span class="p">,</span> <span class="n">no_log_name</span><span class="o">=</span><span class="n">no_log_name</span><span class="p">,</span> <span class="n">propagate</span><span class="o">=</span><span class="n">propagate</span><span class="p">)</span>
        <span class="c1"># propagate=True allows self.log to pass messages to &#39;pose&#39; and &#39;project&#39; logger</span>

    <span class="c1"># Configure standard pose loading mechanism with self.source_path</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pose_file</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">asu_path</span><span class="p">):</span>  <span class="c1"># Standard mechanism of loading the pose</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asu_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.clear_state" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">clear_state</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">clear_state</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Set the current instance structural and sequence attributes to None to remove excess memory</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">clear_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the current instance structural and sequence attributes to None to remove excess memory&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">measure_evolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_alignment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.use_specific_designs" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">use_specific_designs</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">use_specific_designs</span><span class="p">(</span><span class="n">designs</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">directives</span><span class="p">:</span> <span class="n">list</span><span class="p">[</span><span class="n">dict</span><span class="p">[</span><span class="n">int</span><span class="p">,</span> <span class="n">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Set up the instance with the names and instructions to perform further sequence design</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>designs</code></b>
            (<code><span title="collections.abc.Sequence">Sequence</span>[str]</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The names of designs which to include in modules that support PoseJob designs</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>directives</code></b>
            (<code>list[dict[int, str]]</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>Instructions to guide further sampling of designs</p>
        </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">use_specific_designs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">designs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">directives</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up the instance with the names and instructions to perform further sequence design</span>

<span class="sd">    Args:</span>
<span class="sd">        designs: The names of designs which to include in modules that support PoseJob designs</span>
<span class="sd">        directives: Instructions to guide further sampling of designs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">designs</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_designs</span> <span class="o">=</span> <span class="n">designs</span>

    <span class="k">if</span> <span class="n">directives</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directives</span> <span class="o">=</span> <span class="n">directives</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.load_initial_pose" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">load_initial_pose</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">load_initial_pose</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Loads the Pose at the source_path attribute</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_initial_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the Pose at the source_path attribute&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">load_initial_pose</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">() for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> as there isn&#39;t a file specified&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_path</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.is_symmetric" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">is_symmetric</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">is_symmetric</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">bool</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Is the PoseJob symmetric?</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_symmetric</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Is the PoseJob symmetric?&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.get_designs_without_structure" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">get_designs_without_structure</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">get_designs_without_structure</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="p">[</span><span class="n"><span title="symdesign.resources.sql.DesignData">DesignData</span></span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>For each design, access whether there is a structure that exists for it. If not, return the design</p>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
            <code>list[<span title="symdesign.resources.sql.DesignData">DesignData</span>]</code>
        
        <div class="doc-md-description">
          <p>Each instance of the DesignData that is missing a structure</p>
      </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_designs_without_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">sql</span><span class="o">.</span><span class="n">DesignData</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For each design, access whether there is a structure that exists for it. If not, return the design</span>

<span class="sd">    Returns:</span>
<span class="sd">        Each instance of the DesignData that is missing a structure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">design</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">designs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>  <span class="c1"># Slice only real designs, not the pose_source</span>
        <span class="k">if</span> <span class="n">design</span><span class="o">.</span><span class="n">structure_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">design</span><span class="o">.</span><span class="n">structure_path</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">design</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">missing</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.transform_entities_to_pose" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">transform_entities_to_pose</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">transform_entities_to_pose</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="p">[</span><span class="n"><span title="symdesign.structure.model.Entity">Entity</span></span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Take the set of entities involved in a pose composition and transform them from a standard reference frame to
the Pose reference frame using the pose_transformation attribute</p>



  <p>Other Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>refined</code></b>
        
        <div class="doc-md-description">
          <p>bool = True - Whether to use refined models from the StructureDatabase</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>oriented</code></b>
        
        <div class="doc-md-description">
          <p>bool = False - Whether to use oriented models from the StructureDatabase</p>
        </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span>
<span class="normal">988</span>
<span class="normal">989</span>
<span class="normal">990</span>
<span class="normal">991</span>
<span class="normal">992</span>
<span class="normal">993</span>
<span class="normal">994</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">transform_entities_to_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Entity</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Take the set of entities involved in a pose composition and transform them from a standard reference frame to</span>
<span class="sd">    the Pose reference frame using the pose_transformation attribute</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        refined: bool = True - Whether to use refined models from the StructureDatabase</span>
<span class="sd">        oriented: bool = False - Whether to use oriented models from the StructureDatabase</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_entities</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformations</span><span class="p">:</span>
        <span class="n">entities</span> <span class="o">=</span> <span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">get_transformed_copy</span><span class="p">(</span><span class="o">**</span><span class="n">transformation</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">transformation</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformations</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Entities were transformed to the found docking parameters&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Todo change below to handle asymmetric cases...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">missing_pose_transformation</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">entities</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.transform_structures_to_pose" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">transform_structures_to_pose</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">transform_structures_to_pose</span><span class="p">(</span><span class="n">structures</span><span class="p">:</span> <span class="n"><span title="collections.abc.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><span title="symdesign.structure.base.StructureBase">StructureBase</span></span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="p">[</span><span class="n"><span title="symdesign.structure.base.StructureBase">StructureBase</span></span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Take a set of ContainsResidues instances and transform them from a standard reference frame to the Pose reference
frame using the pose_transformation attribute</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>structures</code></b>
            (<code><span title="collections.abc.Iterable">Iterable</span>[<span title="symdesign.structure.base.StructureBase">StructureBase</span>]</code>)
        
        <div class="doc-md-description">
          <p>The ContainsResidues instances to transform</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    The transformed ContainsResidues instances if a transformation was possible</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">transform_structures_to_pose</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">structures</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">StructureBase</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">StructureBase</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Take a set of ContainsResidues instances and transform them from a standard reference frame to the Pose reference</span>
<span class="sd">    frame using the pose_transformation attribute</span>

<span class="sd">    Args:</span>
<span class="sd">        structures: The ContainsResidues instances to transform</span>
<span class="sd">    Returns:</span>
<span class="sd">        The transformed ContainsResidues instances if a transformation was possible</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformations</span><span class="p">:</span>
        <span class="c1"># Todo</span>
        <span class="c1">#  Assumes a 1:1 correspondence between structures and transforms (component group numbers) CHANGE</span>
        <span class="n">structures</span> <span class="o">=</span> <span class="p">[</span><span class="n">structure</span><span class="o">.</span><span class="n">get_transformed_copy</span><span class="p">(</span><span class="o">**</span><span class="n">transformation</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">structure</span><span class="p">,</span> <span class="n">transformation</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">structures</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformations</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Structures were transformed to the found docking parameters&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">missing_pose_transformation</span><span class="p">)</span>
        <span class="n">structures</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">structures</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">structures</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.get_entities" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">get_entities</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">get_entities</span><span class="p">(</span><span class="n">refined</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">oriented</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="p">[</span><span class="n"><span title="symdesign.structure.model.Entity">Entity</span></span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Retrieve Entity files from the design Database using either the oriented directory, or the refined directory.
If these don't exist, use the Pose directory, and load them into job for further processing</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>refined</code></b>
            (<code>bool</code>, default:
                <code>True</code>
)
        
        <div class="doc-md-description">
          <p>Whether to use the refined directory</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>oriented</code></b>
            (<code>bool</code>, default:
                <code>False</code>
)
        
        <div class="doc-md-description">
          <p>Whether to use the oriented directory</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    The list of Entity instances that belong to this PoseData</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_entities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refined</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">oriented</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Entity</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve Entity files from the design Database using either the oriented directory, or the refined directory.</span>
<span class="sd">    If these don&#39;t exist, use the Pose directory, and load them into job for further processing</span>

<span class="sd">    Args:</span>
<span class="sd">        refined: Whether to use the refined directory</span>
<span class="sd">        oriented: Whether to use the oriented directory</span>
<span class="sd">    Returns:</span>
<span class="sd">        The list of Entity instances that belong to this PoseData</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Todo change to rely on EntityData</span>
    <span class="n">source_preference</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;refined&#39;</span><span class="p">,</span> <span class="s1">&#39;oriented_asu&#39;</span><span class="p">,</span> <span class="s1">&#39;design&#39;</span><span class="p">]</span>
    <span class="c1"># Todo once loop_model works &#39;full_models&#39;</span>

    <span class="k">if</span> <span class="n">refined</span><span class="p">:</span>
        <span class="n">source_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">oriented</span><span class="p">:</span>
        <span class="n">source_idx</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">source_idx</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Falling back on Entity instances present in the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> structure_source&#39;</span><span class="p">)</span>

    <span class="n">entities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity_data</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span>
        <span class="n">source_preference_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">source_preference</span><span class="p">)</span>
        <span class="c1"># Discard however many sources are unwanted (source_idx number)</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">source_idx</span><span class="p">):</span>
            <span class="n">_</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">source_preference_iter</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">model</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">source_preference_iter</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SymDesignException</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_entities</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: Couldn&#39;t locate the required files&quot;</span><span class="p">)</span>
            <span class="n">source_datastore</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">structure_db</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># Todo this course of action isn&#39;t set up anymore. It should be depreciated...</span>
            <span class="k">if</span> <span class="n">source_datastore</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Try to get file from the PoseDirectory</span>
                <span class="k">raise</span> <span class="n">SymDesignException</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t locate the specified Entity &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; from any Database sources&quot;</span><span class="p">)</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">source_datastore</span><span class="o">.</span><span class="n">retrieve_data</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="c1">#  Error where the EntityID loaded from 2gtr_1.pdb was 2gtr_1_1</span>
            <span class="c1">#  Below might help resolve this issue</span>
            <span class="c1"># model_file = source_datastore.retrieve_file(name=name)</span>
            <span class="c1"># if model_file:</span>
            <span class="c1">#     model = Entity.from_file(model_file)</span>
            <span class="c1"># else:</span>
            <span class="c1">#     model = None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">Structure</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found Entity at </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1"> DataStore and loaded into job&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t locate the Entity </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> at the Database source &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">source_datastore</span><span class="o">.</span><span class="n">location</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="n">entities</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">entity</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">entities</span><span class="p">])</span>
    <span class="c1"># Todo is this useful or is the ProteinMetadata already set elsewhere?</span>
    <span class="c1"># if source_idx == 0:</span>
    <span class="c1">#     self.refined = True</span>
    <span class="c1"># if source_idx == 0:</span>
    <span class="c1">#     self.loop_modeled = True</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity_data</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">SymDesignException</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Expected </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">entities</span><span class="p">)</span><span class="si">}</span><span class="s1"> entities, but found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity_data</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">entities</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.report_exception" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">report_exception</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">report_exception</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Reports error traceback to the log file.</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>context</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>A string describing the function or situation where the error occurred.</p>
        </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">report_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reports error traceback to the log file.</span>

<span class="sd">    Args:</span>
<span class="sd">        context: A string describing the function or situation where the error occurred.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="s1"> resulted in the exception:</span><span class="se">\n\n</span><span class="s1">&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.format_see_log_msg" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">format_see_log_msg</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">format_see_log_msg</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">str</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Issue a standard informational message indicating the location of further error information</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">format_see_log_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Issue a standard informational message indicating the location of further error information&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;See the log &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log_path</span><span class="si">}</span><span class="s2">&#39; for further information&quot;</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.load_pose" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">load_pose</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">load_pose</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">entities</span><span class="p">:</span> <span class="n">list</span><span class="p">[</span><span class="n"><span title="symdesign.structure.model.Structure">Structure</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>For the design info given by a PoseJob source, initialize the Pose with self.source_path file,
self.symmetry, self.job, self.fragment_database, and self.log objects</p>
<p>Handles Pose clash testing, writing the Pose, adding state variables to the pose</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>file</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The file path to a structure_source file</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>entities</code></b>
            (<code>list[<span title="symdesign.structure.model.Structure">Structure</span>]</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The Entities desired in the Pose</p>
        </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">entities</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Structure</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For the design info given by a PoseJob source, initialize the Pose with self.source_path file,</span>
<span class="sd">    self.symmetry, self.job, self.fragment_database, and self.log objects</span>

<span class="sd">    Handles Pose clash testing, writing the Pose, adding state variables to the pose</span>

<span class="sd">    Args:</span>
<span class="sd">        file: The file path to a structure_source file</span>
<span class="sd">        entities: The Entities desired in the Pose</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check to see if Pose is already loaded and nothing new provided</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span> <span class="ow">and</span> <span class="n">file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">entities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">entities</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structure_source</span> <span class="o">=</span> <span class="s1">&#39;Protocol derived&#39;</span>
            <span class="c1"># Use the entities as provided</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_path</span><span class="p">):</span>
            <span class="c1"># In case a design was initialized without a file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No &#39;.source_path&#39; found. Fetching structure_source from &quot;</span>
                          <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">structure_db</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> and transforming to Pose&#39;</span><span class="p">)</span>
            <span class="c1"># Minimize I/O with transform...</span>
            <span class="c1"># Must add the instance to a session to load any self.transformations present</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">entities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform_entities_to_pose</span><span class="p">()</span>
            <span class="c1"># Todo should use the ProteinMetadata version if the constituent Entity coordinates aren&#39;t modified by</span>
            <span class="c1">#  some small amount as this will ensure that files are refined and that loops are included...</span>
            <span class="c1"># Collect the EntityTransform for these regardless of symmetry since the file will be coming from the</span>
            <span class="c1"># oriented/origin position...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structure_source</span> <span class="o">=</span> <span class="s1">&#39;Database&#39;</span>

        <span class="c1"># Initialize the Pose using provided PDB numbering so that design_selectors are respected</span>
        <span class="k">if</span> <span class="n">entities</span><span class="p">:</span>
            <span class="c1"># Chains should be renamed if the chain_id&#39;s are the same</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">({</span><span class="n">entity</span><span class="o">.</span><span class="n">chain_id</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">})</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entities</span><span class="p">):</span>
                <span class="n">rename</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rename</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="o">.</span><span class="n">from_entities</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rename_chains</span><span class="o">=</span><span class="n">rename</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">job_kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span><span class="p">:</span>
            <span class="c1"># This is a fresh Model that was already loaded so reuse</span>
            <span class="c1"># Careful, if processing has occurred to the initial_pose, then this may be wrong!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="o">.</span><span class="n">from_structure</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">entity_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span><span class="o">.</span><span class="n">entity_info</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">job_kwargs</span><span class="p">)</span>
            <span class="c1"># Use entity_info from already parsed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structure_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structure_source</span> <span class="o">=</span> <span class="n">file</span> <span class="k">if</span> <span class="n">file</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure_source</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_selector</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">apply_design_selector</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">design_selector</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">is_clash</span><span class="p">(</span><span class="n">measure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">clash_criteria</span><span class="p">,</span>
                               <span class="n">distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">clash_distance</span><span class="p">,</span>
                               <span class="n">warn</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">ignore_clashes</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ClashError</span><span class="p">:</span>  <span class="c1"># as error:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">ignore_pose_clashes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report_exception</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s1">&#39;Clash checking&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The Pose from &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">structure_source</span><span class="si">}</span><span class="s2">&#39; contains clashes. &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">format_see_log_msg</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Todo get the message from error and raise a ClashError(</span>
                <span class="c1">#      f&#39;{message}. If you would like to proceed regardless, re-submit the job with &#39;</span>
                <span class="c1">#      f&#39;{flags.format_args(flags.ignore_pose_clashes_args)}&#39;</span>
                <span class="k">raise</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">is_symmetric</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">symmetric_assembly_is_clash</span><span class="p">(</span><span class="n">measure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">clash_criteria</span><span class="p">,</span>
                                                     <span class="n">distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">clash_distance</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">ignore_symmetric_clashes</span><span class="p">:</span>
                    <span class="c1"># self.format_error_for_log()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;The Pose symmetric assembly from &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">structure_source</span><span class="si">}</span><span class="s2">&#39; contains clashes.&quot;</span><span class="p">)</span>
                    <span class="c1">#     f&quot;{self.format_see_log_msg()}&quot;)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ClashError</span><span class="p">(</span>
                        <span class="s2">&quot;The symmetric assembly contains clashes and won&#39;t be considered. If you &quot;</span>
                        <span class="s1">&#39;would like to proceed regardless, re-submit the job with &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">flags</span><span class="o">.</span><span class="n">format_args</span><span class="p">(</span><span class="n">flags</span><span class="o">.</span><span class="n">ignore_symmetric_clashes_args</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># If there is an empty list for the transformations, save the transformations identified from the Pose</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">any_database_transformations</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformations</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">DetachedInstanceError</span><span class="p">:</span>
                <span class="n">any_database_transformations</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">any_database_transformations</span><span class="p">:</span>
                <span class="c1"># Add the transformation data to the database</span>
                <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">transformation</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entity_transformations</span><span class="p">):</span>
                    <span class="c1"># Make an empty EntityTransform</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">EntityTransform</span><span class="p">()</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">transformation</span> <span class="o">=</span> <span class="n">transformation</span>
                <span class="c1"># Ensure this information is persistent</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_db</span><span class="p">()</span>

    <span class="c1"># Save the Pose asu</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_path</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">overwrite</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">load_to_db</span><span class="p">:</span>
        <span class="c1"># Set the pose_path as the source_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="n">out_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_path</span>
        <span class="c1"># # Propagate to the PoseJob parent DesignData</span>
        <span class="c1"># self.source_path = out_path = self.pose_source.structure_path = self.pose_path</span>
        <span class="c1"># Ensure this information is persistent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_db</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Explicitly set None and write anything else requested by input options</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_pose</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="n">out_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.output_pose" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">output_pose</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">output_pose</span><span class="p">(</span><span class="n">out_path</span><span class="p">:</span> <span class="n"><span title="typing.AnyStr">AnyStr</span></span> <span class="o">=</span> <span class="s1">&#39;POSE&#39;</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Save a new Structure from multiple Chain or Entity objects including the Pose symmetry</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>out_path</code></b>
            (<code><span title="typing.AnyStr">AnyStr</span></code>, default:
                <code>&#39;POSE&#39;</code>
)
        
        <div class="doc-md-description">
          <p>The path to save the self.pose.
All other outputs are done to the self.pose_directory or self.output_path</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>force</code></b>
            (<code>bool</code>, default:
                <code>False</code>
)
        
        <div class="doc-md-description">
          <p>Whether to force writing of the pose</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    None</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">output_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_path</span><span class="p">:</span> <span class="n">AnyStr</span> <span class="o">=</span> <span class="s1">&#39;POSE&#39;</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save a new Structure from multiple Chain or Entity objects including the Pose symmetry</span>

<span class="sd">    Args:</span>
<span class="sd">        out_path: The path to save the self.pose.</span>
<span class="sd">            All other outputs are done to the self.pose_directory or self.output_path</span>
<span class="sd">        force: Whether to force writing of the pose</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># if self.job.pose_format:</span>
    <span class="c1">#     self.pose.pose_numbering()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">fuse_chains</span><span class="p">:</span>
        <span class="c1"># try:</span>
        <span class="k">for</span> <span class="n">fusion_nterm</span><span class="p">,</span> <span class="n">fusion_cterm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">fuse_chains</span><span class="p">:</span>
            <span class="c1"># rename_success = False</span>
            <span class="n">new_success</span><span class="p">,</span> <span class="n">same_success</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">chain_id</span> <span class="o">==</span> <span class="n">fusion_cterm</span><span class="p">:</span>
                    <span class="n">entity_new_chain_idx</span> <span class="o">=</span> <span class="n">idx</span>
                    <span class="n">new_success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">chain_id</span> <span class="o">==</span> <span class="n">fusion_nterm</span><span class="p">:</span>
                    <span class="c1"># entity_same_chain_idx = idx</span>
                    <span class="n">same_success</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># rename_success = True</span>
                    <span class="c1"># break</span>
            <span class="c1"># if not rename_success:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_success</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">same_success</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DesignError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Your requested fusion of chain &#39;</span><span class="si">{</span><span class="n">fusion_nterm</span><span class="si">}</span><span class="s2">&#39; with chain &#39;</span><span class="si">{</span><span class="n">fusion_cterm</span><span class="si">}</span><span class="s2">&#39; didn&#39;t work&quot;</span><span class="p">)</span>
                <span class="c1"># self.log.critical(&#39;Your requested fusion of chain %s with chain %s didn\&#39;t work!&#39; %</span>
                <span class="c1">#                   (fusion_nterm, fusion_cterm))</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Won&#39;t be accessed unless entity_new_chain_idx is set</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">[</span><span class="n">entity_new_chain_idx</span><span class="p">]</span><span class="o">.</span><span class="n">chain_id</span> <span class="o">=</span> <span class="n">fusion_nterm</span>
        <span class="c1"># except AttributeError:</span>
        <span class="c1">#     raise ValueError(&#39;One or both of the chain IDs %s were not found in the input model. Possible chain&#39;</span>
        <span class="c1">#                      &#39; ID\&#39;s are %s&#39; % ((fusion_nterm, fusion_cterm), &#39;,&#39;.join(new_asu.chain_ids)))</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">is_symmetric</span><span class="p">():</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">output_assembly</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">output_to_directory</span><span class="p">:</span>
                <span class="n">assembly_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_assembly_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">assembly_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembly_path</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">assembly_path</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">assembly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">out_path</span><span class="o">=</span><span class="n">assembly_path</span><span class="p">,</span>
                                <span class="n">increment_chains</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">increment_chains</span><span class="p">,</span>
                                <span class="n">surrounding_uc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">output_surrounding_uc</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Symmetric assembly written to: &#39;</span><span class="si">{</span><span class="n">assembly_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">output_oligomers</span><span class="p">:</span>  <span class="c1"># Write out Entity.assembly instances to the PoseJob</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">output_to_directory</span><span class="p">:</span>
                    <span class="n">oligomer_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_oligomer.pdb&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">oligomer_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_directory</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_oligomer.pdb&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">oligomer_path</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
                    <span class="n">entity</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">assembly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">out_path</span><span class="o">=</span><span class="n">oligomer_path</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entity </span><span class="si">{</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> oligomer written to: &#39;</span><span class="si">{</span><span class="n">oligomer_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">output_entities</span><span class="p">:</span>  <span class="c1"># Write out Entity instances to the PoseJob</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">output_to_directory</span><span class="p">:</span>
                <span class="n">entity_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_entity_.pdb&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">entity_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_directory</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_entity.pdb&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">entity_path</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
                <span class="n">entity</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="n">entity_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entity </span><span class="si">{</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> written to: &#39;</span><span class="si">{</span><span class="n">entity_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">output_fragments</span><span class="p">:</span>
        <span class="c1"># if not self.pose.fragment_pairs:</span>
        <span class="c1">#     self.pose.generate_interface_fragments()</span>
        <span class="n">putils</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frags_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">output_trajectory</span><span class="p">:</span>
            <span class="c1"># Write all fragments as one trajectory</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span><span class="o">.</span><span class="n">unit_cell</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No unit cell dimensions applicable to the Fragment trajectory file&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">write_fragment_pairs</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frags_path</span><span class="p">,</span> <span class="n">multimodel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">output_trajectory</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">output_interface</span><span class="p">:</span>
        <span class="n">interface_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">get_interface</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">output_to_directory</span><span class="p">:</span>
            <span class="n">interface_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_interface.pdb&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interface_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_directory</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_interface.pdb&#39;</span><span class="p">)</span>
        <span class="n">interface_structure</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="n">interface_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">out_path</span> <span class="o">==</span> <span class="s1">&#39;POSE&#39;</span><span class="p">:</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_path</span>

    <span class="k">if</span> <span class="n">out_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">overwrite</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="n">out_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote Pose file to: &#39;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">output_to_directory</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_pose_path</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">overwrite</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">out_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_pose_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="n">out_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wrote Pose file to: &#39;</span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.set_up_evolutionary_profile" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">set_up_evolutionary_profile</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">set_up_evolutionary_profile</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Add evolutionary profile information for each Entity to the Pose</p>



  <p>Other Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>warn_metrics</code></b>
        
        <div class="doc-md-description">
          <p>Whether to warn the user about missing files for metric collection</p>
        </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">set_up_evolutionary_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add evolutionary profile information for each Entity to the Pose</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        warn_metrics: Whether to warn the user about missing files for metric collection</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">use_evolution</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_evolution</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_alignment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">measure_evolution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_alignment</span> <span class="o">=</span> \
                <span class="n">load_evolutionary_profile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">api_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseData.generate_fragments" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">generate_fragments</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">generate_fragments</span><span class="p">(</span><span class="n">interface</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">oligomeric_interfaces</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">entities</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>For the design info given by a PoseJob source, initialize the Pose then generate interfacial fragment
information between Entities. Aware of symmetry and design_selectors in fragment generation file</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>interface</code></b>
            (<code>bool</code>, default:
                <code>False</code>
)
        
        <div class="doc-md-description">
          <p>Whether to perform fragment generation on the interface</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>oligomeric_interfaces</code></b>
            (<code>bool</code>, default:
                <code>False</code>
)
        
        <div class="doc-md-description">
          <p>Whether to perform fragment generation on the oligomeric interface</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>entities</code></b>
            (<code>bool</code>, default:
                <code>False</code>
)
        
        <div class="doc-md-description">
          <p>Whether to perform fragment generation on each Entity</p>
        </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">generate_fragments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">oligomeric_interfaces</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">entities</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For the design info given by a PoseJob source, initialize the Pose then generate interfacial fragment</span>
<span class="sd">    information between Entities. Aware of symmetry and design_selectors in fragment generation file</span>

<span class="sd">    Args:</span>
<span class="sd">        interface: Whether to perform fragment generation on the interface</span>
<span class="sd">        oligomeric_interfaces: Whether to perform fragment generation on the oligomeric interface</span>
<span class="sd">        entities: Whether to perform fragment generation on each Entity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">interface</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">generate_interface_fragments</span><span class="p">(</span><span class="n">oligomeric_interfaces</span><span class="o">=</span><span class="n">oligomeric_interfaces</span><span class="p">,</span>
                                               <span class="n">distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">interface_distance</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">entities</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">generate_fragments</span><span class="p">(</span><span class="n">oligomeric_interfaces</span><span class="o">=</span><span class="n">oligomeric_interfaces</span><span class="p">,</span>
                                     <span class="n">distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">interface_distance</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">output_fragments</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_pose</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>


</div>

<div class="doc doc-object doc-class">



<h2 id="protocols.pose.PoseProtocol" class="doc doc-heading">
          <span class="doc doc-object-name doc-class-name">PoseProtocol</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">PoseProtocol</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">source_path</span><span class="p">:</span> <span class="n"><span title="typing.AnyStr">AnyStr</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pose</span><span class="p">:</span> <span class="n"><span title="symdesign.structure.model.Pose">Pose</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pose_source</span><span class="p">:</span> <span class="n"><span title="symdesign.resources.sql.DesignData">DesignData</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><a class="autorefs autorefs-internal" title="protocols.pose.PoseData" href="#protocols.pose.PoseData">PoseData</a></code></p>

  



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>name</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The identifier</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>project</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The project which this work belongs too</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>source_path</code></b>
            (<code><span title="typing.AnyStr">AnyStr</span></code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>If a path exists, where is structure files information stored?</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>protocol</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>If a protocol was used to generate this Pose, which protocol?</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>pose_source</code></b>
            (<code><span title="symdesign.resources.sql.DesignData">DesignData</span></code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>If this is a descendant of another Design, which one?</p>
        </div>
      </li>
  </ul>

                <details class="quote">
                  <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
                  <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">source_path</span><span class="p">:</span> <span class="n">AnyStr</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pose</span><span class="p">:</span> <span class="n">Pose</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pose_source</span><span class="p">:</span> <span class="n">sql</span><span class="o">.</span><span class="n">DesignData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="c1"># pose_transformation: Sequence[types.TransformationMapping] = None,</span>
             <span class="c1"># entity_metadata: list[sql.EntityData] = None,</span>
             <span class="c1"># entity_names: Sequence[str] = None,</span>
             <span class="c1"># specific_designs: Sequence[str] = None, directives: list[dict[int, str]] = None,</span>
             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct the instance</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The identifier</span>
<span class="sd">        project: The project which this work belongs too</span>
<span class="sd">        source_path: If a path exists, where is structure files information stored?</span>
<span class="sd">        protocol: If a protocol was used to generate this Pose, which protocol?</span>
<span class="sd">        pose_source: If this is a descendant of another Design, which one?</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># PoseJob attributes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="n">source_path</span>

    <span class="c1"># Most __init__ code is called in __init_from_db__() according to sqlalchemy needs and DRY principles</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__init_from_db__</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">pose</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># It should be saved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span> <span class="o">=</span> <span class="n">pose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_path</span>

    <span class="c1"># Save job variables to the state during initialization</span>
    <span class="n">sym_entry</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sym_entry&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sym_entry</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span> <span class="o">=</span> <span class="n">sym_entry</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_dimension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span><span class="o">.</span><span class="n">dimension</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The dimension of the SymEntry&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span><span class="o">.</span><span class="n">resulting_symmetry</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The resulting symmetry of the SymEntry&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry_specification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span><span class="o">.</span><span class="n">specification</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The specification string of the SymEntry&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span><span class="o">.</span><span class="n">number</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The SymEntry entry number&quot;&quot;&quot;</span>

    <span class="c1"># Set up original DesignData entry for the pose baseline</span>
    <span class="k">if</span> <span class="n">pose_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pose_source</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">DesignData</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">pose</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">design_parent</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># , structure_path=source_path)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pose_source</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">DesignData</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">pose</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">design_parent</span><span class="o">=</span><span class="n">pose_source</span><span class="p">,</span>
                                     <span class="n">structure_path</span><span class="o">=</span><span class="n">pose_source</span><span class="o">.</span><span class="n">structure_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">protocol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pose_source</span><span class="o">.</span><span class="n">protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">DesignProtocol</span><span class="p">(</span><span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
                </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.identify_interface" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">identify_interface</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">identify_interface</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Find the interface(s) between each Entity in the Pose. Handles symmetric clash testing, writing the assembly</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">identify_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the interface(s) between each Entity in the Pose. Handles symmetric clash testing, writing the assembly</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">load_pose</span><span class="p">()</span>
    <span class="c1"># Measure the interface by_distance if the pose is the result of known docking inputs and</span>
    <span class="c1"># the associated sequence is non-sense</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">find_and_split_interface</span><span class="p">(</span><span class="n">by_distance</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">putils</span><span class="o">.</span><span class="n">nanohedra</span>
                                                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">putils</span><span class="o">.</span><span class="n">fragment_docking</span><span class="p">),</span>
                                       <span class="n">distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">interface_distance</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.orient" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">orient</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">orient</span><span class="p">(</span><span class="n">to_pose_directory</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Orient the Pose with the prescribed symmetry at the origin and symmetry axes in canonical orientations
job.symmetry is used to specify the orientation</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>to_pose_directory</code></b>
            (<code>bool</code>, default:
                <code>True</code>
)
        
        <div class="doc-md-description">
          <p>Whether to write the file to the pose_directory or to another source</p>
        </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">orient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_pose_directory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Orient the Pose with the prescribed symmetry at the origin and symmetry axes in canonical orientations</span>
<span class="sd">    job.symmetry is used to specify the orientation</span>

<span class="sd">    Args:</span>
<span class="sd">        to_pose_directory: Whether to write the file to the pose_directory or to another source</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_initial_pose</span><span class="p">()</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span><span class="p">:</span>
        <span class="c1"># This may raise an error if symmetry is malformed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span><span class="o">.</span><span class="n">orient</span><span class="p">(</span><span class="n">symmetry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetry</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">to_pose_directory</span><span class="p">:</span>
            <span class="n">out_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembly_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">putils</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">orient_dir</span><span class="p">)</span>
            <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">orient_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.pdb&#39;</span><span class="p">)</span>

        <span class="n">orient_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="n">out_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The oriented file was saved to </span><span class="si">{</span><span class="n">orient_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># Now that symmetry is set, just set the pose attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_pose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_pose</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SymmetryError</span><span class="p">(</span>
            <span class="n">warn_missing_symmetry</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">orient</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.prepare_rosetta_flags" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">prepare_rosetta_flags</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">prepare_rosetta_flags</span><span class="p">(</span><span class="n">symmetry_protocol</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sym_def_file</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pdb_out_path</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">:</span> <span class="n"><span title="typing.AnyStr">AnyStr</span></span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="n">str</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Prepare a protocol specific Rosetta flags file with program specific variables</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>symmetry_protocol</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The type of symmetric protocol (specifying design dimension) to use for Rosetta jobs</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>sym_def_file</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>A Rosetta specific file specifying the symmetry system</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>pdb_out_path</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>Disk location to write the resulting design files</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>out_dir</code></b>
            (<code><span title="typing.AnyStr">AnyStr</span></code>, default:
                <code><span title="os.getcwd">getcwd</span>()</code>
)
        
        <div class="doc-md-description">
          <p>Disk location to write the flags file</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    Disk location of the flags file</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">prepare_rosetta_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symmetry_protocol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sym_def_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pdb_out_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="n">out_dir</span><span class="p">:</span> <span class="n">AnyStr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare a protocol specific Rosetta flags file with program specific variables</span>

<span class="sd">    Args:</span>
<span class="sd">        symmetry_protocol: The type of symmetric protocol (specifying design dimension) to use for Rosetta jobs</span>
<span class="sd">        sym_def_file: A Rosetta specific file specifying the symmetry system</span>
<span class="sd">        pdb_out_path: Disk location to write the resulting design files</span>
<span class="sd">        out_dir: Disk location to write the flags file</span>
<span class="sd">    Returns:</span>
<span class="sd">        Disk location of the flags file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># flag_variables (list(tuple)): The variable value pairs to be filed in the RosettaScripts XML</span>
    <span class="c1"># Relies on PoseDirecotry attributes</span>
    <span class="c1"># .designs_path</span>
    <span class="c1"># .refined_pdb</span>
    <span class="c1"># .scores_file</span>
    <span class="c1"># .design_profile_file</span>
    <span class="c1"># .fragment_profile_file</span>
    <span class="n">number_of_residues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_residues</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total number of residues in Pose: </span><span class="si">{</span><span class="n">number_of_residues</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Get ASU distance parameters</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_dimension</span><span class="p">:</span>  <span class="c1"># Check for None and dimension 0 simultaneously</span>
        <span class="c1"># The furthest point from the ASU COM + the max individual Entity radius</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">radius</span> <span class="o">+</span> <span class="nb">max</span><span class="p">([</span><span class="n">entity</span><span class="o">.</span><span class="n">radius</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">])</span>  <span class="c1"># all the radii</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Expanding ASU into symmetry group by </span><span class="si">{</span><span class="n">distance</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> Angstroms&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">evolution_constraint</span><span class="p">:</span>
        <span class="n">constraint_percent</span><span class="p">,</span> <span class="n">free_percent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">constraint_percent</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">free_percent</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">constraint_percent</span>

    <span class="n">variables</span> <span class="o">=</span> <span class="n">rosetta</span><span class="o">.</span><span class="n">variables</span> \
        <span class="o">+</span> <span class="p">[(</span><span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="n">distance</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;repack&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">),</span>
           <span class="p">(</span><span class="s1">&#39;constrained_percent&#39;</span><span class="p">,</span> <span class="n">constraint_percent</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;free_percent&#39;</span><span class="p">,</span> <span class="n">free_percent</span><span class="p">)]</span>
    <span class="n">variables</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">putils</span><span class="o">.</span><span class="n">design_profile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_profile_file</span><span class="p">)]</span>
                     <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">design_profile_file</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span>
    <span class="n">variables</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">putils</span><span class="o">.</span><span class="n">fragment_profile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragment_profile_file</span><span class="p">)]</span>
                     <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragment_profile_file</span><span class="p">)</span> <span class="k">else</span> <span class="p">[])</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">is_symmetric</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">symmetry_protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">symmetry_protocols</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;make_point_group&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;make_layer&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;make_lattice&#39;</span><span class="p">,</span>
                                  <span class="kc">None</span><span class="p">:</span> <span class="s1">&#39;asymmetric&#39;</span><span class="p">}</span>  <span class="c1"># -1: &#39;asymmetric&#39;</span>
            <span class="n">symmetry_protocol</span> <span class="o">=</span> <span class="n">symmetry_protocols</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetry_dimension</span><span class="p">]</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;symmetry&#39;</span><span class="p">,</span> <span class="n">symmetry_protocol</span><span class="p">))</span>
        <span class="c1"># The current self.sym_entry can still be None if requested for this particular job</span>
        <span class="k">if</span> <span class="n">sym_def_file</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sym_def_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span><span class="o">.</span><span class="n">sdf_lookup</span><span class="p">()</span>
            <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;sdf&#39;</span><span class="p">,</span> <span class="n">sym_def_file</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Symmetry Option: </span><span class="si">{</span><span class="n">symmetry_protocol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">out_of_bounds_residue</span> <span class="o">=</span> <span class="n">number_of_residues</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_symmetry_mates</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">symmetry_protocol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;symmetry&#39;</span><span class="p">,</span> <span class="n">symmetry_protocol</span><span class="p">))</span>
        <span class="n">out_of_bounds_residue</span> <span class="o">=</span> <span class="n">number_of_residues</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">interface_residue_ids</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">number</span><span class="p">,</span> <span class="n">residues</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">interface_residues_by_interface</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">interface_residue_ids</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;interface</span><span class="si">{</span><span class="n">number</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">residue</span><span class="o">.</span><span class="n">number</span><span class="si">}{</span><span class="n">residue</span><span class="o">.</span><span class="n">chain_id</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">)</span>
    <span class="c1"># self.info[&#39;interface_residue_ids&#39;] = self.interface_residue_ids</span>
    <span class="n">variables</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">interface</span><span class="p">,</span> <span class="n">residues</span><span class="p">)</span> <span class="k">if</span> <span class="n">residues</span> <span class="k">else</span> <span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">out_of_bounds_residue</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">interface</span><span class="p">,</span> <span class="n">residues</span> <span class="ow">in</span> <span class="n">interface_residue_ids</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

    <span class="c1"># Assign any additional designable residues</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">required_residues</span><span class="p">:</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[(</span><span class="s1">&#39;required_residues&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">number</span><span class="si">}{</span><span class="n">res</span><span class="o">.</span><span class="n">chain_id</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">required_residues</span><span class="p">))])</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Get an out-of-bounds index</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="s1">&#39;required_residues&#39;</span><span class="p">,</span> <span class="n">out_of_bounds_residue</span><span class="p">)])</span>

    <span class="c1"># Allocate any &quot;core&quot; residues based on central fragment information</span>
    <span class="n">residues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">residues</span>
    <span class="n">fragment_residues</span> <span class="o">=</span> <span class="p">[</span><span class="n">residues</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">interface_fragment_residue_indices</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fragment_residues</span><span class="p">:</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="s1">&#39;fragment_residues&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">number</span><span class="si">}{</span><span class="n">res</span><span class="o">.</span><span class="n">chain_id</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">fragment_residues</span><span class="p">]))])</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Get an out-of-bounds index</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="s1">&#39;fragment_residues&#39;</span><span class="p">,</span> <span class="n">out_of_bounds_residue</span><span class="p">)])</span>
    <span class="n">core_residues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">core_residues</span>
    <span class="k">if</span> <span class="n">core_residues</span><span class="p">:</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="s1">&#39;core_residues&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">number</span><span class="si">}{</span><span class="n">res</span><span class="o">.</span><span class="n">chain_id</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">core_residues</span><span class="p">]))])</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Get an out-of-bounds index</span>
        <span class="n">variables</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="s1">&#39;core_residues&#39;</span><span class="p">,</span> <span class="n">out_of_bounds_residue</span><span class="p">)])</span>

    <span class="n">rosetta_flags</span> <span class="o">=</span> <span class="n">rosetta</span><span class="o">.</span><span class="n">flags</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">pdb_out_path</span><span class="p">:</span>
        <span class="n">rosetta_flags</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;-out:path:pdb </span><span class="si">{</span><span class="n">pdb_out_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;-scorefile </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scores_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rosetta_flags</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;-out:path:pdb </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;-scorefile </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scores_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
    <span class="n">rosetta_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-in:file:native </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">refined_pdb</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">rosetta_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;-parser:script_vars </span><span class="si">{</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">var</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">variables</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">putils</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;flags&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rosetta_flags</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Rosetta flags written to: </span><span class="si">{</span><span class="n">out_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out_file</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.generate_entity_metrics_commands" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">generate_entity_metrics_commands</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">generate_entity_metrics_commands</span><span class="p">(</span><span class="n">base_command</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="p">[</span><span class="n">list</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Use the Pose state to generate metrics commands for each Entity instance</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>base_command</code></b>
        
        <div class="doc-md-description">
          <p>The base command to build Entity metric commands off of</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    The formatted command for every Entity in the Pose</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">generate_entity_metrics_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_command</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use the Pose state to generate metrics commands for each Entity instance</span>

<span class="sd">    Args:</span>
<span class="sd">        base_command: The base command to build Entity metric commands off of</span>
<span class="sd">    Returns:</span>
<span class="sd">        The formatted command for every Entity in the Pose</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># self.entity_names not dependent on Pose load</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># There is no unbound state to query as only one entity</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symmetry_definition_files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity_data</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
        <span class="n">putils</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">is_symmetric</span><span class="p">():</span>  <span class="c1"># Make symmetric energy in line with SymDesign energies v</span>
                <span class="n">entity</span><span class="o">.</span><span class="n">make_sdf</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span>
                                <span class="n">modify_sym_energy_for_cryst</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sym_entry</span><span class="o">.</span><span class="n">dimension</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Todo monitor if Rosetta energy modifier changed from 2x for crystal set up and adjust accordingly</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">putils</span><span class="o">.</span><span class="n">symmetry_def_files</span><span class="p">,</span> <span class="s1">&#39;C1.sym&#39;</span><span class="p">),</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.sdf&#39;</span><span class="p">))</span>

    <span class="n">entity_metric_commands</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_symmetric</span><span class="p">():</span>
            <span class="n">entity_sdf</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;sdf=</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.sdf&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">entity_sym</span> <span class="o">=</span> <span class="s1">&#39;symmetry=make_point_group&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">entity_sdf</span><span class="p">,</span> <span class="n">entity_sym</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;symmetry=asymmetric&#39;</span>
        <span class="n">metric_cmd</span> <span class="o">=</span> <span class="n">base_command</span> \
            <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;-parser:script_vars&#39;</span><span class="p">,</span> <span class="s1">&#39;repack=yes&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;entity=</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">entity_sym</span><span class="p">]</span> \
            <span class="o">+</span> <span class="p">([</span><span class="n">entity_sdf</span><span class="p">]</span> <span class="k">if</span> <span class="n">entity_sdf</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Metrics command for Entity </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">list2cmdline</span><span class="p">(</span><span class="n">metric_cmd</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">entity_metric_commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric_cmd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">entity_metric_commands</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.get_cmd_process_rosetta_metrics" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">get_cmd_process_rosetta_metrics</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">get_cmd_process_rosetta_metrics</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="p">[</span><span class="n">list</span><span class="p">[</span><span class="n">str</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Generate a list of commands compatible with subprocess.Popen()/subprocess.list2cmdline() to run
process-rosetta-metrics</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_cmd_process_rosetta_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a list of commands compatible with subprocess.Popen()/subprocess.list2cmdline() to run</span>
<span class="sd">    process-rosetta-metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="o">*</span><span class="n">putils</span><span class="o">.</span><span class="n">program_command_tuple</span><span class="p">,</span> <span class="n">flags</span><span class="o">.</span><span class="n">process_rosetta_metrics</span><span class="p">,</span> <span class="s1">&#39;--single&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_directory</span><span class="p">]</span> \
        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">parsed_arguments</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.thread_sequences_to_backbone" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">thread_sequences_to_backbone</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">thread_sequences_to_backbone</span><span class="p">(</span><span class="n">sequences</span><span class="p">:</span> <span class="n">dict</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>From the starting Pose, thread sequences onto the backbone, modifying relevant side chains i.e., mutate the
Pose and build/pack using Rosetta FastRelax. If no sequences are provided, will use self.designed_sequences</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>sequences</code></b>
            (<code>dict[str, str]</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>A mapping of sequence alias to its sequence. These will be used for producing outputs and as
the input sequence</p>
        </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span>
<span class="normal">1617</span>
<span class="normal">1618</span>
<span class="normal">1619</span>
<span class="normal">1620</span>
<span class="normal">1621</span>
<span class="normal">1622</span>
<span class="normal">1623</span>
<span class="normal">1624</span>
<span class="normal">1625</span>
<span class="normal">1626</span>
<span class="normal">1627</span>
<span class="normal">1628</span>
<span class="normal">1629</span>
<span class="normal">1630</span>
<span class="normal">1631</span>
<span class="normal">1632</span>
<span class="normal">1633</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">thread_sequences_to_backbone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequences</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;From the starting Pose, thread sequences onto the backbone, modifying relevant side chains i.e., mutate the</span>
<span class="sd">    Pose and build/pack using Rosetta FastRelax. If no sequences are provided, will use self.designed_sequences</span>

<span class="sd">    Args:</span>
<span class="sd">        sequences: A mapping of sequence alias to its sequence. These will be used for producing outputs and as</span>
<span class="sd">            the input sequence</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sequences</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Gather all already designed sequences</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Must pass sequences to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_sequences_to_backbone</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Todo, this doesn&#39;t work!</span>
        <span class="c1"># refine_sequences = unpickle(self.designed_sequences_file)</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="p">{</span><span class="n">seq</span><span class="p">:</span> <span class="n">seq</span><span class="o">.</span><span class="n">seq</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">read_fasta_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">designed_sequences_file</span><span class="p">)}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">load_pose</span><span class="p">()</span>
    <span class="c1"># Write each &quot;threaded&quot; structure out for further processing</span>
    <span class="n">number_of_residues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_residues</span>
    <span class="c1"># Ensure that mutations to the Pose aren&#39;t saved to state</span>
    <span class="n">pose_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">design_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sequence_id</span><span class="p">,</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">sequences</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="o">!=</span> <span class="n">number_of_residues</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DesignError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;The length of the sequence, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span><span class="si">}</span><span class="s1"> != </span><span class="si">{</span><span class="n">number_of_residues</span><span class="si">}</span><span class="s1">, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;the number of residues in the pose&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">res_idx</span><span class="p">,</span> <span class="n">residue_type</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
            <span class="n">pose_copy</span><span class="o">.</span><span class="n">mutate_residue</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">res_idx</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">residue_type</span><span class="p">)</span>
        <span class="c1"># pre_threaded_file = os.path.join(self.data_path, f&#39;{self.name}_{self.protocol}{seq_idx:04d}.pdb&#39;)</span>
        <span class="n">pre_threaded_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sequence_id</span><span class="si">}</span><span class="s1">.pdb&#39;</span><span class="p">)</span>
        <span class="n">design_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pose_copy</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="n">pre_threaded_file</span><span class="p">))</span>

    <span class="n">putils</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scripts_path</span><span class="p">)</span>
    <span class="n">design_files_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scripts_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">starttime</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s1">_files.txt&#39;</span><span class="p">)</span>

    <span class="c1"># # Modify each sequence score to reflect the new &quot;decoy&quot; name</span>
    <span class="c1"># # Todo update as a consequence of new SQL</span>
    <span class="c1"># sequence_ids = sequences.keys()</span>
    <span class="c1"># design_scores = metrics.parse_rosetta_scores(self.scores_file)</span>
    <span class="c1"># for design, scores in design_scores.items():</span>
    <span class="c1">#     if design in sequence_ids:</span>
    <span class="c1">#         # We previously saved data. Copy to the identifier that is present after threading</span>
    <span class="c1">#         scores[&#39;decoy&#39;] = f&#39;{design}_{self.protocol}&#39;</span>
    <span class="c1">#         # write_json(_scores, self.scores_file)</span>
    <span class="c1">#         with open(self.scores_file, &#39;a&#39;) as f_save:</span>
    <span class="c1">#             json.dump(scores, f_save)  # , **kwargs)</span>
    <span class="c1">#             # Ensure JSON lines are separated by newline</span>
    <span class="c1">#             f_save.write(&#39;\n&#39;)</span>

    <span class="k">if</span> <span class="n">design_files</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">design_files_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">design_files</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DesignError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_sequences_to_backbone</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">: No designed sequences were located&#39;</span><span class="p">)</span>

    <span class="c1"># self.refine(in_file_list=design_files_file)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="n">design_files</span><span class="o">=</span><span class="n">design_files</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.predict_structure" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">predict_structure</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">predict_structure</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Perform structure prediction on the .current_designs. If there are no .current_designs, will use any
design that is missing a structure file. Additionally, add the Pose sequence to the prediction by using the
job.predict.pose flag</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1638</span>
<span class="normal">1639</span>
<span class="normal">1640</span>
<span class="normal">1641</span>
<span class="normal">1642</span>
<span class="normal">1643</span>
<span class="normal">1644</span>
<span class="normal">1645</span>
<span class="normal">1646</span>
<span class="normal">1647</span>
<span class="normal">1648</span>
<span class="normal">1649</span>
<span class="normal">1650</span>
<span class="normal">1651</span>
<span class="normal">1652</span>
<span class="normal">1653</span>
<span class="normal">1654</span>
<span class="normal">1655</span>
<span class="normal">1656</span>
<span class="normal">1657</span>
<span class="normal">1658</span>
<span class="normal">1659</span>
<span class="normal">1660</span>
<span class="normal">1661</span>
<span class="normal">1662</span>
<span class="normal">1663</span>
<span class="normal">1664</span>
<span class="normal">1665</span>
<span class="normal">1666</span>
<span class="normal">1667</span>
<span class="normal">1668</span>
<span class="normal">1669</span>
<span class="normal">1670</span>
<span class="normal">1671</span>
<span class="normal">1672</span>
<span class="normal">1673</span>
<span class="normal">1674</span>
<span class="normal">1675</span>
<span class="normal">1676</span>
<span class="normal">1677</span>
<span class="normal">1678</span>
<span class="normal">1679</span>
<span class="normal">1680</span>
<span class="normal">1681</span>
<span class="normal">1682</span>
<span class="normal">1683</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">predict_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform structure prediction on the .current_designs. If there are no .current_designs, will use any</span>
<span class="sd">    design that is missing a structure file. Additionally, add the Pose sequence to the prediction by using the</span>
<span class="sd">    job.predict.pose flag</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_designs</span><span class="p">:</span>
            <span class="n">sequences</span> <span class="o">=</span> <span class="p">{</span><span class="n">design</span><span class="p">:</span> <span class="n">design</span><span class="o">.</span><span class="n">sequence</span> <span class="k">for</span> <span class="n">design</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_designs</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sequences</span> <span class="o">=</span> <span class="p">{</span><span class="n">design</span><span class="p">:</span> <span class="n">design</span><span class="o">.</span><span class="n">sequence</span> <span class="k">for</span> <span class="n">design</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_designs_without_structure</span><span class="p">()}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_designs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sequences</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">pose</span><span class="p">:</span>
            <span class="c1"># self.pose_source is loaded in above session through get_designs_without_structure()</span>
            <span class="n">pose_sequence</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_source</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_source</span><span class="o">.</span><span class="n">sequence</span><span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_source</span><span class="o">.</span><span class="n">structure_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sequences</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">pose_sequence</span><span class="p">,</span> <span class="o">**</span><span class="n">sequences</span><span class="p">}</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
                <span class="n">sequences</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">pose_sequence</span><span class="p">,</span> <span class="o">**</span><span class="n">sequences</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The flag --</span><span class="si">{</span><span class="n">flags</span><span class="o">.</span><span class="n">format_args</span><span class="p">(</span><span class="n">flags</span><span class="o">.</span><span class="n">predict_pose_args</span><span class="p">)</span><span class="si">}</span><span class="s2"> was specified, but the &quot;</span>
                               <span class="s2">&quot;pose has already been predicted. If you meant to overwrite this pose, explicitly &quot;</span>
                               <span class="s2">&quot;pass --overwrite&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sequences</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DesignError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t find any sequences to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_structure</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># match self.job.predict.method:  # Todo python 3.10</span>
    <span class="c1">#     case &#39;thread&#39;:</span>
    <span class="c1">#         self.thread_sequences_to_backbone(sequences)</span>
    <span class="c1">#     case &#39;alphafold&#39;:</span>
    <span class="c1">#         # Sequences use within alphafold requires .fasta...</span>
    <span class="c1">#         self.alphafold_predict_structure(sequences)</span>
    <span class="c1">#     case _:</span>
    <span class="c1">#         raise NotImplementedError(f&quot;For {self.predict_structure.__name__}, the method &#39;</span>
    <span class="c1">#                                   f&quot;{self.job.predict.method} isn&#39;t implemented yet&quot;)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">method</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;thread&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_sequences_to_backbone</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;alphafold&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alphafold_predict_structure</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;For </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">predict_structure</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">, the method </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> isn&#39;t implemented yet&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.alphafold_predict_structure" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">alphafold_predict_structure</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">alphafold_predict_structure</span><span class="p">(</span><span class="n">sequences</span><span class="p">:</span> <span class="n">dict</span><span class="p">[</span><span class="n"><span title="symdesign.resources.sql.DesignData">DesignData</span></span><span class="p">,</span> <span class="n">str</span><span class="p">],</span> <span class="n">model_type</span><span class="p">:</span> <span class="n"><span title="symdesign.resources.ml.af_model_literal">af_model_literal</span></span> <span class="o">=</span> <span class="s1">&#39;monomer&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Use Alphafold to predict structures for sequences of interest. The sequences will be fit to the Pose
parameters, however will have sequence features unique to that sequence. By default, no multiple sequence
alignment will be used and the AlphafoldInitialGuess model will be used wherein the starting coordinates for
the Pose will be supplied as the initial guess</p>
<p>According to Deepmind Alphafold.ipynb (2/3/23), the usage of multimer with &gt; 3000 residues isn't validated.
while a memory requirement of 4000 is the theoretical limit. I think it depends on the available memory
Args:
    sequences: The mapping for DesignData to sequence
    model_type: The type of Alphafold model to use. Choose from 'monomer', 'monomer_casp14', 'monomer_ptm',
        or 'multimer'
Returns:
    None</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1685</span>
<span class="normal">1686</span>
<span class="normal">1687</span>
<span class="normal">1688</span>
<span class="normal">1689</span>
<span class="normal">1690</span>
<span class="normal">1691</span>
<span class="normal">1692</span>
<span class="normal">1693</span>
<span class="normal">1694</span>
<span class="normal">1695</span>
<span class="normal">1696</span>
<span class="normal">1697</span>
<span class="normal">1698</span>
<span class="normal">1699</span>
<span class="normal">1700</span>
<span class="normal">1701</span>
<span class="normal">1702</span>
<span class="normal">1703</span>
<span class="normal">1704</span>
<span class="normal">1705</span>
<span class="normal">1706</span>
<span class="normal">1707</span>
<span class="normal">1708</span>
<span class="normal">1709</span>
<span class="normal">1710</span>
<span class="normal">1711</span>
<span class="normal">1712</span>
<span class="normal">1713</span>
<span class="normal">1714</span>
<span class="normal">1715</span>
<span class="normal">1716</span>
<span class="normal">1717</span>
<span class="normal">1718</span>
<span class="normal">1719</span>
<span class="normal">1720</span>
<span class="normal">1721</span>
<span class="normal">1722</span>
<span class="normal">1723</span>
<span class="normal">1724</span>
<span class="normal">1725</span>
<span class="normal">1726</span>
<span class="normal">1727</span>
<span class="normal">1728</span>
<span class="normal">1729</span>
<span class="normal">1730</span>
<span class="normal">1731</span>
<span class="normal">1732</span>
<span class="normal">1733</span>
<span class="normal">1734</span>
<span class="normal">1735</span>
<span class="normal">1736</span>
<span class="normal">1737</span>
<span class="normal">1738</span>
<span class="normal">1739</span>
<span class="normal">1740</span>
<span class="normal">1741</span>
<span class="normal">1742</span>
<span class="normal">1743</span>
<span class="normal">1744</span>
<span class="normal">1745</span>
<span class="normal">1746</span>
<span class="normal">1747</span>
<span class="normal">1748</span>
<span class="normal">1749</span>
<span class="normal">1750</span>
<span class="normal">1751</span>
<span class="normal">1752</span>
<span class="normal">1753</span>
<span class="normal">1754</span>
<span class="normal">1755</span>
<span class="normal">1756</span>
<span class="normal">1757</span>
<span class="normal">1758</span>
<span class="normal">1759</span>
<span class="normal">1760</span>
<span class="normal">1761</span>
<span class="normal">1762</span>
<span class="normal">1763</span>
<span class="normal">1764</span>
<span class="normal">1765</span>
<span class="normal">1766</span>
<span class="normal">1767</span>
<span class="normal">1768</span>
<span class="normal">1769</span>
<span class="normal">1770</span>
<span class="normal">1771</span>
<span class="normal">1772</span>
<span class="normal">1773</span>
<span class="normal">1774</span>
<span class="normal">1775</span>
<span class="normal">1776</span>
<span class="normal">1777</span>
<span class="normal">1778</span>
<span class="normal">1779</span>
<span class="normal">1780</span>
<span class="normal">1781</span>
<span class="normal">1782</span>
<span class="normal">1783</span>
<span class="normal">1784</span>
<span class="normal">1785</span>
<span class="normal">1786</span>
<span class="normal">1787</span>
<span class="normal">1788</span>
<span class="normal">1789</span>
<span class="normal">1790</span>
<span class="normal">1791</span>
<span class="normal">1792</span>
<span class="normal">1793</span>
<span class="normal">1794</span>
<span class="normal">1795</span>
<span class="normal">1796</span>
<span class="normal">1797</span>
<span class="normal">1798</span>
<span class="normal">1799</span>
<span class="normal">1800</span>
<span class="normal">1801</span>
<span class="normal">1802</span>
<span class="normal">1803</span>
<span class="normal">1804</span>
<span class="normal">1805</span>
<span class="normal">1806</span>
<span class="normal">1807</span>
<span class="normal">1808</span>
<span class="normal">1809</span>
<span class="normal">1810</span>
<span class="normal">1811</span>
<span class="normal">1812</span>
<span class="normal">1813</span>
<span class="normal">1814</span>
<span class="normal">1815</span>
<span class="normal">1816</span>
<span class="normal">1817</span>
<span class="normal">1818</span>
<span class="normal">1819</span>
<span class="normal">1820</span>
<span class="normal">1821</span>
<span class="normal">1822</span>
<span class="normal">1823</span>
<span class="normal">1824</span>
<span class="normal">1825</span>
<span class="normal">1826</span>
<span class="normal">1827</span>
<span class="normal">1828</span>
<span class="normal">1829</span>
<span class="normal">1830</span>
<span class="normal">1831</span>
<span class="normal">1832</span>
<span class="normal">1833</span>
<span class="normal">1834</span>
<span class="normal">1835</span>
<span class="normal">1836</span>
<span class="normal">1837</span>
<span class="normal">1838</span>
<span class="normal">1839</span>
<span class="normal">1840</span>
<span class="normal">1841</span>
<span class="normal">1842</span>
<span class="normal">1843</span>
<span class="normal">1844</span>
<span class="normal">1845</span>
<span class="normal">1846</span>
<span class="normal">1847</span>
<span class="normal">1848</span>
<span class="normal">1849</span>
<span class="normal">1850</span>
<span class="normal">1851</span>
<span class="normal">1852</span>
<span class="normal">1853</span>
<span class="normal">1854</span>
<span class="normal">1855</span>
<span class="normal">1856</span>
<span class="normal">1857</span>
<span class="normal">1858</span>
<span class="normal">1859</span>
<span class="normal">1860</span>
<span class="normal">1861</span>
<span class="normal">1862</span>
<span class="normal">1863</span>
<span class="normal">1864</span>
<span class="normal">1865</span>
<span class="normal">1866</span>
<span class="normal">1867</span>
<span class="normal">1868</span>
<span class="normal">1869</span>
<span class="normal">1870</span>
<span class="normal">1871</span>
<span class="normal">1872</span>
<span class="normal">1873</span>
<span class="normal">1874</span>
<span class="normal">1875</span>
<span class="normal">1876</span>
<span class="normal">1877</span>
<span class="normal">1878</span>
<span class="normal">1879</span>
<span class="normal">1880</span>
<span class="normal">1881</span>
<span class="normal">1882</span>
<span class="normal">1883</span>
<span class="normal">1884</span>
<span class="normal">1885</span>
<span class="normal">1886</span>
<span class="normal">1887</span>
<span class="normal">1888</span>
<span class="normal">1889</span>
<span class="normal">1890</span>
<span class="normal">1891</span>
<span class="normal">1892</span>
<span class="normal">1893</span>
<span class="normal">1894</span>
<span class="normal">1895</span>
<span class="normal">1896</span>
<span class="normal">1897</span>
<span class="normal">1898</span>
<span class="normal">1899</span>
<span class="normal">1900</span>
<span class="normal">1901</span>
<span class="normal">1902</span>
<span class="normal">1903</span>
<span class="normal">1904</span>
<span class="normal">1905</span>
<span class="normal">1906</span>
<span class="normal">1907</span>
<span class="normal">1908</span>
<span class="normal">1909</span>
<span class="normal">1910</span>
<span class="normal">1911</span>
<span class="normal">1912</span>
<span class="normal">1913</span>
<span class="normal">1914</span>
<span class="normal">1915</span>
<span class="normal">1916</span>
<span class="normal">1917</span>
<span class="normal">1918</span>
<span class="normal">1919</span>
<span class="normal">1920</span>
<span class="normal">1921</span>
<span class="normal">1922</span>
<span class="normal">1923</span>
<span class="normal">1924</span>
<span class="normal">1925</span>
<span class="normal">1926</span>
<span class="normal">1927</span>
<span class="normal">1928</span>
<span class="normal">1929</span>
<span class="normal">1930</span>
<span class="normal">1931</span>
<span class="normal">1932</span>
<span class="normal">1933</span>
<span class="normal">1934</span>
<span class="normal">1935</span>
<span class="normal">1936</span>
<span class="normal">1937</span>
<span class="normal">1938</span>
<span class="normal">1939</span>
<span class="normal">1940</span>
<span class="normal">1941</span>
<span class="normal">1942</span>
<span class="normal">1943</span>
<span class="normal">1944</span>
<span class="normal">1945</span>
<span class="normal">1946</span>
<span class="normal">1947</span>
<span class="normal">1948</span>
<span class="normal">1949</span>
<span class="normal">1950</span>
<span class="normal">1951</span>
<span class="normal">1952</span>
<span class="normal">1953</span>
<span class="normal">1954</span>
<span class="normal">1955</span>
<span class="normal">1956</span>
<span class="normal">1957</span>
<span class="normal">1958</span>
<span class="normal">1959</span>
<span class="normal">1960</span>
<span class="normal">1961</span>
<span class="normal">1962</span>
<span class="normal">1963</span>
<span class="normal">1964</span>
<span class="normal">1965</span>
<span class="normal">1966</span>
<span class="normal">1967</span>
<span class="normal">1968</span>
<span class="normal">1969</span>
<span class="normal">1970</span>
<span class="normal">1971</span>
<span class="normal">1972</span>
<span class="normal">1973</span>
<span class="normal">1974</span>
<span class="normal">1975</span>
<span class="normal">1976</span>
<span class="normal">1977</span>
<span class="normal">1978</span>
<span class="normal">1979</span>
<span class="normal">1980</span>
<span class="normal">1981</span>
<span class="normal">1982</span>
<span class="normal">1983</span>
<span class="normal">1984</span>
<span class="normal">1985</span>
<span class="normal">1986</span>
<span class="normal">1987</span>
<span class="normal">1988</span>
<span class="normal">1989</span>
<span class="normal">1990</span>
<span class="normal">1991</span>
<span class="normal">1992</span>
<span class="normal">1993</span>
<span class="normal">1994</span>
<span class="normal">1995</span>
<span class="normal">1996</span>
<span class="normal">1997</span>
<span class="normal">1998</span>
<span class="normal">1999</span>
<span class="normal">2000</span>
<span class="normal">2001</span>
<span class="normal">2002</span>
<span class="normal">2003</span>
<span class="normal">2004</span>
<span class="normal">2005</span>
<span class="normal">2006</span>
<span class="normal">2007</span>
<span class="normal">2008</span>
<span class="normal">2009</span>
<span class="normal">2010</span>
<span class="normal">2011</span>
<span class="normal">2012</span>
<span class="normal">2013</span>
<span class="normal">2014</span>
<span class="normal">2015</span>
<span class="normal">2016</span>
<span class="normal">2017</span>
<span class="normal">2018</span>
<span class="normal">2019</span>
<span class="normal">2020</span>
<span class="normal">2021</span>
<span class="normal">2022</span>
<span class="normal">2023</span>
<span class="normal">2024</span>
<span class="normal">2025</span>
<span class="normal">2026</span>
<span class="normal">2027</span>
<span class="normal">2028</span>
<span class="normal">2029</span>
<span class="normal">2030</span>
<span class="normal">2031</span>
<span class="normal">2032</span>
<span class="normal">2033</span>
<span class="normal">2034</span>
<span class="normal">2035</span>
<span class="normal">2036</span>
<span class="normal">2037</span>
<span class="normal">2038</span>
<span class="normal">2039</span>
<span class="normal">2040</span>
<span class="normal">2041</span>
<span class="normal">2042</span>
<span class="normal">2043</span>
<span class="normal">2044</span>
<span class="normal">2045</span>
<span class="normal">2046</span>
<span class="normal">2047</span>
<span class="normal">2048</span>
<span class="normal">2049</span>
<span class="normal">2050</span>
<span class="normal">2051</span>
<span class="normal">2052</span>
<span class="normal">2053</span>
<span class="normal">2054</span>
<span class="normal">2055</span>
<span class="normal">2056</span>
<span class="normal">2057</span>
<span class="normal">2058</span>
<span class="normal">2059</span>
<span class="normal">2060</span>
<span class="normal">2061</span>
<span class="normal">2062</span>
<span class="normal">2063</span>
<span class="normal">2064</span>
<span class="normal">2065</span>
<span class="normal">2066</span>
<span class="normal">2067</span>
<span class="normal">2068</span>
<span class="normal">2069</span>
<span class="normal">2070</span>
<span class="normal">2071</span>
<span class="normal">2072</span>
<span class="normal">2073</span>
<span class="normal">2074</span>
<span class="normal">2075</span>
<span class="normal">2076</span>
<span class="normal">2077</span>
<span class="normal">2078</span>
<span class="normal">2079</span>
<span class="normal">2080</span>
<span class="normal">2081</span>
<span class="normal">2082</span>
<span class="normal">2083</span>
<span class="normal">2084</span>
<span class="normal">2085</span>
<span class="normal">2086</span>
<span class="normal">2087</span>
<span class="normal">2088</span>
<span class="normal">2089</span>
<span class="normal">2090</span>
<span class="normal">2091</span>
<span class="normal">2092</span>
<span class="normal">2093</span>
<span class="normal">2094</span>
<span class="normal">2095</span>
<span class="normal">2096</span>
<span class="normal">2097</span>
<span class="normal">2098</span>
<span class="normal">2099</span>
<span class="normal">2100</span>
<span class="normal">2101</span>
<span class="normal">2102</span>
<span class="normal">2103</span>
<span class="normal">2104</span>
<span class="normal">2105</span>
<span class="normal">2106</span>
<span class="normal">2107</span>
<span class="normal">2108</span>
<span class="normal">2109</span>
<span class="normal">2110</span>
<span class="normal">2111</span>
<span class="normal">2112</span>
<span class="normal">2113</span>
<span class="normal">2114</span>
<span class="normal">2115</span>
<span class="normal">2116</span>
<span class="normal">2117</span>
<span class="normal">2118</span>
<span class="normal">2119</span>
<span class="normal">2120</span>
<span class="normal">2121</span>
<span class="normal">2122</span>
<span class="normal">2123</span>
<span class="normal">2124</span>
<span class="normal">2125</span>
<span class="normal">2126</span>
<span class="normal">2127</span>
<span class="normal">2128</span>
<span class="normal">2129</span>
<span class="normal">2130</span>
<span class="normal">2131</span>
<span class="normal">2132</span>
<span class="normal">2133</span>
<span class="normal">2134</span>
<span class="normal">2135</span>
<span class="normal">2136</span>
<span class="normal">2137</span>
<span class="normal">2138</span>
<span class="normal">2139</span>
<span class="normal">2140</span>
<span class="normal">2141</span>
<span class="normal">2142</span>
<span class="normal">2143</span>
<span class="normal">2144</span>
<span class="normal">2145</span>
<span class="normal">2146</span>
<span class="normal">2147</span>
<span class="normal">2148</span>
<span class="normal">2149</span>
<span class="normal">2150</span>
<span class="normal">2151</span>
<span class="normal">2152</span>
<span class="normal">2153</span>
<span class="normal">2154</span>
<span class="normal">2155</span>
<span class="normal">2156</span>
<span class="normal">2157</span>
<span class="normal">2158</span>
<span class="normal">2159</span>
<span class="normal">2160</span>
<span class="normal">2161</span>
<span class="normal">2162</span>
<span class="normal">2163</span>
<span class="normal">2164</span>
<span class="normal">2165</span>
<span class="normal">2166</span>
<span class="normal">2167</span>
<span class="normal">2168</span>
<span class="normal">2169</span>
<span class="normal">2170</span>
<span class="normal">2171</span>
<span class="normal">2172</span>
<span class="normal">2173</span>
<span class="normal">2174</span>
<span class="normal">2175</span>
<span class="normal">2176</span>
<span class="normal">2177</span>
<span class="normal">2178</span>
<span class="normal">2179</span>
<span class="normal">2180</span>
<span class="normal">2181</span>
<span class="normal">2182</span>
<span class="normal">2183</span>
<span class="normal">2184</span>
<span class="normal">2185</span>
<span class="normal">2186</span>
<span class="normal">2187</span>
<span class="normal">2188</span>
<span class="normal">2189</span>
<span class="normal">2190</span>
<span class="normal">2191</span>
<span class="normal">2192</span>
<span class="normal">2193</span>
<span class="normal">2194</span>
<span class="normal">2195</span>
<span class="normal">2196</span>
<span class="normal">2197</span>
<span class="normal">2198</span>
<span class="normal">2199</span>
<span class="normal">2200</span>
<span class="normal">2201</span>
<span class="normal">2202</span>
<span class="normal">2203</span>
<span class="normal">2204</span>
<span class="normal">2205</span>
<span class="normal">2206</span>
<span class="normal">2207</span>
<span class="normal">2208</span>
<span class="normal">2209</span>
<span class="normal">2210</span>
<span class="normal">2211</span>
<span class="normal">2212</span>
<span class="normal">2213</span>
<span class="normal">2214</span>
<span class="normal">2215</span>
<span class="normal">2216</span>
<span class="normal">2217</span>
<span class="normal">2218</span>
<span class="normal">2219</span>
<span class="normal">2220</span>
<span class="normal">2221</span>
<span class="normal">2222</span>
<span class="normal">2223</span>
<span class="normal">2224</span>
<span class="normal">2225</span>
<span class="normal">2226</span>
<span class="normal">2227</span>
<span class="normal">2228</span>
<span class="normal">2229</span>
<span class="normal">2230</span>
<span class="normal">2231</span>
<span class="normal">2232</span>
<span class="normal">2233</span>
<span class="normal">2234</span>
<span class="normal">2235</span>
<span class="normal">2236</span>
<span class="normal">2237</span>
<span class="normal">2238</span>
<span class="normal">2239</span>
<span class="normal">2240</span>
<span class="normal">2241</span>
<span class="normal">2242</span>
<span class="normal">2243</span>
<span class="normal">2244</span>
<span class="normal">2245</span>
<span class="normal">2246</span>
<span class="normal">2247</span>
<span class="normal">2248</span>
<span class="normal">2249</span>
<span class="normal">2250</span>
<span class="normal">2251</span>
<span class="normal">2252</span>
<span class="normal">2253</span>
<span class="normal">2254</span>
<span class="normal">2255</span>
<span class="normal">2256</span>
<span class="normal">2257</span>
<span class="normal">2258</span>
<span class="normal">2259</span>
<span class="normal">2260</span>
<span class="normal">2261</span>
<span class="normal">2262</span>
<span class="normal">2263</span>
<span class="normal">2264</span>
<span class="normal">2265</span>
<span class="normal">2266</span>
<span class="normal">2267</span>
<span class="normal">2268</span>
<span class="normal">2269</span>
<span class="normal">2270</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">alphafold_predict_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequences</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">sql</span><span class="o">.</span><span class="n">DesignData</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                                <span class="n">model_type</span><span class="p">:</span> <span class="n">resources</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">af_model_literal</span> <span class="o">=</span> <span class="s1">&#39;monomer&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use Alphafold to predict structures for sequences of interest. The sequences will be fit to the Pose</span>
<span class="sd">    parameters, however will have sequence features unique to that sequence. By default, no multiple sequence</span>
<span class="sd">    alignment will be used and the AlphafoldInitialGuess model will be used wherein the starting coordinates for</span>
<span class="sd">    the Pose will be supplied as the initial guess</span>

<span class="sd">    According to Deepmind Alphafold.ipynb (2/3/23), the usage of multimer with &gt; 3000 residues isn&#39;t validated.</span>
<span class="sd">    while a memory requirement of 4000 is the theoretical limit. I think it depends on the available memory</span>
<span class="sd">    Args:</span>
<span class="sd">        sequences: The mapping for DesignData to sequence</span>
<span class="sd">        model_type: The type of Alphafold model to use. Choose from &#39;monomer&#39;, &#39;monomer_casp14&#39;, &#39;monomer_ptm&#39;,</span>
<span class="sd">            or &#39;multimer&#39;</span>
<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">load_pose</span><span class="p">()</span>
    <span class="n">number_of_residues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_residues</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Performing structure prediction on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span><span class="si">}</span><span class="s1"> sequences&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">design</span><span class="p">,</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">sequences</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Todo if differentially sized sequence inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found sequence </span><span class="si">{</span><span class="n">sequence</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># max_sequence_length = max([len(sequence) for sequence in sequences.values()])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="o">!=</span> <span class="n">number_of_residues</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DesignError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;The sequence length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span><span class="si">}</span><span class="s1"> != </span><span class="si">{</span><span class="n">number_of_residues</span><span class="si">}</span><span class="s1">, the number of residues in the pose&#39;</span><span class="p">)</span>
    <span class="c1"># Get the DesignData.ids for metrics output</span>
    <span class="n">design_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">design</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">design</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">]</span>

    <span class="c1"># Hardcode parameters</span>
    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;monomer_casp14&#39;</span><span class="p">:</span>
        <span class="n">num_ensemble</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_ensemble</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">number_of_entities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_entities</span>
    <span class="n">heteromer</span> <span class="o">=</span> <span class="n">number_of_entities</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="n">run_multimer_system</span> <span class="o">=</span> <span class="n">heteromer</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_chains</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">run_multimer_system</span><span class="p">:</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;multimer&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The AlphaFold model was automatically set to </span><span class="si">{</span><span class="n">model_type</span><span class="si">}</span><span class="s1"> due to detected multimeric pose&#39;</span><span class="p">)</span>

    <span class="c1"># # Todo enable compilation time savings by returning a precomputed model_factory. Padding the size of this may</span>
    <span class="c1"># #  help quite a bit</span>
    <span class="c1"># model_runners = resources.ml.alphafold_model_factory.get()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">num_predictions_per_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">run_multimer_system</span><span class="p">:</span>
            <span class="c1"># Default is 5, with 5 models for 25 outputs. Could do 1 to increase speed...</span>
            <span class="n">num_predictions_per_model</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_predictions_per_model</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_predictions_per_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">num_predictions_per_model</span>

    <span class="c1"># Set up the various model_runners to supervise the prediction task for each sequence</span>
    <span class="n">model_runners</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">set_up_model_runners</span><span class="p">(</span><span class="n">model_type</span><span class="o">=</span><span class="n">model_type</span><span class="p">,</span>
                                                      <span class="n">num_predictions_per_model</span><span class="o">=</span><span class="n">num_predictions_per_model</span><span class="p">,</span>
                                                      <span class="n">num_ensemble</span><span class="o">=</span><span class="n">num_ensemble</span><span class="p">,</span>
                                                      <span class="n">development</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">development</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_sequence_features_to_merge</span><span class="p">(</span><span class="n">seq_of_interest</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">multimer_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FeatureDict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up a sequence that has similar features to the Pose, but different sequence, say from design output</span>

<span class="sd">        Args:</span>
<span class="sd">            seq_of_interest: The sequence of interest</span>
<span class="sd">            multimer_length: The length of the multimer features, if the features are multimeric</span>
<span class="sd">        Returns:</span>
<span class="sd">            The Alphafold FeatureDict which is essentially a dictionary with dict[str, np.ndarray]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set up scores for each model</span>
        <span class="n">sequence_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_of_interest</span><span class="p">)</span>
        <span class="c1"># Set the sequence up in the FeatureDict</span>
        <span class="c1"># Todo the way that I am adding this here instead of during construction, seems that I should</span>
        <span class="c1">#  symmetrize the sequence before passing to af_predict(). This would occur by entity, where the first</span>
        <span class="c1">#  entity is combined, then the second entity is combined, etc. Any entity agnostic features such</span>
        <span class="c1">#  as all_atom_mask would be able to be made here</span>
        <span class="n">_seq_features</span> <span class="o">=</span> <span class="n">af_pipeline</span><span class="o">.</span><span class="n">make_sequence_features</span><span class="p">(</span>
            <span class="n">sequence</span><span class="o">=</span><span class="n">seq_of_interest</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">num_res</span><span class="o">=</span><span class="n">sequence_length</span><span class="p">)</span>
        <span class="c1"># Always use the outer &quot;domain_name&quot; feature if there is one</span>
        <span class="n">_seq_features</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;domain_name&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">multimer_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Remove &quot;object&quot; dtype arrays. This may be required for &quot;monomer&quot; runs too</span>
            <span class="c1"># _seq_features.pop(&#39;domain_name&#39;)</span>
            <span class="n">_seq_features</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;between_segment_residues&#39;</span><span class="p">)</span>
            <span class="n">_seq_features</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;sequence&#39;</span><span class="p">)</span>
            <span class="n">_seq_features</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;seq_length&#39;</span><span class="p">)</span>
            <span class="c1"># The multimer model performs the one-hot operation itself. So processing gets the sequence as</span>
            <span class="c1"># the idx encoded by this v argmax on the one-hot</span>
            <span class="n">_seq_features</span><span class="p">[</span><span class="s1">&#39;aatype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">_seq_features</span><span class="p">[</span><span class="s1">&#39;aatype&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

            <span class="n">multimer_number</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">multimer_length</span><span class="p">,</span> <span class="n">sequence_length</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remainder</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;The multimer_sequence_length and the sequence_length must differ by an integer number. Found &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;multimer/monomer (</span><span class="si">{</span><span class="n">multimer_sequence_length</span><span class="si">}</span><span class="s1">)/(</span><span class="si">{</span><span class="n">sequence_length</span><span class="si">}</span><span class="s1">) with remainder </span><span class="si">{</span><span class="n">remainder</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;aatype&#39;</span><span class="p">,</span> <span class="s1">&#39;residue_index&#39;</span><span class="p">]:</span>
                <span class="n">_seq_features</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">_seq_features</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">multimer_number</span><span class="p">)</span>
            <span class="c1"># # For &#39;domain_name&#39;, &#39;sequence&#39;, and &#39;seq_length&#39;, transform the 1-D array to a scaler</span>
            <span class="c1"># # np.asarray(np.array([&#39;pope&#39;.encode(&#39;utf-8&#39;)], dtype=np.object_)[0], dtype=np.object_)</span>
            <span class="c1"># # Not sure why this transformation happens for multimer... as the multimer gets rid of them,</span>
            <span class="c1"># # but they are ready for the monomer pipeline</span>
            <span class="c1"># for key in [&#39;domain_name&#39;, &#39;sequence&#39;]:</span>
            <span class="c1">#     _seq_features[key] = np.asarray(_seq_features[key][0], dtype=np.object_)</span>
            <span class="c1"># _seq_features[&#39;seq_length&#39;] = np.asarray(sequence_length, dtype=np.int32)</span>

        <span class="c1"># Todo ensure that the sequence is merged such as in the merge_and_pair subroutine</span>
        <span class="c1">#  a good portion of which is below</span>
        <span class="c1"># if feature_name_split in SEQ_FEATURES:</span>
        <span class="c1">#     # Merges features along their length [MLKF...], [MLKF...] -&gt; [MLKF...MLKF...]</span>
        <span class="c1">#     merged_example[feature_name] = np.concatenate(feats, axis=0)</span>
        <span class="c1">#     # If sequence is the same length as Entity/Pose, then &#39;residue_index&#39; should be correct and</span>
        <span class="c1">#     # increasing for each sequence position, restarting at the beginning of a chain</span>
        <span class="c1"># Make the atom positions according to the sequence</span>
        <span class="c1"># Add all_atom_mask and dummy all_atom_positions based on aatype.</span>
        <span class="n">all_atom_mask</span> <span class="o">=</span> <span class="n">residue_constants</span><span class="o">.</span><span class="n">STANDARD_ATOM_MASK</span><span class="p">[</span><span class="n">_seq_features</span><span class="p">[</span><span class="s1">&#39;aatype&#39;</span><span class="p">]]</span>
        <span class="n">_seq_features</span><span class="p">[</span><span class="s1">&#39;all_atom_mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_atom_mask</span>
        <span class="n">_seq_features</span><span class="p">[</span><span class="s1">&#39;all_atom_positions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">all_atom_mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="c1"># Todo check on &#39;seq_mask&#39; introduction point for multimer...</span>
        <span class="c1"># elif feature_name_split in TEMPLATE_FEATURES:</span>
        <span class="c1"># DONT WORRY ABOUT THESE</span>
        <span class="c1">#     merged_example[feature_name] = np.concatenate(feats, axis=1)</span>
        <span class="c1"># elif feature_name_split in CHAIN_FEATURES:</span>
        <span class="c1">#     merged_example[feature_name] = np.sum(x for x in feats).astype(np.int32)</span>
        <span class="c1"># &#39;num_alignments&#39; should be fine as msa incorporation has happened prior</span>
        <span class="c1"># else:</span>
        <span class="c1">#     # NO use at this time, these take the value of the first chain and eventually get thrown out</span>
        <span class="c1">#     # &#39;domain_name&#39;, &#39;sequence&#39;, &#39;between_segment_residues&#39;</span>
        <span class="c1">#     merged_example[feature_name] = feats[0]</span>
        <span class="k">return</span> <span class="n">_seq_features</span>

    <span class="k">def</span> <span class="nf">output_alphafold_structures</span><span class="p">(</span><span class="n">structure_types</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">design_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;From a PDB formatted string, output structures by design_name to self.designs_path/design_name&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">design_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">design_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># for design, design_scores in structures.items():</span>
        <span class="c1">#     # # Output unrelaxed</span>
        <span class="c1">#     # structures = design_scores[&#39;structures_unrelaxed&#39;]</span>
        <span class="k">for</span> <span class="n">type_str</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;un&#39;</span><span class="p">]:</span>
            <span class="n">structures</span> <span class="o">=</span> <span class="n">structure_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">type_str</span><span class="si">}</span><span class="s1">relaxed&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">structures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span><span class="p">,</span> <span class="n">design_name</span><span class="p">)</span>
                <span class="n">putils</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span>
                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">design_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s1">_rank</span><span class="si">{</span><span class="nb">next</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">type_str</span><span class="si">}</span><span class="s1">relaxed.pdb&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
            <span class="c1"># # Repeat for relaxed</span>
            <span class="c1"># structures = design_scores[&#39;structures&#39;]</span>
            <span class="c1"># idx = count(1)</span>
            <span class="c1"># for model_name, structure in structures.items():</span>
            <span class="c1">#     path = os.path.join(self.designs_path, f&#39;{model_name}_rank{next(idx)}.pdb&#39;)</span>
            <span class="c1">#     with open(path, &#39;w&#39;) as f:</span>
            <span class="c1">#         f.write(structure)</span>

    <span class="k">def</span> <span class="nf">find_model_with_minimal_rmsd</span><span class="p">(</span><span class="n">models</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Structure</span><span class="p">],</span> <span class="n">template_cb_coords</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Use the CB coords to calculate the RMSD and find the best Structure instance from a group of Alphafold</span>
<span class="sd">        models and transform that model to the Pose coordinates</span>

<span class="sd">        Returns:</span>
<span class="sd">            The calculated rmsds, and the name of the model with the minimal rmsd</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">min_rmsd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">minimum_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">rmsds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">af_model_name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rmsd</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">superposition3d</span><span class="p">(</span><span class="n">template_cb_coords</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">cb_coords</span><span class="p">)</span>
            <span class="n">rmsds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmsd</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rmsd</span> <span class="o">&lt;</span> <span class="n">min_rmsd</span><span class="p">:</span>
                <span class="n">min_rmsd</span> <span class="o">=</span> <span class="n">rmsd</span>
                <span class="n">minimum_model</span> <span class="o">=</span> <span class="n">af_model_name</span>
                <span class="c1"># Move the Alphafold model into the Pose reference frame</span>
                <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="n">rot</span><span class="p">,</span> <span class="n">translation</span><span class="o">=</span><span class="n">tx</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rmsds</span><span class="p">,</span> <span class="n">minimum_model</span>

    <span class="k">def</span> <span class="nf">combine_model_scores</span><span class="p">(</span><span class="n">_scores</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add each of the different score types produced by each model to a dictionary with a list of model</span>
<span class="sd">        folding_scores in each category in the order the models appear</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary with format {&#39;score_type&#39;: [score1, score2, ...], } where score1 can have a shape float,</span>
<span class="sd">            (n_residues,), or (n_residues, n_residues)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">score_type</span><span class="p">:</span> <span class="p">[</span><span class="n">scores</span><span class="p">[</span><span class="n">score_type</span><span class="p">]</span> <span class="k">for</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">_scores</span><span class="p">]</span> <span class="k">for</span> <span class="n">score_type</span> <span class="ow">in</span> <span class="n">_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">get_prev_pos_coords</span><span class="p">(</span><span class="n">sequence_</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">assembly</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Using the PoseJob.pose instance, get coordinates compatible with AlphafoldInitialGuess</span>

<span class="sd">        Args:</span>
<span class="sd">            sequence_: The sequence to use as a template to generate the coordinates</span>
<span class="sd">            assembly: Whether the coordinates should reflect the Pose Assembly</span>
<span class="sd">            entity: If coordinates should come from a Pose Entity, which one?</span>
<span class="sd">        Returns:</span>
<span class="sd">            The alphafold formatted sequence coords in a JAX array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pose_copy</span><span class="p">:</span> <span class="n">Pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Choose which Structure to iterate over residues</span>
        <span class="k">if</span> <span class="n">entity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="n">pose_copy</span><span class="o">.</span><span class="n">get_entity</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">structure</span> <span class="o">=</span> <span class="n">pose_copy</span>

        <span class="k">if</span> <span class="n">sequence_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Make an all Alanine structure backbone as the prev_pos</span>
            <span class="n">sequence_</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span> <span class="o">*</span> <span class="n">structure</span><span class="o">.</span><span class="n">number_of_residues</span>

        <span class="c1"># Mutate to a &#39;lame&#39; version of sequence/structure, removing any side-chain atoms not present</span>
        <span class="k">for</span> <span class="n">residue</span><span class="p">,</span> <span class="n">residue_type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">residues</span><span class="p">,</span> <span class="n">sequence_</span><span class="p">):</span>
            <span class="n">deleted_indices</span> <span class="o">=</span> <span class="n">pose_copy</span><span class="o">.</span><span class="n">mutate_residue</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">residue_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">assembly</span><span class="p">:</span>
            <span class="n">af_coords</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">assembly</span><span class="o">.</span><span class="n">alphafold_coords</span>
        <span class="k">elif</span> <span class="n">entity</span><span class="p">:</span>
            <span class="n">af_coords</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">assembly</span><span class="o">.</span><span class="n">alphafold_coords</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">af_coords</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">alphafold_coords</span>

        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">af_coords</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">models_to_relax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">relaxed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">relaxed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Hard code in the use of only design based single sequence models</span>
    <span class="c1"># if self.job.design:</span>
    <span class="c1">#     no_msa = True</span>
    <span class="c1"># else:</span>
    <span class="c1">#     no_msa = False</span>
    <span class="n">no_msa</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">debug_entities_and_oligomers</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Ensure clashes aren&#39;t checked as these stop operation</span>
    <span class="n">pose_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Get features for the Pose and predict</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">designs</span><span class="p">:</span>
        <span class="c1"># For interface analysis the interface residues are needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identify_interface</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">assembly</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_symmetric_residues</span> <span class="o">&gt;</span> <span class="n">resources</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">MULTIMER_RESIDUE_LIMIT</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Predicting on a symmetric input with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_symmetric_residues</span><span class="si">}</span><span class="s2"> isn&#39;t &quot;</span>
                    <span class="s1">&#39;recommended due to memory limitations&#39;</span><span class="p">)</span>
            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">get_alphafold_features</span><span class="p">(</span><span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">multimer</span><span class="o">=</span><span class="n">run_multimer_system</span><span class="p">,</span> <span class="n">no_msa</span><span class="o">=</span><span class="n">no_msa</span><span class="p">)</span>
            <span class="c1"># Todo may need to modify this if the pose isn&#39;t completely symmetric despite it being specified as such</span>
            <span class="n">number_of_residues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_symmetric_residues</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">get_alphafold_features</span><span class="p">(</span><span class="n">symmetric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multimer</span><span class="o">=</span><span class="n">run_multimer_system</span><span class="p">,</span>
                                                        <span class="n">no_msa</span><span class="o">=</span><span class="n">no_msa</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">run_multimer_system</span><span class="p">:</span>  <span class="c1"># Get the length</span>
            <span class="n">multimer_sequence_length</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;seq_length&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">multimer_sequence_length</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">putils</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span><span class="p">)</span>
        <span class="n">model_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">asu_design_structures</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># structure_by_design = {}</span>
        <span class="n">asu_design_scores</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># []  # scores_by_design = {}</span>
        <span class="k">for</span> <span class="n">design</span><span class="p">,</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">sequences</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">this_seq_features</span> <span class="o">=</span> <span class="n">get_sequence_features_to_merge</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">multimer_length</span><span class="o">=</span><span class="n">multimer_sequence_length</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found this_seq_features:</span><span class="se">\n\t</span><span class="s1">%s&#39;</span>
                                  <span class="o">%</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">this_seq_features</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
            <span class="n">model_features</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prev_pos&#39;</span><span class="p">:</span> <span class="n">get_prev_pos_coords</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">assembly</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">assembly</span><span class="p">)}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Predicting Design </span><span class="si">{</span><span class="n">design</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> structure&#39;</span><span class="p">)</span>
            <span class="n">asu_structures</span><span class="p">,</span> <span class="n">asu_scores</span> <span class="o">=</span> \
                <span class="n">resources</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">af_predict</span><span class="p">({</span><span class="o">**</span><span class="n">features</span><span class="p">,</span> <span class="o">**</span><span class="n">this_seq_features</span><span class="p">,</span> <span class="o">**</span><span class="n">model_features</span><span class="p">},</span> <span class="n">model_runners</span><span class="p">,</span>
                                        <span class="n">gpu_relax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">use_gpu_relax</span><span class="p">,</span>
                                        <span class="n">models_to_relax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">models_to_relax</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">relaxed</span><span class="p">:</span>
                <span class="n">structures_to_load</span> <span class="o">=</span> <span class="n">asu_structures</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relaxed&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">structures_to_load</span> <span class="o">=</span> <span class="n">asu_structures</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unrelaxed&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="c1"># # Tod0 remove this after debug is done</span>
            <span class="c1"># output_alphafold_structures(asu_structures, design_name=f&#39;{design}-asu&#39;)</span>
            <span class="c1"># asu_models = load_alphafold_structures(structures_to_load, name=str(design),  # Get &#39;.name&#39;</span>
            <span class="c1">#                                        entity_info=self.pose.entity_info)</span>
            <span class="c1"># Load the Model in while ignoring any potential clashes</span>
            <span class="c1"># Todo should I limit the .splitlines by the number_of_residues? Assembly v asu considerations</span>
            <span class="n">asu_models</span> <span class="o">=</span> <span class="p">{</span><span class="n">model_name</span><span class="p">:</span> <span class="n">Pose</span><span class="o">.</span><span class="n">from_pdb_lines</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">design</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">pose_kwargs</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">structures_to_load</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="c1"># Because the pdb_lines aren&#39;t oriented, must handle orientation of incoming files to match sym_entry</span>
            <span class="c1"># This is handled in find_model_with_minimal_rmsd(), however, the symmetry isn&#39;t set up correctly, i.e.</span>
            <span class="c1"># we need to pose.make_oligomers() in the correct orientation</span>
            <span class="c1"># Do this all at once after every design</span>
            <span class="k">if</span> <span class="n">relaxed</span><span class="p">:</span>  <span class="c1"># Set b-factor data as relaxed get overwritten</span>
                <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">asu_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">set_b_factor_data</span><span class="p">(</span><span class="n">asu_scores</span><span class="p">[</span><span class="n">model_name</span><span class="p">][</span><span class="s1">&#39;plddt&#39;</span><span class="p">][:</span><span class="n">number_of_residues</span><span class="p">])</span>
            <span class="c1"># Check for the prediction rmsd between the backbone of the Entity Model and Alphafold Model</span>
            <span class="n">rmsds</span><span class="p">,</span> <span class="n">minimum_model</span> <span class="o">=</span> <span class="n">find_model_with_minimal_rmsd</span><span class="p">(</span><span class="n">asu_models</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">cb_coords</span><span class="p">)</span>
            <span class="c1"># rmsds, minimum_model = find_model_with_minimal_rmsd(asu_models, self.pose.backbone_and_cb_coords)</span>
            <span class="k">if</span> <span class="n">minimum_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t find the asu model with the minimal rmsd for Design </span><span class="si">{</span><span class="n">design</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Append each ASU result to the full return</span>
            <span class="n">asu_design_structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asu_models</span><span class="p">[</span><span class="n">minimum_model</span><span class="p">])</span>
            <span class="n">model_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">minimum_model</span><span class="p">)</span>
            <span class="c1"># structure_by_design[design].append(asu_models[minimum_model])</span>
            <span class="c1"># asu_design_scores.append({&#39;rmsd_prediction_ensemble&#39;: rmsds, **asu_scores[minimum_model]})</span>
            <span class="c1"># Average all models scores to get the ensemble of the predictions</span>
            <span class="n">combined_scores</span> <span class="o">=</span> <span class="n">combine_model_scores</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">asu_scores</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="n">asu_design_scores</span><span class="p">[</span><span class="n">design</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rmsd_prediction_ensemble&#39;</span><span class="p">:</span> <span class="n">rmsds</span><span class="p">,</span> <span class="o">**</span><span class="n">combined_scores</span><span class="p">}</span>
            <span class="c1"># asu_design_scores[str(design)] = {&#39;rmsd_prediction_ensemble&#39;: rmsds, **asu_scores[minimum_model]}</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Each design in asu_design_scores contain the following features</span>
<span class="sd">            {&#39;predicted_aligned_error&#39;: [(n_residues, n_residues), ...]  # multimer/monomer_ptm</span>
<span class="sd">             &#39;plddt&#39;: [(n_residues,), ...]</span>
<span class="sd">             &#39;predicted_interface_template_modeling_score&#39;: [float, ...]  # multimer</span>
<span class="sd">             &#39;predicted_template_modeling_score&#39;: [float, ...]  # multimer/monomer_ptm</span>
<span class="sd">             &#39;rmsd_prediction_ensemble: [(number_of_models), ...]</span>
<span class="sd">             }</span>
<span class="sd">            &quot;&quot;&quot;</span>

        <span class="c1"># Write the folded structure to designs_path and update DesignProtocols</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">design_data</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sequences</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">asu_design_structures</span><span class="p">)):</span>
            <span class="n">design_data</span><span class="o">.</span><span class="n">structure_path</span> <span class="o">=</span> \
                <span class="n">pose</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">design_data</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.pdb&#39;</span><span class="p">))</span>
            <span class="n">design_data</span><span class="o">.</span><span class="n">protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">sql</span><span class="o">.</span><span class="n">DesignProtocol</span><span class="p">(</span><span class="n">design_id</span><span class="o">=</span><span class="n">design_data</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span>
                                   <span class="n">alphafold_model</span><span class="o">=</span><span class="n">model_names</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">file</span><span class="o">=</span><span class="n">design_data</span><span class="o">.</span><span class="n">structure_path</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># # This corrects the oligomeric specification for each Entity</span>
            <span class="c1"># # by using the inherent _assign_pose_transformation()</span>
            <span class="c1"># pose.make_oligomers()</span>
            <span class="c1"># This would explicitly pass the transformation parameters which are correct for the PoseJob</span>
            <span class="c1"># for entity in pose.entities:</span>
            <span class="c1">#     entity.remove_mate_chains()</span>
            <span class="k">if</span> <span class="n">debug_entities_and_oligomers</span><span class="p">:</span>
                <span class="n">pose</span><span class="o">.</span><span class="n">make_oligomers</span><span class="p">(</span><span class="n">transformations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transformations</span><span class="p">)</span>
                <span class="n">pose</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pose</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">-asu-check.pdb&#39;</span><span class="p">))</span>
                <span class="n">pose</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">assembly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">out_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pose</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">-assembly-check.pdb&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>
                    <span class="n">entity</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="n">out_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pose</span><span class="o">.</span><span class="n">name</span><span class="si">}{</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">-oligomer-asu-check.pdb&#39;</span><span class="p">))</span>
                    <span class="n">entity</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">assembly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">out_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span><span class="p">,</span>
                                                       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pose</span><span class="o">.</span><span class="n">name</span><span class="si">}{</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">-oligomer-check.pdb&#39;</span><span class="p">))</span>

        <span class="c1"># Using the 2-fold aware pose.interface_residues_by_interface</span>
        <span class="n">interface_indices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">]</span>
                                  <span class="k">for</span> <span class="n">residues</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">interface_residues_by_interface</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="c1"># All index are based on design.name</span>
        <span class="n">residues_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_residue_metrics_per_design</span><span class="p">(</span><span class="n">asu_design_structures</span><span class="p">)</span>
        <span class="n">designs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_design_metrics_per_design</span><span class="p">(</span><span class="n">residues_df</span><span class="p">,</span> <span class="n">asu_design_structures</span><span class="p">)</span>
        <span class="n">predict_designs_df</span><span class="p">,</span> <span class="n">predict_residues_df</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">analyze_alphafold_metrics</span><span class="p">(</span><span class="n">asu_design_scores</span><span class="p">,</span> <span class="n">number_of_residues</span><span class="p">,</span>
                                           <span class="n">model_type</span><span class="o">=</span><span class="n">model_type</span><span class="p">,</span> <span class="n">interface_indices</span><span class="o">=</span><span class="n">interface_indices</span><span class="p">)</span>
        <span class="n">residue_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">number_of_residues</span><span class="p">))</span>
        <span class="c1"># Set the index to use the design.id for each design instance</span>
        <span class="n">design_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">design_ids</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">sql</span><span class="o">.</span><span class="n">ResidueMetrics</span><span class="o">.</span><span class="n">design_id</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">residue_sequences_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">sequences</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
                                            <span class="n">index</span><span class="o">=</span><span class="n">predict_residues_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                            <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">residue_indices</span><span class="p">,</span>
                                                                                <span class="p">[</span><span class="n">sql</span><span class="o">.</span><span class="n">ResidueMetrics</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">name</span><span class="p">]]))</span>
        <span class="n">residues_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">predict_residues_df</span><span class="p">,</span> <span class="n">residue_sequences_df</span><span class="p">])</span>
        <span class="n">designs_df</span> <span class="o">=</span> <span class="n">designs_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">predict_designs_df</span><span class="p">)</span>
        <span class="n">designs_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">design_index</span>
        <span class="c1"># Output collected metrics</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">designs</span><span class="o">=</span><span class="n">designs_df</span><span class="p">)</span>
            <span class="n">output_residues</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">output_residues</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">residues</span><span class="o">=</span><span class="n">residues_df</span><span class="p">)</span>
            <span class="c1"># else:  # Only save the &#39;design_residue&#39; columns</span>
            <span class="c1">#     residues_df = residues_df.loc[:, idx_slice[:, sql.DesignResidues.design_residue.name]]</span>
            <span class="c1">#     self.output_metrics(session, design_residues=residues_df)</span>
            <span class="c1"># Commit the newly acquired metrics</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># Prepare the features to feed to the model</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>  <span class="c1"># and self.number_of_entities &gt; 1:</span>
        <span class="c1"># Get the features for each oligomeric Entity</span>
        <span class="c1"># The folding_scores will all be the length of the gene Entity, not oligomer</span>
        <span class="c1"># entity_scores_by_design = {design: [] for design in sequences}</span>

        <span class="c1"># Sort the entity instances by their length to improve compile time.</span>
        <span class="n">entities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span>
        <span class="c1"># The only compile should be the first prediction</span>
        <span class="n">entity_number_of_residues</span> <span class="o">=</span> <span class="p">[(</span><span class="n">entity</span><span class="o">.</span><span class="n">number_of_residues</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">entities</span><span class="p">)]</span>
        <span class="n">entity_idx_sorted_residue_number_highest_to_lowest</span> <span class="o">=</span> \
            <span class="p">[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">entity_number_of_residues</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
        <span class="n">sorted_entities_and_data</span> <span class="o">=</span> <span class="p">[(</span><span class="n">entities</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity_data</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">entity_idx_sorted_residue_number_highest_to_lowest</span><span class="p">]</span>
        <span class="n">entity_structure_by_design</span> <span class="o">=</span> <span class="p">{</span><span class="n">design</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">design</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">}</span>
        <span class="n">entity_design_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">entity_residue_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">entity_data</span> <span class="ow">in</span> <span class="n">sorted_entities_and_data</span><span class="p">:</span>
            <span class="c1"># Fold with symmetry True. If it isn&#39;t symmetric, symmetry won&#39;t be used</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">get_alphafold_features</span><span class="p">(</span><span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">no_msa</span><span class="o">=</span><span class="n">no_msa</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">run_multimer_system</span><span class="p">:</span>  <span class="c1"># Get the length</span>
                <span class="n">multimer_sequence_length</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;seq_length&#39;</span><span class="p">]</span>
                <span class="n">entity_number_of_residues</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">assembly</span><span class="o">.</span><span class="n">number_of_residues</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">multimer_sequence_length</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">entity_number_of_residues</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">number_of_residues</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found oligomer with length: </span><span class="si">{</span><span class="n">entity_number_of_residues</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># if run_multimer_system:</span>
            <span class="n">entity_cb_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">mate</span><span class="o">.</span><span class="n">cb_coords</span> <span class="k">for</span> <span class="n">mate</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">chains</span><span class="p">])</span>
            <span class="c1"># Todo</span>
            <span class="c1">#  entity_backbone_and_cb_coords = entity.assembly.cb_coords</span>
            <span class="c1"># else:</span>
            <span class="c1">#     entity_cb_coords = entity.cb_coords</span>

            <span class="n">entity_interface_residues</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">get_interface_residues</span><span class="p">(</span><span class="n">entity1</span><span class="o">=</span><span class="n">entity</span><span class="p">,</span> <span class="n">entity2</span><span class="o">=</span><span class="n">entity</span><span class="p">,</span>
                                                 <span class="n">distance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">interface_distance</span><span class="p">,</span> <span class="n">oligomeric_interfaces</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">offset_index</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">offset_index</span>
            <span class="n">entity_interface_indices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">offset_index</span> <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">]</span>
                                             <span class="k">for</span> <span class="n">residues</span> <span class="ow">in</span> <span class="n">entity_interface_residues</span><span class="p">)</span>
            <span class="n">entity_name</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">name</span>
            <span class="n">this_entity_info</span> <span class="o">=</span> <span class="p">{</span><span class="n">entity_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entity_info</span><span class="p">[</span><span class="n">entity_name</span><span class="p">]}</span>
            <span class="n">entity_model_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">entity_name</span><span class="p">,</span> <span class="n">entity_info</span><span class="o">=</span><span class="n">this_entity_info</span><span class="p">)</span>
            <span class="n">entity_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">n_terminal_residue</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">entity</span><span class="o">.</span><span class="n">c_terminal_residue</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">entity_scores_by_design</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Iterate over provided sequences. Find the best structural model and it&#39;s folding_scores</span>
            <span class="k">for</span> <span class="n">design</span><span class="p">,</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">sequences</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">[</span><span class="n">entity_slice</span><span class="p">]</span>
                <span class="n">this_seq_features</span> <span class="o">=</span> \
                    <span class="n">get_sequence_features_to_merge</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">multimer_length</span><span class="o">=</span><span class="n">multimer_sequence_length</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found this_seq_features:</span><span class="se">\n\t</span><span class="s1">&#39;</span>
                             <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">this_seq_features</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
                <span class="c1"># If not an oligomer, then get_prev_pos_coords() will just use the entity</span>
                <span class="n">model_features</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prev_pos&#39;</span><span class="p">:</span> <span class="n">get_prev_pos_coords</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">entity</span><span class="o">=</span><span class="n">entity_name</span><span class="p">)}</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Predicting Design </span><span class="si">{</span><span class="n">design</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> Entity </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span><span class="s1"> structure&#39;</span><span class="p">)</span>
                <span class="n">entity_structures</span><span class="p">,</span> <span class="n">entity_scores</span> <span class="o">=</span> \
                    <span class="n">resources</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">af_predict</span><span class="p">({</span><span class="o">**</span><span class="n">features</span><span class="p">,</span> <span class="o">**</span><span class="n">this_seq_features</span><span class="p">,</span> <span class="o">**</span><span class="n">model_features</span><span class="p">},</span> <span class="n">model_runners</span><span class="p">)</span>
                <span class="c1"># NOT using relaxation as these won&#39;t be output for design so their coarse features are all that</span>
                <span class="c1"># are desired</span>
                <span class="c1">#     gpu_relax=self.job.predict.use_gpu_relax, models_to_relax=self.job.predict.models_to_relax)</span>
                <span class="c1"># if relaxed:</span>
                <span class="c1">#     structures_to_load = entity_structures.get(&#39;relaxed&#39;, [])</span>
                <span class="c1"># else:</span>
                <span class="n">structures_to_load</span> <span class="o">=</span> <span class="n">entity_structures</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unrelaxed&#39;</span><span class="p">,</span> <span class="p">[])</span>

                <span class="n">design_models</span> <span class="o">=</span> <span class="p">{</span><span class="n">model_name</span><span class="p">:</span> <span class="n">Model</span><span class="o">.</span><span class="n">from_pdb_lines</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span> <span class="o">**</span><span class="n">entity_model_kwargs</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">structures_to_load</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="c1"># if relaxed:  # Set b-factor data as relaxed get overwritten</span>
                <span class="c1">#     type_str = &#39;&#39;</span>
                <span class="c1">#     for model_name, model in design_models.items():</span>
                <span class="c1">#         model.set_b_factor_data(entity_scores[model_name][&#39;plddt&#39;][:entity_number_of_residues])</span>
                <span class="c1">#     entity_structures[&#39;relaxed&#39;] = \</span>
                <span class="c1">#         {model_name: model.get_atom_record() for model_name, model in design_models.items()}</span>
                <span class="c1"># else:</span>
                <span class="n">type_str</span> <span class="o">=</span> <span class="s1">&#39;un&#39;</span>

                <span class="c1"># output_alphafold_structures(entity_structures, design_name=f&#39;{design}-{entity.name}&#39;)</span>
                <span class="c1"># Check for the prediction rmsd between the backbone of the Entity Model and Alphafold Model</span>
                <span class="c1"># Also, perform an alignment to the pose Entity</span>
                <span class="n">rmsds</span><span class="p">,</span> <span class="n">minimum_model</span> <span class="o">=</span> <span class="n">find_model_with_minimal_rmsd</span><span class="p">(</span><span class="n">design_models</span><span class="p">,</span> <span class="n">entity_cb_coords</span><span class="p">)</span>
                <span class="c1"># rmsds, minimum_model = find_model_with_minimal_rmsd(design_models, entity_backbone_and_cb_coords)</span>
                <span class="k">if</span> <span class="n">minimum_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DesignError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t find the Entity </span><span class="si">{</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> model with the minimal rmsd for Design </span><span class="si">{</span><span class="n">design</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Put Entity Model into a directory in pose/designs/pose-design_id/entity.name.pdb</span>
                <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">design</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">putils</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">minimum_model</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">type_str</span><span class="si">}</span><span class="s1">relaxed.pdb&#39;</span><span class="p">)</span>
                <span class="n">minimum_entity</span> <span class="o">=</span> <span class="n">design_models</span><span class="p">[</span><span class="n">minimum_model</span><span class="p">]</span>
                <span class="n">minimum_entity</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
                <span class="c1"># Append each Entity result to the full return</span>
                <span class="n">entity_structure_by_design</span><span class="p">[</span><span class="n">design</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">minimum_entity</span><span class="p">)</span>
                <span class="c1"># Average all models scores to get the ensemble of the predictions</span>
                <span class="n">combined_scores</span> <span class="o">=</span> <span class="n">combine_model_scores</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">entity_scores</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                <span class="n">entity_scores_by_design</span><span class="p">[</span><span class="n">design</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rmsd_prediction_ensemble&#39;</span><span class="p">:</span> <span class="n">rmsds</span><span class="p">,</span> <span class="o">**</span><span class="n">combined_scores</span><span class="p">}</span>
                <span class="c1"># entity_scores_by_design[str(design)] = \</span>
                <span class="c1">#     {&#39;rmsd_prediction_ensemble&#39;: rmsds, **entity_scores[minimum_model]}</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Each design in entity_scores_by_design contains the following features</span>
<span class="sd">                {&#39;predicted_aligned_error&#39;: [(n_residues, n_residues), ...]  # multimer/monomer_ptm</span>
<span class="sd">                 &#39;plddt&#39;: [(n_residues,), ...]</span>
<span class="sd">                 &#39;predicted_interface_template_modeling_score&#39;: [float, ...]  # multimer</span>
<span class="sd">                 &#39;predicted_template_modeling_score&#39;: [float, ...]  # multimer/monomer_ptm</span>
<span class="sd">                 &#39;rmsd_prediction_ensemble: [(number_of_models), ...]</span>
<span class="sd">                 }</span>
<span class="sd">                &quot;&quot;&quot;</span>

            <span class="c1"># Todo</span>
            <span class="c1">#  Ensure the sequence length is the size of the entity. If saving the entity_residues_df need to</span>
            <span class="c1">#  change the column index to reflect the number of residues</span>
            <span class="n">entity_sequence_length</span> <span class="o">=</span> <span class="n">entity_slice</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">entity_slice</span><span class="o">.</span><span class="n">start</span>
            <span class="n">entity_designs_df</span><span class="p">,</span> <span class="n">entity_residues_df</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">analyze_alphafold_metrics</span><span class="p">(</span><span class="n">entity_scores_by_design</span><span class="p">,</span> <span class="n">entity_sequence_length</span><span class="p">,</span>
                                               <span class="n">model_type</span><span class="o">=</span><span class="n">model_type</span><span class="p">,</span> <span class="n">interface_indices</span><span class="o">=</span><span class="n">entity_interface_indices</span><span class="p">)</span>
            <span class="c1"># Set the index to use the design.id for each design instance and EntityData.id as an additional column</span>
            <span class="n">entity_designs_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
                <span class="p">[</span><span class="n">design_ids</span><span class="p">,</span> <span class="p">[</span><span class="n">entity_data</span><span class="o">.</span><span class="n">id</span><span class="p">]],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="n">sql</span><span class="o">.</span><span class="n">DesignEntityMetrics</span><span class="o">.</span><span class="n">design_id</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                       <span class="n">sql</span><span class="o">.</span><span class="n">DesignEntityMetrics</span><span class="o">.</span><span class="n">entity_id</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
            <span class="n">entity_design_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_designs_df</span><span class="p">)</span>

            <span class="c1"># These aren&#39;t currently written...</span>
            <span class="n">entity_residue_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_residues_df</span><span class="p">)</span>

        <span class="c1"># Save the entity_designs_df DataFrames</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">entity_designs_df</span> <span class="ow">in</span> <span class="n">entity_design_dfs</span><span class="p">:</span>
                <span class="n">sql</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">entity_designs</span><span class="o">=</span><span class="n">entity_designs_df</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># Try to perform an analysis of the separated versus the combined prediction</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">predict</span><span class="o">.</span><span class="n">designs</span><span class="p">:</span>
            <span class="c1"># Reorder the entity structures</span>
            <span class="k">for</span> <span class="n">design</span><span class="p">,</span> <span class="n">entity_structs</span> <span class="ow">in</span> <span class="n">entity_structure_by_design</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">entity_structure_by_design</span><span class="p">[</span><span class="n">design</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="p">[</span><span class="n">entity_structs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">entity_idx_sorted_residue_number_highest_to_lowest</span><span class="p">]</span>
            <span class="c1"># Combine Entity structure to compare with the Pose prediction</span>
            <span class="n">entity_design_structures</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Pose</span><span class="o">.</span><span class="n">from_entities</span><span class="p">([</span><span class="n">entity</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">entity_models</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">entities</span><span class="p">],</span>
                                   <span class="n">name</span><span class="o">=</span><span class="n">design</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">pose_kwargs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">design</span><span class="p">,</span> <span class="n">entity_models</span> <span class="ow">in</span> <span class="n">entity_structure_by_design</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">]</span>
            <span class="c1"># Combine Entity scores to compare with the Pose prediction</span>
            <span class="k">for</span> <span class="n">residue_df</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">entity_residue_dfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">):</span>
                <span class="c1"># Rename the residue_indices along the top most column of DataFrame</span>
                <span class="n">residue_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> \
                    <span class="n">residue_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">set_levels</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">n_terminal_residue</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                                             <span class="mi">1</span> <span class="o">+</span> <span class="n">entity</span><span class="o">.</span><span class="n">c_terminal_residue</span><span class="o">.</span><span class="n">index</span><span class="p">)),</span>
                                                  <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># residue_df.rename(columns=dict(zip(range(entity.number_of_residues),</span>
                <span class="c1">#                                    range(entity.n_terminal_residue.index,</span>
                <span class="c1">#                                          entity.c_terminal_residue.index)</span>
                <span class="c1">#                                    )))</span>
            <span class="n">entity_residues_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">entity_residue_dfs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Testing the addition of entity_designs_df. They were not adding correctly without &#39;</span>
                              <span class="s1">&#39;*unpack&#39;</span><span class="p">)</span>
                <span class="n">entity_designs_df</span><span class="p">,</span> <span class="o">*</span><span class="n">extra_entity_designs_df</span> <span class="o">=</span> <span class="n">entity_design_dfs</span>
                <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">extra_entity_designs_df</span><span class="p">:</span>
                    <span class="n">entity_designs_df</span> <span class="o">+=</span> <span class="n">df</span>

                <span class="n">entity_designs_df</span> <span class="o">/=</span> <span class="n">number_of_entities</span>
                <span class="c1"># entity_designs_df = pd.concat(entity_design_dfs, axis=0)</span>
                <span class="c1"># score_types_mean = [&#39;rmsd_prediction_ensemble&#39;]</span>
                <span class="c1"># if &#39;multimer&#39; in model_type:</span>
                <span class="c1">#     score_types_mean += [&#39;predicted_interface_template_modeling_score&#39;,</span>
                <span class="c1">#                          &#39;predicted_template_modeling_score&#39;]</span>
                <span class="c1"># elif &#39;ptm&#39; in model_type:</span>
                <span class="c1">#     score_types_mean += [&#39;predicted_template_modeling_score&#39;]</span>
                <span class="c1">#</span>
                <span class="c1"># score_types_concat = [&#39;predicted_aligned_error&#39;, &#39;plddt&#39;]</span>
                <span class="c1">#</span>
                <span class="c1"># entity_design_scores = []</span>
                <span class="c1"># for design in sequences:</span>
                <span class="c1">#     entity_scores = entity_scores_by_design[design]</span>
                <span class="c1">#     logger.debug(f&#39;Found entity_scores with contents:\n{entity_scores}&#39;)</span>
                <span class="c1">#     scalar_scores = {score_type: sum([sum(scores[score_type]) for scores in entity_scores])</span>
                <span class="c1">#                      / number_of_entities</span>
                <span class="c1">#                      for score_type in score_types_mean}</span>
                <span class="c1">#     # &#39;predicted_aligned_error&#39; won&#39;t concat correctly, so we average over each residue first</span>
                <span class="c1">#     for scores in entity_scores:</span>
                <span class="c1">#         scores[&#39;predicted_aligned_error&#39;] = scores[&#39;predicted_aligned_error&#39;].mean(axis=-1)</span>
                <span class="c1">#     array_scores = {score_type: np.concatenate([scores[score_type] for scores in entity_scores])</span>
                <span class="c1">#                     for score_type in score_types_concat}</span>
                <span class="c1">#     scalar_scores.update(array_scores)</span>
                <span class="c1">#     logger.debug(f&#39;Found scalar_scores with contents:\n{scalar_scores}&#39;)</span>
                <span class="c1">#     entity_design_scores.append(scalar_scores)</span>

                <span class="c1"># scores = {}</span>
                <span class="n">rmsds</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">design</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sequences</span><span class="p">):</span>
                    <span class="n">entity_pose</span> <span class="o">=</span> <span class="n">entity_design_structures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">asu_model</span> <span class="o">=</span> <span class="n">asu_design_structures</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="c1"># Find the RMSD between each type</span>
                    <span class="n">rmsd</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">superposition3d</span><span class="p">(</span><span class="n">asu_model</span><span class="o">.</span><span class="n">backbone_and_cb_coords</span><span class="p">,</span>
                                                    <span class="n">entity_pose</span><span class="o">.</span><span class="n">backbone_and_cb_coords</span><span class="p">)</span>
                    <span class="c1"># score_deviation[&#39;rmsd&#39;] = rmsd</span>
                    <span class="c1"># scores[design] = score_deviation</span>
                    <span class="c1"># self.log.critical(f&#39;Found rmsd between separated entities and combined pose: {rmsd}&#39;)</span>
                    <span class="n">rmsds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmsd</span><span class="p">)</span>

                <span class="c1"># Compare all folding_scores</span>
                <span class="n">design_deviation_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">predict_designs_df</span> <span class="o">-</span> <span class="n">entity_designs_df</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
                <span class="n">design_deviation_df</span><span class="p">[</span><span class="s1">&#39;rmsd_prediction_deviation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rmsds</span>
                <span class="n">design_deviation_file</span> <span class="o">=</span> \
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">starttime</span><span class="si">}</span><span class="s1">-af_pose-entity-designs-deviation_scores.csv&#39;</span><span class="p">)</span>
                <span class="n">design_deviation_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">design_deviation_file</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Wrote the design deviation file (between separate Entity instances and Pose)&#39;</span>
                            <span class="sa">f</span><span class="s1">&#39; to: </span><span class="si">{</span><span class="n">design_deviation_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">residue_deviation_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">predict_residues_df</span> <span class="o">-</span> <span class="n">entity_residues_df</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
                <span class="n">deviation_file</span> <span class="o">=</span> \
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">starttime</span><span class="si">}</span><span class="s1">-af_pose-entity-residues-deviation_scores.csv&#39;</span><span class="p">)</span>
                <span class="n">residue_deviation_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">deviation_file</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DesignError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.refine" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">refine</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">refine</span><span class="p">(</span><span class="n">to_pose_directory</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">gather_metrics</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">design_files</span><span class="p">:</span> <span class="n">list</span><span class="p">[</span><span class="n"><span title="typing.AnyStr">AnyStr</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">in_file_list</span><span class="p">:</span> <span class="n"><span title="typing.AnyStr">AnyStr</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Refine the PoseJob.pose instance or design Model instances associated with this instance</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>to_pose_directory</code></b>
            (<code>bool</code>, default:
                <code>True</code>
)
        
        <div class="doc-md-description">
          <p>Whether the refinement should be saved to the PoseJob</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>gather_metrics</code></b>
            (<code>bool</code>, default:
                <code>True</code>
)
        
        <div class="doc-md-description">
          <p>Whether metrics should be calculated for the Pose</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>design_files</code></b>
            (<code>list[<span title="typing.AnyStr">AnyStr</span>]</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>A list of files to perform refinement on</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>in_file_list</code></b>
            (<code><span title="typing.AnyStr">AnyStr</span></code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The path to a file containing a list of files to pass to Rosetta refinement</p>
        </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2274</span>
<span class="normal">2275</span>
<span class="normal">2276</span>
<span class="normal">2277</span>
<span class="normal">2278</span>
<span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">refine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_pose_directory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">gather_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
           <span class="n">design_files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">in_file_list</span><span class="p">:</span> <span class="n">AnyStr</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Refine the PoseJob.pose instance or design Model instances associated with this instance</span>

<span class="sd">    Args:</span>
<span class="sd">        to_pose_directory: Whether the refinement should be saved to the PoseJob</span>
<span class="sd">        gather_metrics: Whether metrics should be calculated for the Pose</span>
<span class="sd">        design_files: A list of files to perform refinement on</span>
<span class="sd">        in_file_list: The path to a file containing a list of files to pass to Rosetta refinement</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">main_cmd</span> <span class="o">=</span> <span class="n">rosetta</span><span class="o">.</span><span class="n">script_cmd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">suffix</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">generate_files_cmd</span> <span class="o">=</span> <span class="n">null_cmd</span>
    <span class="k">if</span> <span class="n">to_pose_directory</span><span class="p">:</span>  <span class="c1"># Original protocol to refine a Nanohedra pose</span>
        <span class="n">flag_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scripts_path</span>
        <span class="n">pdb_out_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span>
        <span class="n">refine_pdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refine_pdb</span>
        <span class="n">refined_pdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refined_pdb</span>
        <span class="n">additional_flags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Protocol to refine input structure, place in a common location, then transform for many jobs to source</span>
        <span class="n">flag_dir</span> <span class="o">=</span> <span class="n">pdb_out_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">refine_dir</span>
        <span class="n">refine_pdb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span>
        <span class="n">refined_pdb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pdb_out_path</span><span class="p">,</span> <span class="n">refine_pdb</span><span class="p">)</span>
        <span class="n">additional_flags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-no_scorefile&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">]</span>

    <span class="n">flags_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flag_dir</span><span class="p">,</span> <span class="s1">&#39;flags&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prepare_rosetta_flags</span><span class="p">(</span><span class="n">pdb_out_path</span><span class="o">=</span><span class="n">pdb_out_path</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="n">flag_dir</span><span class="p">)</span>
    <span class="n">putils</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="n">pdb_out_path</span><span class="p">)</span>

    <span class="c1"># Assign designable residues to interface1/interface2 variables, not necessary for non-complexed PDB jobs</span>
    <span class="k">if</span> <span class="n">design_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">in_file_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Run a list of files produced elsewhere</span>
        <span class="n">possible_refine_protocols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;refine&#39;</span><span class="p">,</span> <span class="s1">&#39;thread&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">in</span> <span class="n">possible_refine_protocols</span><span class="p">:</span>
            <span class="n">switch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">switch</span> <span class="o">=</span> <span class="n">putils</span><span class="o">.</span><span class="n">refine</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">switch</span> <span class="o">=</span> <span class="n">putils</span><span class="o">.</span><span class="n">refine</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">refine</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: The requested protocol &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s2">&#39;, wasn&#39;t recognized &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;and is being treated as the standard &#39;</span><span class="si">{</span><span class="n">switch</span><span class="si">}</span><span class="s2">&#39; protocol&quot;</span><span class="p">)</span>

        <span class="c1"># Create file output</span>
        <span class="n">designed_files_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scripts_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">starttime</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">switch</span><span class="si">}</span><span class="s1">_files_output.txt&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">in_file_list</span><span class="p">:</span>
            <span class="n">design_files_file</span> <span class="o">=</span> <span class="n">in_file_list</span>
            <span class="n">generate_files_cmd</span> <span class="o">=</span> \
                <span class="p">[</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">putils</span><span class="o">.</span><span class="n">list_pdb_files</span><span class="p">,</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">designed_files_file</span><span class="p">,</span> <span class="s1">&#39;-e&#39;</span><span class="p">,</span> <span class="s1">&#39;.pdb&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">switch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">design_files</span><span class="p">:</span>
            <span class="n">design_files_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scripts_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">starttime</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s1">_files.txt&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">design_files_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">design_files</span><span class="p">))</span>
            <span class="c1"># Write the designed_files_file with all &quot;tentatively&quot; designed file paths</span>
            <span class="n">out_file_string</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;%s</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="n">pdb_out_path</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s1">%s&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">designed_files_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pdb_out_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
                                           <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">design_files</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t run </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">refine</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> without passing parameter &#39;design_files&#39; or &#39;in_file_list&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># -in:file:native is here to block flag file version, not actually useful for refine</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-in:file:l&#39;</span><span class="p">,</span> <span class="n">design_files_file</span><span class="p">,</span> <span class="s1">&#39;-in:file:native&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span><span class="p">]</span>
        <span class="n">metrics_pdb</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-in:file:l&#39;</span><span class="p">,</span> <span class="n">designed_files_file</span><span class="p">,</span> <span class="s1">&#39;-in:file:native&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span><span class="p">]</span>
        <span class="c1"># generate_files_cmdline = [list2cmdline(generate_files_cmd)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">switch</span> <span class="o">=</span> <span class="n">putils</span><span class="o">.</span><span class="n">refine</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">interface_to_alanine</span><span class="p">:</span>  <span class="c1"># Mutate all design positions to Ala before the Refinement</span>
            <span class="c1"># Ensure the mutations to the pose are wiped</span>
            <span class="n">pose_copy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;In </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">refine</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">, ensure that the pose was copied correctly before &#39;</span>
                              <span class="s1">&#39;trusting output. The residue in mutate_residue() should be equal after the copy... &#39;</span>
                              <span class="s1">&#39;Delete this log if everything checks out&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">entity_pair</span><span class="p">,</span> <span class="n">interface_residues_pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">interface_residues_by_entity_pair</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># if interface_residues_pair[0]:  # Check that there are residues present</span>
                <span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">interface_residues</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">entity_pair</span><span class="p">,</span> <span class="n">interface_residues_pair</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">interface_residues</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">residue</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;GLY&#39;</span><span class="p">:</span>  <span class="c1"># No mutation from GLY to ALA as Rosetta would build a CB</span>
                            <span class="n">pose_copy</span><span class="o">.</span><span class="n">mutate_residue</span><span class="p">(</span><span class="n">residue</span><span class="o">=</span><span class="n">residue</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
            <span class="c1"># Change the name to reflect mutation so the self.pose_path isn&#39;t overwritten</span>
            <span class="n">refine_pdb</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">refine_pdb</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">_ala_mutant.pdb&#39;</span>
        <span class="c1"># else:  # Do nothing and refine the source</span>
        <span class="c1">#     pass</span>

        <span class="c1"># # Set up self.refined_pdb by using a suffix</span>
        <span class="c1"># suffix = [&#39;-out:suffix&#39;, f&#39;_{switch}&#39;]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out_path</span><span class="o">=</span><span class="n">refine_pdb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Cleaned PDB for </span><span class="si">{</span><span class="n">switch</span><span class="si">}</span><span class="s1">: &quot;</span><span class="si">{</span><span class="n">refine_pdb</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="c1"># -in:file:native is here to block flag file version, not actually useful for refine</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-in:file:s&#39;</span><span class="p">,</span> <span class="n">refine_pdb</span><span class="p">,</span> <span class="s1">&#39;-in:file:native&#39;</span><span class="p">,</span> <span class="n">refine_pdb</span><span class="p">]</span>
        <span class="n">metrics_pdb</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-in:file:s&#39;</span><span class="p">,</span> <span class="n">refined_pdb</span><span class="p">,</span> <span class="s1">&#39;-in:file:native&#39;</span><span class="p">,</span> <span class="n">refine_pdb</span><span class="p">]</span>

    <span class="c1"># RELAX: Prepare command</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_dimension</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_dimension</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">symmetry_definition</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-symmetry_definition&#39;</span><span class="p">,</span> <span class="s1">&#39;CRYST1&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">symmetry_definition</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># &#39;-no_nstruct_label&#39;, &#39;true&#39; comes from v</span>
    <span class="n">relax_cmd</span> <span class="o">=</span> <span class="n">main_cmd</span> <span class="o">+</span> <span class="n">rosetta</span><span class="o">.</span><span class="n">relax_flags_cmdline</span> <span class="o">+</span> <span class="n">additional_flags</span> <span class="o">+</span> <span class="n">symmetry_definition</span> \
        <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;@</span><span class="si">{</span><span class="n">flags_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;-parser:protocol&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">putils</span><span class="o">.</span><span class="n">rosetta_scripts_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;refine.xml&#39;</span><span class="p">),</span>
           <span class="s1">&#39;-parser:script_vars&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;switch=</span><span class="si">{</span><span class="n">switch</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">infile</span> <span class="o">+</span> <span class="n">suffix</span> \
        <span class="o">+</span> <span class="p">([</span><span class="s1">&#39;-overwrite&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">overwrite</span> <span class="k">else</span> <span class="p">[])</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">switch</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s1"> Command: </span><span class="si">{</span><span class="n">list2cmdline</span><span class="p">(</span><span class="n">relax_cmd</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">gather_metrics</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">metrics</span><span class="p">:</span>
        <span class="n">gather_metrics</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">mpi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">main_cmd</span> <span class="o">=</span> <span class="n">rosetta</span><span class="o">.</span><span class="n">run_cmds</span><span class="p">[</span><span class="n">putils</span><span class="o">.</span><span class="n">rosetta_extras</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">mpi</span><span class="p">)]</span> <span class="o">+</span> <span class="n">main_cmd</span>
        <span class="c1"># main_cmd += metrics_pdb</span>
        <span class="n">main_cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;@</span><span class="si">{</span><span class="n">flags_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;-out:file:score_only&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores_file</span><span class="p">,</span>
                     <span class="s1">&#39;-no_nstruct_label&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">metrics_pdb</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;-parser:protocol&#39;</span><span class="p">]</span>
        <span class="n">dev_label</span> <span class="o">=</span> <span class="s1">&#39;_DEV&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">development</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">metric_cmd_bound</span> <span class="o">=</span> <span class="n">main_cmd</span> \
            <span class="o">+</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">putils</span><span class="o">.</span><span class="n">rosetta_scripts_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;interface_metrics</span><span class="si">{</span><span class="n">dev_label</span><span class="si">}</span><span class="s1">.xml&#39;</span><span class="p">)]</span> \
            <span class="o">+</span> <span class="n">symmetry_definition</span>
        <span class="n">entity_cmd</span> <span class="o">=</span> <span class="n">main_cmd</span> <span class="o">+</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">putils</span><span class="o">.</span><span class="n">rosetta_scripts_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;metrics_entity</span><span class="si">{</span><span class="n">dev_label</span><span class="si">}</span><span class="s1">.xml&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Metrics command for Pose: </span><span class="si">{</span><span class="n">list2cmdline</span><span class="p">(</span><span class="n">metric_cmd_bound</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">metric_cmds</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric_cmd_bound</span><span class="p">]</span> \
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_entity_metrics_commands</span><span class="p">(</span><span class="n">entity_cmd</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metric_cmds</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Create executable/Run FastRelax on Clean ASU with RosettaScripts</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">distribute_work</span><span class="p">:</span>
        <span class="n">analysis_cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cmd_process_rosetta_metrics</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_script</span> <span class="o">=</span> <span class="n">distribute</span><span class="o">.</span><span class="n">write_script</span><span class="p">(</span>
            <span class="n">list2cmdline</span><span class="p">(</span><span class="n">relax_cmd</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">starttime</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s1">.sh&#39;</span><span class="p">,</span> <span class="n">out_path</span><span class="o">=</span><span class="n">flag_dir</span><span class="p">,</span>
            <span class="n">additional</span><span class="o">=</span><span class="p">[</span><span class="n">list2cmdline</span><span class="p">(</span><span class="n">generate_files_cmd</span><span class="p">)]</span>
            <span class="o">+</span> <span class="p">[</span><span class="n">list2cmdline</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">metric_cmds</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">list2cmdline</span><span class="p">(</span><span class="n">analysis_cmd</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">relax_process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">relax_cmd</span><span class="p">)</span>
        <span class="n">relax_process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>  <span class="c1"># Wait for command to complete</span>
        <span class="n">list_all_files_process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">generate_files_cmd</span><span class="p">)</span>
        <span class="n">list_all_files_process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">gather_metrics</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">metric_cmd</span> <span class="ow">in</span> <span class="n">metric_cmds</span><span class="p">:</span>
                <span class="n">metrics_process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">metric_cmd</span><span class="p">)</span>
                <span class="n">metrics_process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

            <span class="c1"># Gather metrics for each design produced from this procedure</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores_file</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_rosetta_metrics</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.rosetta_interface_design" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">rosetta_interface_design</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">rosetta_interface_design</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>For the basic process of sequence design between two halves of an interface, write the necessary files for
refinement (FastRelax), redesign (FastDesign), and metrics collection (Filters &amp; SimpleMetrics)</p>
<p>Stores job variables in a [stage]_flags file and the command in a [stage].sh file. Sets up dependencies based
on the PoseJob</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span>
<span class="normal">2465</span>
<span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">rosetta_interface_design</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For the basic process of sequence design between two halves of an interface, write the necessary files for</span>
<span class="sd">    refinement (FastRelax), redesign (FastDesign), and metrics collection (Filters &amp; SimpleMetrics)</span>

<span class="sd">    Stores job variables in a [stage]_flags file and the command in a [stage].sh file. Sets up dependencies based</span>
<span class="sd">    on the PoseJob</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;There are multiple outdated dependencies that need to be updated to use Rosetta </span><span class="si">{</span><span class="n">flags</span><span class="o">.</span><span class="n">interface_design</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="sa">f</span><span class="s1">&#39;with modern </span><span class="si">{</span><span class="n">putils</span><span class="o">.</span><span class="n">program_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># Todo</span>
    <span class="c1">#  Modify the way that files are generated/named and later listed for metrics. Right now, reliance on the file</span>
    <span class="c1">#  suffix to get this right, but with the database, this is not needed and will result in inaccurate use</span>
    <span class="c1"># Set up the command base (rosetta bin and database paths)</span>
    <span class="n">main_cmd</span> <span class="o">=</span> <span class="n">rosetta</span><span class="o">.</span><span class="n">script_cmd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_dimension</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">symmetry_dimension</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">main_cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;-symmetry_definition&#39;</span><span class="p">,</span> <span class="s1">&#39;CRYST1&#39;</span><span class="p">]</span>

    <span class="c1"># Todo - Has this been solved?</span>
    <span class="c1">#  must set up a blank -in:file:pssm in case the evolutionary matrix is not used. Design will fail!!</span>
    <span class="n">profile_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-in:file:pssm&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">evolutionary_profile_file</span><span class="p">]</span> \
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evolutionary_profile_file</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="n">additional_cmds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">design_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scripts_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">starttime</span><span class="si">}</span><span class="s1">_design-files_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s1">.txt&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">scout</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol_xml1</span> <span class="o">=</span> <span class="n">putils</span><span class="o">.</span><span class="n">scout</span>
        <span class="c1"># metrics_pdb = [&#39;-in:file:s&#39;, self.scouted_pdb]</span>
        <span class="n">generate_files_cmd</span> <span class="o">=</span> \
            <span class="p">[</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">putils</span><span class="o">.</span><span class="n">list_pdb_files</span><span class="p">,</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">design_files</span><span class="p">,</span> <span class="s1">&#39;-e&#39;</span><span class="p">,</span> <span class="s1">&#39;.pdb&#39;</span><span class="p">,</span>
             <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">metrics_pdb</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-in:file:l&#39;</span><span class="p">,</span> <span class="n">design_files</span><span class="p">]</span>
        <span class="c1"># metrics_flags = &#39;repack=no&#39;</span>
        <span class="n">nstruct_instruct</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-no_nstruct_label&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">generate_files_cmd</span> <span class="o">=</span> \
            <span class="p">[</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">putils</span><span class="o">.</span><span class="n">list_pdb_files</span><span class="p">,</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">design_files</span><span class="p">,</span> <span class="s1">&#39;-e&#39;</span><span class="p">,</span> <span class="s1">&#39;.pdb&#39;</span><span class="p">,</span>
             <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">metrics_pdb</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-in:file:l&#39;</span><span class="p">,</span> <span class="n">design_files</span><span class="p">]</span>
        <span class="c1"># metrics_flags = &#39;repack=yes&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">structure_background</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol_xml1</span> <span class="o">=</span> <span class="n">putils</span><span class="o">.</span><span class="n">structure_background</span>
            <span class="n">nstruct_instruct</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-nstruct&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">number</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">hbnet</span><span class="p">:</span>  <span class="c1"># Run hbnet_design_profile protocol</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">protocol_xml1</span> <span class="o">=</span> <span class="n">putils</span><span class="o">.</span><span class="n">hbnet_design_profile</span><span class="p">,</span> <span class="s1">&#39;hbnet_scout&#39;</span>
            <span class="n">nstruct_instruct</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-no_nstruct_label&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">]</span>
            <span class="c1"># Set up an additional command to perform interface design on hydrogen bond network from hbnet_scout</span>
            <span class="n">additional_cmds</span> <span class="o">=</span> \
                <span class="p">[[</span><span class="n">putils</span><span class="o">.</span><span class="n">hbnet_sort</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;hbnet_silent.o&#39;</span><span class="p">),</span>
                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">number</span><span class="p">)]]</span> \
                <span class="o">+</span> <span class="p">[</span><span class="n">main_cmd</span> <span class="o">+</span> <span class="n">profile_cmd</span>
                   <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;-in:file:silent&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;hbnet_selected.o&#39;</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;-in:file:silent_struct_type&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>  <span class="c1"># &#39;-out:suffix&#39;, f&#39;_{self.protocol}&#39;,</span>
                      <span class="c1"># adding no_nstruct_label true as only hbnet uses this mechanism</span>
                      <span class="c1"># hbnet_design_profile.xml could be just design_profile.xml</span>
                      <span class="s1">&#39;-parser:protocol&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">putils</span><span class="o">.</span><span class="n">rosetta_scripts_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s1">.xml&#39;</span><span class="p">)]</span> \
                   <span class="o">+</span> <span class="n">nstruct_instruct</span><span class="p">]</span>
            <span class="c1"># Set up additional out_file</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-out:file:silent&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;hbnet_silent.o&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;-out:file:silent_struct_type&#39;</span><span class="p">,</span> <span class="s1">&#39;binary&#39;</span><span class="p">]</span>
            <span class="c1"># silent_file = os.path.join(self.data_path, &#39;hbnet_silent.o&#39;)</span>
            <span class="c1"># additional_commands = \</span>
            <span class="c1">#     [</span>
            <span class="c1">#      # [&#39;grep&#39;, &#39;^SCORE&#39;, silent_file, &#39;&gt;&#39;, os.path.join(self.data_path, &#39;hbnet_scores.sc&#39;)],</span>
            <span class="c1">#      main_cmd + [os.path.join(self.data_path, &#39;hbnet_selected.o&#39;)]</span>
            <span class="c1">#      [os.path.join(self.data_path, &#39;hbnet_selected.tags&#39;)]</span>
            <span class="c1">#     ]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Run the legacy protocol</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol_xml1</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="n">interface_design</span>
            <span class="n">nstruct_instruct</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-nstruct&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">number</span><span class="p">)]</span>

    <span class="c1"># DESIGN: Prepare command and flags file</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">prepare_rosetta_flags</span><span class="p">(</span><span class="n">out_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scripts_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">putils</span><span class="o">.</span><span class="n">consensus</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">putils</span><span class="o">.</span><span class="n">consensus</span>
        <span class="n">design_cmd</span> <span class="o">=</span> <span class="n">main_cmd</span> <span class="o">+</span> <span class="n">rosetta</span><span class="o">.</span><span class="n">relax_flags_cmdline</span> \
            <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;-in:file:s&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">consensus_pdb</span><span class="p">,</span>
               <span class="c1"># &#39;-in:file:native&#39;, self.refined_pdb,</span>
               <span class="s1">&#39;-parser:protocol&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">putils</span><span class="o">.</span><span class="n">rosetta_scripts_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;consensus.xml&#39;</span><span class="p">),</span>
               <span class="s1">&#39;-out:suffix&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;-parser:script_vars&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;switch=</span><span class="si">{</span><span class="n">putils</span><span class="o">.</span><span class="n">consensus</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">design_cmd</span> <span class="o">=</span> <span class="n">main_cmd</span> <span class="o">+</span> <span class="n">profile_cmd</span> <span class="o">+</span> \
            <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;-in:file:s&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refined_pdb</span><span class="p">,</span>
             <span class="c1"># self.scouted_pdb if os.path.exists(self.scouted_pdb) else self.refined_pdb,</span>
             <span class="s1">&#39;-parser:protocol&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">putils</span><span class="o">.</span><span class="n">rosetta_scripts_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">protocol_xml1</span><span class="si">}</span><span class="s1">.xml&#39;</span><span class="p">),</span>
             <span class="s1">&#39;-out:suffix&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">out_file</span> <span class="o">+</span> <span class="n">nstruct_instruct</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
        <span class="n">design_cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;-overwrite&#39;</span><span class="p">]</span>

    <span class="c1"># METRICS: Can remove if SimpleMetrics adopts pose metric caching and restoration</span>
    <span class="c1"># Assumes all entity chains are renamed from A to Z for entities (1 to n)</span>
    <span class="n">entity_cmd</span> <span class="o">=</span> <span class="n">rosetta</span><span class="o">.</span><span class="n">script_cmd</span> <span class="o">+</span> <span class="n">metrics_pdb</span> <span class="o">+</span> \
        <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;-out:file:score_only&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores_file</span><span class="p">,</span> <span class="s1">&#39;-no_nstruct_label&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
         <span class="s1">&#39;-parser:protocol&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">putils</span><span class="o">.</span><span class="n">rosetta_scripts_dir</span><span class="p">,</span> <span class="s1">&#39;metrics_entity.xml&#39;</span><span class="p">)]</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">mpi</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">scout</span><span class="p">:</span>
        <span class="n">design_cmd</span> <span class="o">=</span> <span class="n">rosetta</span><span class="o">.</span><span class="n">run_cmds</span><span class="p">[</span><span class="n">putils</span><span class="o">.</span><span class="n">rosetta_extras</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">mpi</span><span class="p">)]</span> <span class="o">+</span> <span class="n">design_cmd</span>
        <span class="n">entity_cmd</span> <span class="o">=</span> <span class="n">rosetta</span><span class="o">.</span><span class="n">run_cmds</span><span class="p">[</span><span class="n">putils</span><span class="o">.</span><span class="n">rosetta_extras</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">mpi</span><span class="p">)]</span> <span class="o">+</span> <span class="n">entity_cmd</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rosetta_interface_design</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> command: </span><span class="si">{</span><span class="n">list2cmdline</span><span class="p">(</span><span class="n">design_cmd</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">metric_cmds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_entity_metrics_commands</span><span class="p">(</span><span class="n">entity_cmd</span><span class="p">)</span>

    <span class="c1"># Create executable/Run FastDesign on Refined ASU with RosettaScripts. Then, gather Metrics</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">distribute_work</span><span class="p">:</span>
        <span class="n">analysis_cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cmd_process_rosetta_metrics</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_script</span> <span class="o">=</span> <span class="n">distribute</span><span class="o">.</span><span class="n">write_script</span><span class="p">(</span>
            <span class="n">list2cmdline</span><span class="p">(</span><span class="n">design_cmd</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">starttime</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">out_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scripts_path</span><span class="p">,</span>
            <span class="n">additional</span><span class="o">=</span><span class="p">[</span><span class="n">list2cmdline</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">additional_cmds</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">[</span><span class="n">list2cmdline</span><span class="p">(</span><span class="n">generate_files_cmd</span><span class="p">)]</span>
            <span class="o">+</span> <span class="p">[</span><span class="n">list2cmdline</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">metric_cmds</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">list2cmdline</span><span class="p">(</span><span class="n">analysis_cmd</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">design_process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">design_cmd</span><span class="p">)</span>
        <span class="n">design_process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>  <span class="c1"># Wait for command to complete</span>
        <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">additional_cmds</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="n">list_all_files_process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">generate_files_cmd</span><span class="p">)</span>
        <span class="n">list_all_files_process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">metric_cmd</span> <span class="ow">in</span> <span class="n">metric_cmds</span><span class="p">:</span>
            <span class="n">metrics_process</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">metric_cmd</span><span class="p">)</span>
            <span class="n">metrics_process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>

        <span class="c1"># Gather metrics for each design produced from this procedure</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores_file</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_rosetta_metrics</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.proteinmpnn_design" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">proteinmpnn_design</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">proteinmpnn_design</span><span class="p">(</span><span class="n">interface</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Perform design based on the ProteinMPNN graph encoder/decoder network</p>

<details class="sets" open>
  <summary>Sets</summary>
  <p>self.protocol = 'proteinmpnn'</p>
</details>


  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>interface</code></b>
            (<code>bool</code>, default:
                <code>False</code>
)
        
        <div class="doc-md-description">
          <p>Whether to only specify the interface as designable, otherwise, use all residues</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>neighbors</code></b>
            (<code>bool</code>, default:
                <code>False</code>
)
        
        <div class="doc-md-description">
          <p>Whether to design interface neighbors</p>
        </div>
      </li>
  </ul>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
            <code>None</code>
        
        <div class="doc-md-description">
          <p>None</p>
      </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">proteinmpnn_design</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform design based on the ProteinMPNN graph encoder/decoder network</span>

<span class="sd">    Sets:</span>
<span class="sd">        self.protocol = &#39;proteinmpnn&#39;</span>

<span class="sd">    Args:</span>
<span class="sd">        interface: Whether to only specify the interface as designable, otherwise, use all residues</span>
<span class="sd">        neighbors: Whether to design interface neighbors</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">putils</span><span class="o">.</span><span class="n">proteinmpnn</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s1"> design calculation with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s1"> &#39;</span>
                  <span class="sa">f</span><span class="s1">&#39;designs over each of the temperatures: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">temperatures</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># design_start = time.time()</span>
    <span class="n">sequences_and_scores</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> \
        <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">design_sequences</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">number</span><span class="p">,</span>
                                   <span class="n">temperatures</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">temperatures</span><span class="p">,</span>
                                   <span class="c1"># interface=interface, neighbors=neighbors,</span>
                                   <span class="n">interface</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">interface</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">neighbors</span><span class="p">,</span>
                                   <span class="n">ca_only</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">ca_only</span><span class="p">,</span>
                                   <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">proteinmpnn_model</span>
                                   <span class="p">)</span>
    <span class="c1"># self.log.debug(f&quot;Took {time.time() - design_start:8f}s for design_sequences&quot;)</span>

    <span class="c1"># self.output_proteinmpnn_scores(design_names, sequences_and_scores)</span>
    <span class="c1"># # Write every designed sequence to the sequences file...</span>
    <span class="c1"># write_sequences(sequences_and_scores[&#39;sequences&#39;], names=design_names, file_name=self.designed_sequences_file)</span>
    <span class="c1"># Convert sequences to a plain string sequence representation</span>
    <span class="n">sequences_and_scores</span><span class="p">[</span><span class="s1">&#39;sequences&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">sequences_and_scores</span><span class="p">[</span><span class="s1">&#39;sequences&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>

    <span class="c1"># Add protocol (job info) and temperature to sequences_and_scores</span>
    <span class="c1"># number_of_new_designs = len(designs_metadata)</span>
    <span class="c1"># sequences_and_scores[putils.protocol] = list(repeat(self.protocol, len(designs_metadata)))</span>
    <span class="c1"># sequences_and_scores[&#39;temperatures&#39;] = [temperature for temperature in self.job.design.temperatures</span>
    <span class="c1"># protocols = list(repeat(self.protocol, len(designs_metadata)))</span>
    <span class="n">temperatures</span> <span class="o">=</span> <span class="p">[</span><span class="n">temperature</span> <span class="k">for</span> <span class="n">temperature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">temperatures</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">number</span><span class="p">)]</span>

    <span class="c1"># # Write every designed sequence to an individual file...</span>
    <span class="c1"># putils.make_path(self.designs_path)</span>
    <span class="c1"># design_names = [design_data.name for design_data in designs_data]</span>
    <span class="c1"># sequence_files = [</span>
    <span class="c1">#     write_sequences(sequence, names=name, file_name=os.path.join(self.designs_path, name))</span>
    <span class="c1">#     for name, sequence in zip(design_names, sequences_and_scores[&#39;sequences&#39;])</span>
    <span class="c1"># ]</span>

    <span class="c1"># Update the Pose with the number of designs</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">designs_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_design_data</span><span class="p">(</span><span class="n">design_parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_source</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">designs_data</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">design_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">design_data</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">design_data</span> <span class="ow">in</span> <span class="n">designs_data</span><span class="p">]</span>

        <span class="c1"># Update the Pose with the design protocols</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">design_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">designs_data</span><span class="p">):</span>
            <span class="n">design_data</span><span class="o">.</span><span class="n">protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">sql</span><span class="o">.</span><span class="n">DesignProtocol</span><span class="p">(</span><span class="n">design</span><span class="o">=</span><span class="n">design_data</span><span class="p">,</span>
                                   <span class="n">job_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                   <span class="c1"># design_id=design_ids[idx],</span>
                                   <span class="n">protocol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span>
                                   <span class="n">temperature</span><span class="o">=</span><span class="n">temperatures</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                                   <span class="p">))</span>

        <span class="c1"># analysis_start = time.time()</span>
        <span class="n">designs_df</span><span class="p">,</span> <span class="n">residues_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_proteinmpnn_metrics</span><span class="p">(</span><span class="n">design_ids</span><span class="p">,</span> <span class="n">sequences_and_scores</span><span class="p">)</span>
        <span class="n">entity_designs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_design_entities_per_residue</span><span class="p">(</span><span class="n">residues_df</span><span class="p">)</span>
        <span class="n">sql</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">entity_designs</span><span class="o">=</span><span class="n">entity_designs_df</span><span class="p">)</span>

        <span class="c1"># self.log.debug(f&quot;Took {time.time() - analysis_start:8f}s for analyze_proteinmpnn_metrics. &quot;</span>
        <span class="c1">#                f&quot;{time.time() - design_start:8f}s total&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">designs</span><span class="o">=</span><span class="n">designs_df</span><span class="p">)</span>
        <span class="n">output_residues</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">output_residues</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">residues</span><span class="o">=</span><span class="n">residues_df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Only save the &#39;design_residue&#39; columns</span>
            <span class="n">residues_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="n">sql</span><span class="o">.</span><span class="n">DesignResidues</span><span class="o">.</span><span class="n">design_residue</span><span class="o">.</span><span class="n">name</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">design_residues</span><span class="o">=</span><span class="n">residues_df</span><span class="p">)</span>
        <span class="c1"># Commit the newly acquired metrics</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.update_design_protocols" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">update_design_protocols</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">update_design_protocols</span><span class="p">(</span><span class="n">design_ids</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n">str</span><span class="p">],</span> <span class="n">protocols</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">temperatures</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">files</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="typing.AnyStr">AnyStr</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="p">[</span><span class="n"><span title="symdesign.resources.sql.DesignProtocol">DesignProtocol</span></span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Associate newly created DesignData with DesignProtocol</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>design_ids</code></b>
            (<code><span title="collections.abc.Sequence">Sequence</span>[str]</code>)
        
        <div class="doc-md-description">
          <p>The identifiers for each DesignData</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>protocols</code></b>
            (<code><span title="collections.abc.Sequence">Sequence</span>[str]</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The sequence of protocols to associate with DesignProtocol</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>temperatures</code></b>
            (<code><span title="collections.abc.Sequence">Sequence</span>[float]</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The temperatures to associate with DesignProtocol</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>files</code></b>
            (<code><span title="collections.abc.Sequence">Sequence</span>[<span title="typing.AnyStr">AnyStr</span>]</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The sequence of files to associate with DesignProtocol</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    The new instances of the sql.DesignProtocol</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_design_protocols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">design_ids</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">protocols</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">temperatures</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">files</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">sql</span><span class="o">.</span><span class="n">DesignProtocol</span><span class="p">]:</span>  <span class="c1"># Unused</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Associate newly created DesignData with DesignProtocol</span>

<span class="sd">    Args:</span>
<span class="sd">        design_ids: The identifiers for each DesignData</span>
<span class="sd">        protocols: The sequence of protocols to associate with DesignProtocol</span>
<span class="sd">        temperatures: The temperatures to associate with DesignProtocol</span>
<span class="sd">        files: The sequence of files to associate with DesignProtocol</span>
<span class="sd">    Returns:</span>
<span class="sd">        The new instances of the sql.DesignProtocol</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">sql</span><span class="o">.</span><span class="n">DesignProtocol</span><span class="p">(</span>
        <span class="n">design_id</span><span class="o">=</span><span class="n">design_id</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">design_id</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">design_ids</span><span class="p">,</span> <span class="n">protocols</span><span class="p">,</span> <span class="n">temperatures</span><span class="p">,</span> <span class="n">files</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">metadata</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.update_design_data" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">update_design_data</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">update_design_data</span><span class="p">(</span><span class="n">design_parent</span><span class="p">:</span> <span class="n"><span title="symdesign.resources.sql.DesignData">DesignData</span></span><span class="p">,</span> <span class="n">number</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="p">[</span><span class="n"><span title="symdesign.resources.sql.DesignData">DesignData</span></span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Updates the PoseData with newly created design identifiers using DesignData</p>

<details class="sets" open>
  <summary>Sets</summary>
  <p>self.current_designs (list[DesignData]): Extends with the newly created DesignData instances</p>
</details>


  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>design_parent</code></b>
            (<code><span title="symdesign.resources.sql.DesignData">DesignData</span></code>)
        
        <div class="doc-md-description">
          <p>The design whom all new designs are based</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>number</code></b>
            (<code>int</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The number of designs. If not provided, set according to job.design.number * job.design.temperature</p>
        </div>
      </li>
  </ul>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
            <code>list[<span title="symdesign.resources.sql.DesignData">DesignData</span>]</code>
        
        <div class="doc-md-description">
          <p>The new instances of the DesignData</p>
      </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_design_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">design_parent</span><span class="p">:</span> <span class="n">sql</span><span class="o">.</span><span class="n">DesignData</span><span class="p">,</span> <span class="n">number</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">sql</span><span class="o">.</span><span class="n">DesignData</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Updates the PoseData with newly created design identifiers using DesignData</span>

<span class="sd">    Sets:</span>
<span class="sd">        self.current_designs (list[DesignData]): Extends with the newly created DesignData instances</span>

<span class="sd">    Args:</span>
<span class="sd">        design_parent: The design whom all new designs are based</span>
<span class="sd">        number: The number of designs. If not provided, set according to job.design.number * job.design.temperature</span>

<span class="sd">    Returns:</span>
<span class="sd">        The new instances of the DesignData</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">number</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">number</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">temperatures</span><span class="p">)</span>

    <span class="n">first_new_design_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_designs</span>  <span class="c1"># + 1 &lt;- don&#39;t add 1 since the first design is .pose_source</span>
    <span class="c1"># design_names = [f&#39;{self.protocol}{seq_idx:04d}&#39;  # f&#39;{self.name}_{self.protocol}{seq_idx:04d}&#39;</span>
    <span class="n">design_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">design_idx</span><span class="si">:</span><span class="s1">04d</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">for</span> <span class="n">design_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">first_new_design_idx</span><span class="p">,</span> <span class="n">first_new_design_idx</span> <span class="o">+</span> <span class="n">number</span><span class="p">)]</span>
    <span class="n">designs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sql</span><span class="o">.</span><span class="n">DesignData</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">pose_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">design_parent</span><span class="o">=</span><span class="n">design_parent</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">design_names</span><span class="p">]</span>
    <span class="c1"># Set the PoseJob.current_designs for access by subsequent functions/protocols</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_designs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">designs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">designs</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.output_metrics" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">output_metrics</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n"><span title="sqlalchemy.orm.Session">Session</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">designs</span><span class="p">:</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">design_residues</span><span class="p">:</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">residues</span><span class="p">:</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pose_metrics</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Format each possible DataFrame type for output via csv or SQL database</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>session</code></b>
            (<code><span title="sqlalchemy.orm.Session">Session</span></code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>A currently open transaction within sqlalchemy</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>designs</code></b>
            (<code><span title="pandas.DataFrame">DataFrame</span></code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The typical per-design metric DataFrame where each index is the design id and the columns are
design metrics</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>design_residues</code></b>
            (<code><span title="pandas.DataFrame">DataFrame</span></code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The typical per-residue metric DataFrame where each index is the design id and the columns
are (residue index, Boolean for design utilization)</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>residues</code></b>
            (<code><span title="pandas.DataFrame">DataFrame</span></code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The typical per-residue metric DataFrame where each index is the design id and the columns are
(residue index, residue metric)</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>pose_metrics</code></b>
            (<code>bool</code>, default:
                <code>False</code>
)
        
        <div class="doc-md-description">
          <p>Whether the metrics being included are based on Pose (self.pose) measurements</p>
        </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">output_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">designs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">design_residues</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">residues</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pose_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format each possible DataFrame type for output via csv or SQL database</span>

<span class="sd">    Args:</span>
<span class="sd">        session: A currently open transaction within sqlalchemy</span>
<span class="sd">        designs: The typical per-design metric DataFrame where each index is the design id and the columns are</span>
<span class="sd">            design metrics</span>
<span class="sd">        design_residues: The typical per-residue metric DataFrame where each index is the design id and the columns</span>
<span class="sd">            are (residue index, Boolean for design utilization)</span>
<span class="sd">        residues: The typical per-residue metric DataFrame where each index is the design id and the columns are</span>
<span class="sd">            (residue index, residue metric)</span>
<span class="sd">        pose_metrics: Whether the metrics being included are based on Pose (self.pose) measurements</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Remove completely empty columns</span>
    <span class="k">if</span> <span class="n">designs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">designs</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">residues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">residues</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">designs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># design_index_names = [&#39;pose&#39;, &#39;design&#39;]</span>
            <span class="c1"># These are reliant on foreign keys...</span>
            <span class="c1"># design_index_names = [sql.DesignMetrics.pose_id.name, sql.DesignMetrics.name.name]</span>
            <span class="c1"># designs = pd.concat([designs], keys=[pose_identifier], axis=0)</span>
            <span class="c1"># design_index_names = [sql.DesignMetrics.pose_id.name, sql.DesignMetrics.design_id.name]</span>
            <span class="c1"># designs = pd.concat([designs], keys=[pose_identifier], axis=0)</span>
            <span class="c1"># #                     names=design_index_names, axis=0)</span>
            <span class="c1"># designs.index.set_names(design_index_names, inplace=True)</span>
            <span class="n">designs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">DesignMetrics</span><span class="o">.</span><span class="n">design_id</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># _design_ids = metrics.sql.write_dataframe(session, designs=designs)</span>
            <span class="n">sql</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">designs</span><span class="o">=</span><span class="n">designs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">residues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># residue_index_names = [&#39;pose&#39;, &#39;design&#39;]</span>
            <span class="c1"># These are reliant on foreign keys...</span>
            <span class="c1"># residue_index_names = [sql.ResidueMetrics.pose_id.name, sql.ResidueMetrics.design_id.name, sql.ResidueMetrics.design_name.name]</span>
            <span class="c1"># residues = pd.concat([residues], keys=list(zip(repeat(pose_identifier), _design_ids)), axis=0)</span>
            <span class="c1"># residue_index_names = [sql.ResidueMetrics.pose_id.name, sql.ResidueMetrics.design_id.name]</span>
            <span class="c1"># residues = pd.concat([residues], keys=[pose_identifier], axis=0)</span>
            <span class="c1"># #                      names=residue_index_names, axis=0)</span>
            <span class="c1"># residues.index.set_names(residue_index_names, inplace=True)</span>
            <span class="k">if</span> <span class="n">pose_metrics</span><span class="p">:</span>
                <span class="n">index_name</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">PoseResidueMetrics</span><span class="o">.</span><span class="n">pose_id</span><span class="o">.</span><span class="n">name</span>
                <span class="n">dataframe_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pose_residues</span><span class="o">=</span><span class="n">residues</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index_name</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">ResidueMetrics</span><span class="o">.</span><span class="n">design_id</span><span class="o">.</span><span class="n">name</span>
                <span class="n">dataframe_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">residues</span><span class="o">=</span><span class="n">residues</span><span class="p">)</span>

            <span class="n">residues</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">index_name</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sql</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="o">**</span><span class="n">dataframe_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">design_residues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">design_residues</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_names</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">ResidueMetrics</span><span class="o">.</span><span class="n">design_id</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sql</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">design_residues</span><span class="o">=</span><span class="n">design_residues</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">putils</span><span class="o">.</span><span class="n">make_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">residues</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Process dataframes for missing values NOT USED with SQL...</span>
            <span class="n">residues</span> <span class="o">=</span> <span class="n">residues</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
            <span class="n">residues</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">residues</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_remaining</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># residue_metric_columns = residues.columns.levels[-1].tolist()</span>
            <span class="c1"># self.log.debug(f&#39;Residues metrics present: {residue_metric_columns}&#39;)</span>

            <span class="n">residues</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residues_metrics_csv</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wrote Residues metrics to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">residues_metrics_csv</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">designs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">designs</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># designs_metric_columns = designs.columns.tolist()</span>
            <span class="c1"># self.log.debug(f&#39;Designs metrics present: {designs_metric_columns}&#39;)</span>

            <span class="c1"># if self.job.merge:</span>
            <span class="c1">#     designs_df = pd.concat([designs_df], axis=1, keys=[&#39;metrics&#39;])</span>
            <span class="c1">#     designs_df = pd.merge(designs_df, residues_df, left_index=True, right_index=True)</span>
            <span class="c1"># else:</span>
            <span class="n">designs</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">designs_metrics_csv</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Wrote Designs metrics to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">designs_metrics_csv</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.parse_rosetta_scores" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">parse_rosetta_scores</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">parse_rosetta_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">:</span> <span class="n">dict</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="n">dict</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="n">str</span> <span class="o">|</span> <span class="n">int</span> <span class="o">|</span> <span class="n">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">tuple</span><span class="p">[</span><span class="n"><span title="pandas.DataFrame">DataFrame</span></span><span class="p">,</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Process Rosetta scoring dictionary into suitable values</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>scores</code></b>
            (<code>dict[str, dict[str, str | int | float]]</code>)
        
        <div class="doc-md-description">
          <p>The dictionary of scores to be parsed</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    A tuple of DataFrame where each contains (
        A per-design metric DataFrame where each index is the design id and the columns are design metrics,
        A per-residue metric DataFrame where each index is the design id and the columns are
            (residue index, residue metric)
    )</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse_rosetta_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scores</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span><span class="p">]])</span> \
        <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process Rosetta scoring dictionary into suitable values</span>

<span class="sd">    Args:</span>
<span class="sd">        scores: The dictionary of scores to be parsed</span>
<span class="sd">    Returns:</span>
<span class="sd">        A tuple of DataFrame where each contains (</span>
<span class="sd">            A per-design metric DataFrame where each index is the design id and the columns are design metrics,</span>
<span class="sd">            A per-residue metric DataFrame where each index is the design id and the columns are</span>
<span class="sd">                (residue index, residue metric)</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create protocol dataframe</span>
    <span class="n">scores_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="c1"># # Fill in all the missing values with that of the default pose_source</span>
    <span class="c1"># scores_df = pd.concat([source_df, scores_df]).fillna(method=&#39;ffill&#39;)</span>
    <span class="c1"># Gather all columns into specific types for processing and formatting</span>
    <span class="n">per_res_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;res_&#39;</span> <span class="ow">in</span> <span class="n">column</span><span class="p">]</span>

    <span class="c1"># Check proper input</span>
    <span class="n">metric_set</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">rosetta_required</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">scores_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">metric_set</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Score columns present before required metric check: </span><span class="si">{</span><span class="n">scores_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DesignError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Missing required metrics: &quot;</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metric_set</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

    <span class="c1"># Remove unnecessary (old scores) as well as Rosetta pose score terms besides ref (has been renamed above)</span>
    <span class="c1"># Todo learn know how to produce Rosetta score terms in output score file. Not in FastRelax...</span>
    <span class="n">remove_columns</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">rosetta_terms</span> <span class="o">+</span> <span class="n">metrics</span><span class="o">.</span><span class="n">unnecessary</span> <span class="o">+</span> <span class="n">per_res_columns</span>
    <span class="c1"># Todo remove dirty when columns are correct (after P432)</span>
    <span class="c1">#  and column tabulation precedes residue/hbond_processing</span>
    <span class="n">scores_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">remove_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

    <span class="c1"># Todo implement this protocol if sequence data is taken at multiple points along a trajectory and the</span>
    <span class="c1">#  sequence data along trajectory is a metric on it&#39;s own</span>
    <span class="c1"># # Gather mutations for residue specific processing and design sequences</span>
    <span class="c1"># for design, data in list(structure_design_scores.items()):  # make a copy as can be removed</span>
    <span class="c1">#     sequence = data.get(&#39;final_sequence&#39;)</span>
    <span class="c1">#     if sequence:</span>
    <span class="c1">#         if len(sequence) &gt;= pose_length:</span>
    <span class="c1">#             pose_sequences[design] = sequence[:pose_length]  # Todo won&#39;t work if design had insertions</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             pose_sequences[design] = sequence</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         self.log.warning(&#39;Design %s is missing sequence data, removing from design pool&#39; % design)</span>
    <span class="c1">#         structure_design_scores.pop(design)</span>
    <span class="c1"># # format {entity: {design_name: sequence, ...}, ...}</span>
    <span class="c1"># entity_sequences = \</span>
    <span class="c1">#     {entity: {design: sequence[entity.n_terminal_residue.number - 1:entity.c_terminal_residue.number]</span>
    <span class="c1">#               for design, sequence in pose_sequences.items()} for entity in self.pose.entities}</span>

    <span class="c1"># Drop designs where required data isn&#39;t present</span>
    <span class="k">if</span> <span class="n">putils</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">in</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="c1"># Format protocol columns</span>
        <span class="c1"># # Todo remove not DEV</span>
        <span class="c1"># missing_group_indices = scores_df[putils.protocol].isna()</span>
        <span class="c1"># scout_indices = [idx for idx in scores_df[missing_group_indices].index if &#39;scout&#39; in idx]</span>
        <span class="c1"># scores_df.loc[scout_indices, putils.protocol] = putils.scout</span>
        <span class="c1"># structure_bkgnd_indices = [idx for idx in scores_df[missing_group_indices].index if &#39;no_constraint&#39; in idx]</span>
        <span class="c1"># scores_df.loc[structure_bkgnd_indices, putils.protocol] = putils.structure_background</span>
        <span class="c1"># # Todo Done remove</span>
        <span class="n">missing_group_indices</span> <span class="o">=</span> <span class="n">scores_df</span><span class="p">[</span><span class="n">putils</span><span class="o">.</span><span class="n">protocol</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
        <span class="c1"># protocol_s.replace({&#39;combo_profile&#39;: putils.design_profile}, inplace=True)  # ensure proper profile name</span>

        <span class="n">scores_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">missing_group_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

    <span class="c1"># Replace empty strings with np.nan and convert remaining to float</span>
    <span class="n">scores_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">scores_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">protocol_specific_columns</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="mi">0</span><span class="p">))),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># scores_df = scores_df.astype(float)  # , copy=False, errors=&#39;ignore&#39;)</span>

    <span class="c1"># protocol_s.drop(missing_group_indices, inplace=True, errors=&#39;ignore&#39;)</span>
    <span class="n">viable_designs</span> <span class="o">=</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">viable_designs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DesignError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;No viable designs remain after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">process_rosetta_metrics</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> data processing steps&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Viable designs with structures remaining after cleaning:</span><span class="se">\n\t</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">viable_designs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Take metrics for the pose_source</span>
    <span class="c1"># entity_energies = [0. for _ in self.pose.entities]</span>
    <span class="c1"># pose_source_residue_info = \</span>
    <span class="c1">#     {residue.index: {&#39;complex&#39;: 0., &#39;bound&#39;: entity_energies.copy(), &#39;unbound&#39;: entity_energies.copy(),</span>
    <span class="c1">#                      &#39;solv_complex&#39;: 0., &#39;solv_bound&#39;: entity_energies.copy(),</span>
    <span class="c1">#                      &#39;solv_unbound&#39;: entity_energies.copy(), &#39;fsp&#39;: 0., &#39;cst&#39;: 0., &#39;hbond&#39;: 0}</span>
    <span class="c1">#      for entity in self.pose.entities for residue in entity.residues}</span>
    <span class="c1"># pose_source_id = self.pose_source.id</span>
    <span class="c1"># residue_info = {pose_source_id: pose_source_residue_info}</span>

    <span class="c1"># residue_info = {&#39;energy&#39;: {&#39;complex&#39;: 0., &#39;unbound&#39;: 0.}, &#39;type&#39;: None, &#39;hbond&#39;: 0}</span>
    <span class="c1"># residue_info.update(self.pose.rosetta_residue_processing(structure_design_scores))</span>
    <span class="n">residue_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">process_rosetta_residue_scores</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    <span class="c1"># Can&#39;t use residue_processing (clean) ^ in the case there is a design without metrics... columns not found!</span>
    <span class="n">residue_info</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">process_residue_info</span><span class="p">(</span><span class="n">residue_info</span><span class="p">,</span> <span class="n">hbonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">rosetta_hbond_processing</span><span class="p">(</span><span class="n">scores</span><span class="p">))</span>

    <span class="c1"># Process mutational frequencies, H-bond, and Residue energy metrics to dataframe</span>
    <span class="c1"># which ends up with multi-index column with residue index as first (top) column index, metric as second index</span>
    <span class="n">rosetta_residues_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">({</span><span class="n">design</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="k">for</span> <span class="n">design</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">residue_info</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span> \
        <span class="o">.</span><span class="n">unstack</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">scores_df</span><span class="p">,</span> <span class="n">rosetta_residues_df</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.rosetta_column_combinations" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">rosetta_column_combinations</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">rosetta_column_combinations</span><span class="p">(</span><span class="n">scores_df</span><span class="p">:</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Calculate metrics from combinations of metrics with variable integer number metric names</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>scores_df</code></b>
            (<code><span title="pandas.DataFrame">DataFrame</span></code>)
        
        <div class="doc-md-description">
          <p>A DataFrame with Rosetta based metrics that should be combined with other metrics to produce new
summary metrics</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    A per-design metric DataFrame where each index is the design id and the columns are design metrics,</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span>
<span class="normal">2963</span>
<span class="normal">2964</span>
<span class="normal">2965</span>
<span class="normal">2966</span>
<span class="normal">2967</span>
<span class="normal">2968</span>
<span class="normal">2969</span>
<span class="normal">2970</span>
<span class="normal">2971</span>
<span class="normal">2972</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">rosetta_column_combinations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scores_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate metrics from combinations of metrics with variable integer number metric names</span>

<span class="sd">    Args:</span>
<span class="sd">        scores_df: A DataFrame with Rosetta based metrics that should be combined with other metrics to produce new</span>
<span class="sd">            summary metrics</span>
<span class="sd">    Returns:</span>
<span class="sd">        A per-design metric DataFrame where each index is the design id and the columns are design metrics,</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scores_columns</span> <span class="o">=</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Metrics present: </span><span class="si">{</span><span class="n">scores_columns</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">summation_pairs</span> <span class="o">=</span> \
        <span class="p">{</span><span class="s1">&#39;buried_unsatisfied_hbonds_unbound&#39;</span><span class="p">:</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;buns[0-9]+_unbound$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">,</span> <span class="n">scores_columns</span><span class="p">)),</span>  <span class="c1"># Rosetta</span>
         <span class="c1"># &#39;interface_energy_bound&#39;:</span>
         <span class="c1">#     list(filter(re.compile(&#39;interface_energy_[0-9]+_bound&#39;).match, scores_columns)),  # Rosetta</span>
         <span class="c1"># &#39;interface_energy_unbound&#39;:</span>
         <span class="c1">#     list(filter(re.compile(&#39;interface_energy_[0-9]+_unbound&#39;).match, scores_columns)),  # Rosetta</span>
         <span class="c1"># &#39;interface_solvation_energy_bound&#39;:</span>
         <span class="c1">#     list(filter(re.compile(&#39;solvation_energy_[0-9]+_bound&#39;).match, scores_columns)),  # Rosetta</span>
         <span class="c1"># &#39;interface_solvation_energy_unbound&#39;:</span>
         <span class="c1">#     list(filter(re.compile(&#39;solvation_energy_[0-9]+_unbound&#39;).match, scores_columns)),  # Rosetta</span>
         <span class="s1">&#39;interface_connectivity&#39;</span><span class="p">:</span>
             <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;entity[0-9]+_interface_connectivity&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">,</span> <span class="n">scores_columns</span><span class="p">)),</span>  <span class="c1"># Rosetta</span>
         <span class="p">}</span>
    <span class="n">scores_df</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">columns_to_new_column</span><span class="p">(</span><span class="n">scores_df</span><span class="p">,</span> <span class="n">summation_pairs</span><span class="p">)</span>
    <span class="c1"># This is a nightmare as the column.map() turns all non-existing to np.nan need to fix upstream instead of</span>
    <span class="c1"># changing here</span>
    <span class="c1"># # Rename buns columns</span>
    <span class="c1"># # This isn&#39;t stable long term given mapping of interface number (sql) and entity number (Rosetta)</span>
    <span class="c1"># buns_columns = summation_pairs[&#39;buried_unsatisfied_hbonds_unbound&#39;]</span>
    <span class="c1"># scores_df.columns = scores_df.columns.map(dict((f&#39;buns{idx}_unbound&#39;, f&#39;buried_unsatisfied_hbonds_unbound{idx}&#39;)</span>
    <span class="c1">#                                                for idx in range(1, 1 + len(buns_columns))))\</span>
    <span class="c1">#     .fillna(scores_df.columns)</span>
    <span class="c1"># Add number_residues_interface for div_pairs and int_comp_similarity</span>
    <span class="c1"># scores_df[&#39;number_residues_interface&#39;] = other_pose_metrics.pop(&#39;number_residues_interface&#39;)</span>
    <span class="n">scores_df</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">columns_to_new_column</span><span class="p">(</span><span class="n">scores_df</span><span class="p">,</span> <span class="n">metrics</span><span class="o">.</span><span class="n">rosetta_delta_pairs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;sub&#39;</span><span class="p">)</span>
    <span class="n">scores_df</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">columns_to_new_column</span><span class="p">(</span><span class="n">scores_df</span><span class="p">,</span> <span class="n">metrics</span><span class="o">.</span><span class="n">rosetta_division_pairs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;truediv&#39;</span><span class="p">)</span>

    <span class="n">scores_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">clean_up_intermediate_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">repacking</span> <span class="o">=</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;repacking&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">repacking</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Set interface_bound_activation_energy = np.nan where repacking is 0</span>
        <span class="c1"># Currently is -1 for True (Rosetta Filter quirk...)</span>
        <span class="n">scores_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">scores_df</span><span class="p">[</span><span class="n">repacking</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;interface_bound_activation_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">scores_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;repacking&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scores_df</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.process_rosetta_metrics" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">process_rosetta_metrics</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">process_rosetta_metrics</span><span class="p">()</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>From Rosetta based protocols, tally the resulting metrics and integrate with SymDesign metrics database</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2974</span>
<span class="normal">2975</span>
<span class="normal">2976</span>
<span class="normal">2977</span>
<span class="normal">2978</span>
<span class="normal">2979</span>
<span class="normal">2980</span>
<span class="normal">2981</span>
<span class="normal">2982</span>
<span class="normal">2983</span>
<span class="normal">2984</span>
<span class="normal">2985</span>
<span class="normal">2986</span>
<span class="normal">2987</span>
<span class="normal">2988</span>
<span class="normal">2989</span>
<span class="normal">2990</span>
<span class="normal">2991</span>
<span class="normal">2992</span>
<span class="normal">2993</span>
<span class="normal">2994</span>
<span class="normal">2995</span>
<span class="normal">2996</span>
<span class="normal">2997</span>
<span class="normal">2998</span>
<span class="normal">2999</span>
<span class="normal">3000</span>
<span class="normal">3001</span>
<span class="normal">3002</span>
<span class="normal">3003</span>
<span class="normal">3004</span>
<span class="normal">3005</span>
<span class="normal">3006</span>
<span class="normal">3007</span>
<span class="normal">3008</span>
<span class="normal">3009</span>
<span class="normal">3010</span>
<span class="normal">3011</span>
<span class="normal">3012</span>
<span class="normal">3013</span>
<span class="normal">3014</span>
<span class="normal">3015</span>
<span class="normal">3016</span>
<span class="normal">3017</span>
<span class="normal">3018</span>
<span class="normal">3019</span>
<span class="normal">3020</span>
<span class="normal">3021</span>
<span class="normal">3022</span>
<span class="normal">3023</span>
<span class="normal">3024</span>
<span class="normal">3025</span>
<span class="normal">3026</span>
<span class="normal">3027</span>
<span class="normal">3028</span>
<span class="normal">3029</span>
<span class="normal">3030</span>
<span class="normal">3031</span>
<span class="normal">3032</span>
<span class="normal">3033</span>
<span class="normal">3034</span>
<span class="normal">3035</span>
<span class="normal">3036</span>
<span class="normal">3037</span>
<span class="normal">3038</span>
<span class="normal">3039</span>
<span class="normal">3040</span>
<span class="normal">3041</span>
<span class="normal">3042</span>
<span class="normal">3043</span>
<span class="normal">3044</span>
<span class="normal">3045</span>
<span class="normal">3046</span>
<span class="normal">3047</span>
<span class="normal">3048</span>
<span class="normal">3049</span>
<span class="normal">3050</span>
<span class="normal">3051</span>
<span class="normal">3052</span>
<span class="normal">3053</span>
<span class="normal">3054</span>
<span class="normal">3055</span>
<span class="normal">3056</span>
<span class="normal">3057</span>
<span class="normal">3058</span>
<span class="normal">3059</span>
<span class="normal">3060</span>
<span class="normal">3061</span>
<span class="normal">3062</span>
<span class="normal">3063</span>
<span class="normal">3064</span>
<span class="normal">3065</span>
<span class="normal">3066</span>
<span class="normal">3067</span>
<span class="normal">3068</span>
<span class="normal">3069</span>
<span class="normal">3070</span>
<span class="normal">3071</span>
<span class="normal">3072</span>
<span class="normal">3073</span>
<span class="normal">3074</span>
<span class="normal">3075</span>
<span class="normal">3076</span>
<span class="normal">3077</span>
<span class="normal">3078</span>
<span class="normal">3079</span>
<span class="normal">3080</span>
<span class="normal">3081</span>
<span class="normal">3082</span>
<span class="normal">3083</span>
<span class="normal">3084</span>
<span class="normal">3085</span>
<span class="normal">3086</span>
<span class="normal">3087</span>
<span class="normal">3088</span>
<span class="normal">3089</span>
<span class="normal">3090</span>
<span class="normal">3091</span>
<span class="normal">3092</span>
<span class="normal">3093</span>
<span class="normal">3094</span>
<span class="normal">3095</span>
<span class="normal">3096</span>
<span class="normal">3097</span>
<span class="normal">3098</span>
<span class="normal">3099</span>
<span class="normal">3100</span>
<span class="normal">3101</span>
<span class="normal">3102</span>
<span class="normal">3103</span>
<span class="normal">3104</span>
<span class="normal">3105</span>
<span class="normal">3106</span>
<span class="normal">3107</span>
<span class="normal">3108</span>
<span class="normal">3109</span>
<span class="normal">3110</span>
<span class="normal">3111</span>
<span class="normal">3112</span>
<span class="normal">3113</span>
<span class="normal">3114</span>
<span class="normal">3115</span>
<span class="normal">3116</span>
<span class="normal">3117</span>
<span class="normal">3118</span>
<span class="normal">3119</span>
<span class="normal">3120</span>
<span class="normal">3121</span>
<span class="normal">3122</span>
<span class="normal">3123</span>
<span class="normal">3124</span>
<span class="normal">3125</span>
<span class="normal">3126</span>
<span class="normal">3127</span>
<span class="normal">3128</span>
<span class="normal">3129</span>
<span class="normal">3130</span>
<span class="normal">3131</span>
<span class="normal">3132</span>
<span class="normal">3133</span>
<span class="normal">3134</span>
<span class="normal">3135</span>
<span class="normal">3136</span>
<span class="normal">3137</span>
<span class="normal">3138</span>
<span class="normal">3139</span>
<span class="normal">3140</span>
<span class="normal">3141</span>
<span class="normal">3142</span>
<span class="normal">3143</span>
<span class="normal">3144</span>
<span class="normal">3145</span>
<span class="normal">3146</span>
<span class="normal">3147</span>
<span class="normal">3148</span>
<span class="normal">3149</span>
<span class="normal">3150</span>
<span class="normal">3151</span>
<span class="normal">3152</span>
<span class="normal">3153</span>
<span class="normal">3154</span>
<span class="normal">3155</span>
<span class="normal">3156</span>
<span class="normal">3157</span>
<span class="normal">3158</span>
<span class="normal">3159</span>
<span class="normal">3160</span>
<span class="normal">3161</span>
<span class="normal">3162</span>
<span class="normal">3163</span>
<span class="normal">3164</span>
<span class="normal">3165</span>
<span class="normal">3166</span>
<span class="normal">3167</span>
<span class="normal">3168</span>
<span class="normal">3169</span>
<span class="normal">3170</span>
<span class="normal">3171</span>
<span class="normal">3172</span>
<span class="normal">3173</span>
<span class="normal">3174</span>
<span class="normal">3175</span>
<span class="normal">3176</span>
<span class="normal">3177</span>
<span class="normal">3178</span>
<span class="normal">3179</span>
<span class="normal">3180</span>
<span class="normal">3181</span>
<span class="normal">3182</span>
<span class="normal">3183</span>
<span class="normal">3184</span>
<span class="normal">3185</span>
<span class="normal">3186</span>
<span class="normal">3187</span>
<span class="normal">3188</span>
<span class="normal">3189</span>
<span class="normal">3190</span>
<span class="normal">3191</span>
<span class="normal">3192</span>
<span class="normal">3193</span>
<span class="normal">3194</span>
<span class="normal">3195</span>
<span class="normal">3196</span>
<span class="normal">3197</span>
<span class="normal">3198</span>
<span class="normal">3199</span>
<span class="normal">3200</span>
<span class="normal">3201</span>
<span class="normal">3202</span>
<span class="normal">3203</span>
<span class="normal">3204</span>
<span class="normal">3205</span>
<span class="normal">3206</span>
<span class="normal">3207</span>
<span class="normal">3208</span>
<span class="normal">3209</span>
<span class="normal">3210</span>
<span class="normal">3211</span>
<span class="normal">3212</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">process_rosetta_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;From Rosetta based protocols, tally the resulting metrics and integrate with SymDesign metrics database&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found design scores in file: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scores_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># Todo PoseJob(.path)</span>
    <span class="n">design_scores</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">parse_rosetta_scorefile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores_file</span><span class="p">)</span>

    <span class="n">pose_design_scores</span> <span class="o">=</span> <span class="n">design_scores</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pose_design_scores</span><span class="p">:</span>
        <span class="c1"># The pose_source is included in the calculations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_pose_metrics</span><span class="p">(</span><span class="n">scores</span><span class="o">=</span><span class="n">pose_design_scores</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">design_scores</span><span class="p">:</span>
        <span class="c1"># No design scores were found</span>
        <span class="k">return</span>

    <span class="c1"># Find all designs files</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">design_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_names</span>
    <span class="n">design_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_design_files</span><span class="p">()</span>  <span class="c1"># Todo PoseJob(.path)</span>
    <span class="n">scored_design_names</span> <span class="o">=</span> <span class="n">design_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">new_design_paths_to_process</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rosetta_provided_new_design_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">existing_design_paths_to_process</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">existing_design_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Collect designs that we have metrics on (possibly again)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">design_files</span><span class="p">):</span>
        <span class="n">file_name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">scored_design_names</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">design_data_index</span> <span class="o">=</span> <span class="n">design_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># file_name not in design_names</span>
                <span class="c1"># New, this file hasn&#39;t been processed</span>
                <span class="n">new_design_paths_to_process</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">rosetta_provided_new_design_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">existing_design_paths_to_process</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">existing_design_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">design_data_index</span><span class="p">)</span>

    <span class="c1"># Ensure that design_paths_to_process and self.current_designs have the same order</span>
    <span class="n">design_paths_to_process</span> <span class="o">=</span> <span class="n">existing_design_paths_to_process</span> <span class="o">+</span> <span class="n">new_design_paths_to_process</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">design_paths_to_process</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># # Find designs with scores but no structures</span>
    <span class="c1"># structure_design_scores = {}</span>
    <span class="c1"># for pose in designs:</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         structure_design_scores[pose.name] = design_scores.pop(pose.name)</span>
    <span class="c1">#     except KeyError:  # Structure wasn&#39;t scored, we will remove this later</span>
    <span class="c1">#         pass</span>

    <span class="c1"># Process the parsed scores to scores_df, rosetta_residues_df</span>
    <span class="n">scores_df</span><span class="p">,</span> <span class="n">rosetta_residues_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_rosetta_scores</span><span class="p">(</span><span class="n">design_scores</span><span class="p">)</span>

    <span class="c1"># Format DesignData</span>
    <span class="c1"># Get all existing</span>
    <span class="n">design_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">designs</span>  <span class="c1"># This is loaded above at &#39;design_names = self.design_names&#39;</span>
    <span class="c1"># Set current_designs to a fresh list</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_current_designs</span> <span class="o">=</span> <span class="p">[</span><span class="n">design_data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">existing_design_indices</span><span class="p">]</span>
    <span class="c1"># Find parent info and remove from scores_df</span>
    <span class="k">if</span> <span class="n">putils</span><span class="o">.</span><span class="n">design_parent</span> <span class="ow">in</span> <span class="n">scores_df</span><span class="p">:</span>
        <span class="c1"># Replace missing values with the pose_source DesignData</span>
        <span class="c1"># This is loaded above at &#39;design_names = self.design_names&#39;</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">putils</span><span class="o">.</span><span class="n">design_parent</span><span class="p">)</span>  <span class="c1"># .fillna(self.pose_source)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Setting parents functionality hasn&#39;t been tested. Proceed with caution&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">design</span><span class="p">,</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
                <span class="n">parents</span><span class="p">[</span><span class="n">design</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_source</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">design_name_index</span> <span class="o">=</span> <span class="n">design_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># This name isn&#39;t right</span>
                <span class="k">raise</span> <span class="n">DesignError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t find the design_parent for the design with name &#39;</span><span class="si">{</span><span class="n">design</span><span class="si">}</span><span class="s2">&#39; and parent value of &#39;&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parent</span><span class="si">}</span><span class="s2">&#39;. The available parents are:</span><span class="se">\n\t</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">design_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parents</span><span class="p">[</span><span class="n">design</span><span class="p">]</span> <span class="o">=</span> <span class="n">design_data</span><span class="p">[</span><span class="n">design_name_index</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Assume this is an offspring of the pose</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="p">{</span><span class="n">provided_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_source</span> <span class="k">for</span> <span class="n">provided_name</span> <span class="ow">in</span> <span class="n">rosetta_provided_new_design_names</span><span class="p">}</span>

    <span class="c1"># Find protocol info and remove from scores_df</span>
    <span class="k">if</span> <span class="n">putils</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">in</span> <span class="n">scores_df</span><span class="p">:</span>
        <span class="c1"># Replace missing values with the pose_source DesignData</span>
        <span class="n">protocol_s</span> <span class="o">=</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">putils</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;metrics&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found &quot;protocol_s&quot; variable with dtype: </span><span class="si">{</span><span class="n">protocol_s</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">protocol_s</span> <span class="o">=</span> <span class="p">{</span><span class="n">provided_name</span><span class="p">:</span> <span class="s1">&#39;metrics&#39;</span> <span class="k">for</span> <span class="n">provided_name</span> <span class="ow">in</span> <span class="n">rosetta_provided_new_design_names</span><span class="p">}</span>

    <span class="c1"># Process all desired files to Pose</span>
    <span class="n">pose_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_kwargs</span>
    <span class="n">design_poses</span> <span class="o">=</span> <span class="p">[</span><span class="n">Pose</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">pose_kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">design_paths_to_process</span><span class="p">]</span>
    <span class="n">design_sequences</span> <span class="o">=</span> <span class="p">{</span><span class="n">pose</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">pose</span><span class="o">.</span><span class="n">sequence</span> <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">design_poses</span><span class="p">}</span>
    <span class="c1"># sequences_df = self.analyze_sequence_metrics_per_design(sequences=design_sequences)</span>

    <span class="c1"># The DataFrame.index needs to become design.id not design.name as it is here. Modify after processing</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_residue_metrics_per_design</span><span class="p">(</span><span class="n">designs</span><span class="o">=</span><span class="n">design_poses</span><span class="p">)</span>
    <span class="c1"># Join Rosetta per-residue DataFrame taking Structure analysis per-residue DataFrame index order</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rosetta_residues_df</span><span class="p">)</span>

    <span class="n">designs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_design_metrics_per_design</span><span class="p">(</span><span class="n">residues_df</span><span class="p">,</span> <span class="n">design_poses</span><span class="p">)</span>
    <span class="c1"># Join Rosetta per-design DataFrame taking Structure analysis per-design DataFrame index order</span>
    <span class="n">designs_df</span> <span class="o">=</span> <span class="n">designs_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scores_df</span><span class="p">)</span>

    <span class="c1"># Finish calculation of Rosetta scores with included metrics</span>
    <span class="n">designs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rosetta_column_combinations</span><span class="p">(</span><span class="n">designs_df</span><span class="p">)</span>

    <span class="c1"># Score using proteinmpnn only if the design was created by Rosetta</span>
    <span class="k">if</span> <span class="n">rosetta_provided_new_design_names</span><span class="p">:</span>
        <span class="n">score_sequences</span> <span class="o">=</span> <span class="p">[</span><span class="n">design_sequences</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">new_file_name</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">new_file_name</span> <span class="ow">in</span> <span class="n">rosetta_provided_new_design_names</span><span class="p">]</span>
        <span class="n">sequences_and_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">score_sequences</span><span class="p">(</span>
            <span class="n">score_sequences</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">proteinmpnn_model</span><span class="p">)</span>
        <span class="c1"># Set each position that was parsed as &quot;designable&quot;</span>
        <span class="c1"># This includes packable residues from neighborhoods. How can we get only designable?</span>
        <span class="c1"># Right now, it is only the interface residues that go into Rosetta</span>
        <span class="c1"># Use simple reporting here until that changes...</span>
        <span class="c1"># Todo get residues_df[&#39;design_indices&#39;] worked out with set up using sql.DesignProtocol?</span>
        <span class="c1">#  See self.analyze_pose_designs()</span>
        <span class="n">design_residues</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rosetta_provided_new_design_names</span><span class="p">,</span>
                                          <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;interface_residue&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">sequences_and_scores</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;design_indices&#39;</span><span class="p">:</span> <span class="n">design_residues</span><span class="p">})</span>
        <span class="n">mpnn_designs_df</span><span class="p">,</span> <span class="n">mpnn_residues_df</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">analyze_proteinmpnn_metrics</span><span class="p">(</span><span class="n">rosetta_provided_new_design_names</span><span class="p">,</span> <span class="n">sequences_and_scores</span><span class="p">)</span>
        <span class="c1"># Join DataFrames</span>
        <span class="n">designs_df</span> <span class="o">=</span> <span class="n">designs_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mpnn_designs_df</span><span class="p">)</span>
        <span class="n">residues_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mpnn_residues_df</span><span class="p">)</span>
    <span class="c1"># else:</span>
    <span class="c1">#     mpnn_residues_df = pd.DataFrame()</span>
    <span class="c1">#</span>
    <span class="c1"># # Calculate sequence metrics for the remaining sequences</span>
    <span class="c1"># sequences_df = self.analyze_sequence_metrics_per_design(sequences=design_sequences)</span>
    <span class="c1"># sequences_df = sequences_df.join(mpnn_residues_df)</span>

    <span class="c1"># Update the Pose.designs with DesignData for each of the new designs</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">new_designs_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_design_data</span><span class="p">(</span>
            <span class="n">design_parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_source</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">new_design_paths_to_process</span><span class="p">))</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">new_designs_data</span><span class="p">)</span>
        <span class="c1"># Generate ids for new entries</span>
        <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_designs</span><span class="p">)</span>

        <span class="c1"># Add attribute to DesignData to save the provided_name and design design_parent</span>
        <span class="k">for</span> <span class="n">design_data</span><span class="p">,</span> <span class="n">provided_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">new_designs_data</span><span class="p">,</span> <span class="n">rosetta_provided_new_design_names</span><span class="p">):</span>
            <span class="n">design_data</span><span class="o">.</span><span class="n">design_parent</span> <span class="o">=</span> <span class="n">parents</span><span class="p">[</span><span class="n">provided_name</span><span class="p">]</span>
            <span class="n">design_data</span><span class="o">.</span><span class="n">provided_name</span> <span class="o">=</span> <span class="n">provided_name</span>

        <span class="n">designs_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">designs_path</span>
        <span class="n">new_design_new_filenames</span> <span class="o">=</span> <span class="p">{</span><span class="n">data</span><span class="o">.</span><span class="n">provided_name</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">designs_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.pdb&#39;</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">new_designs_data</span><span class="p">}</span>

        <span class="c1"># Update the Pose with the design protocols</span>
        <span class="k">for</span> <span class="n">design</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_designs</span><span class="p">:</span>
            <span class="n">name_or_provided_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">design</span><span class="p">,</span> <span class="s1">&#39;provided_name&#39;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">design</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">))</span>
            <span class="n">protocol_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">design_id</span><span class="o">=</span><span class="n">design</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                   <span class="n">job_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                   <span class="n">protocol</span><span class="o">=</span><span class="n">protocol_s</span><span class="p">[</span><span class="n">name_or_provided_name</span><span class="p">],</span>
                                   <span class="c1"># temperature=temperatures[idx],)  # Todo from Rosetta?</span>
                                   <span class="p">)</span>
            <span class="n">new_filename</span> <span class="o">=</span> <span class="n">new_design_new_filenames</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name_or_provided_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_filename</span><span class="p">:</span>
                <span class="n">protocol_kwargs</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_filename</span>
                <span class="c1"># Set the structure_path for this DesignData</span>
                <span class="n">design</span><span class="o">.</span><span class="n">structure_path</span> <span class="o">=</span> <span class="n">new_filename</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">protocol_kwargs</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">designs_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name_or_provided_name</span><span class="si">}</span><span class="s1">.pdb&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">design</span><span class="o">.</span><span class="n">structure_path</span><span class="p">:</span>
                    <span class="n">design</span><span class="o">.</span><span class="n">structure_path</span> <span class="o">=</span> <span class="n">protocol_kwargs</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
            <span class="n">design</span><span class="o">.</span><span class="n">protocols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">DesignProtocol</span><span class="p">(</span><span class="o">**</span><span class="n">protocol_kwargs</span><span class="p">))</span>
        <span class="c1"># else:  # Assume that no design was done and only metrics were acquired</span>
        <span class="c1">#     pass</span>

        <span class="c1"># This is all done in update_design_data</span>
        <span class="c1"># self.designs.append(new_designs_data)</span>
        <span class="c1"># # Flush the newly acquired DesignData and DesignProtocol to generate .id primary keys</span>
        <span class="c1"># self.job.current_session.flush()</span>
        <span class="c1"># new_design_ids = [design_data.id for design_data in new_designs_data]</span>

        <span class="c1"># Get the name/provided_name to design_id mapping</span>
        <span class="n">design_name_to_id_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">design</span><span class="p">,</span> <span class="s1">&#39;provided_name&#39;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">design</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)):</span> <span class="n">design</span><span class="o">.</span><span class="n">id</span>
            <span class="k">for</span> <span class="n">design</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_designs</span><span class="p">}</span>

        <span class="c1"># This call is redundant with the analyze_proteinmpnn_metrics(design_names, sequences_and_scores) above</span>
        <span class="c1"># Todo remove from above the sequences portion..? Commenting out below for now</span>
        <span class="c1"># designs_df = designs_df.join(self.analyze_design_metrics_per_residue(sequences_df))</span>

        <span class="c1"># Rename all designs and clean up resulting metrics for storage</span>
        <span class="c1"># In keeping with &quot;unit of work&quot;, only rename once all data is processed incase we run into any errors</span>
        <span class="n">designs_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">designs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">design_name_to_id_map</span><span class="p">)</span>
        <span class="n">residues_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">design_name_to_id_map</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rosetta_provided_new_design_names</span><span class="p">:</span>
            <span class="c1"># Must move the entity_id to the columns for index.map to work</span>
            <span class="n">entity_designs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_design_entities_per_residue</span><span class="p">(</span><span class="n">mpnn_residues_df</span><span class="p">)</span>
            <span class="n">entity_designs_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">entity_designs_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">entity_designs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">design_name_to_id_map</span><span class="p">)</span>

        <span class="c1"># Commit the newly acquired metrics to the database</span>
        <span class="c1"># First check if the files are situated correctly</span>
        <span class="n">temp_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">()</span>
        <span class="n">temp_files_to_move</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">files_to_move</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">new_filename</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">new_design_paths_to_process</span><span class="p">,</span> <span class="n">new_design_new_filenames</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="n">new_filename</span><span class="p">:</span>
                <span class="c1"># These are the same file, proceed without processing</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_filename</span><span class="p">):</span>
                    <span class="c1"># Target file exists and nothing exists where it will be moved</span>
                    <span class="n">files_to_move</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_filename</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># The new_filename already exists. Redirect the filename to a temporary file, then complete move</span>
                    <span class="n">dir_</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_filename</span><span class="p">)</span>
                    <span class="n">temp_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;TEMP</span><span class="si">{</span><span class="nb">next</span><span class="p">(</span><span class="n">temp_count</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">temp_files_to_move</span><span class="p">[</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_filename</span>
                    <span class="n">files_to_move</span><span class="p">[</span><span class="n">temp_filename</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_filename</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># filename doesn&#39;t exist</span>
                <span class="k">raise</span> <span class="n">DesignError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The specified file </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> doesn&#39;t exist&quot;</span><span class="p">)</span>

        <span class="c1"># If so, proceed with insert, file rename and commit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">designs</span><span class="o">=</span><span class="n">designs_df</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rosetta_provided_new_design_names</span><span class="p">:</span>
            <span class="n">sql</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">entity_designs</span><span class="o">=</span><span class="n">entity_designs_df</span><span class="p">)</span>
        <span class="n">output_residues</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">output_residues</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">residues</span><span class="o">=</span><span class="n">residues_df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Only save the &#39;design_residue&#39; columns</span>
            <span class="k">if</span> <span class="n">rosetta_provided_new_design_names</span><span class="p">:</span>
                <span class="n">residues_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="n">sql</span><span class="o">.</span><span class="n">DesignResidues</span><span class="o">.</span><span class="n">design_residue</span><span class="o">.</span><span class="n">name</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">design_residues</span><span class="o">=</span><span class="n">residues_df</span><span class="p">)</span>
        <span class="c1"># Rename the incoming files to their prescribed names</span>
        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">temp_filename</span> <span class="ow">in</span> <span class="n">temp_files_to_move</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">temp_filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">new_filename</span> <span class="ow">in</span> <span class="n">files_to_move</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">new_filename</span><span class="p">)</span>

        <span class="c1"># Commit all new data</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.calculate_pose_metrics" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">calculate_pose_metrics</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">calculate_pose_metrics</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Collect Pose metrics using the reference Pose</p>



  <p>Other Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>scores</code></b>
        
        <div class="doc-md-description">
          <p>dict[str, str | int | float] = None - Parsed Pose scores from Rosetta output</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>novel_interface</code></b>
        
        <div class="doc-md-description">
          <p>bool = True - Whether the pose interface is novel (i.e. docked) or from a bona-fide input</p>
        </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3214</span>
<span class="normal">3215</span>
<span class="normal">3216</span>
<span class="normal">3217</span>
<span class="normal">3218</span>
<span class="normal">3219</span>
<span class="normal">3220</span>
<span class="normal">3221</span>
<span class="normal">3222</span>
<span class="normal">3223</span>
<span class="normal">3224</span>
<span class="normal">3225</span>
<span class="normal">3226</span>
<span class="normal">3227</span>
<span class="normal">3228</span>
<span class="normal">3229</span>
<span class="normal">3230</span>
<span class="normal">3231</span>
<span class="normal">3232</span>
<span class="normal">3233</span>
<span class="normal">3234</span>
<span class="normal">3235</span>
<span class="normal">3236</span>
<span class="normal">3237</span>
<span class="normal">3238</span>
<span class="normal">3239</span>
<span class="normal">3240</span>
<span class="normal">3241</span>
<span class="normal">3242</span>
<span class="normal">3243</span>
<span class="normal">3244</span>
<span class="normal">3245</span>
<span class="normal">3246</span>
<span class="normal">3247</span>
<span class="normal">3248</span>
<span class="normal">3249</span>
<span class="normal">3250</span>
<span class="normal">3251</span>
<span class="normal">3252</span>
<span class="normal">3253</span>
<span class="normal">3254</span>
<span class="normal">3255</span>
<span class="normal">3256</span>
<span class="normal">3257</span>
<span class="normal">3258</span>
<span class="normal">3259</span>
<span class="normal">3260</span>
<span class="normal">3261</span>
<span class="normal">3262</span>
<span class="normal">3263</span>
<span class="normal">3264</span>
<span class="normal">3265</span>
<span class="normal">3266</span>
<span class="normal">3267</span>
<span class="normal">3268</span>
<span class="normal">3269</span>
<span class="normal">3270</span>
<span class="normal">3271</span>
<span class="normal">3272</span>
<span class="normal">3273</span>
<span class="normal">3274</span>
<span class="normal">3275</span>
<span class="normal">3276</span>
<span class="normal">3277</span>
<span class="normal">3278</span>
<span class="normal">3279</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_pose_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect Pose metrics using the reference Pose</span>

<span class="sd">    Keyword Args:</span>
<span class="sd">        scores: dict[str, str | int | float] = None - Parsed Pose scores from Rosetta output</span>
<span class="sd">        novel_interface: bool = True - Whether the pose interface is novel (i.e. docked) or from a bona-fide input</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">load_pose</span><span class="p">()</span>
    <span class="c1"># self.identify_interface()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">fragment_info_by_entity_pair</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_fragments</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_metrics</span><span class="p">():</span>
        <span class="n">_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">metrics</span>  <span class="c1"># Also calculates entity.metrics</span>
        <span class="c1"># Todo</span>
        <span class="c1"># # Gather the docking metrics if not acquired from Nanohedra</span>
        <span class="c1"># pose_residues_df = self.analyze_docked_metrics()</span>
        <span class="c1"># self.output_metrics(residues=pose_residues_df, pose_metrics=True)</span>
        <span class="c1"># Todo move into this mechanism PoseMetrics level calculations of the following:</span>
        <span class="c1">#  dock_collapse_*,</span>
        <span class="c1">#  dock_hydrophobicity,</span>
        <span class="c1">#  proteinmpnn_v_evolution_probability_cross_entropy_loss</span>
        <span class="c1">#</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">is_thermophilic</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">entity_data</span><span class="p">),</span> <span class="n">idx</span><span class="p">):</span>
            <span class="c1"># Todo remove entity.thermophilicity once sql load more streamlined</span>
            <span class="c1"># is_thermophilic.append(1 if entity.thermophilicity else 0)</span>
            <span class="n">is_thermophilic</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">thermophilicity</span><span class="p">)</span>
            <span class="c1"># Save entity.metrics to db</span>
            <span class="n">data</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">metrics</span>
        <span class="n">_metrics</span><span class="o">.</span><span class="n">pose_thermophilicity</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">is_thermophilic</span><span class="p">)</span> <span class="o">/</span> <span class="n">idx</span>

        <span class="k">return</span> <span class="n">_metrics</span>

    <span class="c1"># Check if PoseMetrics have been captured</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">metrics_</span> <span class="o">=</span> <span class="n">get_metrics</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">metrics_</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Update existing self.metrics</span>
                    <span class="n">current_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span>
                    <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">metrics_</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;_sa_instance_state&#39;</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">current_metrics</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="c1"># Update the design_metrics for this Pose</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calculate_pose_design_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_pose_metrics</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> doesn&#39;t output anything yet when </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">.db&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">db</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The reference=SymEntry.resulting_symmetry center_of_mass is needed as well&quot;</span><span class="p">)</span>
        <span class="n">pose_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">df</span>  <span class="c1"># Also performs entity.calculate_spatial_orientation_metrics()</span>

        <span class="n">entity_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>
            <span class="n">entity_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="o">**</span><span class="n">entity</span><span class="o">.</span><span class="n">calculate_spatial_orientation_metrics</span><span class="p">())</span>
            <span class="n">entity_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_s</span><span class="p">)</span>

        <span class="c1"># Stack the Series on the columns to turn into a dataframe where the metrics are rows and entity are columns</span>
        <span class="n">entity_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">entity_dfs</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">entity_dfs</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.calculate_pose_design_metrics" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">calculate_pose_design_metrics</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">calculate_pose_design_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n"><span title="sqlalchemy.orm.Session">Session</span></span><span class="p">,</span> <span class="n">scores</span><span class="p">:</span> <span class="n">dict</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="n">str</span> <span class="o">|</span> <span class="n">int</span> <span class="o">|</span> <span class="n">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">novel_interface</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Collects 'design' and per-residue metrics on the reference Pose</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>session</code></b>
            (<code><span title="sqlalchemy.orm.Session">Session</span></code>)
        
        <div class="doc-md-description">
          <p>An open transaction within sqlalchemy</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>scores</code></b>
            (<code>dict[str, str | int | float]</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>Parsed Pose scores from Rosetta output</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>novel_interface</code></b>
            (<code>bool</code>, default:
                <code>True</code>
)
        
        <div class="doc-md-description">
          <p>Whether the pose interface is novel (i.e. docked) or from a bona-fide input</p>
        </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3281</span>
<span class="normal">3282</span>
<span class="normal">3283</span>
<span class="normal">3284</span>
<span class="normal">3285</span>
<span class="normal">3286</span>
<span class="normal">3287</span>
<span class="normal">3288</span>
<span class="normal">3289</span>
<span class="normal">3290</span>
<span class="normal">3291</span>
<span class="normal">3292</span>
<span class="normal">3293</span>
<span class="normal">3294</span>
<span class="normal">3295</span>
<span class="normal">3296</span>
<span class="normal">3297</span>
<span class="normal">3298</span>
<span class="normal">3299</span>
<span class="normal">3300</span>
<span class="normal">3301</span>
<span class="normal">3302</span>
<span class="normal">3303</span>
<span class="normal">3304</span>
<span class="normal">3305</span>
<span class="normal">3306</span>
<span class="normal">3307</span>
<span class="normal">3308</span>
<span class="normal">3309</span>
<span class="normal">3310</span>
<span class="normal">3311</span>
<span class="normal">3312</span>
<span class="normal">3313</span>
<span class="normal">3314</span>
<span class="normal">3315</span>
<span class="normal">3316</span>
<span class="normal">3317</span>
<span class="normal">3318</span>
<span class="normal">3319</span>
<span class="normal">3320</span>
<span class="normal">3321</span>
<span class="normal">3322</span>
<span class="normal">3323</span>
<span class="normal">3324</span>
<span class="normal">3325</span>
<span class="normal">3326</span>
<span class="normal">3327</span>
<span class="normal">3328</span>
<span class="normal">3329</span>
<span class="normal">3330</span>
<span class="normal">3331</span>
<span class="normal">3332</span>
<span class="normal">3333</span>
<span class="normal">3334</span>
<span class="normal">3335</span>
<span class="normal">3336</span>
<span class="normal">3337</span>
<span class="normal">3338</span>
<span class="normal">3339</span>
<span class="normal">3340</span>
<span class="normal">3341</span>
<span class="normal">3342</span>
<span class="normal">3343</span>
<span class="normal">3344</span>
<span class="normal">3345</span>
<span class="normal">3346</span>
<span class="normal">3347</span>
<span class="normal">3348</span>
<span class="normal">3349</span>
<span class="normal">3350</span>
<span class="normal">3351</span>
<span class="normal">3352</span>
<span class="normal">3353</span>
<span class="normal">3354</span>
<span class="normal">3355</span>
<span class="normal">3356</span>
<span class="normal">3357</span>
<span class="normal">3358</span>
<span class="normal">3359</span>
<span class="normal">3360</span>
<span class="normal">3361</span>
<span class="normal">3362</span>
<span class="normal">3363</span>
<span class="normal">3364</span>
<span class="normal">3365</span>
<span class="normal">3366</span>
<span class="normal">3367</span>
<span class="normal">3368</span>
<span class="normal">3369</span>
<span class="normal">3370</span>
<span class="normal">3371</span>
<span class="normal">3372</span>
<span class="normal">3373</span>
<span class="normal">3374</span>
<span class="normal">3375</span>
<span class="normal">3376</span>
<span class="normal">3377</span>
<span class="normal">3378</span>
<span class="normal">3379</span>
<span class="normal">3380</span>
<span class="normal">3381</span>
<span class="normal">3382</span>
<span class="normal">3383</span>
<span class="normal">3384</span>
<span class="normal">3385</span>
<span class="normal">3386</span>
<span class="normal">3387</span>
<span class="normal">3388</span>
<span class="normal">3389</span>
<span class="normal">3390</span>
<span class="normal">3391</span>
<span class="normal">3392</span>
<span class="normal">3393</span>
<span class="normal">3394</span>
<span class="normal">3395</span>
<span class="normal">3396</span>
<span class="normal">3397</span>
<span class="normal">3398</span>
<span class="normal">3399</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">calculate_pose_design_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">scores</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">novel_interface</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collects &#39;design&#39; and per-residue metrics on the reference Pose</span>

<span class="sd">    Args:</span>
<span class="sd">        session: An open transaction within sqlalchemy</span>
<span class="sd">        scores: Parsed Pose scores from Rosetta output</span>
<span class="sd">        novel_interface: Whether the pose interface is novel (i.e. docked) or from a bona-fide input</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span>
    <span class="n">pose_length</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">number_of_residues</span>
    <span class="n">residue_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">pose_length</span><span class="p">))</span>

    <span class="n">designs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pose</span><span class="p">]</span>
    <span class="c1"># Todo</span>
    <span class="c1">#  This function call is sort of accomplished by the following code</span>
    <span class="c1">#  residues_df = self.analyze_residue_metrics_per_design(designs=designs)</span>
    <span class="c1">#  Only differences are inclusion of interface_residue (^) and the novel_interface flag</span>

    <span class="c1"># novel_interface = False if not self.pose_source.protocols else True</span>
    <span class="c1"># if novel_interface:  # The input structure wasn&#39;t meant to be together, take the errat measurement as such</span>
    <span class="c1">#     source_errat = []</span>
    <span class="c1">#     for idx, entity in enumerate(self.pose.entities):</span>
    <span class="c1">#         _, oligomeric_errat = entity.assembly.errat(out_path=os.path.devnull)</span>
    <span class="c1">#         source_errat.append(oligomeric_errat[:entity.number_of_residues])</span>
    <span class="c1">#     # atomic_deviation[pose_source_name] = sum(source_errat_accuracy) / float(self.pose.number_of_entities)</span>
    <span class="c1">#     pose_source_errat = np.concatenate(source_errat)</span>
    <span class="c1"># else:</span>
    <span class="c1">#     # pose_assembly_minimally_contacting = self.pose.assembly_minimally_contacting</span>
    <span class="c1">#     # # atomic_deviation[pose_source_name], pose_per_residue_errat = \</span>
    <span class="c1">#     # _, pose_per_residue_errat = \</span>
    <span class="c1">#     #     pose_assembly_minimally_contacting.errat(out_path=os.path.devnull)</span>
    <span class="c1">#     # pose_source_errat = pose_per_residue_errat[:pose_length]</span>
    <span class="c1">#     # Get errat measurement</span>
    <span class="c1">#     # per_residue_data[pose_source_name].update(self.pose.per_residue_errat())</span>
    <span class="c1">#     pose_source_errat = self.pose.per_residue_errat()[&#39;errat_deviation&#39;]</span>

    <span class="n">interface_residue_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">pose</span><span class="o">.</span><span class="n">interface_residues</span><span class="p">]])</span>
    <span class="n">pose_name</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">name</span>
    <span class="c1"># pose_source_id = self.pose_source.id</span>
    <span class="c1"># Collect reference Structure metrics</span>
    <span class="n">per_residue_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">pose_name</span><span class="p">:</span>
                        <span class="p">{</span><span class="o">**</span><span class="n">pose</span><span class="o">.</span><span class="n">per_residue_interface_surface_area</span><span class="p">(),</span>
                         <span class="o">**</span><span class="n">pose</span><span class="o">.</span><span class="n">per_residue_contact_order</span><span class="p">(),</span>
                         <span class="c1"># &#39;errat_deviation&#39;: pose_source_errat</span>
                         <span class="o">**</span><span class="n">pose</span><span class="o">.</span><span class="n">per_residue_spatial_aggregation_propensity</span><span class="p">()</span>
                         <span class="p">}}</span>
    <span class="c1"># Convert per_residue_data into a dataframe matching residues_df orientation</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">residue_indices</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">per_residue_data</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Construct interface residue array</span>
    <span class="n">interface_residue_bool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">designs</span><span class="p">),</span> <span class="n">pose_length</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">interface_indices</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">interface_residue_indices</span><span class="p">)):</span>
        <span class="n">interface_residue_bool</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">interface_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">interface_residue_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">interface_residue_bool</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">residues_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                        <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
                                            <span class="p">(</span><span class="n">residue_indices</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;interface_residue&#39;</span><span class="p">])))</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">interface_residue_df</span><span class="p">)</span>
    <span class="c1"># Make buried surface area (bsa) columns, and residue classification</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">calculate_residue_buried_surface_area</span><span class="p">(</span><span class="n">residues_df</span><span class="p">)</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">classify_interface_residues</span><span class="p">(</span><span class="n">residues_df</span><span class="p">)</span>
    <span class="c1"># Todo same to here</span>

    <span class="n">designs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_design_metrics_per_design</span><span class="p">(</span><span class="n">residues_df</span><span class="p">,</span> <span class="n">designs</span><span class="p">)</span>

    <span class="c1"># Score using proteinmpnn</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">use_proteinmpnn</span><span class="p">:</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="p">[</span><span class="n">pose</span><span class="o">.</span><span class="n">sequence</span><span class="p">]</span>  <span class="c1"># Expected ASU sequence</span>
        <span class="n">sequences_and_scores</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">score_sequences</span><span class="p">(</span>
            <span class="n">sequences</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">proteinmpnn_model</span><span class="p">)</span>
        <span class="c1"># design_residues = np.zeros((1, pose_length), dtype=bool)</span>
        <span class="c1"># design_residues[interface_residue_indices] = 1</span>
        <span class="n">sequences_and_scores</span><span class="p">[</span><span class="s1">&#39;design_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">pose_length</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">mpnn_designs_df</span><span class="p">,</span> <span class="n">mpnn_residues_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_proteinmpnn_metrics</span><span class="p">([</span><span class="n">pose_name</span><span class="p">],</span> <span class="n">sequences_and_scores</span><span class="p">)</span>
        <span class="n">entity_designs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_design_entities_per_residue</span><span class="p">(</span><span class="n">mpnn_residues_df</span><span class="p">)</span>
        <span class="n">designs_df</span> <span class="o">=</span> <span class="n">designs_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mpnn_designs_df</span><span class="p">)</span>
        <span class="c1"># sequences_df = self.analyze_sequence_metrics_per_design(sequences=[self.pose.sequence],</span>
        <span class="c1">#                                                         design_ids=[pose_source_id])</span>
        <span class="c1"># designs_df = designs_df.join(self.analyze_design_metrics_per_residue(sequences_df))</span>
        <span class="c1"># # Join per-residue like DataFrames</span>
        <span class="c1"># # Each of these could have different index/column, so we use concat to perform an outer merge</span>
        <span class="c1"># residues_df = residues_df.join([mpnn_residues_df, sequences_df])</span>
        <span class="n">residues_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mpnn_residues_df</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">entity_designs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">scores</span><span class="p">:</span>
        <span class="c1"># pose_source_id = self.pose_source.id</span>
        <span class="n">scores_with_identifier</span> <span class="o">=</span> <span class="p">{</span><span class="n">pose_name</span><span class="p">:</span> <span class="n">scores</span><span class="p">}</span>
        <span class="n">scores_df</span><span class="p">,</span> <span class="n">rosetta_residues_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_rosetta_scores</span><span class="p">(</span><span class="n">scores_with_identifier</span><span class="p">)</span>
        <span class="c1"># Currently the metrics putils.protocol and putils.design_parent are not handle as this is the pose_source</span>
        <span class="c1"># and no protocols should have been run on this, nor should it have a parent. They will be removed when</span>
        <span class="c1"># output to the database</span>
        <span class="n">scores_df</span> <span class="o">=</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">sum_per_residue_metrics</span><span class="p">(</span><span class="n">rosetta_residues_df</span><span class="p">))</span>
        <span class="c1"># Finish calculation of Rosetta scores with included metrics</span>
        <span class="n">designs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rosetta_column_combinations</span><span class="p">(</span><span class="n">designs_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scores_df</span><span class="p">))</span>
        <span class="n">residues_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rosetta_residues_df</span><span class="p">)</span>

    <span class="c1"># with self.job.db.session(expire_on_commit=False) as session:</span>
    <span class="c1"># Currently, self isn&#39;t producing any new information from database, session only important for metrics</span>
    <span class="c1"># session.add(self)</span>
    <span class="c1"># Correct the index of the DataFrame by changing from &quot;name&quot; to database ID</span>
    <span class="n">name_to_id_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">pose_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_source</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
    <span class="n">designs_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">designs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">name_to_id_map</span><span class="p">)</span>
    <span class="c1"># Must move the entity_id to the columns for index.map to work</span>
    <span class="n">entity_designs_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">entity_designs_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">entity_designs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">name_to_id_map</span><span class="p">)</span>
    <span class="n">residues_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">name_to_id_map</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">designs</span><span class="o">=</span><span class="n">designs_df</span><span class="p">)</span>
    <span class="n">output_residues</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">output_residues</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">residues</span><span class="o">=</span><span class="n">residues_df</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Only save the &#39;design_residue&#39; columns</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">residues_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="n">sql</span><span class="o">.</span><span class="n">DesignResidues</span><span class="o">.</span><span class="n">design_residue</span><span class="o">.</span><span class="n">name</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># When self.job.use_proteinmpnn is false</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">design_residues</span><span class="o">=</span><span class="n">residues_df</span><span class="p">)</span>
    <span class="n">sql</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">entity_designs</span><span class="o">=</span><span class="n">entity_designs_df</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.analyze_alphafold_metrics" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">analyze_alphafold_metrics</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">analyze_alphafold_metrics</span><span class="p">(</span><span class="n">folding_scores</span><span class="p">:</span> <span class="n">dict</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="p">[</span><span class="n">dict</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="n"><span title="numpy.ndarray">ndarray</span></span><span class="p">]]],</span> <span class="n">pose_length</span><span class="p">:</span> <span class="n">int</span><span class="p">,</span> <span class="n">model_type</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">interface_indices</span><span class="p">:</span> <span class="n">tuple</span><span class="p">[</span><span class="n"><span title="collections.abc.Iterable">Iterable</span></span><span class="p">[</span><span class="n">int</span><span class="p">],</span> <span class="n"><span title="collections.abc.Iterable">Iterable</span></span><span class="p">[</span><span class="n">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tuple</span><span class="p">[</span><span class="n"><span title="pandas.DataFrame">DataFrame</span></span><span class="p">,</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span><span class="p">]</span> <span class="o">|</span> <span class="n">tuple</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>From a set of folding metrics output by Alphafold (or possible other)</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>folding_scores</code></b>
            (<code>dict[str, [dict[str, <span title="numpy.ndarray">ndarray</span>]]]</code>)
        
        <div class="doc-md-description">
          <p>Metrics which may contain the following features as single metric or list or metrics
{'predicted_aligned_error': [(n_residues, n_residues), ...]  # multimer/monomer_ptm
 'plddt': [(n_residues,), ...]
 'predicted_interface_template_modeling_score': [float, ...]  # multimer
 'predicted_template_modeling_score': [float, ...]  # multimer/monomer_ptm
 'rmsd_prediction_ensemble: [(number_of_models), ...]
 }</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>pose_length</code></b>
            (<code>int</code>)
        
        <div class="doc-md-description">
          <p>The length of the scores to return for metrics with an array</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>model_type</code></b>
            (<code>str</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The type of model used during prediction</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>interface_indices</code></b>
            (<code>tuple[<span title="collections.abc.Iterable">Iterable</span>[int], <span title="collections.abc.Iterable">Iterable</span>[int]]</code>, default:
                <code>False</code>
)
        
        <div class="doc-md-description">
          <p>The Residue instance of two sides of a predicted interface</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    A tuple of DataFrame where each contains (
        A per-design metric DataFrame where each index is the design id and the columns are design metrics,
        A per-residue metric DataFrame where each index is the design id and the columns are
            (residue index, residue metric)
    )</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3403</span>
<span class="normal">3404</span>
<span class="normal">3405</span>
<span class="normal">3406</span>
<span class="normal">3407</span>
<span class="normal">3408</span>
<span class="normal">3409</span>
<span class="normal">3410</span>
<span class="normal">3411</span>
<span class="normal">3412</span>
<span class="normal">3413</span>
<span class="normal">3414</span>
<span class="normal">3415</span>
<span class="normal">3416</span>
<span class="normal">3417</span>
<span class="normal">3418</span>
<span class="normal">3419</span>
<span class="normal">3420</span>
<span class="normal">3421</span>
<span class="normal">3422</span>
<span class="normal">3423</span>
<span class="normal">3424</span>
<span class="normal">3425</span>
<span class="normal">3426</span>
<span class="normal">3427</span>
<span class="normal">3428</span>
<span class="normal">3429</span>
<span class="normal">3430</span>
<span class="normal">3431</span>
<span class="normal">3432</span>
<span class="normal">3433</span>
<span class="normal">3434</span>
<span class="normal">3435</span>
<span class="normal">3436</span>
<span class="normal">3437</span>
<span class="normal">3438</span>
<span class="normal">3439</span>
<span class="normal">3440</span>
<span class="normal">3441</span>
<span class="normal">3442</span>
<span class="normal">3443</span>
<span class="normal">3444</span>
<span class="normal">3445</span>
<span class="normal">3446</span>
<span class="normal">3447</span>
<span class="normal">3448</span>
<span class="normal">3449</span>
<span class="normal">3450</span>
<span class="normal">3451</span>
<span class="normal">3452</span>
<span class="normal">3453</span>
<span class="normal">3454</span>
<span class="normal">3455</span>
<span class="normal">3456</span>
<span class="normal">3457</span>
<span class="normal">3458</span>
<span class="normal">3459</span>
<span class="normal">3460</span>
<span class="normal">3461</span>
<span class="normal">3462</span>
<span class="normal">3463</span>
<span class="normal">3464</span>
<span class="normal">3465</span>
<span class="normal">3466</span>
<span class="normal">3467</span>
<span class="normal">3468</span>
<span class="normal">3469</span>
<span class="normal">3470</span>
<span class="normal">3471</span>
<span class="normal">3472</span>
<span class="normal">3473</span>
<span class="normal">3474</span>
<span class="normal">3475</span>
<span class="normal">3476</span>
<span class="normal">3477</span>
<span class="normal">3478</span>
<span class="normal">3479</span>
<span class="normal">3480</span>
<span class="normal">3481</span>
<span class="normal">3482</span>
<span class="normal">3483</span>
<span class="normal">3484</span>
<span class="normal">3485</span>
<span class="normal">3486</span>
<span class="normal">3487</span>
<span class="normal">3488</span>
<span class="normal">3489</span>
<span class="normal">3490</span>
<span class="normal">3491</span>
<span class="normal">3492</span>
<span class="normal">3493</span>
<span class="normal">3494</span>
<span class="normal">3495</span>
<span class="normal">3496</span>
<span class="normal">3497</span>
<span class="normal">3498</span>
<span class="normal">3499</span>
<span class="normal">3500</span>
<span class="normal">3501</span>
<span class="normal">3502</span>
<span class="normal">3503</span>
<span class="normal">3504</span>
<span class="normal">3505</span>
<span class="normal">3506</span>
<span class="normal">3507</span>
<span class="normal">3508</span>
<span class="normal">3509</span>
<span class="normal">3510</span>
<span class="normal">3511</span>
<span class="normal">3512</span>
<span class="normal">3513</span>
<span class="normal">3514</span>
<span class="normal">3515</span>
<span class="normal">3516</span>
<span class="normal">3517</span>
<span class="normal">3518</span>
<span class="normal">3519</span>
<span class="normal">3520</span>
<span class="normal">3521</span>
<span class="normal">3522</span>
<span class="normal">3523</span>
<span class="normal">3524</span>
<span class="normal">3525</span>
<span class="normal">3526</span>
<span class="normal">3527</span>
<span class="normal">3528</span>
<span class="normal">3529</span>
<span class="normal">3530</span>
<span class="normal">3531</span>
<span class="normal">3532</span>
<span class="normal">3533</span>
<span class="normal">3534</span>
<span class="normal">3535</span>
<span class="normal">3536</span>
<span class="normal">3537</span>
<span class="normal">3538</span>
<span class="normal">3539</span>
<span class="normal">3540</span>
<span class="normal">3541</span>
<span class="normal">3542</span>
<span class="normal">3543</span>
<span class="normal">3544</span>
<span class="normal">3545</span>
<span class="normal">3546</span>
<span class="normal">3547</span>
<span class="normal">3548</span>
<span class="normal">3549</span>
<span class="normal">3550</span>
<span class="normal">3551</span>
<span class="normal">3552</span>
<span class="normal">3553</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_alphafold_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folding_scores</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]],</span> <span class="n">pose_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                              <span class="n">model_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">interface_indices</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;From a set of folding metrics output by Alphafold (or possible other)</span>

<span class="sd">    Args:</span>
<span class="sd">        folding_scores: Metrics which may contain the following features as single metric or list or metrics</span>
<span class="sd">            {&#39;predicted_aligned_error&#39;: [(n_residues, n_residues), ...]  # multimer/monomer_ptm</span>
<span class="sd">             &#39;plddt&#39;: [(n_residues,), ...]</span>
<span class="sd">             &#39;predicted_interface_template_modeling_score&#39;: [float, ...]  # multimer</span>
<span class="sd">             &#39;predicted_template_modeling_score&#39;: [float, ...]  # multimer/monomer_ptm</span>
<span class="sd">             &#39;rmsd_prediction_ensemble: [(number_of_models), ...]</span>
<span class="sd">             }</span>
<span class="sd">        pose_length: The length of the scores to return for metrics with an array</span>
<span class="sd">        model_type: The type of model used during prediction</span>
<span class="sd">        interface_indices: The Residue instance of two sides of a predicted interface</span>
<span class="sd">    Returns:</span>
<span class="sd">        A tuple of DataFrame where each contains (</span>
<span class="sd">            A per-design metric DataFrame where each index is the design id and the columns are design metrics,</span>
<span class="sd">            A per-residue metric DataFrame where each index is the design id and the columns are</span>
<span class="sd">                (residue index, residue metric)</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">folding_scores</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">interface_indices</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interface_indices</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;The argument &quot;interface_indices&quot; must contain a pair of indices for each side of an interfaces. &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;Found the number of interfaces, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">interface_indices</span><span class="p">)</span><span class="si">}</span><span class="s1"> != 2, the number expected&#39;</span><span class="p">)</span>
        <span class="n">interface_indices1</span><span class="p">,</span> <span class="n">interface_indices2</span> <span class="o">=</span> <span class="n">interface_indices</span>
        <span class="c1"># Check if this interface is 2-fold symetric. If so, the interface_indices2 will be empty</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">interface_indices2</span><span class="p">:</span>
            <span class="n">interface_indices2</span> <span class="o">=</span> <span class="n">interface_indices1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">interface_indices1</span> <span class="o">=</span> <span class="n">interface_indices2</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># def describe_metrics(array_like: Iterable[int] | np.ndarray) -&gt; dict[str, float]:</span>
    <span class="c1">#     length = len(array_like)</span>
    <span class="c1">#     middle, remain = divmod(length, 2)</span>
    <span class="c1">#     if remain:  # Odd</span>
    <span class="c1">#         median_div = 1</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         middle = slice(middle, 1 + middle)</span>
    <span class="c1">#         median_div = 2</span>
    <span class="c1">#</span>
    <span class="c1">#     return dict(</span>
    <span class="c1">#         min=min(array_like),</span>
    <span class="c1">#         max=max(array_like),</span>
    <span class="c1">#         mean=sum(array_like) / length,</span>
    <span class="c1">#         median=sum(list(sorted(array_like))[middle]) / median_div</span>
    <span class="c1">#     )</span>

    <span class="n">score_types_mean</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rmsd_prediction_ensemble&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;multimer&#39;</span> <span class="ow">in</span> <span class="n">model_type</span><span class="p">:</span>
        <span class="n">measure_pae</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">score_types_mean</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;predicted_interface_template_modeling_score&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;predicted_template_modeling_score&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;ptm&#39;</span> <span class="ow">in</span> <span class="n">model_type</span><span class="p">:</span>
        <span class="n">measure_pae</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">score_types_mean</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;predicted_template_modeling_score&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">measure_pae</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># number_models, number_of_residues = len(representative_plddt_per_model[0])</span>
    <span class="c1"># number_models = 1</span>
    <span class="n">per_residue_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">design_scores</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">design_name</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">folding_scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found metrics with contents:</span><span class="se">\n</span><span class="si">{</span><span class="n">scores</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># This shouldn&#39;t fail as plddt should always be present</span>
        <span class="n">array_scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">scalar_scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">score_type</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># rmsd_metrics = describe_metrics(rmsds)</span>
            <span class="k">if</span> <span class="n">score_type</span> <span class="ow">in</span> <span class="n">score_types_mean</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">score_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                    <span class="n">scalar_scores</span><span class="p">[</span><span class="n">score_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">score</span><span class="p">)</span> <span class="o">/</span> <span class="n">score_len</span>
                    <span class="k">if</span> <span class="n">score_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># Using the standard deviation of a sample</span>
                        <span class="n">deviation</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">([(</span><span class="n">score_</span><span class="o">-</span><span class="n">mean_</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">score_</span> <span class="ow">in</span> <span class="n">score</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">score_len</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">deviation</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="n">scalar_scores</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">score_type</span><span class="si">}</span><span class="s1">_deviation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deviation</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scalar_scores</span><span class="p">[</span><span class="n">score_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
            <span class="c1"># Process &#39;predicted_aligned_error&#39; when multimer/monomer_ptm. shape is (n_residues, n_residues)</span>
            <span class="k">elif</span> <span class="n">measure_pae</span> <span class="ow">and</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s1">&#39;predicted_aligned_error&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="c1"># First average over each residue, storing in a container</span>
                    <span class="n">number_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                    <span class="n">pae</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
                    <span class="n">pae</span><span class="p">,</span> <span class="o">*</span><span class="n">other_pae</span> <span class="o">=</span> <span class="n">score</span>
                    <span class="k">for</span> <span class="n">pae_</span> <span class="ow">in</span> <span class="n">other_pae</span><span class="p">:</span>
                        <span class="n">pae</span> <span class="o">+=</span> <span class="n">pae_</span>
                    <span class="k">if</span> <span class="n">number_models</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">pae</span> <span class="o">/=</span> <span class="n">number_models</span>
                    <span class="c1"># pae_container = np.zeros((number_models, pose_length), dtype=np.float32)</span>
                    <span class="c1"># for idx, pae_ in enumerate(score):</span>
                    <span class="c1">#     pae_container[idx, :] = pae_.mean(axis=0)[:pose_length]</span>
                    <span class="c1"># # Next, average over each model</span>
                    <span class="c1"># pae = pae_container.mean(axis=0)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pae</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">array_scores</span><span class="p">[</span><span class="s1">&#39;predicted_aligned_error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pae</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="n">pose_length</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">interface_indices1</span><span class="p">:</span>
                    <span class="c1"># Index the resulting pae to get the error at the interface residues in particular</span>
                    <span class="c1"># interface_pae_means = [model_pae[interface_indices1][:, interface_indices2].mean()</span>
                    <span class="c1">#                        for model_pae in scores[&#39;predicted_aligned_error&#39;]]</span>
                    <span class="c1"># scalar_scores[&#39;predicted_aligned_error_interface&#39;] = sum(interface_pae_means) / number_models</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found interface_indices1: </span><span class="si">{</span><span class="n">interface_indices1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found interface_indices2: </span><span class="si">{</span><span class="n">interface_indices2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">interface_pae</span> <span class="o">=</span> <span class="n">pae</span><span class="p">[</span><span class="n">interface_indices1</span><span class="p">][:,</span> <span class="n">interface_indices2</span><span class="p">]</span>
                    <span class="n">scalar_scores</span><span class="p">[</span><span class="s1">&#39;predicted_aligned_error_interface&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interface_pae</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                    <span class="n">scalar_scores</span><span class="p">[</span><span class="s1">&#39;predicted_aligned_error_interface_deviation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interface_pae</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">score_type</span> <span class="o">==</span> <span class="s1">&#39;plddt&#39;</span><span class="p">:</span>  <span class="c1"># Todo combine with above</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">number_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                    <span class="n">plddt</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
                    <span class="n">plddt</span><span class="p">,</span> <span class="o">*</span><span class="n">other_plddt</span> <span class="o">=</span> <span class="n">score</span>
                    <span class="k">for</span> <span class="n">plddt_</span> <span class="ow">in</span> <span class="n">other_plddt</span><span class="p">:</span>
                        <span class="n">plddt</span> <span class="o">+=</span> <span class="n">plddt_</span>
                    <span class="k">if</span> <span class="n">number_models</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">plddt</span> <span class="o">/=</span> <span class="n">number_models</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plddt</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">array_scores</span><span class="p">[</span><span class="s1">&#39;plddt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plddt</span><span class="p">[:</span><span class="n">pose_length</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found scalar_scores with contents:</span><span class="se">\n</span><span class="si">{</span><span class="n">scalar_scores</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found array_scores with contents:</span><span class="se">\n</span><span class="si">{</span><span class="n">array_scores</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">per_residue_data</span><span class="p">[</span><span class="n">design_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">array_scores</span>
        <span class="n">design_scores</span><span class="p">[</span><span class="n">design_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">scalar_scores</span>

    <span class="n">designs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">design_scores</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="c1"># residues_df = pd.DataFrame.from_dict(per_residue_data, orient=&#39;index&#39;)</span>
    <span class="n">residue_indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">pose_length</span><span class="p">)</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">residue_indices</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">per_residue_data</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">designs_df</span> <span class="o">=</span> <span class="n">designs_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">sum_per_residue_metrics</span><span class="p">(</span><span class="n">residues_df</span><span class="p">))</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;plddt&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">pose_length</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;plddt_deviation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;plddt&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;predicted_aligned_error&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">pose_length</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;predicted_aligned_error_deviation&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;predicted_aligned_error&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">designs_df</span><span class="p">,</span> <span class="n">residues_df</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.analyze_design_entities_per_residue" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">analyze_design_entities_per_residue</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">analyze_design_entities_per_residue</span><span class="p">(</span><span class="n">residues_df</span><span class="p">:</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Gather sequence metrics on a per-entity basis and write to the database</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>residues_df</code></b>
            (<code><span title="pandas.DataFrame">DataFrame</span></code>)
        
        <div class="doc-md-description">
          <p>A per-residue metric DataFrame where each index is the design id and the columns are
(residue index, residue metric)</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    A per-entity metric DataFrame where each index is a combination of (design_id, entity_id) and the columns
        are design metrics</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3555</span>
<span class="normal">3556</span>
<span class="normal">3557</span>
<span class="normal">3558</span>
<span class="normal">3559</span>
<span class="normal">3560</span>
<span class="normal">3561</span>
<span class="normal">3562</span>
<span class="normal">3563</span>
<span class="normal">3564</span>
<span class="normal">3565</span>
<span class="normal">3566</span>
<span class="normal">3567</span>
<span class="normal">3568</span>
<span class="normal">3569</span>
<span class="normal">3570</span>
<span class="normal">3571</span>
<span class="normal">3572</span>
<span class="normal">3573</span>
<span class="normal">3574</span>
<span class="normal">3575</span>
<span class="normal">3576</span>
<span class="normal">3577</span>
<span class="normal">3578</span>
<span class="normal">3579</span>
<span class="normal">3580</span>
<span class="normal">3581</span>
<span class="normal">3582</span>
<span class="normal">3583</span>
<span class="normal">3584</span>
<span class="normal">3585</span>
<span class="normal">3586</span>
<span class="normal">3587</span>
<span class="normal">3588</span>
<span class="normal">3589</span>
<span class="normal">3590</span>
<span class="normal">3591</span>
<span class="normal">3592</span>
<span class="normal">3593</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_design_entities_per_residue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">residues_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gather sequence metrics on a per-entity basis and write to the database</span>

<span class="sd">    Args:</span>
<span class="sd">        residues_df: A per-residue metric DataFrame where each index is the design id and the columns are</span>
<span class="sd">            (residue index, residue metric)</span>
<span class="sd">    Returns:</span>
<span class="sd">        A per-entity metric DataFrame where each index is a combination of (design_id, entity_id) and the columns</span>
<span class="sd">            are design metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">residue_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_residues</span><span class="p">))</span>
    <span class="n">mutation_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;mutation&#39;</span><span class="p">]]</span>

    <span class="n">entity_designs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">entity_data</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entity_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">):</span>
        <span class="n">number_mutations</span> <span class="o">=</span> \
            <span class="n">mutation_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[</span><span class="n">residue_indices</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">n_terminal_residue</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                                                         <span class="mi">1</span> <span class="o">+</span> <span class="n">entity</span><span class="o">.</span><span class="n">c_terminal_residue</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="p">:]]</span>\
            <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">entity_designs</span><span class="p">[</span><span class="n">entity_data</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">number_mutations</span><span class="o">=</span><span class="n">number_mutations</span><span class="p">,</span>
            <span class="n">percent_mutations</span><span class="o">=</span><span class="n">number_mutations</span> <span class="o">/</span> <span class="n">entity</span><span class="o">.</span><span class="n">number_of_residues</span><span class="p">)</span>

    <span class="c1"># Set up the DesignEntityMetrics dataframe for writing</span>
    <span class="n">entity_designs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">entity_designs</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
                                  <span class="n">keys</span><span class="o">=</span><span class="n">entity_designs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">design_ids</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">entity_designs_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">entity_designs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_levels</span><span class="p">(</span><span class="n">design_ids</span><span class="p">,</span> <span class="n">level</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># entity_designs_df = pd.concat([pd.DataFrame(data) for data in entity_designs.values()])</span>
    <span class="c1"># design_name_to_id_map = dict(zip(entity_designs_df.index.get_level_values(-1), design_ids))</span>
    <span class="c1"># # mapped_index = entity_designs_df.index.map(design_name_to_id_map)</span>
    <span class="c1"># entity_designs_df.index = \</span>
    <span class="c1">#     pd.MultiIndex.from_tuples(zip(entity_designs.keys(),</span>
    <span class="c1">#                                   entity_designs_df.index.map(design_name_to_id_map).tolist()))</span>
    <span class="c1"># input(entity_designs_df)</span>
    <span class="n">entity_designs_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">entity_designs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="p">[</span><span class="n">sql</span><span class="o">.</span><span class="n">DesignEntityMetrics</span><span class="o">.</span><span class="n">entity_id</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sql</span><span class="o">.</span><span class="n">DesignEntityMetrics</span><span class="o">.</span><span class="n">design_id</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
    <span class="c1"># entity_designs_df.reset_index(level=-1, inplace=True)</span>
    <span class="k">return</span> <span class="n">entity_designs_df</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.analyze_design_metrics_per_design" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">analyze_design_metrics_per_design</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">analyze_design_metrics_per_design</span><span class="p">(</span><span class="n">residues_df</span><span class="p">:</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span><span class="p">,</span> <span class="n">designs</span><span class="p">:</span> <span class="n"><span title="collections.abc.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><span title="symdesign.structure.model.Pose">Pose</span></span><span class="p">]</span> <span class="o">|</span> <span class="n"><span title="collections.abc.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><span title="typing.AnyStr">AnyStr</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Take every design Model and perform design level structural analysis. Sums per-residue metrics (residues_df)</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>residues_df</code></b>
            (<code><span title="pandas.DataFrame">DataFrame</span></code>)
        
        <div class="doc-md-description">
          <p>The typical per-residue metric DataFrame where each index is the design id and the columns are
(residue index, residue metric)</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>designs</code></b>
            (<code><span title="collections.abc.Iterable">Iterable</span>[<span title="symdesign.structure.model.Pose">Pose</span>] | <span title="collections.abc.Iterable">Iterable</span>[<span title="typing.AnyStr">AnyStr</span>]</code>)
        
        <div class="doc-md-description">
          <p>The designs to perform analysis on. By default, fetches all available structures</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    A per-design metric DataFrame where each index is the design id and the columns are design metrics
    Including metrics 'interface_area_total' and 'number_residues_interface' which are used in other analysis
        functions</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3595</span>
<span class="normal">3596</span>
<span class="normal">3597</span>
<span class="normal">3598</span>
<span class="normal">3599</span>
<span class="normal">3600</span>
<span class="normal">3601</span>
<span class="normal">3602</span>
<span class="normal">3603</span>
<span class="normal">3604</span>
<span class="normal">3605</span>
<span class="normal">3606</span>
<span class="normal">3607</span>
<span class="normal">3608</span>
<span class="normal">3609</span>
<span class="normal">3610</span>
<span class="normal">3611</span>
<span class="normal">3612</span>
<span class="normal">3613</span>
<span class="normal">3614</span>
<span class="normal">3615</span>
<span class="normal">3616</span>
<span class="normal">3617</span>
<span class="normal">3618</span>
<span class="normal">3619</span>
<span class="normal">3620</span>
<span class="normal">3621</span>
<span class="normal">3622</span>
<span class="normal">3623</span>
<span class="normal">3624</span>
<span class="normal">3625</span>
<span class="normal">3626</span>
<span class="normal">3627</span>
<span class="normal">3628</span>
<span class="normal">3629</span>
<span class="normal">3630</span>
<span class="normal">3631</span>
<span class="normal">3632</span>
<span class="normal">3633</span>
<span class="normal">3634</span>
<span class="normal">3635</span>
<span class="normal">3636</span>
<span class="normal">3637</span>
<span class="normal">3638</span>
<span class="normal">3639</span>
<span class="normal">3640</span>
<span class="normal">3641</span>
<span class="normal">3642</span>
<span class="normal">3643</span>
<span class="normal">3644</span>
<span class="normal">3645</span>
<span class="normal">3646</span>
<span class="normal">3647</span>
<span class="normal">3648</span>
<span class="normal">3649</span>
<span class="normal">3650</span>
<span class="normal">3651</span>
<span class="normal">3652</span>
<span class="normal">3653</span>
<span class="normal">3654</span>
<span class="normal">3655</span>
<span class="normal">3656</span>
<span class="normal">3657</span>
<span class="normal">3658</span>
<span class="normal">3659</span>
<span class="normal">3660</span>
<span class="normal">3661</span>
<span class="normal">3662</span>
<span class="normal">3663</span>
<span class="normal">3664</span>
<span class="normal">3665</span>
<span class="normal">3666</span>
<span class="normal">3667</span>
<span class="normal">3668</span>
<span class="normal">3669</span>
<span class="normal">3670</span>
<span class="normal">3671</span>
<span class="normal">3672</span>
<span class="normal">3673</span>
<span class="normal">3674</span>
<span class="normal">3675</span>
<span class="normal">3676</span>
<span class="normal">3677</span>
<span class="normal">3678</span>
<span class="normal">3679</span>
<span class="normal">3680</span>
<span class="normal">3681</span>
<span class="normal">3682</span>
<span class="normal">3683</span>
<span class="normal">3684</span>
<span class="normal">3685</span>
<span class="normal">3686</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_design_metrics_per_design</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">residues_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                      <span class="n">designs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Pose</span><span class="p">]</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Take every design Model and perform design level structural analysis. Sums per-residue metrics (residues_df)</span>

<span class="sd">    Args:</span>
<span class="sd">        residues_df: The typical per-residue metric DataFrame where each index is the design id and the columns are</span>
<span class="sd">            (residue index, residue metric)</span>
<span class="sd">        designs: The designs to perform analysis on. By default, fetches all available structures</span>
<span class="sd">    Returns:</span>
<span class="sd">        A per-design metric DataFrame where each index is the design id and the columns are design metrics</span>
<span class="sd">        Including metrics &#39;interface_area_total&#39; and &#39;number_residues_interface&#39; which are used in other analysis</span>
<span class="sd">            functions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#     designs_df: The typical per-design metric DataFrame where each index is the design id and the columns are</span>
    <span class="c1">#         design metrics</span>
    <span class="c1"># Find all designs files</span>
    <span class="c1">#   Todo fold these into Model(s) and attack metrics from Pose objects?</span>
    <span class="c1"># if designs is None:</span>
    <span class="c1">#     designs = []</span>

    <span class="c1"># Compute structural measurements for all designs</span>
    <span class="n">pose_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_kwargs</span>
    <span class="n">interface_local_density</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># number_residues_interface = {}</span>
    <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">designs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pose_name</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">name</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># This is likely a filepath</span>
            <span class="n">pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">pose</span><span class="p">,</span> <span class="o">**</span><span class="n">pose_kwargs</span><span class="p">)</span>
            <span class="n">pose_name</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># Must find interface residues before measure local_density</span>
        <span class="n">pose</span><span class="o">.</span><span class="n">find_and_split_interface</span><span class="p">()</span>
        <span class="c1"># number_residues_interface[pose.name] = len(pose.interface_residues)</span>
        <span class="n">interface_local_density</span><span class="p">[</span><span class="n">pose_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">local_density_interface</span><span class="p">()</span>

    <span class="c1"># designs_df = pd.Series(interface_local_density, index=residues_df.index,</span>
    <span class="c1">#                        name=&#39;interface_local_density&#39;).to_frame()</span>
    <span class="n">designs_df</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">sum_per_residue_metrics</span><span class="p">(</span><span class="n">residues_df</span><span class="p">)</span>
    <span class="n">interface_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;interface_residue&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;spatial_aggregation_propensity_interface&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="p">((</span><span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;spatial_aggregation_propensity_unbound&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
          <span class="o">-</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;spatial_aggregation_propensity&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
         <span class="o">*</span> <span class="n">interface_df</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Divide by the number of interface residues</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;spatial_aggregation_propensity_interface&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">interface_df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Find the average for these summed design metrics</span>
    <span class="n">pose_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_residues</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;spatial_aggregation_propensity_unbound&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">pose_length</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;spatial_aggregation_propensity&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">pose_length</span>
    <span class="c1"># designs_df[&#39;number_residues_interface&#39;] = pd.Series(number_residues_interface)</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;interface_local_density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">interface_local_density</span><span class="p">)</span>

    <span class="c1"># self.load_pose()</span>
    <span class="c1"># # Make designs_df errat_deviation that takes into account the pose_source sequence errat_deviation</span>
    <span class="c1"># # Get per-residue errat scores from the residues_df</span>
    <span class="c1"># errat_df = residues_df.loc[:, idx_slice[:, &#39;errat_deviation&#39;]].droplevel(-1, axis=1)</span>
    <span class="c1">#</span>
    <span class="c1"># # Todo improve efficiency by using precomputed. Something like:</span>
    <span class="c1"># #  stmt = select(ResidueMetrics).where(ResidueMetrics.pose_id == self.id, ResidueMetrics.name == self.name)</span>
    <span class="c1"># #  rows = session.scalars(stmt)</span>
    <span class="c1"># #  row_dict = {row.index: row.errat_deviation for row in rows}</span>
    <span class="c1"># #  pd.Series(row_dict, name=&#39;errat_Deviation&#39;)</span>
    <span class="c1"># # pose_source_errat = errat_df.loc[self.pose.name, :]</span>
    <span class="c1"># pose_source_errat = self.pose.per_residue_errat()[&#39;errat_deviation&#39;]</span>
    <span class="c1"># # Include in errat_deviation if errat score is &lt; 2 std devs and isn&#39;t 0 to begin with</span>
    <span class="c1"># source_errat_inclusion_boolean = \</span>
    <span class="c1">#     np.logical_and(pose_source_errat &lt; metrics.errat_2_sigma, pose_source_errat != 0.)</span>
    <span class="c1"># # Find residues where designs deviate above wild-type errat scores</span>
    <span class="c1"># errat_sig_df = errat_df.sub(pose_source_errat, axis=1) &gt; metrics.errat_1_sigma  # axis=1 is per-residue subtract</span>
    <span class="c1"># # Then select only those residues which are expressly important by the inclusion boolean</span>
    <span class="c1"># # This overwrites the metrics.sum_per_residue_metrics() value</span>
    <span class="c1"># designs_df[&#39;errat_deviation&#39;] = (errat_sig_df.loc[:, source_errat_inclusion_boolean] * 1).sum(axis=1)</span>

    <span class="c1"># pose_df = self.pose.df</span>
    <span class="c1"># # Todo should each have the same number_residues_interface? need each design specifics</span>
    <span class="c1"># designs_df[&#39;number_residues_interface&#39;] = pose_df[&#39;number_residues_interface&#39;]</span>

    <span class="c1"># Find the proportion of the residue surface area that is solvent accessible versus buried in the interface</span>
    <span class="c1"># if &#39;interface_area_total&#39; in designs_df and &#39;area_total_complex&#39; in designs_df:</span>
    <span class="n">interface_bsa_df</span> <span class="o">=</span> <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;interface_area_total&#39;</span><span class="p">]</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;interface_area_to_residue_surface_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="p">(</span><span class="n">interface_bsa_df</span> <span class="o">/</span> <span class="p">(</span><span class="n">interface_bsa_df</span> <span class="o">+</span> <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;area_total_complex&#39;</span><span class="p">]))</span>

    <span class="c1"># designs_df[&#39;interface_area_total&#39;] = pose_df[&#39;interface_area_total&#39;]</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;number_of_interface_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">designs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">metrics</span><span class="o">.</span><span class="n">residue_classification</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">designs_df</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">columns_to_new_column</span><span class="p">(</span><span class="n">designs_df</span><span class="p">,</span> <span class="n">metrics</span><span class="o">.</span><span class="n">division_pairs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;truediv&#39;</span><span class="p">)</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;interface_composition_similarity&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">designs_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">interface_composition_similarity</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">designs_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;number_of_interface_class&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">designs_df</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.analyze_design_metrics_per_residue" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">analyze_design_metrics_per_residue</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">analyze_design_metrics_per_residue</span><span class="p">(</span><span class="n">residues_df</span><span class="p">:</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Take every design in the residues_df and perform design level statistical analysis</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>residues_df</code></b>
            (<code><span title="pandas.DataFrame">DataFrame</span></code>)
        
        <div class="doc-md-description">
          <p>The typical per-residue metric DataFrame where each index is the design id and the columns are
(residue index, residue metric)</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    A per-design metric DataFrame where each index is the design id and the columns are design metrics</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3688</span>
<span class="normal">3689</span>
<span class="normal">3690</span>
<span class="normal">3691</span>
<span class="normal">3692</span>
<span class="normal">3693</span>
<span class="normal">3694</span>
<span class="normal">3695</span>
<span class="normal">3696</span>
<span class="normal">3697</span>
<span class="normal">3698</span>
<span class="normal">3699</span>
<span class="normal">3700</span>
<span class="normal">3701</span>
<span class="normal">3702</span>
<span class="normal">3703</span>
<span class="normal">3704</span>
<span class="normal">3705</span>
<span class="normal">3706</span>
<span class="normal">3707</span>
<span class="normal">3708</span>
<span class="normal">3709</span>
<span class="normal">3710</span>
<span class="normal">3711</span>
<span class="normal">3712</span>
<span class="normal">3713</span>
<span class="normal">3714</span>
<span class="normal">3715</span>
<span class="normal">3716</span>
<span class="normal">3717</span>
<span class="normal">3718</span>
<span class="normal">3719</span>
<span class="normal">3720</span>
<span class="normal">3721</span>
<span class="normal">3722</span>
<span class="normal">3723</span>
<span class="normal">3724</span>
<span class="normal">3725</span>
<span class="normal">3726</span>
<span class="normal">3727</span>
<span class="normal">3728</span>
<span class="normal">3729</span>
<span class="normal">3730</span>
<span class="normal">3731</span>
<span class="normal">3732</span>
<span class="normal">3733</span>
<span class="normal">3734</span>
<span class="normal">3735</span>
<span class="normal">3736</span>
<span class="normal">3737</span>
<span class="normal">3738</span>
<span class="normal">3739</span>
<span class="normal">3740</span>
<span class="normal">3741</span>
<span class="normal">3742</span>
<span class="normal">3743</span>
<span class="normal">3744</span>
<span class="normal">3745</span>
<span class="normal">3746</span>
<span class="normal">3747</span>
<span class="normal">3748</span>
<span class="normal">3749</span>
<span class="normal">3750</span>
<span class="normal">3751</span>
<span class="normal">3752</span>
<span class="normal">3753</span>
<span class="normal">3754</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_design_metrics_per_residue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">residues_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="c1"># designs_df: pd.DataFrame = None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Take every design in the residues_df and perform design level statistical analysis</span>

<span class="sd">    Args:</span>
<span class="sd">        residues_df: The typical per-residue metric DataFrame where each index is the design id and the columns are</span>
<span class="sd">            (residue index, residue metric)</span>
<span class="sd">    Returns:</span>
<span class="sd">        A per-design metric DataFrame where each index is the design id and the columns are design metrics</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#     designs_df: The typical per-design metric DataFrame where each index is the design id and the columns are</span>
    <span class="c1">#         design metrics</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">load_pose</span><span class="p">()</span>
    <span class="c1"># self.identify_interface()</span>

    <span class="c1"># Load fragment_profile into the analysis</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">fragment_info_by_entity_pair</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_fragments</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">calculate_fragment_profile</span><span class="p">()</span>

    <span class="c1"># CAUTION: Assumes each structure is the same length</span>
    <span class="n">pose_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_residues</span>
    <span class="c1"># residue_indices = list(range(pose_length))</span>

    <span class="n">designs_df</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">sum_per_residue_metrics</span><span class="p">(</span><span class="n">residues_df</span><span class="p">)</span>

    <span class="n">pose_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">df</span>
    <span class="c1"># Calculate mutational content</span>
    <span class="c1"># designs_df[&#39;number_mutations&#39;] = mutation_df.sum(axis=1)</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;percent_mutations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;number_mutations&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pose_length</span>

    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;sequence_loss_design_per_residue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;sequence_loss_design&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pose_length</span>
    <span class="c1"># The per residue average loss compared to the design profile</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;sequence_loss_evolution_per_residue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;sequence_loss_evolution&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pose_length</span>
    <span class="c1"># The per residue average loss compared to the evolution profile</span>
    <span class="c1"># Todo modify this when fragments come from elsewhere, not just interface</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;sequence_loss_fragment_per_residue&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;sequence_loss_fragment&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pose_df</span><span class="p">[</span><span class="s1">&#39;number_residues_interface_fragment_total&#39;</span><span class="p">]</span>
    <span class="c1"># The per residue average loss compared to the fragment profile</span>

    <span class="c1"># designs_df[&#39;collapse_new_positions&#39;] /= pose_length</span>
    <span class="c1"># designs_df[&#39;collapse_new_position_significance&#39;] /= pose_length</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;collapse_significance_by_contact_order_z_mean&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;collapse_significance_by_contact_order_z&#39;</span><span class="p">]</span> <span class="o">/</span> \
        <span class="p">(</span><span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;collapse_significance_by_contact_order_z&#39;</span><span class="p">]]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># if self.measure_alignment:</span>
    <span class="c1"># Todo THESE ARE NOW DIFFERENT SOURCE if not self.measure_alignment</span>
    <span class="n">collapse_increased_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;collapse_increased_z&#39;</span><span class="p">]]</span>
    <span class="n">total_increased_collapse</span> <span class="o">=</span> <span class="p">(</span><span class="n">collapse_increased_df</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># designs_df[&#39;collapse_increase_significance_by_contact_order_z_mean&#39;] = \</span>
    <span class="c1">#     designs_df[&#39;collapse_increase_significance_by_contact_order_z&#39;] / total_increased_collapse</span>
    <span class="c1"># designs_df[&#39;collapse_increased_z&#39;] /= pose_length</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;collapse_increased_z_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collapse_increased_df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_increased_collapse</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;collapse_violation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;collapse_new_positions&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;collapse_variance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;collapse_deviation_magnitude&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pose_length</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;collapse_sequential_peaks_z_mean&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;collapse_sequential_peaks_z&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_increased_collapse</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;collapse_sequential_z_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;collapse_sequential_z&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_increased_collapse</span>

    <span class="c1"># Ensure summed observed_types are taken as the average over the pose_length</span>
    <span class="k">for</span> <span class="n">_type</span> <span class="ow">in</span> <span class="n">observed_types</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">designs_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;observed_</span><span class="si">{</span><span class="n">_type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">pose_length</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="k">return</span> <span class="n">designs_df</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.analyze_pose_designs" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">analyze_pose_designs</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">analyze_pose_designs</span><span class="p">(</span><span class="n">designs</span><span class="p">:</span> <span class="n"><span title="collections.abc.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><span title="symdesign.resources.sql.DesignData">DesignData</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Retrieve all score information from a PoseJob and write results to .csv file</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>designs</code></b>
            (<code><span title="collections.abc.Iterable">Iterable</span>[<span title="symdesign.resources.sql.DesignData">DesignData</span>]</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The DesignData instances to perform analysis on. By default, fetches all PoseJob.designs</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    Series containing summary metrics for all designs</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3756</span>
<span class="normal">3757</span>
<span class="normal">3758</span>
<span class="normal">3759</span>
<span class="normal">3760</span>
<span class="normal">3761</span>
<span class="normal">3762</span>
<span class="normal">3763</span>
<span class="normal">3764</span>
<span class="normal">3765</span>
<span class="normal">3766</span>
<span class="normal">3767</span>
<span class="normal">3768</span>
<span class="normal">3769</span>
<span class="normal">3770</span>
<span class="normal">3771</span>
<span class="normal">3772</span>
<span class="normal">3773</span>
<span class="normal">3774</span>
<span class="normal">3775</span>
<span class="normal">3776</span>
<span class="normal">3777</span>
<span class="normal">3778</span>
<span class="normal">3779</span>
<span class="normal">3780</span>
<span class="normal">3781</span>
<span class="normal">3782</span>
<span class="normal">3783</span>
<span class="normal">3784</span>
<span class="normal">3785</span>
<span class="normal">3786</span>
<span class="normal">3787</span>
<span class="normal">3788</span>
<span class="normal">3789</span>
<span class="normal">3790</span>
<span class="normal">3791</span>
<span class="normal">3792</span>
<span class="normal">3793</span>
<span class="normal">3794</span>
<span class="normal">3795</span>
<span class="normal">3796</span>
<span class="normal">3797</span>
<span class="normal">3798</span>
<span class="normal">3799</span>
<span class="normal">3800</span>
<span class="normal">3801</span>
<span class="normal">3802</span>
<span class="normal">3803</span>
<span class="normal">3804</span>
<span class="normal">3805</span>
<span class="normal">3806</span>
<span class="normal">3807</span>
<span class="normal">3808</span>
<span class="normal">3809</span>
<span class="normal">3810</span>
<span class="normal">3811</span>
<span class="normal">3812</span>
<span class="normal">3813</span>
<span class="normal">3814</span>
<span class="normal">3815</span>
<span class="normal">3816</span>
<span class="normal">3817</span>
<span class="normal">3818</span>
<span class="normal">3819</span>
<span class="normal">3820</span>
<span class="normal">3821</span>
<span class="normal">3822</span>
<span class="normal">3823</span>
<span class="normal">3824</span>
<span class="normal">3825</span>
<span class="normal">3826</span>
<span class="normal">3827</span>
<span class="normal">3828</span>
<span class="normal">3829</span>
<span class="normal">3830</span>
<span class="normal">3831</span>
<span class="normal">3832</span>
<span class="normal">3833</span>
<span class="normal">3834</span>
<span class="normal">3835</span>
<span class="normal">3836</span>
<span class="normal">3837</span>
<span class="normal">3838</span>
<span class="normal">3839</span>
<span class="normal">3840</span>
<span class="normal">3841</span>
<span class="normal">3842</span>
<span class="normal">3843</span>
<span class="normal">3844</span>
<span class="normal">3845</span>
<span class="normal">3846</span>
<span class="normal">3847</span>
<span class="normal">3848</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_pose_designs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">designs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">sql</span><span class="o">.</span><span class="n">DesignData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve all score information from a PoseJob and write results to .csv file</span>

<span class="sd">    Args:</span>
<span class="sd">        designs: The DesignData instances to perform analysis on. By default, fetches all PoseJob.designs</span>
<span class="sd">    Returns:</span>
<span class="sd">        Series containing summary metrics for all designs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">designs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_designs</span><span class="p">:</span>
                <span class="n">designs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_designs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Slice off the self.pose_source from these</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_designs</span> <span class="o">=</span> <span class="n">designs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">designs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">designs</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># There is nothing to analyze</span>

        <span class="c1"># Fetch data from the database</span>
        <span class="c1"># Get the name/provided_name to design_id mapping</span>
        <span class="n">design_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">design</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">design</span> <span class="ow">in</span> <span class="n">designs</span><span class="p">]</span>
        <span class="n">design_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">design</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">design</span> <span class="ow">in</span> <span class="n">designs</span><span class="p">]</span>
        <span class="n">design_name_to_id_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">design_names</span><span class="p">,</span> <span class="n">design_ids</span><span class="p">))</span>
        <span class="n">design_sequences</span> <span class="o">=</span> <span class="p">[</span><span class="n">design</span><span class="o">.</span><span class="n">sequence</span> <span class="k">for</span> <span class="n">design</span> <span class="ow">in</span> <span class="n">designs</span><span class="p">]</span>
        <span class="n">design_paths_to_process</span> <span class="o">=</span> <span class="p">[</span><span class="n">design</span><span class="o">.</span><span class="n">structure_path</span> <span class="k">for</span> <span class="n">design</span> <span class="ow">in</span> <span class="n">designs</span><span class="p">]</span>
        <span class="n">select_stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">((</span><span class="n">sql</span><span class="o">.</span><span class="n">DesignResidues</span><span class="o">.</span><span class="n">design_id</span><span class="p">,</span> <span class="n">sql</span><span class="o">.</span><span class="n">DesignResidues</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">sql</span><span class="o">.</span><span class="n">DesignResidues</span><span class="o">.</span><span class="n">design_residue</span><span class="p">))</span>\
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">DesignResidues</span><span class="o">.</span><span class="n">design_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">design_ids</span><span class="p">))</span>
        <span class="n">index_col</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">ResidueMetrics</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>
        <span class="n">design_residue_df</span> <span class="o">=</span> \
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_records</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select_stmt</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
                                      <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="p">,</span> <span class="n">sql</span><span class="o">.</span><span class="n">DesignResidues</span><span class="o">.</span><span class="n">design_residue</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
    <span class="n">design_residue_df</span> <span class="o">=</span> <span class="n">design_residue_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="p">])</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
    <span class="c1"># Use simple reporting here until that changes...</span>
    <span class="c1"># interface_residue_indices = [residue.index for residue in self.pose.interface_residues]</span>
    <span class="c1"># pose_length = self.pose.number_of_residues</span>
    <span class="c1"># design_residues = np.zeros((len(designs), pose_length), dtype=bool)</span>
    <span class="c1"># design_residues[:, interface_residue_indices] = 1</span>

    <span class="c1"># Score using proteinmpnn</span>
    <span class="c1"># sequences_df = self.analyze_sequence_metrics_per_design(sequences=design_sequences)</span>
    <span class="c1"># sequences_and_scores = self.pose.score(</span>
    <span class="n">sequences_and_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">score_sequences</span><span class="p">(</span>
        <span class="n">design_sequences</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">design</span><span class="o">.</span><span class="n">proteinmpnn_model</span><span class="p">)</span>
    <span class="n">sequences_and_scores</span><span class="p">[</span><span class="s1">&#39;design_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">design_residue_df</span><span class="o">.</span><span class="n">values</span>

    <span class="n">mpnn_designs_df</span><span class="p">,</span> <span class="n">mpnn_residues_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_proteinmpnn_metrics</span><span class="p">(</span><span class="n">design_names</span><span class="p">,</span> <span class="n">sequences_and_scores</span><span class="p">)</span>
    <span class="c1"># The DataFrame.index needs to become the design.id not design.name. Modify after all processing</span>
    <span class="n">entity_designs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_design_entities_per_residue</span><span class="p">(</span><span class="n">mpnn_residues_df</span><span class="p">)</span>

    <span class="c1"># Process all desired files to Pose</span>
    <span class="n">pose_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_kwargs</span>
    <span class="n">designs_poses</span> <span class="o">=</span> \
        <span class="p">[</span><span class="n">Pose</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">pose_kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">design_paths_to_process</span> <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">designs_poses</span><span class="p">:</span>
        <span class="n">residues_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_residue_metrics_per_design</span><span class="p">(</span><span class="n">designs</span><span class="o">=</span><span class="n">designs_poses</span><span class="p">)</span>
        <span class="n">designs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_design_metrics_per_design</span><span class="p">(</span><span class="n">residues_df</span><span class="p">,</span> <span class="n">designs_poses</span><span class="p">)</span>
        <span class="c1"># Join DataFrames</span>
        <span class="n">designs_df</span> <span class="o">=</span> <span class="n">designs_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mpnn_designs_df</span><span class="p">)</span>
        <span class="n">residues_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mpnn_residues_df</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">designs_df</span> <span class="o">=</span> <span class="n">mpnn_designs_df</span>
        <span class="n">residues_df</span> <span class="o">=</span> <span class="n">mpnn_residues_df</span>

    <span class="c1"># Each of these could have different index/column, so we use concat to perform an outer merge</span>
    <span class="c1"># residues_df = pd.concat([residues_df, mpnn_residues_df, sequences_df], axis=1) WORKED!!</span>
    <span class="c1"># residues_df = residues_df.join([mpnn_residues_df, sequences_df])</span>
    <span class="c1"># Todo should this &quot;different index&quot; be allowed? be possible</span>
    <span class="c1">#  residues_df = residues_df.join(rosetta_residues_df)</span>

    <span class="c1"># Rename all designs and clean up resulting metrics for storage</span>
    <span class="c1"># In keeping with &quot;unit of work&quot;, only rename once all data is processed incase we run into any errors</span>
    <span class="n">designs_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">designs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">design_name_to_id_map</span><span class="p">)</span>
    <span class="c1"># Must move the entity_id to the columns for index.map to work</span>
    <span class="n">entity_designs_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">entity_designs_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">entity_designs_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">design_name_to_id_map</span><span class="p">)</span>
    <span class="n">residues_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">design_name_to_id_map</span><span class="p">)</span>

    <span class="c1"># Commit the newly acquired metrics to the database</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">sql</span><span class="o">.</span><span class="n">write_dataframe</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">entity_designs</span><span class="o">=</span><span class="n">entity_designs_df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">designs</span><span class="o">=</span><span class="n">designs_df</span><span class="p">)</span>
        <span class="n">output_residues</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">output_residues</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">residues</span><span class="o">=</span><span class="n">residues_df</span><span class="p">)</span>
        <span class="c1"># This function doesn&#39;t generate any &#39;design_residue&#39;</span>
        <span class="c1"># else:  # Only save the &#39;design_residue&#39; columns</span>
        <span class="c1">#     residues_df = residues_df.loc[:, idx_slice[:, sql.DesignResidues.design_residue.name]]</span>
        <span class="c1">#     self.output_metrics(session, design_residues=residues_df)</span>
        <span class="c1"># Commit the newly acquired metrics</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.analyze_pose_metrics_per_design" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">analyze_pose_metrics_per_design</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">analyze_pose_metrics_per_design</span><span class="p">(</span><span class="n">residues_df</span><span class="p">:</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span><span class="p">,</span> <span class="n">designs_df</span><span class="p">:</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">designs</span><span class="p">:</span> <span class="n"><span title="collections.abc.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><span title="symdesign.structure.model.Pose">Pose</span></span><span class="p">]</span> <span class="o">|</span> <span class="n"><span title="collections.abc.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><span title="typing.AnyStr">AnyStr</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pandas.Series">Series</span></span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Perform Pose level analysis on every design produced from this Pose</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>residues_df</code></b>
            (<code><span title="pandas.DataFrame">DataFrame</span></code>)
        
        <div class="doc-md-description">
          <p>The typical per-residue metric DataFrame where each index is the design id and the columns are
(residue index, residue metric)</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>designs_df</code></b>
            (<code><span title="pandas.DataFrame">DataFrame</span></code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The typical per-design metric DataFrame where each index is the design id and the columns are
design metrics</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>designs</code></b>
            (<code><span title="collections.abc.Iterable">Iterable</span>[<span title="symdesign.structure.model.Pose">Pose</span>] | <span title="collections.abc.Iterable">Iterable</span>[<span title="typing.AnyStr">AnyStr</span>]</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The subsequent designs to perform analysis on</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    Series containing summary metrics for all designs</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3850</span>
<span class="normal">3851</span>
<span class="normal">3852</span>
<span class="normal">3853</span>
<span class="normal">3854</span>
<span class="normal">3855</span>
<span class="normal">3856</span>
<span class="normal">3857</span>
<span class="normal">3858</span>
<span class="normal">3859</span>
<span class="normal">3860</span>
<span class="normal">3861</span>
<span class="normal">3862</span>
<span class="normal">3863</span>
<span class="normal">3864</span>
<span class="normal">3865</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_pose_metrics_per_design</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">residues_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">designs_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">designs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Pose</span><span class="p">]</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform Pose level analysis on every design produced from this Pose</span>

<span class="sd">    Args:</span>
<span class="sd">        residues_df: The typical per-residue metric DataFrame where each index is the design id and the columns are</span>
<span class="sd">            (residue index, residue metric)</span>
<span class="sd">        designs_df: The typical per-design metric DataFrame where each index is the design id and the columns are</span>
<span class="sd">            design metrics</span>
<span class="sd">        designs: The subsequent designs to perform analysis on</span>
<span class="sd">    Returns:</span>
<span class="sd">        Series containing summary metrics for all designs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">load_pose</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">pose_s</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.analyze_proteinmpnn_metrics" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">analyze_proteinmpnn_metrics</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">analyze_proteinmpnn_metrics</span><span class="p">(</span><span class="n">design_ids</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n">str</span><span class="p">],</span> <span class="n">sequences_and_scores</span><span class="p">:</span> <span class="n">dict</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="n"><span title="numpy.array">array</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">tuple</span><span class="p">[</span><span class="n"><span title="pandas.DataFrame">DataFrame</span></span><span class="p">,</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Takes the sequences/scores ProteinMPNN features including 'design_indices', 'proteinmpnn_loss_complex',
and 'proteinmpnn_loss_unbound' to format summary metrics. Performs sequence analysis with 'sequences' feature</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>design_ids</code></b>
            (<code><span title="collections.abc.Sequence">Sequence</span>[str]</code>)
        
        <div class="doc-md-description">
          <p>The associated design identifier for each corresponding entry in sequences_and_scores</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>sequences_and_scores</code></b>
            (<code>dict[str, <span title="numpy.array">array</span>]</code>)
        
        <div class="doc-md-description">
          <p>The mapping of ProteinMPNN score type to it's corresponding data</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    A tuple of DataFrame where each contains (
        A per-design metric DataFrame where each index is the design id and the columns are design metrics,
        A per-residue metric DataFrame where each index is the design id and the columns are
            (residue index, residue metric)
    )</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3867</span>
<span class="normal">3868</span>
<span class="normal">3869</span>
<span class="normal">3870</span>
<span class="normal">3871</span>
<span class="normal">3872</span>
<span class="normal">3873</span>
<span class="normal">3874</span>
<span class="normal">3875</span>
<span class="normal">3876</span>
<span class="normal">3877</span>
<span class="normal">3878</span>
<span class="normal">3879</span>
<span class="normal">3880</span>
<span class="normal">3881</span>
<span class="normal">3882</span>
<span class="normal">3883</span>
<span class="normal">3884</span>
<span class="normal">3885</span>
<span class="normal">3886</span>
<span class="normal">3887</span>
<span class="normal">3888</span>
<span class="normal">3889</span>
<span class="normal">3890</span>
<span class="normal">3891</span>
<span class="normal">3892</span>
<span class="normal">3893</span>
<span class="normal">3894</span>
<span class="normal">3895</span>
<span class="normal">3896</span>
<span class="normal">3897</span>
<span class="normal">3898</span>
<span class="normal">3899</span>
<span class="normal">3900</span>
<span class="normal">3901</span>
<span class="normal">3902</span>
<span class="normal">3903</span>
<span class="normal">3904</span>
<span class="normal">3905</span>
<span class="normal">3906</span>
<span class="normal">3907</span>
<span class="normal">3908</span>
<span class="normal">3909</span>
<span class="normal">3910</span>
<span class="normal">3911</span>
<span class="normal">3912</span>
<span class="normal">3913</span>
<span class="normal">3914</span>
<span class="normal">3915</span>
<span class="normal">3916</span>
<span class="normal">3917</span>
<span class="normal">3918</span>
<span class="normal">3919</span>
<span class="normal">3920</span>
<span class="normal">3921</span>
<span class="normal">3922</span>
<span class="normal">3923</span>
<span class="normal">3924</span>
<span class="normal">3925</span>
<span class="normal">3926</span>
<span class="normal">3927</span>
<span class="normal">3928</span>
<span class="normal">3929</span>
<span class="normal">3930</span>
<span class="normal">3931</span>
<span class="normal">3932</span>
<span class="normal">3933</span>
<span class="normal">3934</span>
<span class="normal">3935</span>
<span class="normal">3936</span>
<span class="normal">3937</span>
<span class="normal">3938</span>
<span class="normal">3939</span>
<span class="normal">3940</span>
<span class="normal">3941</span>
<span class="normal">3942</span>
<span class="normal">3943</span>
<span class="normal">3944</span>
<span class="normal">3945</span>
<span class="normal">3946</span>
<span class="normal">3947</span>
<span class="normal">3948</span>
<span class="normal">3949</span>
<span class="normal">3950</span>
<span class="normal">3951</span>
<span class="normal">3952</span>
<span class="normal">3953</span>
<span class="normal">3954</span>
<span class="normal">3955</span>
<span class="normal">3956</span>
<span class="normal">3957</span>
<span class="normal">3958</span>
<span class="normal">3959</span>
<span class="normal">3960</span>
<span class="normal">3961</span>
<span class="normal">3962</span>
<span class="normal">3963</span>
<span class="normal">3964</span>
<span class="normal">3965</span>
<span class="normal">3966</span>
<span class="normal">3967</span>
<span class="normal">3968</span>
<span class="normal">3969</span>
<span class="normal">3970</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_proteinmpnn_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">design_ids</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">sequences_and_scores</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">])</span>\
        <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
    <span class="c1">#                      designs: Iterable[Pose] | Iterable[AnyStr] = None</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes the sequences/scores ProteinMPNN features including &#39;design_indices&#39;, &#39;proteinmpnn_loss_complex&#39;,</span>
<span class="sd">    and &#39;proteinmpnn_loss_unbound&#39; to format summary metrics. Performs sequence analysis with &#39;sequences&#39; feature</span>

<span class="sd">    Args:</span>
<span class="sd">        design_ids: The associated design identifier for each corresponding entry in sequences_and_scores</span>
<span class="sd">        sequences_and_scores: The mapping of ProteinMPNN score type to it&#39;s corresponding data</span>
<span class="sd">    Returns:</span>
<span class="sd">        A tuple of DataFrame where each contains (</span>
<span class="sd">            A per-design metric DataFrame where each index is the design id and the columns are design metrics,</span>
<span class="sd">            A per-residue metric DataFrame where each index is the design id and the columns are</span>
<span class="sd">                (residue index, residue metric)</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#     designs: The designs to perform analysis on. By default, fetches all available structures</span>
    <span class="c1"># Calculate metrics on input Pose before any manipulation</span>
    <span class="n">pose_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_residues</span>
    <span class="n">residue_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">pose_length</span><span class="p">))</span>  <span class="c1"># [residue.index for residue in self.pose.residues]</span>
    <span class="c1"># residue_numbers = [residue.number for residue in self.pose.residues]</span>

    <span class="c1"># metadata_df = pd.DataFrame(sequences_and_scores[&#39;temperatures&#39;], index=design_ids, columns=[&#39;temperature&#39;])</span>
    <span class="c1"># metadata_df[putils.protocol] = sequences_and_scores[putils.protocol]</span>
    <span class="c1"># numeric_sequences = sequences_and_scores[&#39;numeric_sequences&#39;]</span>
    <span class="c1"># torch_numeric_sequences = torch.from_numpy(numeric_sequences)</span>
    <span class="c1"># nan_blank_data = list(repeat(np.nan, pose_length))</span>

    <span class="c1"># Construct residues_df</span>
    <span class="n">sequences</span> <span class="o">=</span> <span class="n">sequences_and_scores</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;sequences&#39;</span><span class="p">)</span>
    <span class="n">sequences_and_scores</span><span class="p">[</span><span class="s1">&#39;design_residue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequences_and_scores</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;design_indices&#39;</span><span class="p">)</span>
    <span class="c1"># If sequences_and_scores gets any other keys in it this isn&#39;t explicitly enough</span>
    <span class="c1"># proteinmpnn_data = {</span>
    <span class="c1">#     &#39;design_residue&#39;: sequences_and_scores[&#39;design_indices&#39;],</span>
    <span class="c1">#     &#39;proteinmpnn_loss_complex&#39;: sequences_and_scores[&#39;proteinmpnn_loss_complex&#39;],</span>
    <span class="c1">#     &#39;proteinmpnn_loss_unbound&#39;: sequences_and_scores[&#39;proteinmpnn_loss_unbound&#39;]</span>
    <span class="c1"># }</span>
    <span class="n">proteinmpnn_residue_info_df</span> <span class="o">=</span> \
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">design_ids</span><span class="p">,</span>
                                <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">residue_indices</span><span class="p">,</span> <span class="p">[</span><span class="n">metric</span><span class="p">]]))</span>
                   <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">sequences_and_scores</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Incorporate residue, design, and sequence metrics on every designed Pose</span>
    <span class="c1"># Todo UPDATE These are now from a different collapse &#39;hydrophobicity&#39; source, &#39;expanded&#39;</span>
    <span class="n">sequences_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_sequence_metrics_per_design</span><span class="p">(</span><span class="n">sequences</span><span class="o">=</span><span class="n">sequences</span><span class="p">,</span> <span class="n">design_ids</span><span class="o">=</span><span class="n">design_ids</span><span class="p">)</span>
    <span class="c1"># Since no structure design completed, no residue_metrics is performed, but the pose source can be...</span>
    <span class="c1"># # The residues_df here has the wrong .index. It needs to become the design.id not design.name</span>
    <span class="c1"># residues_df = self.analyze_residue_metrics_per_design()  # designs=designs)</span>
    <span class="c1"># # Join each per-residue like dataframe</span>
    <span class="c1"># # Each of these can have difference index, so we use concat to perform an outer merge</span>
    <span class="c1"># residues_df = pd.concat([residues_df, sequences_df, proteinmpnn_residue_info_df], axis=1)</span>
    <span class="c1"># residues_df = pd.concat([sequences_df, proteinmpnn_residue_info_df], axis=1)</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">sequences_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proteinmpnn_residue_info_df</span><span class="p">)</span>

    <span class="n">designs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_design_metrics_per_residue</span><span class="p">(</span><span class="n">residues_df</span><span class="p">)</span>

    <span class="n">designed_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;design_residue&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">number_designed_residues_s</span> <span class="o">=</span> <span class="n">designed_df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># designs_df[putils.protocol] = &#39;proteinmpnn&#39;</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_complex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_loss_complex&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pose_length</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_unbound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_loss_unbound&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pose_length</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_delta&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_complex&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_unbound&#39;</span><span class="p">]</span>
    <span class="c1"># Find the mean of each of these using the boolean like array and the sum</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_complex_per_designed_residue&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="p">(</span><span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;proteinmpnn_loss_complex&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
         <span class="o">*</span> <span class="n">designed_df</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_complex_per_designed_residue&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">number_designed_residues_s</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_unbound_per_designed_residue&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="p">(</span><span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;proteinmpnn_loss_unbound&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
         <span class="o">*</span> <span class="n">designed_df</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_unbound_per_designed_residue&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">number_designed_residues_s</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_delta_per_designed_residue&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_complex_per_designed_residue&#39;</span><span class="p">]</span> \
        <span class="o">-</span> <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_unbound_per_designed_residue&#39;</span><span class="p">]</span>

    <span class="c1"># Make an array the length of the designs and size of the pose to calculate the interface residues</span>
    <span class="n">interface_residues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">designed_df</span><span class="p">),</span> <span class="n">pose_length</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">interface_residues</span><span class="p">[:,</span> <span class="p">[</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">interface_residues</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">number_interface_residues</span> <span class="o">=</span> <span class="n">interface_residues</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_complex_per_interface_residue&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="p">(</span><span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;proteinmpnn_loss_complex&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
         <span class="o">*</span> <span class="n">interface_residues</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_complex_per_interface_residue&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">number_interface_residues</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_unbound_per_interface_residue&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="p">(</span><span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;proteinmpnn_loss_unbound&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
         <span class="o">*</span> <span class="n">interface_residues</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_unbound_per_interface_residue&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">number_interface_residues</span>
    <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_delta_per_interface_residue&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_complex_per_interface_residue&#39;</span><span class="p">]</span> \
        <span class="o">-</span> <span class="n">designs_df</span><span class="p">[</span><span class="s1">&#39;proteinmpnn_score_unbound_per_interface_residue&#39;</span><span class="p">]</span>

    <span class="c1"># # Drop unused particular residues_df columns that have been summed</span>
    <span class="c1"># per_residue_drop_columns = per_residue_energy_states + energy_metric_names + per_residue_sasa_states \</span>
    <span class="c1">#                            + collapse_metrics + residue_classification \</span>
    <span class="c1">#                            + [&#39;errat_deviation&#39;, &#39;hydrophobic_collapse&#39;, &#39;contact_order&#39;] \</span>
    <span class="c1">#                            + [&#39;hbond&#39;, &#39;evolution&#39;, &#39;fragment&#39;, &#39;type&#39;] + [&#39;surface&#39;, &#39;interior&#39;]</span>
    <span class="c1"># # Slice each of these columns as the first level residue number needs to be accounted for in MultiIndex</span>
    <span class="c1"># residues_df = residues_df.drop(</span>
    <span class="c1">#     list(residues_df.loc[:, idx_slice[:, per_residue_drop_columns]].columns),</span>
    <span class="c1">#     errors=&#39;ignore&#39;, axis=1)</span>

    <span class="k">return</span> <span class="n">designs_df</span><span class="p">,</span> <span class="n">residues_df</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.analyze_residue_metrics_per_design" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">analyze_residue_metrics_per_design</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">analyze_residue_metrics_per_design</span><span class="p">(</span><span class="n">designs</span><span class="p">:</span> <span class="n"><span title="collections.abc.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><span title="symdesign.structure.model.Pose">Pose</span></span><span class="p">]</span> <span class="o">|</span> <span class="n"><span title="collections.abc.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><span title="typing.AnyStr">AnyStr</span></span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Perform per-residue analysis on design Model instances</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>designs</code></b>
            (<code><span title="collections.abc.Iterable">Iterable</span>[<span title="symdesign.structure.model.Pose">Pose</span>] | <span title="collections.abc.Iterable">Iterable</span>[<span title="typing.AnyStr">AnyStr</span>]</code>)
        
        <div class="doc-md-description">
          <p>The designs to analyze. The StructureBase.name attribute is used for naming DataFrame indices</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    A per-residue metric DataFrame where each index is the design id and the columns are
        (residue index, residue metric)</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">3972</span>
<span class="normal">3973</span>
<span class="normal">3974</span>
<span class="normal">3975</span>
<span class="normal">3976</span>
<span class="normal">3977</span>
<span class="normal">3978</span>
<span class="normal">3979</span>
<span class="normal">3980</span>
<span class="normal">3981</span>
<span class="normal">3982</span>
<span class="normal">3983</span>
<span class="normal">3984</span>
<span class="normal">3985</span>
<span class="normal">3986</span>
<span class="normal">3987</span>
<span class="normal">3988</span>
<span class="normal">3989</span>
<span class="normal">3990</span>
<span class="normal">3991</span>
<span class="normal">3992</span>
<span class="normal">3993</span>
<span class="normal">3994</span>
<span class="normal">3995</span>
<span class="normal">3996</span>
<span class="normal">3997</span>
<span class="normal">3998</span>
<span class="normal">3999</span>
<span class="normal">4000</span>
<span class="normal">4001</span>
<span class="normal">4002</span>
<span class="normal">4003</span>
<span class="normal">4004</span>
<span class="normal">4005</span>
<span class="normal">4006</span>
<span class="normal">4007</span>
<span class="normal">4008</span>
<span class="normal">4009</span>
<span class="normal">4010</span>
<span class="normal">4011</span>
<span class="normal">4012</span>
<span class="normal">4013</span>
<span class="normal">4014</span>
<span class="normal">4015</span>
<span class="normal">4016</span>
<span class="normal">4017</span>
<span class="normal">4018</span>
<span class="normal">4019</span>
<span class="normal">4020</span>
<span class="normal">4021</span>
<span class="normal">4022</span>
<span class="normal">4023</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_residue_metrics_per_design</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">designs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Pose</span><span class="p">]</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform per-residue analysis on design Model instances</span>

<span class="sd">    Args:</span>
<span class="sd">        designs: The designs to analyze. The StructureBase.name attribute is used for naming DataFrame indices</span>
<span class="sd">    Returns:</span>
<span class="sd">        A per-residue metric DataFrame where each index is the design id and the columns are</span>
<span class="sd">            (residue index, residue metric)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute structural measurements for all designs</span>
    <span class="n">per_residue_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">interface_residues</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pose_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_kwargs</span>
    <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">designs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">name</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># This is likely a filepath</span>
            <span class="n">pose</span> <span class="o">=</span> <span class="n">Pose</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">pose</span><span class="p">,</span> <span class="o">**</span><span class="n">pose_kwargs</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># Get interface residues</span>
        <span class="n">pose</span><span class="o">.</span><span class="n">find_and_split_interface</span><span class="p">()</span>
        <span class="n">interface_residues</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">pose</span><span class="o">.</span><span class="n">interface_residues</span><span class="p">])</span>
        <span class="n">per_residue_data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">pose</span><span class="o">.</span><span class="n">per_residue_interface_surface_area</span><span class="p">(),</span>
            <span class="o">**</span><span class="n">pose</span><span class="o">.</span><span class="n">per_residue_contact_order</span><span class="p">(),</span>
            <span class="c1"># **pose.per_residue_errat()</span>
            <span class="o">**</span><span class="n">pose</span><span class="o">.</span><span class="n">per_residue_spatial_aggregation_propensity</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">load_pose</span><span class="p">()</span>

    <span class="c1"># CAUTION: Assumes each structure is the same length</span>
    <span class="n">pose_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_residues</span>
    <span class="n">residue_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">pose_length</span><span class="p">))</span>
    <span class="c1"># residue_numbers = [residue.number for residue in self.pose.residues]</span>
    <span class="c1"># design_residue_indices = [residue.index for residue in self.pose.design_residues]</span>
    <span class="c1"># interface_residue_indices = [residue.index for residue in self.pose.interface_residues]</span>

    <span class="c1"># Convert per_residue_data into a dataframe matching residues_df orientation</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">residue_indices</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">per_residue_data</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Construct interface residue array</span>
    <span class="n">interface_residue_bool</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">designs</span><span class="p">),</span> <span class="n">pose_length</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">interface_indices</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">interface_residues</span><span class="p">):</span>
        <span class="n">interface_residue_bool</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">interface_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">interface_residue_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">interface_residue_bool</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">residues_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                        <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">((</span><span class="n">residue_indices</span><span class="p">,</span>
                                                                            <span class="p">[</span><span class="s1">&#39;interface_residue&#39;</span><span class="p">])))</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">interface_residue_df</span><span class="p">)</span>
    <span class="c1"># Make buried surface area (bsa) columns, and classify residue types</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">calculate_residue_buried_surface_area</span><span class="p">(</span><span class="n">residues_df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metrics</span><span class="o">.</span><span class="n">classify_interface_residues</span><span class="p">(</span><span class="n">residues_df</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.analyze_sequence_metrics_per_design" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">analyze_sequence_metrics_per_design</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">analyze_sequence_metrics_per_design</span><span class="p">(</span><span class="n">sequences</span><span class="p">:</span> <span class="n">dict</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n">str</span><span class="p">]]</span> <span class="o">|</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">design_ids</span><span class="p">:</span> <span class="n"><span title="collections.abc.Sequence">Sequence</span></span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pandas.DataFrame">DataFrame</span></span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Gather metrics based on provided sequences in comparison to the Pose sequence</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>sequences</code></b>
            (<code>dict[str, <span title="collections.abc.Sequence">Sequence</span>[str]] | <span title="collections.abc.Sequence">Sequence</span>[<span title="collections.abc.Sequence">Sequence</span>[str]]</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The sequences to analyze compared to the "pose source" sequence</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>design_ids</code></b>
            (<code><span title="collections.abc.Sequence">Sequence</span>[str]</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>If sequences isn't a mapping from identifier to sequence, the identifiers for each sequence</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    A per-residue metric DataFrame where each index is the design id and the columns are
        (residue index, residue metric)</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4025</span>
<span class="normal">4026</span>
<span class="normal">4027</span>
<span class="normal">4028</span>
<span class="normal">4029</span>
<span class="normal">4030</span>
<span class="normal">4031</span>
<span class="normal">4032</span>
<span class="normal">4033</span>
<span class="normal">4034</span>
<span class="normal">4035</span>
<span class="normal">4036</span>
<span class="normal">4037</span>
<span class="normal">4038</span>
<span class="normal">4039</span>
<span class="normal">4040</span>
<span class="normal">4041</span>
<span class="normal">4042</span>
<span class="normal">4043</span>
<span class="normal">4044</span>
<span class="normal">4045</span>
<span class="normal">4046</span>
<span class="normal">4047</span>
<span class="normal">4048</span>
<span class="normal">4049</span>
<span class="normal">4050</span>
<span class="normal">4051</span>
<span class="normal">4052</span>
<span class="normal">4053</span>
<span class="normal">4054</span>
<span class="normal">4055</span>
<span class="normal">4056</span>
<span class="normal">4057</span>
<span class="normal">4058</span>
<span class="normal">4059</span>
<span class="normal">4060</span>
<span class="normal">4061</span>
<span class="normal">4062</span>
<span class="normal">4063</span>
<span class="normal">4064</span>
<span class="normal">4065</span>
<span class="normal">4066</span>
<span class="normal">4067</span>
<span class="normal">4068</span>
<span class="normal">4069</span>
<span class="normal">4070</span>
<span class="normal">4071</span>
<span class="normal">4072</span>
<span class="normal">4073</span>
<span class="normal">4074</span>
<span class="normal">4075</span>
<span class="normal">4076</span>
<span class="normal">4077</span>
<span class="normal">4078</span>
<span class="normal">4079</span>
<span class="normal">4080</span>
<span class="normal">4081</span>
<span class="normal">4082</span>
<span class="normal">4083</span>
<span class="normal">4084</span>
<span class="normal">4085</span>
<span class="normal">4086</span>
<span class="normal">4087</span>
<span class="normal">4088</span>
<span class="normal">4089</span>
<span class="normal">4090</span>
<span class="normal">4091</span>
<span class="normal">4092</span>
<span class="normal">4093</span>
<span class="normal">4094</span>
<span class="normal">4095</span>
<span class="normal">4096</span>
<span class="normal">4097</span>
<span class="normal">4098</span>
<span class="normal">4099</span>
<span class="normal">4100</span>
<span class="normal">4101</span>
<span class="normal">4102</span>
<span class="normal">4103</span>
<span class="normal">4104</span>
<span class="normal">4105</span>
<span class="normal">4106</span>
<span class="normal">4107</span>
<span class="normal">4108</span>
<span class="normal">4109</span>
<span class="normal">4110</span>
<span class="normal">4111</span>
<span class="normal">4112</span>
<span class="normal">4113</span>
<span class="normal">4114</span>
<span class="normal">4115</span>
<span class="normal">4116</span>
<span class="normal">4117</span>
<span class="normal">4118</span>
<span class="normal">4119</span>
<span class="normal">4120</span>
<span class="normal">4121</span>
<span class="normal">4122</span>
<span class="normal">4123</span>
<span class="normal">4124</span>
<span class="normal">4125</span>
<span class="normal">4126</span>
<span class="normal">4127</span>
<span class="normal">4128</span>
<span class="normal">4129</span>
<span class="normal">4130</span>
<span class="normal">4131</span>
<span class="normal">4132</span>
<span class="normal">4133</span>
<span class="normal">4134</span>
<span class="normal">4135</span>
<span class="normal">4136</span>
<span class="normal">4137</span>
<span class="normal">4138</span>
<span class="normal">4139</span>
<span class="normal">4140</span>
<span class="normal">4141</span>
<span class="normal">4142</span>
<span class="normal">4143</span>
<span class="normal">4144</span>
<span class="normal">4145</span>
<span class="normal">4146</span>
<span class="normal">4147</span>
<span class="normal">4148</span>
<span class="normal">4149</span>
<span class="normal">4150</span>
<span class="normal">4151</span>
<span class="normal">4152</span>
<span class="normal">4153</span>
<span class="normal">4154</span>
<span class="normal">4155</span>
<span class="normal">4156</span>
<span class="normal">4157</span>
<span class="normal">4158</span>
<span class="normal">4159</span>
<span class="normal">4160</span>
<span class="normal">4161</span>
<span class="normal">4162</span>
<span class="normal">4163</span>
<span class="normal">4164</span>
<span class="normal">4165</span>
<span class="normal">4166</span>
<span class="normal">4167</span>
<span class="normal">4168</span>
<span class="normal">4169</span>
<span class="normal">4170</span>
<span class="normal">4171</span>
<span class="normal">4172</span>
<span class="normal">4173</span>
<span class="normal">4174</span>
<span class="normal">4175</span>
<span class="normal">4176</span>
<span class="normal">4177</span>
<span class="normal">4178</span>
<span class="normal">4179</span>
<span class="normal">4180</span>
<span class="normal">4181</span>
<span class="normal">4182</span>
<span class="normal">4183</span>
<span class="normal">4184</span>
<span class="normal">4185</span>
<span class="normal">4186</span>
<span class="normal">4187</span>
<span class="normal">4188</span>
<span class="normal">4189</span>
<span class="normal">4190</span>
<span class="normal">4191</span>
<span class="normal">4192</span>
<span class="normal">4193</span>
<span class="normal">4194</span>
<span class="normal">4195</span>
<span class="normal">4196</span>
<span class="normal">4197</span>
<span class="normal">4198</span>
<span class="normal">4199</span>
<span class="normal">4200</span>
<span class="normal">4201</span>
<span class="normal">4202</span>
<span class="normal">4203</span>
<span class="normal">4204</span>
<span class="normal">4205</span>
<span class="normal">4206</span>
<span class="normal">4207</span>
<span class="normal">4208</span>
<span class="normal">4209</span>
<span class="normal">4210</span>
<span class="normal">4211</span>
<span class="normal">4212</span>
<span class="normal">4213</span>
<span class="normal">4214</span>
<span class="normal">4215</span>
<span class="normal">4216</span>
<span class="normal">4217</span>
<span class="normal">4218</span>
<span class="normal">4219</span>
<span class="normal">4220</span>
<span class="normal">4221</span>
<span class="normal">4222</span>
<span class="normal">4223</span>
<span class="normal">4224</span>
<span class="normal">4225</span>
<span class="normal">4226</span>
<span class="normal">4227</span>
<span class="normal">4228</span>
<span class="normal">4229</span>
<span class="normal">4230</span>
<span class="normal">4231</span>
<span class="normal">4232</span>
<span class="normal">4233</span>
<span class="normal">4234</span>
<span class="normal">4235</span>
<span class="normal">4236</span>
<span class="normal">4237</span>
<span class="normal">4238</span>
<span class="normal">4239</span>
<span class="normal">4240</span>
<span class="normal">4241</span>
<span class="normal">4242</span>
<span class="normal">4243</span>
<span class="normal">4244</span>
<span class="normal">4245</span>
<span class="normal">4246</span>
<span class="normal">4247</span>
<span class="normal">4248</span>
<span class="normal">4249</span>
<span class="normal">4250</span>
<span class="normal">4251</span>
<span class="normal">4252</span>
<span class="normal">4253</span>
<span class="normal">4254</span>
<span class="normal">4255</span>
<span class="normal">4256</span>
<span class="normal">4257</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">analyze_sequence_metrics_per_design</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequences</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                        <span class="n">design_ids</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gather metrics based on provided sequences in comparison to the Pose sequence</span>

<span class="sd">    Args:</span>
<span class="sd">        sequences: The sequences to analyze compared to the &quot;pose source&quot; sequence</span>
<span class="sd">        design_ids: If sequences isn&#39;t a mapping from identifier to sequence, the identifiers for each sequence</span>
<span class="sd">    Returns:</span>
<span class="sd">        A per-residue metric DataFrame where each index is the design id and the columns are</span>
<span class="sd">            (residue index, residue metric)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Ensure the pose.sequence (or reference sequence) is used as the first sequence during analysis</span>
    <span class="c1"># if sequences is None:</span>
    <span class="c1">#     # Todo handle design sequences from a read_fasta_file?</span>
    <span class="c1">#     # Todo implement reference sequence from included file(s) or as with self.pose.sequence below</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sequences</span><span class="p">:</span>
            <span class="n">design_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sequences</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>  <span class="c1"># [self.pose.name] +</span>
            <span class="n">sequences</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sequences</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>  <span class="c1"># [self.pose.sequence] +</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Nothing passed, return an empty DataFrame</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">design_ids</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="n">design_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">design_ids</span><span class="p">)</span>  <span class="c1"># [self.pose.name] +</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Can&#39;t perform </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analyze_sequence_metrics_per_design</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> without argument &quot;</span>
                <span class="s2">&quot;&#39;design_ids&#39; when &#39;sequences&#39; isn&#39;t a dictionary&quot;</span><span class="p">)</span>
        <span class="c1"># All sequences must be string for Biopython</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">sequences</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">sequences</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>  <span class="c1"># [self.pose.sequence] +</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="n">sequences</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">]</span>  <span class="c1"># [self.pose.sequence] +</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">design_sequences</span> <span class="o">=</span> <span class="n">design_ids</span> <span class="o">=</span> <span class="n">sequences</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Can&#39;t perform </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">analyze_sequence_metrics_per_design</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> with argument &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;sequences&#39; as a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">. Pass &#39;sequences&#39; as a Sequence[str]&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">design_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequences</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The length of the design_ids (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">design_ids</span><span class="p">)</span><span class="si">}</span><span class="s2">) != sequences (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="c1"># Create numeric sequence types</span>
    <span class="n">number_of_sequences</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>
    <span class="n">numeric_sequences</span> <span class="o">=</span> <span class="n">sequences_to_numeric</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>
    <span class="n">torch_numeric_sequences</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">numeric_sequences</span><span class="p">)</span>

    <span class="n">pose_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_residues</span>
    <span class="n">residue_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">pose_length</span><span class="p">))</span>
    <span class="n">nan_blank_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">pose_length</span><span class="p">)),</span> <span class="p">(</span><span class="n">number_of_sequences</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Make requisite profiles</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_up_evolutionary_profile</span><span class="p">(</span><span class="n">warn_metrics</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Try to add each of the profile types in observed_types to profile_background</span>
    <span class="n">profile_background</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_evolution</span><span class="p">:</span>
        <span class="n">profile_background</span><span class="p">[</span><span class="s1">&#39;evolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">evolutionary_profile_array</span> <span class="o">=</span> \
            <span class="n">pssm_as_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">evolutionary_profile</span><span class="p">)</span>
        <span class="n">batch_evolutionary_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">evolutionary_profile_array</span><span class="p">,</span> <span class="p">(</span><span class="n">number_of_sequences</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># torch_log_evolutionary_profile = torch.from_numpy(np.log(batch_evolutionary_profile))</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="c1"># np.log causes -inf at 0, so they are corrected to a &#39;large&#39; number</span>
            <span class="n">corrected_evol_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">batch_evolutionary_profile</span><span class="p">),</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                 <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="n">metrics</span><span class="o">.</span><span class="n">zero_probability_evol_value</span><span class="p">)</span>
        <span class="n">torch_log_evolutionary_profile</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">corrected_evol_array</span><span class="p">)</span>
        <span class="n">per_residue_evolutionary_profile_loss</span> <span class="o">=</span> \
            <span class="n">resources</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">sequence_nllloss</span><span class="p">(</span><span class="n">torch_numeric_sequences</span><span class="p">,</span> <span class="n">torch_log_evolutionary_profile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Because self.pose.calculate_profile() is used below, need to ensure there is a null_profile attached</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">evolutionary_profile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">evolutionary_profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">create_null_profile</span><span class="p">()</span>
        <span class="c1"># per_residue_evolutionary_profile_loss = per_residue_design_profile_loss = nan_blank_data</span>
        <span class="n">per_residue_evolutionary_profile_loss</span> <span class="o">=</span> <span class="n">nan_blank_data</span>

    <span class="c1"># Load fragment_profile into the analysis</span>
    <span class="c1"># if self.job.design.term_constraint and not self.pose.fragment_queries:</span>
    <span class="c1"># if self.job.design.term_constraint:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">fragment_info_by_entity_pair</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_fragments</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">fragment_profile</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">calculate_fragment_profile</span><span class="p">()</span>
    <span class="n">profile_background</span><span class="p">[</span><span class="s1">&#39;fragment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fragment_profile_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">fragment_profile</span><span class="o">.</span><span class="n">as_array</span><span class="p">()</span>
    <span class="n">batch_fragment_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">fragment_profile_array</span><span class="p">,</span> <span class="p">(</span><span class="n">number_of_sequences</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="c1"># np.log causes -inf at 0, so they are corrected to a &#39;large&#39; number</span>
        <span class="n">corrected_frag_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">batch_fragment_profile</span><span class="p">),</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                             <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="n">metrics</span><span class="o">.</span><span class="n">zero_probability_frag_value</span><span class="p">)</span>
    <span class="n">per_residue_fragment_profile_loss</span> <span class="o">=</span> \
        <span class="n">resources</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">sequence_nllloss</span><span class="p">(</span><span class="n">torch_numeric_sequences</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">corrected_frag_array</span><span class="p">))</span>
    <span class="c1"># else:</span>
    <span class="c1">#     per_residue_fragment_profile_loss = nan_blank_data</span>

    <span class="c1"># Set up &quot;design&quot; profile</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">calculate_profile</span><span class="p">()</span>
    <span class="n">profile_background</span><span class="p">[</span><span class="s1">&#39;design&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">design_profile_array</span> <span class="o">=</span> <span class="n">pssm_as_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>
    <span class="n">batch_design_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">design_profile_array</span><span class="p">,</span> <span class="p">(</span><span class="n">number_of_sequences</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">fragment_info_by_entity_pair</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="c1"># np.log causes -inf at 0, so they are corrected to a &#39;large&#39; number</span>
            <span class="n">corrected_design_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">batch_design_profile</span><span class="p">),</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                   <span class="n">nan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="n">metrics</span><span class="o">.</span><span class="n">zero_probability_evol_value</span><span class="p">)</span>
            <span class="n">torch_log_design_profile</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">corrected_design_array</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">torch_log_design_profile</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">batch_design_profile</span><span class="p">))</span>
    <span class="n">per_residue_design_profile_loss</span> <span class="o">=</span> \
        <span class="n">resources</span><span class="o">.</span><span class="n">ml</span><span class="o">.</span><span class="n">sequence_nllloss</span><span class="p">(</span><span class="n">torch_numeric_sequences</span><span class="p">,</span> <span class="n">torch_log_design_profile</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">fragment_db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">interface_bkgd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">fragment_db</span><span class="o">.</span><span class="n">aa_frequencies</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">profile_background</span><span class="p">[</span><span class="s1">&#39;interface&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">interface_bkgd</span><span class="p">,</span> <span class="p">(</span><span class="n">pose_length</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Format all sequence info to DataFrame</span>
    <span class="n">sequence_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">],</span>  <span class="c1"># Ensure 2D array like</span>
        <span class="s1">&#39;sequence_loss_design&#39;</span><span class="p">:</span> <span class="n">per_residue_design_profile_loss</span><span class="p">,</span>
        <span class="s1">&#39;sequence_loss_evolution&#39;</span><span class="p">:</span> <span class="n">per_residue_evolutionary_profile_loss</span><span class="p">,</span>
        <span class="s1">&#39;sequence_loss_fragment&#39;</span><span class="p">:</span> <span class="n">per_residue_fragment_profile_loss</span>
    <span class="p">}</span>

    <span class="n">sequence_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">design_ids</span><span class="p">,</span>
                                          <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">residue_indices</span><span class="p">,</span> <span class="p">[</span><span class="n">metric</span><span class="p">]]))</span>
                             <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">sequence_data</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># if profile_background:</span>
    <span class="c1"># Todo This is pretty much already done!</span>
    <span class="c1">#  pose_alignment = MultipleSequenceAlignment.from_array(sequences)</span>
    <span class="c1">#  Make this capability</span>
    <span class="c1">#   pose_alignment.tolist()</span>
    <span class="c1"># Ensure sequences are strings as MultipleSequenceAlignment.from_dictionary() SeqRecord requires ids as strings</span>
    <span class="n">design_names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">design_ids</span><span class="p">]</span>
    <span class="n">design_sequences</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">design_names</span><span class="p">,</span> <span class="n">sequences</span><span class="p">))</span>
    <span class="n">pose_alignment</span> <span class="o">=</span> <span class="n">MultipleSequenceAlignment</span><span class="o">.</span><span class="n">from_dictionary</span><span class="p">(</span><span class="n">design_sequences</span><span class="p">)</span>
    <span class="c1"># Todo this must be calculated on the entire Designs batch</span>
    <span class="c1"># # Calculate Jensen Shannon Divergence using design frequencies and different profile occurrence data</span>
    <span class="c1"># per_residue_divergence_df = \</span>
    <span class="c1">#     pd.concat([pd.DataFrame(metrics.position_specific_divergence(pose_alignment.frequencies, background),</span>
    <span class="c1">#                             index=design_ids,</span>
    <span class="c1">#                             columns=pd.MultiIndex.from_product([residue_indices, [f&#39;divergence_{profile}&#39;]]))</span>
    <span class="c1">#                for profile, background in profile_background.items()])</span>
    <span class="c1"># Perform a frequency extraction for each background profile</span>
    <span class="n">per_residue_background_frequency_df</span> <span class="o">=</span> \
        <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pose_alignment</span><span class="o">.</span><span class="n">get_probabilities_from_profile</span><span class="p">(</span><span class="n">background</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">design_ids</span><span class="p">,</span>
                                <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">residue_indices</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;observed_</span><span class="si">{</span><span class="n">profile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]]))</span>
                   <span class="k">for</span> <span class="n">profile</span><span class="p">,</span> <span class="n">background</span> <span class="ow">in</span> <span class="n">profile_background</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">sequences_by_entity</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>
        <span class="n">entity_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">n_terminal_residue</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">entity</span><span class="o">.</span><span class="n">c_terminal_residue</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">sequences_by_entity</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sequence</span><span class="p">[</span><span class="n">entity_slice</span><span class="p">]</span> <span class="k">for</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">])</span>

    <span class="n">sequences_split_at_entity</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">sequences_by_entity</span><span class="p">))</span>

    <span class="c1"># Calculate hydrophobic collapse for each design</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_evolution</span><span class="p">:</span>
        <span class="n">hydrophobicity</span> <span class="o">=</span> <span class="s1">&#39;expanded&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hydrophobicity</span> <span class="o">=</span> <span class="s1">&#39;standard&#39;</span>
    <span class="n">contact_order_per_res_z</span><span class="p">,</span> <span class="n">reference_collapse</span><span class="p">,</span> <span class="n">collapse_profile</span> <span class="o">=</span> \
        <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">get_folding_metrics</span><span class="p">(</span><span class="n">hydrophobicity</span><span class="o">=</span><span class="n">hydrophobicity</span><span class="p">)</span>
    <span class="c1"># collapse_significance_threshold = metrics.collapse_thresholds[hydrophobicity]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_evolution</span><span class="p">:</span>  <span class="c1"># collapse_profile.size:  # Not equal to zero, use the profile instead</span>
        <span class="n">reference_collapse</span> <span class="o">=</span> <span class="n">collapse_profile</span>
    <span class="c1">#     reference_mean = np.nanmean(collapse_profile, axis=-2)</span>
    <span class="c1">#     reference_std = np.nanstd(collapse_profile, axis=-2)</span>
    <span class="c1"># else:</span>
    <span class="c1">#     reference_mean = reference_std = None</span>
    <span class="n">folding_and_collapse</span> <span class="o">=</span> \
        <span class="n">metrics</span><span class="o">.</span><span class="n">collapse_per_residue</span><span class="p">(</span><span class="n">sequences_split_at_entity</span><span class="p">,</span> <span class="n">contact_order_per_res_z</span><span class="p">,</span> <span class="n">reference_collapse</span><span class="p">)</span>
    <span class="n">per_residue_collapse_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">({</span><span class="n">design_id</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">residue_indices</span><span class="p">)</span>
                                         <span class="k">for</span> <span class="n">design_id</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">design_ids</span><span class="p">,</span> <span class="n">folding_and_collapse</span><span class="p">)},</span>
                                        <span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Calculate mutational content</span>
    <span class="c1"># Make a mutational array, i.e. find those sites that have been mutated from the reference</span>
    <span class="c1"># reference_numeric_sequence = numeric_sequences[0]</span>
    <span class="n">reference_numeric_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">sequence_numeric</span>
    <span class="n">mutational_array</span> <span class="o">=</span> <span class="p">(</span><span class="n">numeric_sequences</span> <span class="o">-</span> <span class="n">reference_numeric_sequence</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">mutation_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mutational_array</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">design_ids</span><span class="p">,</span>
                               <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">residue_indices</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mutation&#39;</span><span class="p">]]))</span>
    <span class="c1"># Join all results</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">sequence_df</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>  <span class="c1"># per_residue_divergence_df,</span>
        <span class="c1"># Make background_frequency dataframe according to whether indicated residue was allowed in profile</span>
        <span class="n">per_residue_background_frequency_df</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">per_residue_collapse_df</span><span class="p">,</span>
        <span class="n">mutation_df</span><span class="p">])</span>

    <span class="c1"># entity_alignment = multi_chain_alignment(entity_sequences)</span>
    <span class="c1"># INSTEAD OF USING BELOW, split Pose.MultipleSequenceAlignment at entity.chain_break...</span>
    <span class="c1"># entity_alignments = \</span>
    <span class="c1">#     {idx: MultipleSequenceAlignment.from_dictionary(designed_sequences)</span>
    <span class="c1">#      for idx, designed_sequences in entity_sequences.items()}</span>
    <span class="c1"># entity_alignments = \</span>
    <span class="c1">#     {idx: msa_from_dictionary(designed_sequences) for idx, designed_sequences in entity_sequences.items()}</span>
    <span class="c1"># pose_collapse_ = pd.concat(pd.DataFrame(folding_and_collapse), axis=1, keys=[(&#39;sequence_design&#39;, &#39;pose&#39;)])</span>
    <span class="n">dca_design_residues_concat</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dca_succeed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># dca_background_energies, dca_design_energies = [], []</span>
    <span class="n">dca_background_energies</span><span class="p">,</span> <span class="n">dca_design_energies</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">entity</span><span class="p">,</span> <span class="n">entity_sequences</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">,</span> <span class="n">sequences_by_entity</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># Todo add these to the analysis</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">h_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">api_db</span><span class="o">.</span><span class="n">bmdca_fields</span><span class="o">.</span><span class="n">retrieve_data</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">j_couplings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">api_db</span><span class="o">.</span><span class="n">bmdca_couplings</span><span class="o">.</span><span class="n">retrieve_data</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">dca_background_residue_energies</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">direct_coupling_analysis</span><span class="p">()</span>
            <span class="c1"># Todo INSTEAD OF USING BELOW, split Pose.MultipleSequenceAlignment at entity.chain_break...</span>
            <span class="n">entity_alignment</span> <span class="o">=</span> \
                <span class="n">MultipleSequenceAlignment</span><span class="o">.</span><span class="n">from_dictionary</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">design_names</span><span class="p">,</span> <span class="n">entity_sequences</span><span class="p">)))</span>
            <span class="c1"># entity_alignment = msa_from_dictionary(entity_sequences[idx])</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">msa</span> <span class="o">=</span> <span class="n">entity_alignment</span>
            <span class="n">dca_design_residue_energies</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">direct_coupling_analysis</span><span class="p">()</span>
            <span class="n">dca_design_residues_concat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dca_design_residue_energies</span><span class="p">)</span>
            <span class="c1"># dca_background_energies.append(dca_background_energies.sum(axis=1))</span>
            <span class="c1"># dca_design_energies.append(dca_design_energies.sum(axis=1))</span>
            <span class="n">dca_background_energies</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="n">dca_background_residue_energies</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Turns data to 1D</span>
            <span class="n">dca_design_energies</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="n">dca_design_residue_energies</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For </span><span class="si">{</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, DCA analysis couldn&#39;t be performed. &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;Missing required parameter files&quot;</span><span class="p">)</span>
            <span class="n">dca_succeed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">dca_succeed</span><span class="p">:</span>
        <span class="c1"># concatenate along columns, adding residue index to column, design name to row</span>
        <span class="n">dca_concatenated_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dca_design_residues_concat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                           <span class="n">index</span><span class="o">=</span><span class="n">design_ids</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">residue_indices</span><span class="p">)</span>
        <span class="c1"># dca_concatenated_df.columns = pd.MultiIndex.from_product([dca_concatenated_df.columns, [&#39;dca_energy&#39;]])</span>
        <span class="n">dca_concatenated_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dca_concatenated_df</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dca_energy&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Merge with residues_df</span>
        <span class="n">residues_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">residues_df</span><span class="p">,</span> <span class="n">dca_concatenated_df</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">residues_df</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h3 id="protocols.pose.PoseProtocol.interface_design_analysis" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">interface_design_analysis</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">interface_design_analysis</span><span class="p">(</span><span class="n">designs</span><span class="p">:</span> <span class="n"><span title="collections.abc.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><span title="symdesign.structure.model.Pose">Pose</span></span><span class="p">]</span> <span class="o">|</span> <span class="n"><span title="collections.abc.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><span title="typing.AnyStr">AnyStr</span></span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n"><span title="pandas.Series">Series</span></span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Retrieve all score information from a PoseJob and write results to .csv file</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>designs</code></b>
            (<code><span title="collections.abc.Iterable">Iterable</span>[<span title="symdesign.structure.model.Pose">Pose</span>] | <span title="collections.abc.Iterable">Iterable</span>[<span title="typing.AnyStr">AnyStr</span>]</code>, default:
                <code>None</code>
)
        
        <div class="doc-md-description">
          <p>The designs to perform analysis on. By default, fetches all available structures</p>
        </div>
      </li>
  </ul>
      <p>Returns:
    Series containing summary metrics for all designs</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">4259</span>
<span class="normal">4260</span>
<span class="normal">4261</span>
<span class="normal">4262</span>
<span class="normal">4263</span>
<span class="normal">4264</span>
<span class="normal">4265</span>
<span class="normal">4266</span>
<span class="normal">4267</span>
<span class="normal">4268</span>
<span class="normal">4269</span>
<span class="normal">4270</span>
<span class="normal">4271</span>
<span class="normal">4272</span>
<span class="normal">4273</span>
<span class="normal">4274</span>
<span class="normal">4275</span>
<span class="normal">4276</span>
<span class="normal">4277</span>
<span class="normal">4278</span>
<span class="normal">4279</span>
<span class="normal">4280</span>
<span class="normal">4281</span>
<span class="normal">4282</span>
<span class="normal">4283</span>
<span class="normal">4284</span>
<span class="normal">4285</span>
<span class="normal">4286</span>
<span class="normal">4287</span>
<span class="normal">4288</span>
<span class="normal">4289</span>
<span class="normal">4290</span>
<span class="normal">4291</span>
<span class="normal">4292</span>
<span class="normal">4293</span>
<span class="normal">4294</span>
<span class="normal">4295</span>
<span class="normal">4296</span>
<span class="normal">4297</span>
<span class="normal">4298</span>
<span class="normal">4299</span>
<span class="normal">4300</span>
<span class="normal">4301</span>
<span class="normal">4302</span>
<span class="normal">4303</span>
<span class="normal">4304</span>
<span class="normal">4305</span>
<span class="normal">4306</span>
<span class="normal">4307</span>
<span class="normal">4308</span>
<span class="normal">4309</span>
<span class="normal">4310</span>
<span class="normal">4311</span>
<span class="normal">4312</span>
<span class="normal">4313</span>
<span class="normal">4314</span>
<span class="normal">4315</span>
<span class="normal">4316</span>
<span class="normal">4317</span>
<span class="normal">4318</span>
<span class="normal">4319</span>
<span class="normal">4320</span>
<span class="normal">4321</span>
<span class="normal">4322</span>
<span class="normal">4323</span>
<span class="normal">4324</span>
<span class="normal">4325</span>
<span class="normal">4326</span>
<span class="normal">4327</span>
<span class="normal">4328</span>
<span class="normal">4329</span>
<span class="normal">4330</span>
<span class="normal">4331</span>
<span class="normal">4332</span>
<span class="normal">4333</span>
<span class="normal">4334</span>
<span class="normal">4335</span>
<span class="normal">4336</span>
<span class="normal">4337</span>
<span class="normal">4338</span>
<span class="normal">4339</span>
<span class="normal">4340</span>
<span class="normal">4341</span>
<span class="normal">4342</span>
<span class="normal">4343</span>
<span class="normal">4344</span>
<span class="normal">4345</span>
<span class="normal">4346</span>
<span class="normal">4347</span>
<span class="normal">4348</span>
<span class="normal">4349</span>
<span class="normal">4350</span>
<span class="normal">4351</span>
<span class="normal">4352</span>
<span class="normal">4353</span>
<span class="normal">4354</span>
<span class="normal">4355</span>
<span class="normal">4356</span>
<span class="normal">4357</span>
<span class="normal">4358</span>
<span class="normal">4359</span>
<span class="normal">4360</span>
<span class="normal">4361</span>
<span class="normal">4362</span>
<span class="normal">4363</span>
<span class="normal">4364</span>
<span class="normal">4365</span>
<span class="normal">4366</span>
<span class="normal">4367</span>
<span class="normal">4368</span>
<span class="normal">4369</span>
<span class="normal">4370</span>
<span class="normal">4371</span>
<span class="normal">4372</span>
<span class="normal">4373</span>
<span class="normal">4374</span>
<span class="normal">4375</span>
<span class="normal">4376</span>
<span class="normal">4377</span>
<span class="normal">4378</span>
<span class="normal">4379</span>
<span class="normal">4380</span>
<span class="normal">4381</span>
<span class="normal">4382</span>
<span class="normal">4383</span>
<span class="normal">4384</span>
<span class="normal">4385</span>
<span class="normal">4386</span>
<span class="normal">4387</span>
<span class="normal">4388</span>
<span class="normal">4389</span>
<span class="normal">4390</span>
<span class="normal">4391</span>
<span class="normal">4392</span>
<span class="normal">4393</span>
<span class="normal">4394</span>
<span class="normal">4395</span>
<span class="normal">4396</span>
<span class="normal">4397</span>
<span class="normal">4398</span>
<span class="normal">4399</span>
<span class="normal">4400</span>
<span class="normal">4401</span>
<span class="normal">4402</span>
<span class="normal">4403</span>
<span class="normal">4404</span>
<span class="normal">4405</span>
<span class="normal">4406</span>
<span class="normal">4407</span>
<span class="normal">4408</span>
<span class="normal">4409</span>
<span class="normal">4410</span>
<span class="normal">4411</span>
<span class="normal">4412</span>
<span class="normal">4413</span>
<span class="normal">4414</span>
<span class="normal">4415</span>
<span class="normal">4416</span>
<span class="normal">4417</span>
<span class="normal">4418</span>
<span class="normal">4419</span>
<span class="normal">4420</span>
<span class="normal">4421</span>
<span class="normal">4422</span>
<span class="normal">4423</span>
<span class="normal">4424</span>
<span class="normal">4425</span>
<span class="normal">4426</span>
<span class="normal">4427</span>
<span class="normal">4428</span>
<span class="normal">4429</span>
<span class="normal">4430</span>
<span class="normal">4431</span>
<span class="normal">4432</span>
<span class="normal">4433</span>
<span class="normal">4434</span>
<span class="normal">4435</span>
<span class="normal">4436</span>
<span class="normal">4437</span>
<span class="normal">4438</span>
<span class="normal">4439</span>
<span class="normal">4440</span>
<span class="normal">4441</span>
<span class="normal">4442</span>
<span class="normal">4443</span>
<span class="normal">4444</span>
<span class="normal">4445</span>
<span class="normal">4446</span>
<span class="normal">4447</span>
<span class="normal">4448</span>
<span class="normal">4449</span>
<span class="normal">4450</span>
<span class="normal">4451</span>
<span class="normal">4452</span>
<span class="normal">4453</span>
<span class="normal">4454</span>
<span class="normal">4455</span>
<span class="normal">4456</span>
<span class="normal">4457</span>
<span class="normal">4458</span>
<span class="normal">4459</span>
<span class="normal">4460</span>
<span class="normal">4461</span>
<span class="normal">4462</span>
<span class="normal">4463</span>
<span class="normal">4464</span>
<span class="normal">4465</span>
<span class="normal">4466</span>
<span class="normal">4467</span>
<span class="normal">4468</span>
<span class="normal">4469</span>
<span class="normal">4470</span>
<span class="normal">4471</span>
<span class="normal">4472</span>
<span class="normal">4473</span>
<span class="normal">4474</span>
<span class="normal">4475</span>
<span class="normal">4476</span>
<span class="normal">4477</span>
<span class="normal">4478</span>
<span class="normal">4479</span>
<span class="normal">4480</span>
<span class="normal">4481</span>
<span class="normal">4482</span>
<span class="normal">4483</span>
<span class="normal">4484</span>
<span class="normal">4485</span>
<span class="normal">4486</span>
<span class="normal">4487</span>
<span class="normal">4488</span>
<span class="normal">4489</span>
<span class="normal">4490</span>
<span class="normal">4491</span>
<span class="normal">4492</span>
<span class="normal">4493</span>
<span class="normal">4494</span>
<span class="normal">4495</span>
<span class="normal">4496</span>
<span class="normal">4497</span>
<span class="normal">4498</span>
<span class="normal">4499</span>
<span class="normal">4500</span>
<span class="normal">4501</span>
<span class="normal">4502</span>
<span class="normal">4503</span>
<span class="normal">4504</span>
<span class="normal">4505</span>
<span class="normal">4506</span>
<span class="normal">4507</span>
<span class="normal">4508</span>
<span class="normal">4509</span>
<span class="normal">4510</span>
<span class="normal">4511</span>
<span class="normal">4512</span>
<span class="normal">4513</span>
<span class="normal">4514</span>
<span class="normal">4515</span>
<span class="normal">4516</span>
<span class="normal">4517</span>
<span class="normal">4518</span>
<span class="normal">4519</span>
<span class="normal">4520</span>
<span class="normal">4521</span>
<span class="normal">4522</span>
<span class="normal">4523</span>
<span class="normal">4524</span>
<span class="normal">4525</span>
<span class="normal">4526</span>
<span class="normal">4527</span>
<span class="normal">4528</span>
<span class="normal">4529</span>
<span class="normal">4530</span>
<span class="normal">4531</span>
<span class="normal">4532</span>
<span class="normal">4533</span>
<span class="normal">4534</span>
<span class="normal">4535</span>
<span class="normal">4536</span>
<span class="normal">4537</span>
<span class="normal">4538</span>
<span class="normal">4539</span>
<span class="normal">4540</span>
<span class="normal">4541</span>
<span class="normal">4542</span>
<span class="normal">4543</span>
<span class="normal">4544</span>
<span class="normal">4545</span>
<span class="normal">4546</span>
<span class="normal">4547</span>
<span class="normal">4548</span>
<span class="normal">4549</span>
<span class="normal">4550</span>
<span class="normal">4551</span>
<span class="normal">4552</span>
<span class="normal">4553</span>
<span class="normal">4554</span>
<span class="normal">4555</span>
<span class="normal">4556</span>
<span class="normal">4557</span>
<span class="normal">4558</span>
<span class="normal">4559</span>
<span class="normal">4560</span>
<span class="normal">4561</span>
<span class="normal">4562</span>
<span class="normal">4563</span>
<span class="normal">4564</span>
<span class="normal">4565</span>
<span class="normal">4566</span>
<span class="normal">4567</span>
<span class="normal">4568</span>
<span class="normal">4569</span>
<span class="normal">4570</span>
<span class="normal">4571</span>
<span class="normal">4572</span>
<span class="normal">4573</span>
<span class="normal">4574</span>
<span class="normal">4575</span>
<span class="normal">4576</span>
<span class="normal">4577</span>
<span class="normal">4578</span>
<span class="normal">4579</span>
<span class="normal">4580</span>
<span class="normal">4581</span>
<span class="normal">4582</span>
<span class="normal">4583</span>
<span class="normal">4584</span>
<span class="normal">4585</span>
<span class="normal">4586</span>
<span class="normal">4587</span>
<span class="normal">4588</span>
<span class="normal">4589</span>
<span class="normal">4590</span>
<span class="normal">4591</span>
<span class="normal">4592</span>
<span class="normal">4593</span>
<span class="normal">4594</span>
<span class="normal">4595</span>
<span class="normal">4596</span>
<span class="normal">4597</span>
<span class="normal">4598</span>
<span class="normal">4599</span>
<span class="normal">4600</span>
<span class="normal">4601</span>
<span class="normal">4602</span>
<span class="normal">4603</span>
<span class="normal">4604</span>
<span class="normal">4605</span>
<span class="normal">4606</span>
<span class="normal">4607</span>
<span class="normal">4608</span>
<span class="normal">4609</span>
<span class="normal">4610</span>
<span class="normal">4611</span>
<span class="normal">4612</span>
<span class="normal">4613</span>
<span class="normal">4614</span>
<span class="normal">4615</span>
<span class="normal">4616</span>
<span class="normal">4617</span>
<span class="normal">4618</span>
<span class="normal">4619</span>
<span class="normal">4620</span>
<span class="normal">4621</span>
<span class="normal">4622</span>
<span class="normal">4623</span>
<span class="normal">4624</span>
<span class="normal">4625</span>
<span class="normal">4626</span>
<span class="normal">4627</span>
<span class="normal">4628</span>
<span class="normal">4629</span>
<span class="normal">4630</span>
<span class="normal">4631</span>
<span class="normal">4632</span>
<span class="normal">4633</span>
<span class="normal">4634</span>
<span class="normal">4635</span>
<span class="normal">4636</span>
<span class="normal">4637</span>
<span class="normal">4638</span>
<span class="normal">4639</span>
<span class="normal">4640</span>
<span class="normal">4641</span>
<span class="normal">4642</span>
<span class="normal">4643</span>
<span class="normal">4644</span>
<span class="normal">4645</span>
<span class="normal">4646</span>
<span class="normal">4647</span>
<span class="normal">4648</span>
<span class="normal">4649</span>
<span class="normal">4650</span>
<span class="normal">4651</span>
<span class="normal">4652</span>
<span class="normal">4653</span>
<span class="normal">4654</span>
<span class="normal">4655</span>
<span class="normal">4656</span>
<span class="normal">4657</span>
<span class="normal">4658</span>
<span class="normal">4659</span>
<span class="normal">4660</span>
<span class="normal">4661</span>
<span class="normal">4662</span>
<span class="normal">4663</span>
<span class="normal">4664</span>
<span class="normal">4665</span>
<span class="normal">4666</span>
<span class="normal">4667</span>
<span class="normal">4668</span>
<span class="normal">4669</span>
<span class="normal">4670</span>
<span class="normal">4671</span>
<span class="normal">4672</span>
<span class="normal">4673</span>
<span class="normal">4674</span>
<span class="normal">4675</span>
<span class="normal">4676</span>
<span class="normal">4677</span>
<span class="normal">4678</span>
<span class="normal">4679</span>
<span class="normal">4680</span>
<span class="normal">4681</span>
<span class="normal">4682</span>
<span class="normal">4683</span>
<span class="normal">4684</span>
<span class="normal">4685</span>
<span class="normal">4686</span>
<span class="normal">4687</span>
<span class="normal">4688</span>
<span class="normal">4689</span>
<span class="normal">4690</span>
<span class="normal">4691</span>
<span class="normal">4692</span>
<span class="normal">4693</span>
<span class="normal">4694</span>
<span class="normal">4695</span>
<span class="normal">4696</span>
<span class="normal">4697</span>
<span class="normal">4698</span>
<span class="normal">4699</span>
<span class="normal">4700</span>
<span class="normal">4701</span>
<span class="normal">4702</span>
<span class="normal">4703</span>
<span class="normal">4704</span>
<span class="normal">4705</span>
<span class="normal">4706</span>
<span class="normal">4707</span>
<span class="normal">4708</span>
<span class="normal">4709</span>
<span class="normal">4710</span>
<span class="normal">4711</span>
<span class="normal">4712</span>
<span class="normal">4713</span>
<span class="normal">4714</span>
<span class="normal">4715</span>
<span class="normal">4716</span>
<span class="normal">4717</span>
<span class="normal">4718</span>
<span class="normal">4719</span>
<span class="normal">4720</span>
<span class="normal">4721</span>
<span class="normal">4722</span>
<span class="normal">4723</span>
<span class="normal">4724</span>
<span class="normal">4725</span>
<span class="normal">4726</span>
<span class="normal">4727</span>
<span class="normal">4728</span>
<span class="normal">4729</span>
<span class="normal">4730</span>
<span class="normal">4731</span>
<span class="normal">4732</span>
<span class="normal">4733</span>
<span class="normal">4734</span>
<span class="normal">4735</span>
<span class="normal">4736</span>
<span class="normal">4737</span>
<span class="normal">4738</span>
<span class="normal">4739</span>
<span class="normal">4740</span>
<span class="normal">4741</span>
<span class="normal">4742</span>
<span class="normal">4743</span>
<span class="normal">4744</span>
<span class="normal">4745</span>
<span class="normal">4746</span>
<span class="normal">4747</span>
<span class="normal">4748</span>
<span class="normal">4749</span>
<span class="normal">4750</span>
<span class="normal">4751</span>
<span class="normal">4752</span>
<span class="normal">4753</span>
<span class="normal">4754</span>
<span class="normal">4755</span>
<span class="normal">4756</span>
<span class="normal">4757</span>
<span class="normal">4758</span>
<span class="normal">4759</span>
<span class="normal">4760</span>
<span class="normal">4761</span>
<span class="normal">4762</span>
<span class="normal">4763</span>
<span class="normal">4764</span>
<span class="normal">4765</span>
<span class="normal">4766</span>
<span class="normal">4767</span>
<span class="normal">4768</span>
<span class="normal">4769</span>
<span class="normal">4770</span>
<span class="normal">4771</span>
<span class="normal">4772</span>
<span class="normal">4773</span>
<span class="normal">4774</span>
<span class="normal">4775</span>
<span class="normal">4776</span>
<span class="normal">4777</span>
<span class="normal">4778</span>
<span class="normal">4779</span>
<span class="normal">4780</span>
<span class="normal">4781</span>
<span class="normal">4782</span>
<span class="normal">4783</span>
<span class="normal">4784</span>
<span class="normal">4785</span>
<span class="normal">4786</span>
<span class="normal">4787</span>
<span class="normal">4788</span>
<span class="normal">4789</span>
<span class="normal">4790</span>
<span class="normal">4791</span>
<span class="normal">4792</span>
<span class="normal">4793</span>
<span class="normal">4794</span>
<span class="normal">4795</span>
<span class="normal">4796</span>
<span class="normal">4797</span>
<span class="normal">4798</span>
<span class="normal">4799</span>
<span class="normal">4800</span>
<span class="normal">4801</span>
<span class="normal">4802</span>
<span class="normal">4803</span>
<span class="normal">4804</span>
<span class="normal">4805</span>
<span class="normal">4806</span>
<span class="normal">4807</span>
<span class="normal">4808</span>
<span class="normal">4809</span>
<span class="normal">4810</span>
<span class="normal">4811</span>
<span class="normal">4812</span>
<span class="normal">4813</span>
<span class="normal">4814</span>
<span class="normal">4815</span>
<span class="normal">4816</span>
<span class="normal">4817</span>
<span class="normal">4818</span>
<span class="normal">4819</span>
<span class="normal">4820</span>
<span class="normal">4821</span>
<span class="normal">4822</span>
<span class="normal">4823</span>
<span class="normal">4824</span>
<span class="normal">4825</span>
<span class="normal">4826</span>
<span class="normal">4827</span>
<span class="normal">4828</span>
<span class="normal">4829</span>
<span class="normal">4830</span>
<span class="normal">4831</span>
<span class="normal">4832</span>
<span class="normal">4833</span>
<span class="normal">4834</span>
<span class="normal">4835</span>
<span class="normal">4836</span>
<span class="normal">4837</span>
<span class="normal">4838</span>
<span class="normal">4839</span>
<span class="normal">4840</span>
<span class="normal">4841</span>
<span class="normal">4842</span>
<span class="normal">4843</span>
<span class="normal">4844</span>
<span class="normal">4845</span>
<span class="normal">4846</span>
<span class="normal">4847</span>
<span class="normal">4848</span>
<span class="normal">4849</span>
<span class="normal">4850</span>
<span class="normal">4851</span>
<span class="normal">4852</span>
<span class="normal">4853</span>
<span class="normal">4854</span>
<span class="normal">4855</span>
<span class="normal">4856</span>
<span class="normal">4857</span>
<span class="normal">4858</span>
<span class="normal">4859</span>
<span class="normal">4860</span>
<span class="normal">4861</span>
<span class="normal">4862</span>
<span class="normal">4863</span>
<span class="normal">4864</span>
<span class="normal">4865</span>
<span class="normal">4866</span>
<span class="normal">4867</span>
<span class="normal">4868</span>
<span class="normal">4869</span>
<span class="normal">4870</span>
<span class="normal">4871</span>
<span class="normal">4872</span>
<span class="normal">4873</span>
<span class="normal">4874</span>
<span class="normal">4875</span>
<span class="normal">4876</span>
<span class="normal">4877</span>
<span class="normal">4878</span>
<span class="normal">4879</span>
<span class="normal">4880</span>
<span class="normal">4881</span>
<span class="normal">4882</span>
<span class="normal">4883</span>
<span class="normal">4884</span>
<span class="normal">4885</span>
<span class="normal">4886</span>
<span class="normal">4887</span>
<span class="normal">4888</span>
<span class="normal">4889</span>
<span class="normal">4890</span>
<span class="normal">4891</span>
<span class="normal">4892</span>
<span class="normal">4893</span>
<span class="normal">4894</span>
<span class="normal">4895</span>
<span class="normal">4896</span>
<span class="normal">4897</span>
<span class="normal">4898</span>
<span class="normal">4899</span>
<span class="normal">4900</span>
<span class="normal">4901</span>
<span class="normal">4902</span>
<span class="normal">4903</span>
<span class="normal">4904</span>
<span class="normal">4905</span>
<span class="normal">4906</span>
<span class="normal">4907</span>
<span class="normal">4908</span>
<span class="normal">4909</span>
<span class="normal">4910</span>
<span class="normal">4911</span>
<span class="normal">4912</span>
<span class="normal">4913</span>
<span class="normal">4914</span>
<span class="normal">4915</span>
<span class="normal">4916</span>
<span class="normal">4917</span>
<span class="normal">4918</span>
<span class="normal">4919</span>
<span class="normal">4920</span>
<span class="normal">4921</span>
<span class="normal">4922</span>
<span class="normal">4923</span>
<span class="normal">4924</span>
<span class="normal">4925</span>
<span class="normal">4926</span>
<span class="normal">4927</span>
<span class="normal">4928</span>
<span class="normal">4929</span>
<span class="normal">4930</span>
<span class="normal">4931</span>
<span class="normal">4932</span>
<span class="normal">4933</span>
<span class="normal">4934</span>
<span class="normal">4935</span>
<span class="normal">4936</span>
<span class="normal">4937</span>
<span class="normal">4938</span>
<span class="normal">4939</span>
<span class="normal">4940</span>
<span class="normal">4941</span>
<span class="normal">4942</span>
<span class="normal">4943</span>
<span class="normal">4944</span>
<span class="normal">4945</span>
<span class="normal">4946</span>
<span class="normal">4947</span>
<span class="normal">4948</span>
<span class="normal">4949</span>
<span class="normal">4950</span>
<span class="normal">4951</span>
<span class="normal">4952</span>
<span class="normal">4953</span>
<span class="normal">4954</span>
<span class="normal">4955</span>
<span class="normal">4956</span>
<span class="normal">4957</span>
<span class="normal">4958</span>
<span class="normal">4959</span>
<span class="normal">4960</span>
<span class="normal">4961</span>
<span class="normal">4962</span>
<span class="normal">4963</span>
<span class="normal">4964</span>
<span class="normal">4965</span>
<span class="normal">4966</span>
<span class="normal">4967</span>
<span class="normal">4968</span>
<span class="normal">4969</span>
<span class="normal">4970</span>
<span class="normal">4971</span>
<span class="normal">4972</span>
<span class="normal">4973</span>
<span class="normal">4974</span>
<span class="normal">4975</span>
<span class="normal">4976</span>
<span class="normal">4977</span>
<span class="normal">4978</span>
<span class="normal">4979</span>
<span class="normal">4980</span>
<span class="normal">4981</span>
<span class="normal">4982</span>
<span class="normal">4983</span>
<span class="normal">4984</span>
<span class="normal">4985</span>
<span class="normal">4986</span>
<span class="normal">4987</span>
<span class="normal">4988</span>
<span class="normal">4989</span>
<span class="normal">4990</span>
<span class="normal">4991</span>
<span class="normal">4992</span>
<span class="normal">4993</span>
<span class="normal">4994</span>
<span class="normal">4995</span>
<span class="normal">4996</span>
<span class="normal">4997</span>
<span class="normal">4998</span>
<span class="normal">4999</span>
<span class="normal">5000</span>
<span class="normal">5001</span>
<span class="normal">5002</span>
<span class="normal">5003</span>
<span class="normal">5004</span>
<span class="normal">5005</span>
<span class="normal">5006</span>
<span class="normal">5007</span>
<span class="normal">5008</span>
<span class="normal">5009</span>
<span class="normal">5010</span>
<span class="normal">5011</span>
<span class="normal">5012</span>
<span class="normal">5013</span>
<span class="normal">5014</span>
<span class="normal">5015</span>
<span class="normal">5016</span>
<span class="normal">5017</span>
<span class="normal">5018</span>
<span class="normal">5019</span>
<span class="normal">5020</span>
<span class="normal">5021</span>
<span class="normal">5022</span>
<span class="normal">5023</span>
<span class="normal">5024</span>
<span class="normal">5025</span>
<span class="normal">5026</span>
<span class="normal">5027</span>
<span class="normal">5028</span>
<span class="normal">5029</span>
<span class="normal">5030</span>
<span class="normal">5031</span>
<span class="normal">5032</span>
<span class="normal">5033</span>
<span class="normal">5034</span>
<span class="normal">5035</span>
<span class="normal">5036</span>
<span class="normal">5037</span>
<span class="normal">5038</span>
<span class="normal">5039</span>
<span class="normal">5040</span>
<span class="normal">5041</span>
<span class="normal">5042</span>
<span class="normal">5043</span>
<span class="normal">5044</span>
<span class="normal">5045</span>
<span class="normal">5046</span>
<span class="normal">5047</span>
<span class="normal">5048</span>
<span class="normal">5049</span>
<span class="normal">5050</span>
<span class="normal">5051</span>
<span class="normal">5052</span>
<span class="normal">5053</span>
<span class="normal">5054</span>
<span class="normal">5055</span>
<span class="normal">5056</span>
<span class="normal">5057</span>
<span class="normal">5058</span>
<span class="normal">5059</span>
<span class="normal">5060</span>
<span class="normal">5061</span>
<span class="normal">5062</span>
<span class="normal">5063</span>
<span class="normal">5064</span>
<span class="normal">5065</span>
<span class="normal">5066</span>
<span class="normal">5067</span>
<span class="normal">5068</span>
<span class="normal">5069</span>
<span class="normal">5070</span>
<span class="normal">5071</span>
<span class="normal">5072</span>
<span class="normal">5073</span>
<span class="normal">5074</span>
<span class="normal">5075</span>
<span class="normal">5076</span>
<span class="normal">5077</span>
<span class="normal">5078</span>
<span class="normal">5079</span>
<span class="normal">5080</span>
<span class="normal">5081</span>
<span class="normal">5082</span>
<span class="normal">5083</span>
<span class="normal">5084</span>
<span class="normal">5085</span>
<span class="normal">5086</span>
<span class="normal">5087</span>
<span class="normal">5088</span>
<span class="normal">5089</span>
<span class="normal">5090</span>
<span class="normal">5091</span>
<span class="normal">5092</span>
<span class="normal">5093</span>
<span class="normal">5094</span>
<span class="normal">5095</span>
<span class="normal">5096</span>
<span class="normal">5097</span>
<span class="normal">5098</span>
<span class="normal">5099</span>
<span class="normal">5100</span>
<span class="normal">5101</span>
<span class="normal">5102</span>
<span class="normal">5103</span>
<span class="normal">5104</span>
<span class="normal">5105</span>
<span class="normal">5106</span>
<span class="normal">5107</span>
<span class="normal">5108</span>
<span class="normal">5109</span>
<span class="normal">5110</span>
<span class="normal">5111</span>
<span class="normal">5112</span>
<span class="normal">5113</span>
<span class="normal">5114</span>
<span class="normal">5115</span>
<span class="normal">5116</span>
<span class="normal">5117</span>
<span class="normal">5118</span>
<span class="normal">5119</span>
<span class="normal">5120</span>
<span class="normal">5121</span>
<span class="normal">5122</span>
<span class="normal">5123</span>
<span class="normal">5124</span>
<span class="normal">5125</span>
<span class="normal">5126</span>
<span class="normal">5127</span>
<span class="normal">5128</span>
<span class="normal">5129</span>
<span class="normal">5130</span>
<span class="normal">5131</span>
<span class="normal">5132</span>
<span class="normal">5133</span>
<span class="normal">5134</span>
<span class="normal">5135</span>
<span class="normal">5136</span>
<span class="normal">5137</span>
<span class="normal">5138</span>
<span class="normal">5139</span>
<span class="normal">5140</span>
<span class="normal">5141</span>
<span class="normal">5142</span>
<span class="normal">5143</span>
<span class="normal">5144</span>
<span class="normal">5145</span>
<span class="normal">5146</span>
<span class="normal">5147</span>
<span class="normal">5148</span>
<span class="normal">5149</span>
<span class="normal">5150</span>
<span class="normal">5151</span>
<span class="normal">5152</span>
<span class="normal">5153</span>
<span class="normal">5154</span>
<span class="normal">5155</span>
<span class="normal">5156</span>
<span class="normal">5157</span>
<span class="normal">5158</span>
<span class="normal">5159</span>
<span class="normal">5160</span>
<span class="normal">5161</span>
<span class="normal">5162</span>
<span class="normal">5163</span>
<span class="normal">5164</span>
<span class="normal">5165</span>
<span class="normal">5166</span>
<span class="normal">5167</span>
<span class="normal">5168</span>
<span class="normal">5169</span>
<span class="normal">5170</span>
<span class="normal">5171</span>
<span class="normal">5172</span>
<span class="normal">5173</span>
<span class="normal">5174</span>
<span class="normal">5175</span>
<span class="normal">5176</span>
<span class="normal">5177</span>
<span class="normal">5178</span>
<span class="normal">5179</span>
<span class="normal">5180</span>
<span class="normal">5181</span>
<span class="normal">5182</span>
<span class="normal">5183</span>
<span class="normal">5184</span>
<span class="normal">5185</span>
<span class="normal">5186</span>
<span class="normal">5187</span>
<span class="normal">5188</span>
<span class="normal">5189</span>
<span class="normal">5190</span>
<span class="normal">5191</span>
<span class="normal">5192</span>
<span class="normal">5193</span>
<span class="normal">5194</span>
<span class="normal">5195</span>
<span class="normal">5196</span>
<span class="normal">5197</span>
<span class="normal">5198</span>
<span class="normal">5199</span>
<span class="normal">5200</span>
<span class="normal">5201</span>
<span class="normal">5202</span>
<span class="normal">5203</span>
<span class="normal">5204</span>
<span class="normal">5205</span>
<span class="normal">5206</span>
<span class="normal">5207</span>
<span class="normal">5208</span>
<span class="normal">5209</span>
<span class="normal">5210</span>
<span class="normal">5211</span>
<span class="normal">5212</span>
<span class="normal">5213</span>
<span class="normal">5214</span>
<span class="normal">5215</span>
<span class="normal">5216</span>
<span class="normal">5217</span>
<span class="normal">5218</span>
<span class="normal">5219</span>
<span class="normal">5220</span>
<span class="normal">5221</span>
<span class="normal">5222</span>
<span class="normal">5223</span>
<span class="normal">5224</span>
<span class="normal">5225</span>
<span class="normal">5226</span>
<span class="normal">5227</span>
<span class="normal">5228</span>
<span class="normal">5229</span>
<span class="normal">5230</span>
<span class="normal">5231</span>
<span class="normal">5232</span>
<span class="normal">5233</span>
<span class="normal">5234</span>
<span class="normal">5235</span>
<span class="normal">5236</span>
<span class="normal">5237</span>
<span class="normal">5238</span>
<span class="normal">5239</span>
<span class="normal">5240</span>
<span class="normal">5241</span>
<span class="normal">5242</span>
<span class="normal">5243</span>
<span class="normal">5244</span>
<span class="normal">5245</span>
<span class="normal">5246</span>
<span class="normal">5247</span>
<span class="normal">5248</span>
<span class="normal">5249</span>
<span class="normal">5250</span>
<span class="normal">5251</span>
<span class="normal">5252</span>
<span class="normal">5253</span>
<span class="normal">5254</span>
<span class="normal">5255</span>
<span class="normal">5256</span>
<span class="normal">5257</span>
<span class="normal">5258</span>
<span class="normal">5259</span>
<span class="normal">5260</span>
<span class="normal">5261</span>
<span class="normal">5262</span>
<span class="normal">5263</span>
<span class="normal">5264</span>
<span class="normal">5265</span>
<span class="normal">5266</span>
<span class="normal">5267</span>
<span class="normal">5268</span>
<span class="normal">5269</span>
<span class="normal">5270</span>
<span class="normal">5271</span>
<span class="normal">5272</span>
<span class="normal">5273</span>
<span class="normal">5274</span>
<span class="normal">5275</span>
<span class="normal">5276</span>
<span class="normal">5277</span>
<span class="normal">5278</span>
<span class="normal">5279</span>
<span class="normal">5280</span>
<span class="normal">5281</span>
<span class="normal">5282</span>
<span class="normal">5283</span>
<span class="normal">5284</span>
<span class="normal">5285</span>
<span class="normal">5286</span>
<span class="normal">5287</span>
<span class="normal">5288</span>
<span class="normal">5289</span>
<span class="normal">5290</span>
<span class="normal">5291</span>
<span class="normal">5292</span>
<span class="normal">5293</span>
<span class="normal">5294</span>
<span class="normal">5295</span>
<span class="normal">5296</span>
<span class="normal">5297</span>
<span class="normal">5298</span>
<span class="normal">5299</span>
<span class="normal">5300</span>
<span class="normal">5301</span>
<span class="normal">5302</span>
<span class="normal">5303</span>
<span class="normal">5304</span>
<span class="normal">5305</span>
<span class="normal">5306</span>
<span class="normal">5307</span>
<span class="normal">5308</span>
<span class="normal">5309</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">interface_design_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">designs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Pose</span><span class="p">]</span> <span class="o">|</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve all score information from a PoseJob and write results to .csv file</span>

<span class="sd">    Args:</span>
<span class="sd">        designs: The designs to perform analysis on. By default, fetches all available structures</span>
<span class="sd">    Returns:</span>
<span class="sd">        Series containing summary metrics for all designs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s1">&#39;This is in place for backward compatibility but is currently not debugged. Please&#39;</span>
        <span class="sa">f</span><span class="s1">&#39; consider using the module &quot;</span><span class="si">{</span><span class="n">flags</span><span class="o">.</span><span class="n">process_rosetta_metrics</span><span class="si">}</span><span class="s1">&quot; instead, or debug &#39;</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">interface_design_analysis</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> from the module &quot;</span><span class="si">{</span><span class="n">flags</span><span class="o">.</span><span class="n">analysis</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">load_pose</span><span class="p">()</span>
    <span class="c1"># self.identify_interface()</span>

    <span class="c1"># Load fragment_profile into the analysis</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">fragment_info_by_entity_pair</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_fragments</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">calculate_fragment_profile</span><span class="p">()</span>

    <span class="c1"># CAUTION: Assumes each structure is the same length</span>
    <span class="c1"># Todo get residues_df[&#39;design_indices&#39;]</span>
    <span class="n">pose_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_residues</span>
    <span class="n">residue_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">pose_length</span><span class="p">))</span>
    <span class="c1"># residue_numbers = [residue.number for residue in self.pose.residues]</span>
    <span class="c1"># interface_residue_indices = [residue.index for residue in self.pose.interface_residues]</span>

    <span class="c1"># Find all designs files</span>
    <span class="c1"># Todo fold these into Model(s) and attack metrics from Pose objects?</span>
    <span class="k">if</span> <span class="n">designs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pose_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_kwargs</span>
        <span class="n">designs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Pose</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">pose_kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_design_files</span><span class="p">()]</span>  <span class="c1"># Todo PoseJob(.path)</span>

    <span class="n">pose_sequences</span> <span class="o">=</span> <span class="p">{</span><span class="n">pose</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">pose</span><span class="o">.</span><span class="n">sequence</span> <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">designs</span><span class="p">}</span>
    <span class="n">sequences_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_sequence_metrics_per_design</span><span class="p">(</span><span class="n">pose_sequences</span><span class="p">)</span>
    <span class="c1"># all_mutations = generate_mutations_from_reference(self.pose.sequence, pose_sequences,</span>
    <span class="c1">#                                                   zero_index=True, return_to=True)</span>

    <span class="n">entity_energies</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">]</span>
    <span class="n">pose_source_residue_info</span> <span class="o">=</span> \
        <span class="p">{</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;complex&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;bound&#39;</span><span class="p">:</span> <span class="n">entity_energies</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="s1">&#39;unbound&#39;</span><span class="p">:</span> <span class="n">entity_energies</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                         <span class="s1">&#39;solv_complex&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;solv_bound&#39;</span><span class="p">:</span> <span class="n">entity_energies</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                         <span class="s1">&#39;solv_unbound&#39;</span><span class="p">:</span> <span class="n">entity_energies</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="s1">&#39;fsp&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;cst&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;hbond&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
         <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span> <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">residues</span><span class="p">}</span>
    <span class="n">pose_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
    <span class="n">residue_info</span> <span class="o">=</span> <span class="p">{</span><span class="n">pose_name</span><span class="p">:</span> <span class="n">pose_source_residue_info</span><span class="p">}</span>

    <span class="c1"># Gather miscellaneous pose specific metrics</span>
    <span class="c1"># other_pose_metrics = self.pose.calculate_metrics()</span>
    <span class="c1"># Create metrics for the pose_source</span>
    <span class="n">empty_source</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="c1"># **other_pose_metrics,</span>
        <span class="n">buried_unsatisfied_hbonds_complex</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="c1"># buried_unsatisfied_hbonds_unbound=0,</span>
        <span class="n">contact_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">favor_residue_energy</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">interaction_energy_complex</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">interaction_energy_per_residue</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">interface_separation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">number_hbonds</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">rmsd_complex</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># Todo calculate this here instead of Rosetta using superposition3d</span>
        <span class="n">rosetta_reference_energy</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">shape_complementarity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">job_key</span> <span class="o">=</span> <span class="s1">&#39;no_energy&#39;</span>
    <span class="n">empty_source</span><span class="p">[</span><span class="n">putils</span><span class="o">.</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_key</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">empty_source</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;buns</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">_unbound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">empty_source</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;entity</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">_interface_connectivity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">source_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">empty_source</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">pose_name</span><span class="p">])</span>

    <span class="c1"># Get the metrics from the score file for each design</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores_file</span><span class="p">):</span>  <span class="c1"># Rosetta scores file is present  # Todo PoseJob(.path)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found design scores in file: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scores_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># Todo PoseJob(.path)</span>
        <span class="n">design_was_performed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># # Get the scores from the score file on design trajectory metrics</span>
        <span class="c1"># source_df = pd.DataFrame.from_dict({pose_name: {putils.protocol: job_key}}, orient=&#39;index&#39;)</span>
        <span class="c1"># for idx, entity in enumerate(self.pose.entities, 1):</span>
        <span class="c1">#     source_df[f&#39;buns{idx}_unbound&#39;] = 0</span>
        <span class="c1">#     source_df[f&#39;entity{idx}_interface_connectivity&#39;] = 0</span>
        <span class="c1"># source_df[&#39;buried_unsatisfied_hbonds_complex&#39;] = 0</span>
        <span class="c1"># # source_df[&#39;buried_unsatisfied_hbonds_unbound&#39;] = 0</span>
        <span class="c1"># source_df[&#39;contact_count&#39;] = 0</span>
        <span class="c1"># source_df[&#39;favor_residue_energy&#39;] = 0</span>
        <span class="c1"># # Used in sum_per_residue_df</span>
        <span class="c1"># # source_df[&#39;interface_energy_complex&#39;] = 0</span>
        <span class="c1"># source_df[&#39;interaction_energy_complex&#39;] = 0</span>
        <span class="c1"># source_df[&#39;interaction_energy_per_residue&#39;] = \</span>
        <span class="c1">#     source_df[&#39;interaction_energy_complex&#39;] / len(self.pose.interface_residues)</span>
        <span class="c1"># source_df[&#39;interface_separation&#39;] = 0</span>
        <span class="c1"># source_df[&#39;number_hbonds&#39;] = 0</span>
        <span class="c1"># source_df[&#39;rmsd_complex&#39;] = 0</span>
        <span class="c1"># source_df[&#39;rosetta_reference_energy&#39;] = 0</span>
        <span class="c1"># source_df[&#39;shape_complementarity&#39;] = 0</span>
        <span class="n">design_scores</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">parse_rosetta_scorefile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scores_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;All designs with scores: </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">design_scores</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Find designs with scores and structures</span>
        <span class="n">structure_design_scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">designs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">structure_design_scores</span><span class="p">[</span><span class="n">pose</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">design_scores</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pose</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># Structure wasn&#39;t scored, we will remove this later</span>
                <span class="k">pass</span>

        <span class="c1"># Create protocol dataframe</span>
        <span class="n">scores_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">structure_design_scores</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="c1"># # Fill in all the missing values with that of the default pose_source</span>
        <span class="c1"># scores_df = pd.concat([source_df, scores_df]).fillna(method=&#39;ffill&#39;)</span>
        <span class="c1"># Gather all columns into specific types for processing and formatting</span>
        <span class="n">per_res_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># hbonds_columns = []</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;res_&#39;</span> <span class="ow">in</span> <span class="n">column</span><span class="p">:</span>  <span class="c1"># if column.startswith(&#39;per_res_&#39;):</span>
                <span class="n">per_res_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="c1"># elif column.startswith(&#39;hbonds_res_selection&#39;):</span>
            <span class="c1">#     hbonds_columns.append(column)</span>

        <span class="c1"># Check proper input</span>
        <span class="n">metric_set</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">rosetta_required</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">scores_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">metric_set</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DesignError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Missing required metrics: &quot;</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metric_set</span><span class="p">)</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

        <span class="c1"># Remove unnecessary (old scores) as well as Rosetta pose score terms besides ref (has been renamed above)</span>
        <span class="c1"># Todo learn know how to produce Rosetta score terms in output score file. Not in FastRelax...</span>
        <span class="n">remove_columns</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">rosetta_terms</span> <span class="o">+</span> <span class="n">metrics</span><span class="o">.</span><span class="n">unnecessary</span> <span class="o">+</span> <span class="n">per_res_columns</span>
        <span class="c1"># Todo remove dirty when columns are correct (after P432)</span>
        <span class="c1">#  and column tabulation precedes residue/hbond_processing</span>
        <span class="c1"># residue_info = {&#39;energy&#39;: {&#39;complex&#39;: 0., &#39;unbound&#39;: 0.}, &#39;type&#39;: None, &#39;hbond&#39;: 0}</span>
        <span class="n">residue_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">process_rosetta_residue_scores</span><span class="p">(</span><span class="n">structure_design_scores</span><span class="p">))</span>
        <span class="c1"># Can&#39;t use residue_processing (clean) ^ in the case there is a design without metrics... columns not found!</span>
        <span class="n">residue_info</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">process_residue_info</span><span class="p">(</span>
            <span class="n">residue_info</span><span class="p">,</span> <span class="n">hbonds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">rosetta_hbond_processing</span><span class="p">(</span><span class="n">structure_design_scores</span><span class="p">))</span>
        <span class="c1"># residue_info = metrics.incorporate_sequence_info(residue_info, pose_sequences)</span>

        <span class="c1"># Drop designs where required data isn&#39;t present</span>
        <span class="c1"># Format protocol columns</span>
        <span class="k">if</span> <span class="n">putils</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">in</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">missing_group_indices</span> <span class="o">=</span> <span class="n">scores_df</span><span class="p">[</span><span class="n">putils</span><span class="o">.</span><span class="n">protocol</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
            <span class="c1"># Todo remove not DEV</span>
            <span class="n">scout_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">scores_df</span><span class="p">[</span><span class="n">missing_group_indices</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="s1">&#39;scout&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
            <span class="n">scores_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">scout_indices</span><span class="p">,</span> <span class="n">putils</span><span class="o">.</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> <span class="n">putils</span><span class="o">.</span><span class="n">scout</span>
            <span class="n">structure_bkgnd_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">scores_df</span><span class="p">[</span><span class="n">missing_group_indices</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
                                       <span class="k">if</span> <span class="s1">&#39;no_constraint&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
            <span class="n">scores_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">structure_bkgnd_indices</span><span class="p">,</span> <span class="n">putils</span><span class="o">.</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> <span class="n">putils</span><span class="o">.</span><span class="n">structure_background</span>
            <span class="c1"># Todo Done remove</span>
            <span class="c1"># protocol_s.replace({&#39;combo_profile&#39;: putils.design_profile}, inplace=True)  # Ensure proper name</span>

            <span class="n">scores_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">missing_group_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="c1"># protocol_s.drop(missing_group_indices, inplace=True, errors=&#39;ignore&#39;)</span>

        <span class="n">viable_designs</span> <span class="o">=</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">viable_designs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DesignError</span><span class="p">(</span><span class="s1">&#39;No viable designs remain after processing!&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Viable designs with structures remaining after cleaning:</span><span class="se">\n\t</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">viable_designs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">pose_sequences</span> <span class="o">=</span> <span class="p">{</span><span class="n">design</span><span class="p">:</span> <span class="n">sequence</span> <span class="k">for</span> <span class="n">design</span><span class="p">,</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">pose_sequences</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span>
                          <span class="n">design</span> <span class="ow">in</span> <span class="n">viable_designs</span><span class="p">}</span>

        <span class="c1"># Todo implement this protocol if sequence data is taken at multiple points along a trajectory and the</span>
        <span class="c1">#  sequence data along trajectory is a metric on it&#39;s own</span>
        <span class="c1"># # Gather mutations for residue specific processing and design sequences</span>
        <span class="c1"># for design, data in list(structure_design_scores.items()):  # make a copy as can be removed</span>
        <span class="c1">#     sequence = data.get(&#39;final_sequence&#39;)</span>
        <span class="c1">#     if sequence:</span>
        <span class="c1">#         if len(sequence) &gt;= pose_length:</span>
        <span class="c1">#             pose_sequences[design] = sequence[:pose_length]  # Todo won&#39;t work if design had insertions</span>
        <span class="c1">#         else:</span>
        <span class="c1">#             pose_sequences[design] = sequence</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         self.log.warning(&#39;Design %s is missing sequence data, removing from design pool&#39; % design)</span>
        <span class="c1">#         structure_design_scores.pop(design)</span>
        <span class="c1"># # format {entity: {design_name: sequence, ...}, ...}</span>
        <span class="c1"># entity_sequences = \</span>
        <span class="c1">#     {entity: {design: sequence[entity.n_terminal_residue.number - 1:entity.c_terminal_residue.number]</span>
        <span class="c1">#               for design, sequence in pose_sequences.items()} for entity in self.pose.entities}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Missing design scores file at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scores_file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># Todo PoseJob(.path)</span>
        <span class="n">design_was_performed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Todo add relevant missing scores such as those specified as 0 below</span>
        <span class="c1"># Todo may need to put source_df in scores file alternative</span>
        <span class="c1"># source_df = pd.DataFrame.from_dict({pose_name: {putils.protocol: job_key}}, orient=&#39;index&#39;)</span>
        <span class="c1"># for idx, entity in enumerate(self.pose.entities, 1):</span>
        <span class="c1">#     source_df[f&#39;buns{idx}_unbound&#39;] = 0</span>
        <span class="c1">#     source_df[f&#39;entity{idx}_interface_connectivity&#39;] = 0</span>
        <span class="c1">#     # residue_info = {&#39;energy&#39;: {&#39;complex&#39;: 0., &#39;unbound&#39;: 0.}, &#39;type&#39;: None, &#39;hbond&#39;: 0}</span>
        <span class="c1">#     # design_info.update({residue.number: {&#39;energy_delta&#39;: 0.,</span>
        <span class="c1">#     #                                      &#39;type&#39;: protein_letters_3to1.get(residue.type),</span>
        <span class="c1">#     #                                      &#39;hbond&#39;: 0} for residue in entity.residues})</span>
        <span class="c1"># source_df[&#39;buried_unsatisfied_hbonds_complex&#39;] = 0</span>
        <span class="c1"># # source_df[&#39;buried_unsatisfied_hbonds_unbound&#39;] = 0</span>
        <span class="c1"># source_df[&#39;contact_count&#39;] = 0</span>
        <span class="c1"># source_df[&#39;favor_residue_energy&#39;] = 0</span>
        <span class="c1"># # source_df[&#39;interface_energy_complex&#39;] = 0</span>
        <span class="c1"># source_df[&#39;interaction_energy_complex&#39;] = 0</span>
        <span class="c1"># source_df[&#39;interaction_energy_per_residue&#39;] = \</span>
        <span class="c1">#     source_df[&#39;interaction_energy_complex&#39;] / len(self.pose.interface_residues)</span>
        <span class="c1"># source_df[&#39;interface_separation&#39;] = 0</span>
        <span class="c1"># source_df[&#39;number_hbonds&#39;] = 0</span>
        <span class="c1"># source_df[&#39;rmsd_complex&#39;] = 0</span>
        <span class="c1"># source_df[&#39;rosetta_reference_energy&#39;] = 0</span>
        <span class="c1"># source_df[&#39;shape_complementarity&#39;] = 0</span>
        <span class="n">scores_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="n">pose</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span><span class="n">putils</span><span class="o">.</span><span class="n">protocol</span><span class="p">:</span> <span class="n">job_key</span><span class="p">}</span> <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">designs</span><span class="p">},</span>
                                           <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="c1"># # Fill in all the missing values with that of the default pose_source</span>
        <span class="c1"># scores_df = pd.concat([source_df, scores_df]).fillna(method=&#39;ffill&#39;)</span>

        <span class="n">remove_columns</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">rosetta_terms</span> <span class="o">+</span> <span class="n">metrics</span><span class="o">.</span><span class="n">unnecessary</span>
        <span class="n">residue_info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">struct_name</span><span class="p">:</span> <span class="n">pose_source_residue_info</span> <span class="k">for</span> <span class="n">struct_name</span> <span class="ow">in</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()})</span>
        <span class="c1"># Todo generate energy scores internally which matches output from residue_processing</span>
        <span class="n">viable_designs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pose</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">designs</span><span class="p">]</span>

    <span class="n">scores_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">remove_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

    <span class="c1"># Find protocols for protocol specific data processing removing from scores_df</span>
    <span class="n">protocol_s</span> <span class="o">=</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">putils</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">designs_by_protocol</span> <span class="o">=</span> <span class="n">protocol_s</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">protocol_s</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>
    <span class="c1"># unique_protocols = list(designs_by_protocol.keys())</span>
    <span class="c1"># Remove refine and consensus if present as there was no design done over multiple protocols</span>
    <span class="c1"># Todo change if we did multiple rounds of these protocols</span>
    <span class="n">designs_by_protocol</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">putils</span><span class="o">.</span><span class="n">refine</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">designs_by_protocol</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">putils</span><span class="o">.</span><span class="n">consensus</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># Get unique protocols</span>
    <span class="n">unique_design_protocols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">designs_by_protocol</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unique Design Protocols: </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique_design_protocols</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Replace empty strings with np.nan and convert remaining to float</span>
    <span class="n">scores_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">scores_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">protocol_specific_columns</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="mi">0</span><span class="p">))),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># scores_df = scores_df.astype(float)  # , copy=False, errors=&#39;ignore&#39;)</span>
    <span class="c1"># Fill in all the missing values with that of the default pose_source</span>
    <span class="n">scores_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">source_df</span><span class="p">,</span> <span class="n">scores_df</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>

    <span class="c1"># atomic_deviation = {}</span>
    <span class="c1"># pose_assembly_minimally_contacting = self.pose.assembly_minimally_contacting</span>
    <span class="c1"># perform SASA measurements</span>
    <span class="c1"># pose_assembly_minimally_contacting.get_sasa()</span>
    <span class="c1"># assembly_asu_residues = pose_assembly_minimally_contacting.residues[:pose_length]</span>
    <span class="c1"># per_residue_data[&#39;sasa_hydrophobic_complex&#39;][pose_name] = \</span>
    <span class="c1">#     [residue.sasa_apolar for residue in assembly_asu_residues]</span>
    <span class="c1"># per_residue_data[&#39;sasa_polar_complex&#39;][pose_name] = [residue.sasa_polar for residue in assembly_asu_residues]</span>
    <span class="c1"># per_residue_data[&#39;sasa_relative_complex&#39;][pose_name] = \</span>
    <span class="c1">#     [residue.relative_sasa for residue in assembly_asu_residues]</span>

    <span class="c1"># Grab metrics for the pose source. Checks if self.pose was designed</span>
    <span class="c1"># Favor pose source errat/collapse on a per-entity basis if design occurred</span>
    <span class="c1"># As the pose source assumes no legit interface present while designs have an interface</span>
    <span class="c1"># per_residue_sasa_unbound_apolar, per_residue_sasa_unbound_polar, per_residue_sasa_unbound_relative = [], [], []</span>
    <span class="c1"># source_errat_accuracy, inverse_residue_contact_order_z = [], []</span>

    <span class="n">per_residue_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> \
        <span class="p">{</span><span class="n">pose_name</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">per_residue_interface_surface_area</span><span class="p">(),</span>
                     <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">per_residue_contact_order</span><span class="p">()}</span>
         <span class="p">}</span>

    <span class="n">number_of_entities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_entities</span>
    <span class="c1"># if design_was_performed:  # The input structure was not meant to be together, treat as such</span>
    <span class="c1">#     source_errat = []</span>
    <span class="c1">#     for idx, entity in enumerate(self.pose.entities):</span>
    <span class="c1">#         # Replace &#39;errat_deviation&#39; measurement with uncomplexed entities</span>
    <span class="c1">#         # oligomer_errat_accuracy, oligomeric_errat = entity_oligomer.errat(out_path=os.path.devnull)</span>
    <span class="c1">#         # source_errat_accuracy.append(oligomer_errat_accuracy)</span>
    <span class="c1">#         _, oligomeric_errat = entity.assembly.errat(out_path=os.path.devnull)</span>
    <span class="c1">#         source_errat.append(oligomeric_errat[:entity.number_of_residues])</span>
    <span class="c1">#     # atomic_deviation[pose_name] = sum(source_errat_accuracy) / float(number_of_entities)</span>
    <span class="c1">#     pose_source_errat = np.concatenate(source_errat)</span>
    <span class="c1"># else:</span>
    <span class="c1">#     # Get errat measurement</span>
    <span class="c1">#     # per_residue_data[pose_name].update(self.pose.per_residue_errat())</span>
    <span class="c1">#     pose_source_errat = self.pose.per_residue_errat()[&#39;errat_deviation&#39;]</span>
    <span class="c1">#</span>
    <span class="c1"># per_residue_data[pose_name][&#39;errat_deviation&#39;] = pose_source_errat</span>

    <span class="c1"># Compute structural measurements for all designs</span>
    <span class="n">interface_local_density</span> <span class="o">=</span> <span class="p">{</span><span class="n">pose_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">local_density_interface</span><span class="p">()}</span>
    <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">designs</span><span class="p">:</span>  <span class="c1"># Takes 1-2 seconds for Structure -&gt; assembly -&gt; errat</span>
        <span class="c1"># Must find interface residues before measure local_density</span>
        <span class="n">pose</span><span class="o">.</span><span class="n">find_and_split_interface</span><span class="p">()</span>
        <span class="n">per_residue_data</span><span class="p">[</span><span class="n">pose</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">per_residue_interface_surface_area</span><span class="p">()</span>
        <span class="c1"># Get errat measurement</span>
        <span class="c1"># per_residue_data[pose.name].update(pose.per_residue_errat())</span>
        <span class="c1"># Todo remove Rosetta</span>
        <span class="c1">#  This is a measurement of interface_connectivity like from Rosetta</span>
        <span class="n">interface_local_density</span><span class="p">[</span><span class="n">pose</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">local_density_interface</span><span class="p">()</span>

    <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;interface_local_density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">interface_local_density</span><span class="p">)</span>

    <span class="c1"># Load profiles of interest into the analysis</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_up_evolutionary_profile</span><span class="p">(</span><span class="n">warn_metrics</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># self.generate_fragments() was already called</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">calculate_profile</span><span class="p">()</span>

    <span class="n">profile_background</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;design&#39;</span><span class="p">:</span> <span class="n">pssm_as_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">profile</span><span class="p">),</span>
                          <span class="s1">&#39;evolution&#39;</span><span class="p">:</span> <span class="n">pssm_as_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">evolutionary_profile</span><span class="p">),</span>
                          <span class="s1">&#39;fragment&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">fragment_profile</span><span class="o">.</span><span class="n">as_array</span><span class="p">()}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">fragment_db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">interface_bkgd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">fragment_db</span><span class="o">.</span><span class="n">aa_frequencies</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">profile_background</span><span class="p">[</span><span class="s1">&#39;interface&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">interface_bkgd</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">number_of_residues</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Calculate hydrophobic collapse for each design</span>
    <span class="c1"># Include the pose_source in the measured designs</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_evolution</span><span class="p">:</span>
        <span class="c1"># This is set for figures as well</span>
        <span class="n">hydrophobicity</span> <span class="o">=</span> <span class="s1">&#39;expanded&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hydrophobicity</span> <span class="o">=</span> <span class="s1">&#39;standard&#39;</span>
    <span class="n">contact_order_per_res_z</span><span class="p">,</span> <span class="n">reference_collapse</span><span class="p">,</span> <span class="n">collapse_profile</span> <span class="o">=</span> \
        <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">get_folding_metrics</span><span class="p">(</span><span class="n">hydrophobicity</span><span class="o">=</span><span class="n">hydrophobicity</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">measure_evolution</span><span class="p">:</span>  <span class="c1"># collapse_profile.size:  # Not equal to zero, use the profile instead</span>
        <span class="n">reference_collapse</span> <span class="o">=</span> <span class="n">collapse_profile</span>
    <span class="c1">#     reference_mean = np.nanmean(collapse_profile, axis=-2)</span>
    <span class="c1">#     reference_std = np.nanstd(collapse_profile, axis=-2)</span>
    <span class="c1"># else:</span>
    <span class="c1">#     reference_mean = reference_std = None</span>
    <span class="n">entity_sequences</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>
        <span class="n">entity_slice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">n_terminal_residue</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">entity</span><span class="o">.</span><span class="n">c_terminal_residue</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">entity_sequences</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">design</span><span class="p">:</span> <span class="n">sequence</span><span class="p">[</span><span class="n">entity_slice</span><span class="p">]</span> <span class="k">for</span> <span class="n">design</span><span class="p">,</span> <span class="n">sequence</span> <span class="ow">in</span> <span class="n">pose_sequences</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

    <span class="n">all_sequences_split</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">designed_sequences</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">designed_sequences</span> <span class="ow">in</span> <span class="n">entity_sequences</span><span class="p">]</span>
    <span class="n">all_sequences_by_entity</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">all_sequences_split</span><span class="p">))</span>

    <span class="n">folding_and_collapse</span> <span class="o">=</span> \
        <span class="n">metrics</span><span class="o">.</span><span class="n">collapse_per_residue</span><span class="p">(</span><span class="n">all_sequences_by_entity</span><span class="p">,</span> <span class="n">contact_order_per_res_z</span><span class="p">,</span> <span class="n">reference_collapse</span><span class="p">)</span>
    <span class="n">per_residue_collapse_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">({</span><span class="n">design_id</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">residue_indices</span><span class="p">)</span>
                                         <span class="k">for</span> <span class="n">design_id</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">viable_designs</span><span class="p">,</span> <span class="n">folding_and_collapse</span><span class="p">)},</span>
                                        <span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Convert per_residue_data into a dataframe matching residues_df orientation</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">residue_indices</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">per_residue_data</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Fill in missing pose_source metrics for each design not calculated in rosetta</span>
    <span class="c1"># residues_df.fillna(residues_df.loc[pose_name, idx_slice[:, &#39;contact_order&#39;]], inplace=True)</span>
    <span class="n">residues_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pose_name</span><span class="p">,</span> <span class="p">:],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">per_residue_collapse_df</span><span class="p">)</span>

    <span class="c1"># Process mutational frequencies, H-bond, and Residue energy metrics to dataframe</span>
    <span class="n">rosetta_residues_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">({</span><span class="n">design</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="k">for</span> <span class="n">design</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">residue_info</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
    <span class="c1"># returns multi-index column with residue number as first (top) column index, metric as second index</span>
    <span class="c1"># during residues_df unstack, all residues with missing dicts are copied as nan</span>
    <span class="c1"># Merge interface design specific residue metrics with total per residue metrics</span>
    <span class="c1"># residues_df = pd.merge(residues_df, rosetta_residues_df, left_index=True, right_index=True)</span>

    <span class="c1"># Join each residues_df like dataframe</span>
    <span class="c1"># Each of these can have difference index, so we use concat to perform an outer merge</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">residues_df</span><span class="p">,</span> <span class="n">sequences_df</span><span class="p">,</span> <span class="n">rosetta_residues_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># # Join rosetta_residues_df and sequence metrics</span>
    <span class="c1"># residues_df = residues_df.join([rosetta_residues_df, sequences_df])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">profile_background</span><span class="p">:</span>
        <span class="n">divergence_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Calculate sequence statistics</span>
        <span class="c1"># First, for entire pose</span>
        <span class="n">pose_alignment</span> <span class="o">=</span> <span class="n">MultipleSequenceAlignment</span><span class="o">.</span><span class="n">from_dictionary</span><span class="p">(</span><span class="n">pose_sequences</span><span class="p">)</span>
        <span class="n">observed</span><span class="p">,</span> <span class="n">divergence</span> <span class="o">=</span> \
            <span class="n">metrics</span><span class="o">.</span><span class="n">calculate_sequence_observations_and_divergence</span><span class="p">(</span><span class="n">pose_alignment</span><span class="p">,</span> <span class="n">profile_background</span><span class="p">)</span>
        <span class="n">observed_dfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">profile</span><span class="p">,</span> <span class="n">observed_values</span> <span class="ow">in</span> <span class="n">observed</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># scores_df[f&#39;observed_{profile}&#39;] = observed_values.mean(axis=1)</span>
            <span class="n">observed_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">observed_values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">viable_designs</span><span class="p">,</span>
                                             <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">residue_indices</span><span class="p">,</span>
                                                                                 <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;observed_</span><span class="si">{</span><span class="n">profile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]]))</span>
                                <span class="p">)</span>
        <span class="c1"># Add observation information into the residues_df</span>
        <span class="n">residues_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">observed_dfs</span><span class="p">)</span>
        <span class="c1"># Get pose sequence divergence</span>
        <span class="n">design_residue_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">design_residues</span><span class="p">]</span>
        <span class="n">pose_divergence_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">divergence_type</span><span class="si">}</span><span class="s1">_per_residue&#39;</span><span class="p">:</span>
                                                  <span class="n">_divergence</span><span class="p">[</span><span class="n">design_residue_indices</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                                                  <span class="k">for</span> <span class="n">divergence_type</span><span class="p">,</span> <span class="n">_divergence</span> <span class="ow">in</span> <span class="n">divergence</span><span class="o">.</span><span class="n">items</span><span class="p">()})],</span>
                                      <span class="n">keys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;sequence_design&#39;</span><span class="p">,</span> <span class="s1">&#39;pose&#39;</span><span class="p">)])</span>
        <span class="c1"># pose_divergence_s = pd.Series({f&#39;{divergence_type}_per_residue&#39;: per_res_metric(stat)</span>
        <span class="c1">#                                for divergence_type, stat in divergence.items()},</span>
        <span class="c1">#                               name=(&#39;sequence_design&#39;, &#39;pose&#39;))</span>
        <span class="k">if</span> <span class="n">designs_by_protocol</span><span class="p">:</span>  <span class="c1"># were multiple designs generated with each protocol?</span>
            <span class="c1"># find the divergence within each protocol</span>
            <span class="n">divergence_by_protocol</span> <span class="o">=</span> <span class="p">{</span><span class="n">protocol</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="n">designs_by_protocol</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">designs</span> <span class="ow">in</span> <span class="n">designs_by_protocol</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Todo select from pose_alignment the indices of each design then pass to MultipleSequenceAlignment?</span>
                <span class="c1"># protocol_alignment = \</span>
                <span class="c1">#     MultipleSequenceAlignment.from_dictionary({design: pose_sequences[design]</span>
                <span class="c1">#                                                for design in designs})</span>
                <span class="n">protocol_alignment</span> <span class="o">=</span> <span class="n">MultipleSequenceAlignment</span><span class="o">.</span><span class="n">from_dictionary</span><span class="p">({</span><span class="n">design</span><span class="p">:</span> <span class="n">pose_sequences</span><span class="p">[</span><span class="n">design</span><span class="p">]</span>
                                                                                <span class="k">for</span> <span class="n">design</span> <span class="ow">in</span> <span class="n">designs</span><span class="p">})</span>
                <span class="c1"># protocol_mutation_freq = filter_dictionary_keys(protocol_alignment.frequencies,</span>
                <span class="c1">#                                                 self.pose.interface_residues)</span>
                <span class="c1"># protocol_mutation_freq = protocol_alignment.frequencies</span>
                <span class="n">protocol_divergence</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;divergence_</span><span class="si">{</span><span class="n">profile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span>
                                       <span class="n">metrics</span><span class="o">.</span><span class="n">position_specific_divergence</span><span class="p">(</span><span class="n">protocol_alignment</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">bgd</span><span class="p">)</span>
                                       <span class="k">for</span> <span class="n">profile</span><span class="p">,</span> <span class="n">bgd</span> <span class="ow">in</span> <span class="n">profile_background</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="c1"># if interface_bkgd is not None:</span>
                <span class="c1">#     protocol_divergence[&#39;divergence_interface&#39;] = \</span>
                <span class="c1">#         metrics.position_specific_divergence(protocol_alignment.frequencies, tiled_int_background)</span>
                <span class="c1"># Get per residue divergence metric by protocol</span>
                <span class="n">divergence_by_protocol</span><span class="p">[</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">divergence_type</span><span class="si">}</span><span class="s1">_per_residue&#39;</span><span class="p">:</span> <span class="n">divergence</span><span class="p">[</span><span class="n">design_residue_indices</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                     <span class="k">for</span> <span class="n">divergence_type</span><span class="p">,</span> <span class="n">divergence</span> <span class="ow">in</span> <span class="n">protocol_divergence</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="c1"># new = dfd.columns.to_frame()</span>
            <span class="c1"># new.insert(0, &#39;new2_level_name&#39;, new_level_values)</span>
            <span class="c1"># dfd.columns = pd.MultiIndex.from_frame(new)</span>
            <span class="n">protocol_divergence_s</span> <span class="o">=</span> \
                <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">divergence_by_protocol</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">()],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sequence_design&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">protocol_divergence_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># Get profile mean observed</span>
        <span class="c1"># Perform a frequency extraction for each background profile</span>
        <span class="n">per_residue_background_frequency_df</span> <span class="o">=</span> \
            <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pose_alignment</span><span class="o">.</span><span class="n">get_probabilities_from_profile</span><span class="p">(</span><span class="n">background</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">viable_designs</span><span class="p">,</span>
                                    <span class="n">columns</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">residue_indices</span><span class="p">,</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;observed_</span><span class="si">{</span><span class="n">profile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]]))</span>
                       <span class="k">for</span> <span class="n">profile</span><span class="p">,</span> <span class="n">background</span> <span class="ow">in</span> <span class="n">profile_background</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Todo</span>
        <span class="c1">#  Ensure that only interface residues are selected, not only by those that are 0 as interface can be 0!</span>
        <span class="n">observed_frequencies_from_fragment_profile</span> <span class="o">=</span> <span class="n">profile_background</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fragment&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">observed_frequencies_from_fragment_profile</span><span class="p">:</span>
            <span class="n">observed_frequencies_from_fragment_profile</span><span class="p">[</span><span class="n">observed_frequencies_from_fragment_profile</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="c1"># Todo RuntimeWarning: Mean of empty slice</span>
            <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;observed_fragment_mean_probability&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">observed_frequencies_from_fragment_profile</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">profile</span><span class="p">,</span> <span class="n">background</span> <span class="ow">in</span> <span class="n">profile_background</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">scores_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;observed_</span><span class="si">{</span><span class="n">profile</span><span class="si">}</span><span class="s1">_mean_probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;observed_</span><span class="si">{</span><span class="n">profile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pose_length</span>
            <span class="c1"># scores_df[&#39;observed_evolution_mean_probability&#39;] = scores_df[&#39;observed_evolution&#39;] / pose_length</span>

        <span class="n">divergence_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">protocol_divergence_s</span><span class="p">,</span> <span class="n">pose_divergence_s</span><span class="p">])</span>

    <span class="c1"># entity_alignment = multi_chain_alignment(entity_sequences)</span>
    <span class="c1"># INSTEAD OF USING BELOW, split Pose.MultipleSequenceAlignment at entity.chain_break...</span>
    <span class="c1"># entity_alignments = \</span>
    <span class="c1">#     {idx: MultipleSequenceAlignment.from_dictionary(designed_sequences)</span>
    <span class="c1">#      for idx, designed_sequences in entity_sequences.items()}</span>
    <span class="c1"># entity_alignments = \</span>
    <span class="c1">#     {idx: msa_from_dictionary(designed_sequences) for idx, designed_sequences in entity_sequences.items()}</span>
    <span class="c1"># pose_collapse_ = pd.concat(pd.DataFrame(folding_and_collapse), axis=1, keys=[(&#39;sequence_design&#39;, &#39;pose&#39;)])</span>
    <span class="n">dca_design_residues_concat</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dca_succeed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># dca_background_energies, dca_design_energies = [], []</span>
    <span class="n">dca_background_energies</span><span class="p">,</span> <span class="n">dca_design_energies</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># Todo add these to the analysis</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">h_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">api_db</span><span class="o">.</span><span class="n">bmdca_fields</span><span class="o">.</span><span class="n">retrieve_data</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">j_couplings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">api_db</span><span class="o">.</span><span class="n">bmdca_couplings</span><span class="o">.</span><span class="n">retrieve_data</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">dca_background_residue_energies</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">direct_coupling_analysis</span><span class="p">()</span>
            <span class="c1"># Todo</span>
            <span class="c1">#  Instead of below, split Pose.MultipleSequenceAlignment at entity.chain_break...</span>
            <span class="n">entity_alignment</span> <span class="o">=</span> <span class="n">MultipleSequenceAlignment</span><span class="o">.</span><span class="n">from_dictionary</span><span class="p">(</span><span class="n">entity_sequences</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="c1"># entity_alignment = msa_from_dictionary(entity_sequences[idx])</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">msa</span> <span class="o">=</span> <span class="n">entity_alignment</span>
            <span class="n">dca_design_residue_energies</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">direct_coupling_analysis</span><span class="p">()</span>
            <span class="n">dca_design_residues_concat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dca_design_residue_energies</span><span class="p">)</span>
            <span class="c1"># dca_background_energies.append(dca_background_energies.sum(axis=1))</span>
            <span class="c1"># dca_design_energies.append(dca_design_energies.sum(axis=1))</span>
            <span class="n">dca_background_energies</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="n">dca_background_residue_energies</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># turns data to 1D</span>
            <span class="n">dca_design_energies</span><span class="p">[</span><span class="n">entity</span><span class="p">]</span> <span class="o">=</span> <span class="n">dca_design_residue_energies</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;For </span><span class="si">{</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, DCA analysis couldn&#39;t be performed. &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;Missing required parameter files&quot;</span><span class="p">)</span>
            <span class="n">dca_succeed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">dca_succeed</span><span class="p">:</span>
        <span class="c1"># concatenate along columns, adding residue index to column, design name to row</span>
        <span class="n">dca_concatenated_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dca_design_residues_concat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                           <span class="n">index</span><span class="o">=</span><span class="n">viable_designs</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">residue_indices</span><span class="p">)</span>
        <span class="c1"># dca_concatenated_df.columns = pd.MultiIndex.from_product([dca_concatenated_df.columns, [&#39;dca_energy&#39;]])</span>
        <span class="n">dca_concatenated_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dca_concatenated_df</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dca_energy&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Merge with residues_df</span>
        <span class="n">residues_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">residues_df</span><span class="p">,</span> <span class="n">dca_concatenated_df</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Make buried surface area (bsa) columns, and residue classification</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">calculate_residue_buried_surface_area</span><span class="p">(</span><span class="n">residues_df</span><span class="p">)</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">classify_interface_residues</span><span class="p">(</span><span class="n">residues_df</span><span class="p">)</span>

    <span class="c1"># Calculate new metrics from combinations of other metrics</span>
    <span class="c1"># Add design residue information to scores_df such as how many core, rim, and support residues were measured</span>
    <span class="n">mean_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hydrophobicity&#39;</span><span class="p">]</span>  <span class="c1"># , &#39;sasa_relative_bound&#39;, &#39;sasa_relative_complex&#39;]</span>
    <span class="n">scores_df</span> <span class="o">=</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">sum_per_residue_metrics</span><span class="p">(</span><span class="n">residues_df</span><span class="p">,</span> <span class="n">mean_metrics</span><span class="o">=</span><span class="n">mean_columns</span><span class="p">))</span>

    <span class="c1"># scores_df[&#39;collapse_new_positions&#39;] /= pose_length</span>
    <span class="c1"># scores_df[&#39;collapse_new_position_significance&#39;] /= pose_length</span>
    <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;collapse_significance_by_contact_order_z_mean&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;collapse_significance_by_contact_order_z&#39;</span><span class="p">]</span> <span class="o">/</span> \
        <span class="p">(</span><span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;collapse_significance_by_contact_order_z&#39;</span><span class="p">]]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># if self.measure_alignment:</span>
    <span class="c1"># Todo THESE ARE NOW DIFFERENT SOURCE if not self.measure_alignment</span>
    <span class="n">collapse_increased_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;collapse_increased_z&#39;</span><span class="p">]]</span>
    <span class="n">total_increased_collapse</span> <span class="o">=</span> <span class="p">(</span><span class="n">collapse_increased_df</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># scores_df[&#39;collapse_increase_significance_by_contact_order_z_mean&#39;] = \</span>
    <span class="c1">#     scores_df[&#39;collapse_increase_significance_by_contact_order_z&#39;] / total_increased_collapse</span>
    <span class="c1"># scores_df[&#39;collapse_increased_z&#39;] /= pose_length</span>
    <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;collapse_increased_z_mean&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">collapse_increased_df</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_increased_collapse</span>
    <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;collapse_variance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;collapse_deviation_magnitude&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pose_length</span>
    <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;collapse_sequential_peaks_z_mean&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;collapse_sequential_peaks_z&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_increased_collapse</span>
    <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;collapse_sequential_z_mean&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;collapse_sequential_z&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_increased_collapse</span>

    <span class="c1"># scores_df[&#39;interface_area_total&#39;] = bsa_assembly_df = \</span>
    <span class="c1">#     scores_df[&#39;interface_area_polar&#39;] + scores_df[&#39;interface_area_hydrophobic&#39;]</span>
    <span class="c1"># Find the proportion of the residue surface area that is solvent accessible versus buried in the interface</span>
    <span class="n">bsa_assembly_df</span> <span class="o">=</span> <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;interface_area_total&#39;</span><span class="p">]</span>
    <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;interface_area_to_residue_surface_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="p">(</span><span class="n">bsa_assembly_df</span> <span class="o">/</span> <span class="p">(</span><span class="n">bsa_assembly_df</span> <span class="o">+</span> <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;area_total_complex&#39;</span><span class="p">]))</span>

    <span class="c1"># # Make scores_df errat_deviation that takes into account the pose_source sequence errat_deviation</span>
    <span class="c1"># # Include in errat_deviation if errat score is &lt; 2 std devs and isn&#39;t 0 to begin with</span>
    <span class="c1"># # Get per-residue errat scores from the residues_df</span>
    <span class="c1"># errat_df = residues_df.loc[:, idx_slice[:, &#39;errat_deviation&#39;]].droplevel(-1, axis=1)</span>
    <span class="c1">#</span>
    <span class="c1"># pose_source_errat = errat_df.loc[pose_name, :]</span>
    <span class="c1"># source_errat_inclusion_boolean = \</span>
    <span class="c1">#     np.logical_and(pose_source_errat &lt; metrics.errat_2_sigma, pose_source_errat != 0.)</span>
    <span class="c1"># # Find residues where designs deviate above wild-type errat scores</span>
    <span class="c1"># errat_sig_df = errat_df.sub(pose_source_errat, axis=1) &gt; metrics.errat_1_sigma  # axis=1 is per-residue subtract</span>
    <span class="c1"># # Then select only those residues which are expressly important by the inclusion boolean</span>
    <span class="c1"># # This overwrites the metrics.sum_per_residue_metrics() value</span>
    <span class="c1"># scores_df[&#39;errat_deviation&#39;] = (errat_sig_df.loc[:, source_errat_inclusion_boolean] * 1).sum(axis=1)</span>

    <span class="c1"># Calculate mutational content</span>
    <span class="n">mutation_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;mutation&#39;</span><span class="p">]]</span>
    <span class="c1"># scores_df[&#39;number_mutations&#39;] = mutation_df.sum(axis=1)</span>
    <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;percent_mutations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;number_mutations&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">pose_length</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># prior_slice = 0</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">entity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="c1"># entity_n_terminal_residue_index = entity.n_terminal_residue.index</span>
        <span class="c1"># entity_c_terminal_residue_index = entity.c_terminal_residue.index</span>
        <span class="n">scores_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;entity</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">_number_mutations&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">mutation_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[</span><span class="n">residue_indices</span><span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">n_terminal_residue</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>  <span class="c1"># prior_slice</span>
                                                         <span class="mi">1</span> <span class="o">+</span> <span class="n">entity</span><span class="o">.</span><span class="n">c_terminal_residue</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="p">:]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># prior_slice = entity_c_terminal_residue_index</span>
        <span class="n">scores_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;entity</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">_percent_mutations&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">scores_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;entity</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">_number_mutations&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">entity</span><span class="o">.</span><span class="n">number_of_residues</span>

    <span class="c1"># scores_df[&#39;number_mutations&#39;] = \</span>
    <span class="c1">#     pd.Series({design: len(mutations) for design, mutations in all_mutations.items()})</span>
    <span class="c1"># scores_df[&#39;percent_mutations&#39;] = scores_df[&#39;number_mutations&#39;] / pose_length</span>

    <span class="c1"># Check if any columns are &gt; 50% interior (value can be 0 or 1). If so, return True for that column</span>
    <span class="c1"># interior_residue_df = residues_df.loc[:, idx_slice[:, &#39;interior&#39;]]</span>
    <span class="c1"># interior_residue_numbers = \</span>
    <span class="c1">#     interior_residues.loc[:, interior_residues.mean(axis=0) &gt; 0.5].columns.remove_unused_levels().levels[0].</span>
    <span class="c1">#     to_list()</span>
    <span class="c1"># if interior_residue_numbers:</span>
    <span class="c1">#     self.log.info(f&#39;Design Residues {&quot;,&quot;.join(map(str, sorted(interior_residue_numbers)))}</span>
    <span class="c1">#                   &#39;are located in the interior&#39;)</span>

    <span class="c1"># This shouldn&#39;t be much different from the state variable self.interface_residue_numbers</span>
    <span class="c1"># perhaps the use of residue neighbor energy metrics adds residues which contribute, but not directly</span>
    <span class="c1"># interface_residues = set(residues_df.columns.levels[0].unique()).difference(interior_residue_numbers)</span>

    <span class="c1"># Add design residue information to scores_df such as how many core, rim, and support residues were measured</span>
    <span class="c1"># for residue_class in metrics.residue_classification:</span>
    <span class="c1">#     scores_df[residue_class] = residues_df.loc[:, idx_slice[:, residue_class]].sum(axis=1)</span>

    <span class="c1"># Calculate metrics from combinations of metrics with variable integer number metric names</span>
    <span class="n">scores_columns</span> <span class="o">=</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Metrics present: </span><span class="si">{</span><span class="n">scores_columns</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># sum columns using list[0] + list[1] + list[n]</span>
    <span class="c1"># residues_df = residues_df.drop([column</span>
    <span class="c1">#                                 for columns in [complex_df.columns, bound_df.columns, unbound_df.columns,</span>
    <span class="c1">#                                                 solvation_complex_df.columns, solvation_bound_df.columns,</span>
    <span class="c1">#                                                 solvation_unbound_df.columns]</span>
    <span class="c1">#                                 for column in columns], axis=1)</span>
    <span class="n">summation_pairs</span> <span class="o">=</span> \
        <span class="p">{</span><span class="s1">&#39;buried_unsatisfied_hbonds_unbound&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;buns[0-9]+_unbound$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">,</span> <span class="n">scores_columns</span><span class="p">)),</span>  <span class="c1"># Rosetta</span>
         <span class="c1"># &#39;interface_energy_bound&#39;:</span>
         <span class="c1">#     list(filter(re.compile(&#39;interface_energy_[0-9]+_bound&#39;).match, scores_columns)),  # Rosetta</span>
         <span class="c1"># &#39;interface_energy_unbound&#39;:</span>
         <span class="c1">#     list(filter(re.compile(&#39;interface_energy_[0-9]+_unbound&#39;).match, scores_columns)),  # Rosetta</span>
         <span class="c1"># &#39;interface_solvation_energy_bound&#39;:</span>
         <span class="c1">#     list(filter(re.compile(&#39;solvation_energy_[0-9]+_bound&#39;).match, scores_columns)),  # Rosetta</span>
         <span class="c1"># &#39;interface_solvation_energy_unbound&#39;:</span>
         <span class="c1">#     list(filter(re.compile(&#39;solvation_energy_[0-9]+_unbound&#39;).match, scores_columns)),  # Rosetta</span>
         <span class="s1">&#39;interface_connectivity&#39;</span><span class="p">:</span>
             <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;entity[0-9]+_interface_connectivity&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">,</span> <span class="n">scores_columns</span><span class="p">)),</span>  <span class="c1"># Rosetta</span>
         <span class="p">}</span>

    <span class="n">scores_df</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">columns_to_new_column</span><span class="p">(</span><span class="n">scores_df</span><span class="p">,</span> <span class="n">summation_pairs</span><span class="p">)</span>
    <span class="n">scores_df</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">columns_to_new_column</span><span class="p">(</span><span class="n">scores_df</span><span class="p">,</span> <span class="n">metrics</span><span class="o">.</span><span class="n">rosetta_delta_pairs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;sub&#39;</span><span class="p">)</span>
    <span class="c1"># Add number_residues_interface for div_pairs and int_comp_similarity</span>
    <span class="c1"># scores_df[&#39;number_residues_interface&#39;] = other_pose_metrics.pop(&#39;number_residues_interface&#39;)</span>
    <span class="n">scores_df</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">columns_to_new_column</span><span class="p">(</span><span class="n">scores_df</span><span class="p">,</span> <span class="n">metrics</span><span class="o">.</span><span class="n">rosetta_division_pairs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;truediv&#39;</span><span class="p">)</span>
    <span class="n">scores_df</span><span class="p">[</span><span class="s1">&#39;interface_composition_similarity&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">scores_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">interface_composition_similarity</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">scores_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">clean_up_intermediate_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">repacking</span> <span class="o">=</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;repacking&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">repacking</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Set interface_bound_activation_energy = np.nan where repacking is 0</span>
        <span class="c1"># Currently is -1 for True (Rosetta Filter quirk...)</span>
        <span class="n">scores_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">scores_df</span><span class="p">[</span><span class="n">repacking</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;interface_bound_activation_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">scores_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;repacking&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Process dataframes for missing values and drop refine trajectory if present</span>
    <span class="c1"># refine_index = scores_df[scores_df[putils.protocol] == putils.refine].index</span>
    <span class="c1"># scores_df.drop(refine_index, axis=0, inplace=True, errors=&#39;ignore&#39;)</span>
    <span class="c1"># residues_df.drop(refine_index, axis=0, inplace=True, errors=&#39;ignore&#39;)</span>
    <span class="c1"># residue_info.pop(putils.refine, None)  # Remove refine from analysis</span>
    <span class="c1"># residues_no_frags = residues_df.columns[residues_df.isna().all(axis=0)].remove_unused_levels().levels[0]</span>
    <span class="c1"># Remove completely empty columns such as obs_interface</span>
    <span class="n">residues_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">residues_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># residue_indices_no_frags = residues_df.columns[residues_df.isna().all(axis=0)]</span>

    <span class="c1"># POSE ANALYSIS</span>
    <span class="c1"># scores_df = pd.concat([scores_df, proteinmpnn_df], axis=1)</span>
    <span class="n">scores_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Remove completely empty columns</span>
    <span class="c1"># Refine is not considered sequence design and destroys mean. remove v</span>
    <span class="c1"># designs_df = scores_df.sort_index().drop(putils.refine, axis=0, errors=&#39;ignore&#39;)</span>
    <span class="c1"># Consensus cst_weights are very large and destroy the mean.</span>
    <span class="c1"># Remove this drop for consensus or refine if they are run multiple times</span>
    <span class="n">designs_df</span> <span class="o">=</span> \
        <span class="n">scores_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">pose_name</span><span class="p">,</span> <span class="n">putils</span><span class="o">.</span><span class="n">refine</span><span class="p">,</span> <span class="n">putils</span><span class="o">.</span><span class="n">consensus</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

    <span class="c1"># Get total design statistics for every sequence in the pose and every protocol specifically</span>
    <span class="n">scores_df</span><span class="p">[</span><span class="n">putils</span><span class="o">.</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> <span class="n">protocol_s</span>
    <span class="n">protocol_groups</span> <span class="o">=</span> <span class="n">scores_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">putils</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span>
    <span class="c1"># numerics = [&#39;int16&#39;, &#39;int32&#39;, &#39;int64&#39;, &#39;float16&#39;, &#39;float32&#39;, &#39;float64&#39;]</span>
    <span class="c1"># print(designs_df.select_dtypes(exclude=numerics))</span>

    <span class="n">pose_stats</span><span class="p">,</span> <span class="n">protocol_stats</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stats_metrics</span><span class="p">):</span>
        <span class="c1"># Todo both groupby calls have this warning</span>
        <span class="c1">#  FutureWarning: The default value of numeric_only in DataFrame.mean is deprecated. In a future version,</span>
        <span class="c1">#  it will default to False. In addition, specifying &#39;numeric_only=None&#39; is deprecated. Select only valid</span>
        <span class="c1">#  columns or specify the value of numeric_only to silence this warning.</span>
        <span class="n">pose_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">designs_df</span><span class="p">,</span> <span class="n">stat</span><span class="p">)()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">stat</span><span class="p">))</span>
        <span class="n">protocol_stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">protocol_groups</span><span class="p">,</span> <span class="n">stat</span><span class="p">)())</span>

    <span class="c1"># Add the number of observations of each protocol</span>
    <span class="n">protocol_stats</span><span class="p">[</span><span class="n">stats_metrics</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">mean</span><span class="p">)][</span><span class="s1">&#39;observations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">protocol_groups</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
    <span class="c1"># Format stats_s for final pose_s Series</span>
    <span class="n">protocol_stats_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">stat_df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span> <span class="k">for</span> <span class="n">stat_df</span> <span class="ow">in</span> <span class="n">protocol_stats</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="n">stats_metrics</span><span class="p">)</span>
    <span class="n">pose_stats_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">pose_stats</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">stats_metrics</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="s1">&#39;pose&#39;</span><span class="p">))))</span>
    <span class="n">pose_stats_s</span><span class="p">[(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;pose&#39;</span><span class="p">,</span> <span class="s1">&#39;observations&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">viable_designs</span><span class="p">)</span>
    <span class="n">stat_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">protocol_stats_s</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">pose_stats_s</span><span class="o">.</span><span class="n">dropna</span><span class="p">()])</span>  <span class="c1"># dropna removes NaN metrics</span>

    <span class="c1"># Change statistic names for all df that are not groupby means for the final trajectory dataframe</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stats_metrics</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stat</span> <span class="o">!=</span> <span class="n">mean</span><span class="p">:</span>
            <span class="n">protocol_stats</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">protocol_stats</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">{</span><span class="n">protocol</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">stat</span><span class="si">}</span><span class="s1">&#39;</span>
                                                                    <span class="k">for</span> <span class="n">protocol</span> <span class="ow">in</span> <span class="n">unique_design_protocols</span><span class="p">})</span>
    <span class="c1"># Remove std rows if there is no stdev</span>
    <span class="c1"># number_of_trajectories = len(designs_df) + len(protocol_groups) + 1  # 1 for the mean</span>
    <span class="c1"># final_trajectory_indices = designs_df.index.tolist() + unique_protocols + [mean]</span>
    <span class="n">designs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">designs_df</span><span class="p">]</span>
                           <span class="o">+</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">protocol_stats</span><span class="p">]</span>  <span class="c1"># v don&#39;t add if nothing</span>
                           <span class="o">+</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pose_stats</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">isna</span><span class="p">())])</span>
    <span class="c1"># This concat puts back pose_name, refine, consensus index as protocol_stats is calculated on scores_df</span>
    <span class="c1"># # Add all pose information to each trajectory</span>
    <span class="c1"># pose_metrics_df = pd.DataFrame.from_dict({idx: other_pose_metrics for idx in final_trajectory_indices},</span>
    <span class="c1">#                                          orient=&#39;index&#39;)</span>
    <span class="c1"># designs_df = pd.concat([designs_df, pose_metrics_df], axis=1)</span>
    <span class="n">designs_df</span> <span class="o">=</span> <span class="n">designs_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">({</span><span class="s1">&#39;observations&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>

    <span class="c1"># Calculate protocol significance</span>
    <span class="n">pvalue_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">scout_protocols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.*</span><span class="si">{</span><span class="n">putils</span><span class="o">.</span><span class="n">scout</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">,</span>
                                  <span class="n">protocol_s</span><span class="p">[</span><span class="o">~</span><span class="n">protocol_s</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
    <span class="n">similarity_protocols</span> <span class="o">=</span> <span class="n">unique_design_protocols</span><span class="o">.</span><span class="n">difference</span><span class="p">([</span><span class="n">putils</span><span class="o">.</span><span class="n">refine</span><span class="p">,</span> <span class="n">job_key</span><span class="p">]</span> <span class="o">+</span> <span class="n">scout_protocols</span><span class="p">)</span>
    <span class="n">sim_series</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">putils</span><span class="o">.</span><span class="n">structure_background</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_design_protocols</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing background protocol &#39;</span><span class="si">{</span><span class="n">putils</span><span class="o">.</span><span class="n">structure_background</span><span class="si">}</span><span class="s2">&#39;. No protocol significance &quot;</span>
                      <span class="sa">f</span><span class="s1">&#39;measurements available for this pose&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">similarity_protocols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># measure significance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Can&#39;t measure protocol significance, only one protocol of interest&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Test significance between all combinations of protocols by grabbing mean entries per protocol</span>
        <span class="k">for</span> <span class="n">prot1</span><span class="p">,</span> <span class="n">prot2</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">similarity_protocols</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">select_df</span> <span class="o">=</span> \
                <span class="n">designs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">design</span> <span class="k">for</span> <span class="n">designs</span> <span class="ow">in</span> <span class="p">[</span><span class="n">designs_by_protocol</span><span class="p">[</span><span class="n">prot1</span><span class="p">],</span> <span class="n">designs_by_protocol</span><span class="p">[</span><span class="n">prot2</span><span class="p">]]</span>
                                <span class="k">for</span> <span class="n">design</span> <span class="ow">in</span> <span class="n">designs</span><span class="p">],</span> <span class="n">metrics</span><span class="o">.</span><span class="n">significance_columns</span><span class="p">]</span>
            <span class="c1"># prot1/2 pull out means from designs_df by using the protocol name</span>
            <span class="n">difference_s</span> <span class="o">=</span> \
                <span class="n">designs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prot1</span><span class="p">,</span> <span class="n">metrics</span><span class="o">.</span><span class="n">significance_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                    <span class="n">designs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prot2</span><span class="p">,</span> <span class="n">metrics</span><span class="o">.</span><span class="n">significance_columns</span><span class="p">])</span>
            <span class="n">pvalue_df</span><span class="p">[(</span><span class="n">prot1</span><span class="p">,</span> <span class="n">prot2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">df_permutation_test</span><span class="p">(</span><span class="n">select_df</span><span class="p">,</span> <span class="n">difference_s</span><span class="p">,</span> <span class="n">compare</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span>
                                                                    <span class="n">group1_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">designs_by_protocol</span><span class="p">[</span><span class="n">prot1</span><span class="p">]))</span>
        <span class="n">pvalue_df</span> <span class="o">=</span> <span class="n">pvalue_df</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># transpose significance pairs to indices and significance metrics to columns</span>
        <span class="n">designs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">designs_df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pvalue_df</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;similarity&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

        <span class="c1"># Compute residue energy/sequence differences between each protocol</span>
        <span class="n">residue_energy_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;energy_delta&#39;</span><span class="p">]]</span>

        <span class="n">scaler</span> <span class="o">=</span> <span class="n">skl</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">StandardScaler</span><span class="p">()</span>
        <span class="n">res_pca</span> <span class="o">=</span> <span class="n">skl</span><span class="o">.</span><span class="n">decomposition</span><span class="o">.</span><span class="n">PCA</span><span class="p">(</span><span class="n">resources</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_pca_variance</span><span class="p">)</span>
        <span class="n">residue_energy_np</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">residue_energy_df</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">residue_energy_pc</span> <span class="o">=</span> <span class="n">res_pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">residue_energy_np</span><span class="p">)</span>

        <span class="n">seq_pca</span> <span class="o">=</span> <span class="n">skl</span><span class="o">.</span><span class="n">decomposition</span><span class="o">.</span><span class="n">PCA</span><span class="p">(</span><span class="n">resources</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_pca_variance</span><span class="p">)</span>
        <span class="n">designed_sequence_modifications</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;type&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">pairwise_sequence_diff_np</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">all_vs_all</span><span class="p">(</span><span class="n">designed_sequence_modifications</span><span class="p">,</span>
                                                                    <span class="n">sequence_difference</span><span class="p">))</span>
        <span class="n">seq_pc</span> <span class="o">=</span> <span class="n">seq_pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">pairwise_sequence_diff_np</span><span class="p">)</span>
        <span class="c1"># Make principal components (PC) DataFrame</span>
        <span class="n">residue_energy_pc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">residue_energy_pc</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">residue_energy_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;pc</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res_pca</span><span class="o">.</span><span class="n">components_</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
        <span class="n">seq_pc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">seq_pc</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">residue_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                                 <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;pc</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_pca</span><span class="o">.</span><span class="n">components_</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
        <span class="c1"># Compute the euclidean distance</span>
        <span class="c1"># pairwise_pca_distance_np = pdist(seq_pc)</span>
        <span class="c1"># pairwise_pca_distance_np = SDUtils.all_vs_all(seq_pc, euclidean)</span>

        <span class="c1"># Merge PC DataFrames with labels</span>
        <span class="c1"># seq_pc_df = pd.merge(protocol_s, seq_pc_df, left_index=True, right_index=True)</span>
        <span class="n">seq_pc_df</span><span class="p">[</span><span class="n">putils</span><span class="o">.</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> <span class="n">protocol_s</span>
        <span class="c1"># residue_energy_pc_df = pd.merge(protocol_s, residue_energy_pc_df, left_index=True, right_index=True)</span>
        <span class="n">residue_energy_pc_df</span><span class="p">[</span><span class="n">putils</span><span class="o">.</span><span class="n">protocol</span><span class="p">]</span> <span class="o">=</span> <span class="n">protocol_s</span>
        <span class="c1"># Next group the labels</span>
        <span class="n">sequence_groups</span> <span class="o">=</span> <span class="n">seq_pc_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">putils</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span>
        <span class="n">residue_energy_groups</span> <span class="o">=</span> <span class="n">residue_energy_pc_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">putils</span><span class="o">.</span><span class="n">protocol</span><span class="p">)</span>
        <span class="c1"># Measure statistics for each group</span>
        <span class="c1"># All protocol means have pairwise distance measured to access similarity</span>
        <span class="c1"># Gather protocol similarity/distance metrics</span>
        <span class="n">sim_measures</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sequence_distance&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;energy_distance&#39;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="c1"># sim_stdev = {}  # &#39;similarity&#39;: None, &#39;seq_distance&#39;: None, &#39;energy_distance&#39;: None}</span>
        <span class="c1"># grouped_pc_seq_df_dict, grouped_pc_energy_df_dict, similarity_stat_dict = {}, {}, {}</span>
        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_metrics</span><span class="p">:</span>
            <span class="n">grouped_pc_seq_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sequence_groups</span><span class="p">,</span> <span class="n">stat</span><span class="p">)()</span>
            <span class="n">grouped_pc_energy_df</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">residue_energy_groups</span><span class="p">,</span> <span class="n">stat</span><span class="p">)()</span>
            <span class="n">similarity_stat</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pvalue_df</span><span class="p">,</span> <span class="n">stat</span><span class="p">)(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># protocol pair : stat Series</span>
            <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="n">mean</span><span class="p">:</span>
                <span class="c1"># for each measurement in residue_energy_pc_df, need to take the distance between it and the</span>
                <span class="c1"># structure background mean (if structure background, is the mean is useful too?)</span>
                <span class="n">background_distance</span> <span class="o">=</span> \
                    <span class="n">cdist</span><span class="p">(</span><span class="n">residue_energy_pc</span><span class="p">,</span>
                          <span class="n">grouped_pc_energy_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">putils</span><span class="o">.</span><span class="n">structure_background</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span>
                <span class="n">designs_df</span> <span class="o">=</span> \
                    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">designs_df</span><span class="p">,</span>
                               <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">background_distance</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">index</span><span class="o">=</span><span class="n">residue_energy_pc_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                         <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;energy_distance_from_</span><span class="si">{</span><span class="n">putils</span><span class="o">.</span><span class="n">structure_background</span><span class="si">}</span><span class="s1">_mean&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># if renaming is necessary</span>
                <span class="c1"># protocol_stats_s[stat].index = protocol_stats_s[stat].index.to_series().map(</span>
                <span class="c1">#     {protocol: protocol + &#39;_&#39; + stat for protocol in sorted(unique_design_protocols)})</span>
                <span class="c1"># find the pairwise distance from every point to every other point</span>
                <span class="n">seq_pca_mean_distance_vector</span> <span class="o">=</span> <span class="n">pdist</span><span class="p">(</span><span class="n">grouped_pc_seq_df</span><span class="p">)</span>
                <span class="n">energy_pca_mean_distance_vector</span> <span class="o">=</span> <span class="n">pdist</span><span class="p">(</span><span class="n">grouped_pc_energy_df</span><span class="p">)</span>
                <span class="c1"># protocol_indices_map = list(tuple(condensed_to_square(k, len(seq_pca_mean_distance_vector)))</span>
                <span class="c1">#                             for k in seq_pca_mean_distance_vector)</span>
                <span class="c1"># find similarity between each protocol by taking row average of all p-values for each metric</span>
                <span class="c1"># mean_pvalue_s = pvalue_df.mean(axis=1)  # protocol pair : mean significance Series</span>
                <span class="c1"># mean_pvalue_s.index = pd.MultiIndex.from_tuples(mean_pvalue_s.index)</span>
                <span class="c1"># sim_measures[&#39;similarity&#39;] = mean_pvalue_s</span>
                <span class="n">similarity_stat</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">similarity_stat</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">sim_measures</span><span class="p">[</span><span class="s1">&#39;similarity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">similarity_stat</span>

                <span class="c1"># for vector_idx, seq_dist in enumerate(seq_pca_mean_distance_vector):</span>
                <span class="c1">#     i, j = condensed_to_square(vector_idx, len(grouped_pc_seq_df.index))</span>
                <span class="c1">#     sim_measures[&#39;sequence_distance&#39;][(grouped_pc_seq_df.index[i],</span>
                <span class="c1">#                                        grouped_pc_seq_df.index[j])] = seq_dist</span>

                <span class="k">for</span> <span class="n">vector_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">seq_dist</span><span class="p">,</span> <span class="n">energy_dist</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">seq_pca_mean_distance_vector</span><span class="p">,</span>
                                                                         <span class="n">energy_pca_mean_distance_vector</span><span class="p">)):</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">condensed_to_square</span><span class="p">(</span><span class="n">vector_idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">grouped_pc_energy_df</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
                    <span class="n">sim_measures</span><span class="p">[</span><span class="s1">&#39;sequence_distance&#39;</span><span class="p">][(</span><span class="n">grouped_pc_seq_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                       <span class="n">grouped_pc_seq_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">])]</span> <span class="o">=</span> <span class="n">seq_dist</span>
                    <span class="n">sim_measures</span><span class="p">[</span><span class="s1">&#39;energy_distance&#39;</span><span class="p">][(</span><span class="n">grouped_pc_energy_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                     <span class="n">grouped_pc_energy_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">j</span><span class="p">])]</span> <span class="o">=</span> <span class="n">energy_dist</span>
            <span class="k">elif</span> <span class="n">stat</span> <span class="o">==</span> <span class="n">std</span><span class="p">:</span>
                <span class="c1"># sim_stdev[&#39;similarity&#39;] = similarity_stat_dict[stat]</span>
                <span class="k">pass</span>
                <span class="c1"># # Todo need to square each pc, add them up, divide by the group number, then take the sqrt</span>
                <span class="c1"># sim_stdev[&#39;sequence_distance&#39;] = grouped_pc_seq_df</span>
                <span class="c1"># sim_stdev[&#39;energy_distance&#39;] = grouped_pc_energy_df</span>

        <span class="c1"># Find the significance between each pair of protocols</span>
        <span class="n">protocol_sig_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pvalue_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">pair</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pvalue_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span>
                                   <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pvalue_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>
        <span class="c1"># squeeze turns the column headers into series indices. Keys appends to make a multi-index</span>

        <span class="c1"># Find total protocol similarity for different metrics</span>
        <span class="c1"># for measure, values in sim_measures.items():</span>
        <span class="c1">#     # measure_s = pd.Series({pair: similarity for pair, similarity in values.items()})</span>
        <span class="c1">#     # measure_s = pd.Series(values)</span>
        <span class="c1">#     similarity_sum[&#39;protocol_%s_sum&#39; % measure] = pd.Series(values).sum()</span>
        <span class="n">similarity_sum</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;protocol_</span><span class="si">{</span><span class="n">measure</span><span class="si">}</span><span class="s1">_sum&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                          <span class="k">for</span> <span class="n">measure</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">sim_measures</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">similarity_sum_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">similarity_sum</span><span class="p">)],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;sequence_design&#39;</span><span class="p">,</span> <span class="s1">&#39;pose&#39;</span><span class="p">)])</span>

        <span class="c1"># Process similarity between protocols</span>
        <span class="n">sim_measures_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">sim_measures</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
                                   <span class="n">keys</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">sim_measures</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="c1"># # Todo test</span>
        <span class="c1"># sim_stdev_s = pd.concat(list(sim_stdev.values()),</span>
        <span class="c1">#                         keys=list(zip(repeat(&#39;std&#39;), sim_stdev.keys()))).swaplevel(1, 2)</span>
        <span class="c1"># sim_series = [protocol_sig_s, similarity_sum_s, sim_measures_s, sim_stdev_s]</span>
        <span class="n">sim_series</span> <span class="o">=</span> <span class="p">[</span><span class="n">protocol_sig_s</span><span class="p">,</span> <span class="n">similarity_sum_s</span><span class="p">,</span> <span class="n">sim_measures_s</span><span class="p">]</span>

        <span class="c1"># if self.job.figures:  # Todo ensure output is as expected then move below</span>
        <span class="c1">#     protocols_by_design = {design: protocol for protocol, designs in designs_by_protocol.items()</span>
        <span class="c1">#                            for design in designs}</span>
        <span class="c1">#     _path = os.path.join(self.job.all_scores, str(self))</span>
        <span class="c1">#     # Set up Labels &amp; Plot the PC data</span>
        <span class="c1">#     protocol_map = {protocol: i for i, protocol in enumerate(designs_by_protocol)}</span>
        <span class="c1">#     integer_map = {i: protocol for (protocol, i) in protocol_map.items()}</span>
        <span class="c1">#     pc_labels_group = [protocols_by_design[design] for design in residue_info]</span>
        <span class="c1">#     # pc_labels_group = np.array([protocols_by_design[design] for design in residue_info])</span>
        <span class="c1">#     pc_labels_int = [protocol_map[protocols_by_design[design]] for design in residue_info]</span>
        <span class="c1">#     fig = plt.figure()</span>
        <span class="c1">#     # ax = fig.add_subplot(111, projection=&#39;3d&#39;)</span>
        <span class="c1">#     ax = Axes3D(fig, rect=[0, 0, .7, 1], elev=48, azim=134)</span>
        <span class="c1">#     # plt.cla()</span>
        <span class="c1">#</span>
        <span class="c1">#     # for color_int, label in integer_map.items():  # zip(pc_labels_group, pc_labels_int):</span>
        <span class="c1">#     #     ax.scatter(seq_pc[pc_labels_group == label, 0],</span>
        <span class="c1">#     #                seq_pc[pc_labels_group == label, 1],</span>
        <span class="c1">#     #                seq_pc[pc_labels_group == label, 2],</span>
        <span class="c1">#     #                c=color_int, cmap=plt.cm.nipy_spectral, edgecolor=&#39;k&#39;)</span>
        <span class="c1">#     scatter = ax.scatter(seq_pc[:, 0], seq_pc[:, 1], seq_pc[:, 2], c=pc_labels_int, cmap=&#39;Spectral&#39;,</span>
        <span class="c1">#                          edgecolor=&#39;k&#39;)</span>
        <span class="c1">#     # handles, labels = scatter.legend_elements()</span>
        <span class="c1">#     # # print(labels)  # [&#39;$\\mathdefault{0}$&#39;, &#39;$\\mathdefault{1}$&#39;, &#39;$\\mathdefault{2}$&#39;]</span>
        <span class="c1">#     # ax.legend(handles, labels, loc=&#39;upper right&#39;, title=protocol)</span>
        <span class="c1">#     # # ax.legend(handles, [integer_map[label] for label in labels], loc=&quot;upper right&quot;, title=protocol)</span>
        <span class="c1">#     # # plt.axis(&#39;equal&#39;) # not possible with 3D graphs</span>
        <span class="c1">#     # plt.legend()  # No handles with labels found to put in legend.</span>
        <span class="c1">#     colors = [scatter.cmap(scatter.norm(i)) for i in integer_map.keys()]</span>
        <span class="c1">#     custom_lines = [plt.Line2D([], [], ls=&#39;&#39;, marker=&#39;.&#39;, mec=&#39;k&#39;, mfc=c, mew=.1, ms=20)</span>
        <span class="c1">#                     for c in colors]</span>
        <span class="c1">#     ax.legend(custom_lines, [j for j in integer_map.values()], loc=&#39;center left&#39;,</span>
        <span class="c1">#               bbox_to_anchor=(1.0, .5))</span>
        <span class="c1">#     # # Add group mean to the plot</span>
        <span class="c1">#     # for name, label in integer_map.items():</span>
        <span class="c1">#     #     ax.scatter(seq_pc[pc_labels_group == label, 0].mean(),</span>
        <span class="c1">#     #                seq_pc[pc_labels_group == label, 1].mean(),</span>
        <span class="c1">#     #                seq_pc[pc_labels_group == label, 2].mean(), marker=&#39;x&#39;)</span>
        <span class="c1">#     ax.set_xlabel(&#39;PC1&#39;)</span>
        <span class="c1">#     ax.set_ylabel(&#39;PC2&#39;)</span>
        <span class="c1">#     ax.set_zlabel(&#39;PC3&#39;)</span>
        <span class="c1">#     # plt.legend(pc_labels_group)</span>
        <span class="c1">#     plt.savefig(&#39;%s_seq_pca.png&#39; % _path)</span>
        <span class="c1">#     plt.clf()</span>
        <span class="c1">#     # Residue PCA Figure to assay multiple interface states</span>
        <span class="c1">#     fig = plt.figure()</span>
        <span class="c1">#     # ax = fig.add_subplot(111, projection=&#39;3d&#39;)</span>
        <span class="c1">#     ax = Axes3D(fig, rect=[0, 0, .7, 1], elev=48, azim=134)</span>
        <span class="c1">#     scatter = ax.scatter(residue_energy_pc[:, 0], residue_energy_pc[:, 1], residue_energy_pc[:, 2],</span>
        <span class="c1">#                          c=pc_labels_int,</span>
        <span class="c1">#                          cmap=&#39;Spectral&#39;, edgecolor=&#39;k&#39;)</span>
        <span class="c1">#     colors = [scatter.cmap(scatter.norm(i)) for i in integer_map.keys()]</span>
        <span class="c1">#     custom_lines = [plt.Line2D([], [], ls=&#39;&#39;, marker=&#39;.&#39;, mec=&#39;k&#39;, mfc=c, mew=.1, ms=20) for c in</span>
        <span class="c1">#                     colors]</span>
        <span class="c1">#     ax.legend(custom_lines, [j for j in integer_map.values()], loc=&#39;center left&#39;,</span>
        <span class="c1">#               bbox_to_anchor=(1.0, .5))</span>
        <span class="c1">#     ax.set_xlabel(&#39;PC1&#39;)</span>
        <span class="c1">#     ax.set_ylabel(&#39;PC2&#39;)</span>
        <span class="c1">#     ax.set_zlabel(&#39;PC3&#39;)</span>
        <span class="c1">#     plt.savefig(&#39;%s_res_energy_pca.png&#39; % _path)</span>

    <span class="c1"># Format output and save Trajectory, Residue DataFrames, and PDB Sequences</span>
    <span class="c1"># if self.job.save:</span>
    <span class="c1"># residues_df[(putils.protocol, putils.protocol)] = protocol_s</span>
    <span class="c1"># residues_df.sort_index(inplace=True, key=lambda x: x.str.isdigit())  # put wt entry first</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">designs</span><span class="o">=</span><span class="n">designs_df</span><span class="p">)</span>
        <span class="n">output_residues</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">output_residues</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">residues</span><span class="o">=</span><span class="n">residues_df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Only save the &#39;design_residue&#39; columns</span>
            <span class="n">residues_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="n">sql</span><span class="o">.</span><span class="n">DesignResidues</span><span class="o">.</span><span class="n">design_residue</span><span class="o">.</span><span class="n">name</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_metrics</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">design_residues</span><span class="o">=</span><span class="n">residues_df</span><span class="p">)</span>
        <span class="c1"># Commit the newly acquired metrics</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># pickle_object(pose_sequences, self.designed_sequences_file, out_path=&#39;&#39;)  # Todo PoseJob(.path)</span>
    <span class="n">write_sequences</span><span class="p">(</span><span class="n">pose_sequences</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">designed_sequences_file</span><span class="p">)</span>

    <span class="c1"># Create figures</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">figures</span><span class="p">:</span>  <span class="c1"># For plotting collapse profile, errat data, contact order</span>
        <span class="n">interface_residue_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">residue</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">interface_residues</span><span class="p">]</span>
        <span class="c1"># Plot: Format the collapse data with residues as index and each design as column</span>
        <span class="c1"># collapse_graph_df = pd.DataFrame(per_residue_data[&#39;hydrophobic_collapse&#39;])</span>
        <span class="n">collapse_graph_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;hydrophobic_collapse&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">reference_collapse</span> <span class="o">=</span> <span class="p">[</span><span class="n">entity</span><span class="o">.</span><span class="n">hydrophobic_collapse</span><span class="p">()</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">]</span>
        <span class="n">reference_collapse_concatenated_s</span> <span class="o">=</span> \
            <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">reference_collapse</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="n">putils</span><span class="o">.</span><span class="n">reference_name</span><span class="p">)</span>
        <span class="n">collapse_graph_df</span><span class="p">[</span><span class="n">putils</span><span class="o">.</span><span class="n">reference_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_collapse_concatenated_s</span>
        <span class="c1"># collapse_graph_df.columns += 1  # offset index to residue numbering</span>
        <span class="c1"># collapse_graph_df.sort_index(axis=1, inplace=True)</span>
        <span class="c1"># graph_collapse = sns.lineplot(data=collapse_graph_df)</span>
        <span class="c1"># g = sns.FacetGrid(tip_sumstats, col=&quot;sex&quot;, row=&quot;smoker&quot;)</span>
        <span class="c1"># graph_collapse = sns.relplot(data=collapse_graph_df, kind=&#39;line&#39;)  # x=&#39;Residue Number&#39;</span>

        <span class="c1"># Set the base figure aspect ratio for all sequence designs</span>
        <span class="n">figure_aspect_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">pose_length</span> <span class="o">/</span> <span class="mf">25.</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>  <span class="c1"># 20 is arbitrary size to fit all information in figure</span>
        <span class="n">color_cycler</span> <span class="o">=</span> <span class="n">cycler</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">large_color_array</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">,</span> <span class="n">prop_cycle</span><span class="o">=</span><span class="n">color_cycler</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figure_aspect_ratio</span><span class="p">)</span>
        <span class="c1"># legend_fill_value = int(15 * pose_length / 100)</span>

        <span class="c1"># sharex=True allows the axis to be shared across plots</span>
        <span class="c1"># collapse_ax, contact_ax, errat_ax = fig.subplots(3, 1, sharex=True)</span>
        <span class="c1"># collapse_ax, errat_ax = fig.subplots(2, 1, sharex=True)</span>
        <span class="n">collapse_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Add the contact order to the same plot with a separate axis</span>
        <span class="n">contact_ax</span> <span class="o">=</span> <span class="n">collapse_ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">contact_order_df</span> <span class="o">=</span> <span class="n">residues_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pose_name</span><span class="p">,</span> <span class="n">idx_slice</span><span class="p">[:,</span> <span class="s1">&#39;contact_order&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># source_contact_order_s = pd.Series(source_contact_order, index=residue_indices, name=&#39;contact_order&#39;)</span>
        <span class="n">contact_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">contact_order_df</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Contact Order&#39;</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#fbc0cb&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>  <span class="c1"># pink</span>
        <span class="c1"># contact_ax.scatter(residue_indices, source_contact_order_s, color=&#39;#fbc0cb&#39;, marker=&#39;o&#39;)  # pink</span>
        <span class="c1"># wt_contact_order_concatenated_min_s = source_contact_order_s.min()</span>
        <span class="c1"># wt_contact_order_concatenated_max_s = source_contact_order_s.max()</span>
        <span class="c1"># wt_contact_order_range = wt_contact_order_concatenated_max_s - wt_contact_order_concatenated_min_s</span>
        <span class="c1"># scaled_contact_order = ((source_contact_order_s - wt_contact_order_concatenated_min_s)</span>
        <span class="c1">#                         / wt_contact_order_range)  # / wt_contact_order_range)</span>
        <span class="c1"># graph_contact_order = sns.relplot(data=errat_graph_df, kind=&#39;line&#39;)  # x=&#39;Residue Number&#39;</span>
        <span class="c1"># collapse_ax1.plot(scaled_contact_order)</span>
        <span class="c1"># contact_ax.vlines(self.pose.chain_breaks, 0, 1, transform=contact_ax.get_xaxis_transform(),</span>
        <span class="c1">#                   label=&#39;Entity Breaks&#39;, colors=&#39;#cccccc&#39;)  # , grey)</span>
        <span class="c1"># contact_ax.vlines(interface_residue_indices, 0, 0.05, transform=contact_ax.get_xaxis_transform(),</span>
        <span class="c1">#                   label=&#39;Design Residues&#39;, colors=&#39;#f89938&#39;, lw=2)  # , orange)</span>
        <span class="n">contact_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Contact Order&#39;</span><span class="p">)</span>
        <span class="c1"># contact_ax.set_xlim(0, pose_length)</span>
        <span class="n">contact_ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># contact_ax.figure.savefig(os.path.join(self.data_path, &#39;hydrophobic_collapse+contact.png&#39;))</span>
        <span class="c1"># collapse_ax1.figure.savefig(os.path.join(self.data_path, &#39;hydrophobic_collapse+contact.png&#39;))</span>

        <span class="c1"># Get the plot of each collapse profile into a matplotlib axes</span>
        <span class="c1"># collapse_ax = collapse_graph_df.plot.line(legend=False, ax=collapse_ax, figsize=figure_aspect_ratio)</span>
        <span class="c1"># collapse_ax = collapse_graph_df.plot.line(legend=False, ax=collapse_ax)</span>
        <span class="n">collapse_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">collapse_graph_df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">collapse_graph_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="c1"># collapse_ax = collapse_graph_df.plot.line(ax=collapse_ax)</span>
        <span class="n">collapse_ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
        <span class="n">collapse_ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{x:.0f}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># For the minor ticks, use no labels; default NullFormatter.</span>
        <span class="n">collapse_ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">collapse_ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pose_length</span><span class="p">)</span>
        <span class="n">collapse_ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># # CAN&#39;T SET FacetGrid object for most matplotlib elements...</span>
        <span class="c1"># ax = graph_collapse.axes</span>
        <span class="c1"># ax = plt.gca()  # gca &lt;- get current axis</span>
        <span class="c1"># labels = [fill(index, legend_fill_value) for index in collapse_graph_df.index]</span>
        <span class="c1"># collapse_ax.legend(labels, loc=&#39;lower left&#39;, bbox_to_anchor=(0., 1))</span>
        <span class="c1"># collapse_ax.legend(loc=&#39;lower left&#39;, bbox_to_anchor=(0., 1))</span>
        <span class="c1"># Plot the chain break(s) and design residues</span>
        <span class="c1"># linestyles={&#39;solid&#39;, &#39;dashed&#39;, &#39;dashdot&#39;, &#39;dotted&#39;}</span>
        <span class="n">collapse_ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">chain_breaks</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">collapse_ax</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">(),</span>
                           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Entity Breaks&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;#cccccc&#39;</span><span class="p">)</span>  <span class="c1"># , grey)</span>
        <span class="n">collapse_ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">interface_residue_indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">collapse_ax</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">(),</span>
                           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Design Residues&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;#f89938&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># , orange)</span>
        <span class="c1"># Plot horizontal significance</span>
        <span class="n">collapse_significance_threshold</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">collapse_thresholds</span><span class="p">[</span><span class="n">hydrophobicity</span><span class="p">]</span>
        <span class="n">collapse_ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">([</span><span class="n">collapse_significance_threshold</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">collapse_ax</span><span class="o">.</span><span class="n">get_yaxis_transform</span><span class="p">(),</span>
                           <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Collapse Threshold&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;#fc554f&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">)</span>  <span class="c1"># tomato</span>
        <span class="c1"># collapse_ax.set_xlabel(&#39;Residue Number&#39;)</span>
        <span class="n">collapse_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Hydrophobic Collapse Index&#39;</span><span class="p">)</span>
        <span class="c1"># collapse_ax.set_prop_cycle(color_cycler)</span>
        <span class="c1"># ax.autoscale(True)</span>
        <span class="c1"># collapse_ax.figure.tight_layout()  # no standardization</span>
        <span class="c1"># collapse_ax.figure.savefig(os.path.join(self.data_path, &#39;hydrophobic_collapse.png&#39;))  # no standardization</span>

        <span class="c1"># Plot: Collapse description of total profile against each design</span>
        <span class="n">entity_collapse_mean</span><span class="p">,</span> <span class="n">entity_collapse_std</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">msa</span><span class="p">:</span>
                <span class="n">collapse</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">collapse_profile</span><span class="p">()</span>
                <span class="n">entity_collapse_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collapse</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">entity_collapse_std</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collapse</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Only execute if we successfully looped</span>
            <span class="n">profile_mean_collapse_concatenated_s</span> <span class="o">=</span> \
                <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">entity_collapse_mean</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_entities</span><span class="p">)],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">profile_std_collapse_concatenated_s</span> <span class="o">=</span> \
                <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">entity_collapse_std</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_entities</span><span class="p">)],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">profile_mean_collapse_concatenated_s</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># offset index to residue numbering</span>
            <span class="n">profile_std_collapse_concatenated_s</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># offset index to residue numbering</span>
            <span class="n">collapse_graph_describe_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;std_min&#39;</span><span class="p">:</span> <span class="n">profile_mean_collapse_concatenated_s</span> <span class="o">-</span> <span class="n">profile_std_collapse_concatenated_s</span><span class="p">,</span>
                <span class="s1">&#39;std_max&#39;</span><span class="p">:</span> <span class="n">profile_mean_collapse_concatenated_s</span> <span class="o">+</span> <span class="n">profile_std_collapse_concatenated_s</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="n">collapse_graph_describe_df</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># offset index to residue numbering</span>
            <span class="n">collapse_graph_describe_df</span><span class="p">[</span><span class="s1">&#39;Residue Number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collapse_graph_describe_df</span><span class="o">.</span><span class="n">index</span>
            <span class="n">collapse_ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="s1">&#39;Residue Number&#39;</span><span class="p">,</span> <span class="s1">&#39;std_min&#39;</span><span class="p">,</span> <span class="s1">&#39;std_max&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">collapse_graph_describe_df</span><span class="p">,</span>
                               <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#e6e6fa&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>  <span class="c1"># lavender</span>
            <span class="c1"># collapse_ax.figure.savefig(os.path.join(self.data_path, &#39;hydrophobic_collapse_versus_profile.png&#39;))</span>

        <span class="c1"># # Plot: Errat Accuracy</span>
        <span class="c1"># # errat_graph_df = pd.DataFrame(per_residue_data[&#39;errat_deviation&#39;])</span>
        <span class="c1"># # errat_graph_df = residues_df.loc[:, idx_slice[:, &#39;errat_deviation&#39;]].droplevel(-1, axis=1)</span>
        <span class="c1"># # errat_graph_df = errat_df</span>
        <span class="c1"># # wt_errat_concatenated_s = pd.Series(np.concatenate(list(source_errat.values())), name=&#39;clean_asu&#39;)</span>
        <span class="c1"># # errat_graph_df[pose_name] = pose_source_errat</span>
        <span class="c1"># # errat_graph_df.columns += 1  # offset index to residue numbering</span>
        <span class="c1"># errat_df.sort_index(axis=0, inplace=True)</span>
        <span class="c1"># # errat_ax = errat_graph_df.plot.line(legend=False, ax=errat_ax, figsize=figure_aspect_ratio)</span>
        <span class="c1"># # errat_ax = errat_graph_df.plot.line(legend=False, ax=errat_ax)</span>
        <span class="c1"># # errat_ax = errat_graph_df.plot.line(ax=errat_ax)</span>
        <span class="c1"># errat_ax.plot(errat_df.T.values, label=collapse_graph_df.index)</span>
        <span class="c1"># errat_ax.xaxis.set_major_locator(MultipleLocator(20))</span>
        <span class="c1"># errat_ax.xaxis.set_major_formatter(&#39;{x:.0f}&#39;)</span>
        <span class="c1"># # For the minor ticks, use no labels; default NullFormatter.</span>
        <span class="c1"># errat_ax.xaxis.set_minor_locator(MultipleLocator(5))</span>
        <span class="c1"># # errat_ax.set_xlim(0, pose_length)</span>
        <span class="c1"># errat_ax.set_ylim(0, None)</span>
        <span class="c1"># # graph_errat = sns.relplot(data=errat_graph_df, kind=&#39;line&#39;)  # x=&#39;Residue Number&#39;</span>
        <span class="c1"># # Plot the chain break(s) and design residues</span>
        <span class="c1"># # labels = [fill(column, legend_fill_value) for column in errat_graph_df.columns]</span>
        <span class="c1"># # errat_ax.legend(labels, loc=&#39;lower left&#39;, bbox_to_anchor=(0., 1.))</span>
        <span class="c1"># # errat_ax.legend(loc=&#39;lower center&#39;, bbox_to_anchor=(0., 1.))</span>
        <span class="c1"># errat_ax.vlines(self.pose.chain_breaks, 0, 1, transform=errat_ax.get_xaxis_transform(),</span>
        <span class="c1">#                 label=&#39;Entity Breaks&#39;, colors=&#39;#cccccc&#39;)  # , grey)</span>
        <span class="c1"># errat_ax.vlines(interface_residue_indices, 0, 0.05, transform=errat_ax.get_xaxis_transform(),</span>
        <span class="c1">#                 label=&#39;Design Residues&#39;, colors=&#39;#f89938&#39;, lw=2)  # , orange)</span>
        <span class="c1"># # Plot horizontal significance</span>
        <span class="c1"># errat_ax.hlines([metrics.errat_2_sigma], 0, 1, transform=errat_ax.get_yaxis_transform(),</span>
        <span class="c1">#                 label=&#39;Significant Error&#39;, colors=&#39;#fc554f&#39;, linestyle=&#39;dotted&#39;)  # tomato</span>
        <span class="c1"># errat_ax.set_xlabel(&#39;Residue Number&#39;)</span>
        <span class="c1"># errat_ax.set_ylabel(&#39;Errat Score&#39;)</span>
        <span class="c1"># # errat_ax.autoscale(True)</span>
        <span class="c1"># # errat_ax.figure.tight_layout()</span>
        <span class="c1"># # errat_ax.figure.savefig(os.path.join(self.data_path, &#39;errat.png&#39;))</span>
        <span class="n">collapse_handles</span><span class="p">,</span> <span class="n">collapse_labels</span> <span class="o">=</span> <span class="n">collapse_ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">contact_handles</span><span class="p">,</span> <span class="n">contact_labels</span> <span class="o">=</span> <span class="n">contact_ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="c1"># errat_handles, errat_labels = errat_ax.get_legend_handles_labels()</span>
        <span class="c1"># print(handles, labels)</span>
        <span class="n">handles</span> <span class="o">=</span> <span class="n">collapse_handles</span> <span class="o">+</span> <span class="n">contact_handles</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">collapse_labels</span> <span class="o">+</span> <span class="n">contact_labels</span>
        <span class="c1"># handles = errat_handles + contact_handles</span>
        <span class="c1"># labels = errat_labels + contact_labels</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>
        <span class="c1"># plt.legend(loc=&#39;upper right&#39;, bbox_to_anchor=(1, 1))  #, ncol=3, mode=&#39;expand&#39;)</span>
        <span class="c1"># print(labels)</span>
        <span class="c1"># plt.legend(handles, labels, loc=&#39;upper center&#39;, bbox_to_anchor=(0.5, -1.), ncol=3)  # , mode=&#39;expand&#39;</span>
        <span class="c1"># v Why the hell doesn&#39;t this work??</span>
        <span class="c1"># fig.legend(handles, labels, loc=&#39;upper center&#39;, bbox_to_anchor=(0.5, 0.), ncol=3,  # , mode=&#39;expand&#39;)</span>
        <span class="c1"># fig.subplots_adjust(bottom=0.1)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># , mode=&#39;expand&#39;)</span>
        <span class="c1">#            bbox_transform=plt.gcf().transFigure)  # , bbox_transform=collapse_ax.transAxes)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;DesignMetricsPerResidues.png&#39;</span><span class="p">))</span>  <span class="c1"># Todo PoseJob(.path)</span>

    <span class="c1"># After parsing data sources</span>
    <span class="c1"># other_pose_metrics[&#39;observations&#39;] = len(viable_designs)</span>
    <span class="c1"># interface_metrics_s = pd.concat([pd.Series(other_pose_metrics)], keys=[(&#39;dock&#39;, &#39;pose&#39;)])</span>

    <span class="c1"># CONSTRUCT: Create pose series and format index names</span>
    <span class="c1"># pose_s = pd.concat([interface_metrics_s, stat_s, divergence_s] + sim_series).swaplevel(0, 1)</span>
    <span class="n">pose_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">stat_s</span><span class="p">,</span> <span class="n">divergence_s</span><span class="p">]</span> <span class="o">+</span> <span class="n">sim_series</span><span class="p">)</span><span class="o">.</span><span class="n">swaplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Remove pose specific metrics from pose_s, sort, and name protocol_mean_df</span>
    <span class="n">pose_s</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">putils</span><span class="o">.</span><span class="n">protocol</span><span class="p">],</span> <span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">pose_s</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_remaining</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pose_s</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_remaining</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pose_s</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_remaining</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pose_s</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pose_s</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>


</div>



<div class="doc doc-object doc-function">



<h2 id="protocols.pose.load_evolutionary_profile" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">load_evolutionary_profile</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">load_evolutionary_profile</span><span class="p">(</span><span class="n">api_db</span><span class="p">:</span> <span class="n"><span title="symdesign.resources.wrapapi.APIDatabase">APIDatabase</span></span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n"><span title="symdesign.structure.model.ContainsEntities">ContainsEntities</span></span><span class="p">,</span> <span class="n">warn_metrics</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tuple</span><span class="p">[</span><span class="n">bool</span><span class="p">,</span> <span class="n">bool</span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Add evolutionary profile information to the provided Entity</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>api_db</code></b>
            (<code><span title="symdesign.resources.wrapapi.APIDatabase">APIDatabase</span></code>)
        
        <div class="doc-md-description">
          <p>The database which store all information pertaining to evolutionary information</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>model</code></b>
            (<code><span title="symdesign.structure.model.ContainsEntities">ContainsEntities</span></code>)
        
        <div class="doc-md-description">
          <p>The ContainsEntities instance to check for Entity instances to load evolutionary information</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>warn_metrics</code></b>
            (<code>bool</code>, default:
                <code>False</code>
)
        
        <div class="doc-md-description">
          <p>Whether to warn the user about missing files for metric collection</p>
        </div>
      </li>
  </ul>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
            <code>bool</code>
        
        <div class="doc-md-description">
          <p>A tuple of boolean values of length two indicating if, 1-evolutionary and 2-alignment information was added to</p>
      </div>
      </li>
      <li class="field-body">
            <code>bool</code>
        
        <div class="doc-md-description">
          <p>the Entity instances</p>
      </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_evolutionary_profile</span><span class="p">(</span><span class="n">api_db</span><span class="p">:</span> <span class="n">resources</span><span class="o">.</span><span class="n">wrapapi</span><span class="o">.</span><span class="n">APIDatabase</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">ContainsEntities</span><span class="p">,</span>
                              <span class="n">warn_metrics</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add evolutionary profile information to the provided Entity</span>

<span class="sd">    Args:</span>
<span class="sd">        api_db: The database which store all information pertaining to evolutionary information</span>
<span class="sd">        model: The ContainsEntities instance to check for Entity instances to load evolutionary information</span>
<span class="sd">        warn_metrics: Whether to warn the user about missing files for metric collection</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple of boolean values of length two indicating if, 1-evolutionary and 2-alignment information was added to</span>
<span class="sd">        the Entity instances</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Assume True given this function call and set False if not possible for one of the Entities</span>
    <span class="n">measure_evolution</span> <span class="o">=</span> <span class="n">measure_alignment</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">warn</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">entities</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">evolutionary_profile</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># if len(entity.uniprot_ids) &gt; 1:</span>
        <span class="c1">#     raise SymDesignException(</span>
        <span class="c1">#         f&quot;Can&#39;t set the profile for an {entity.__class__.__name__} with number of UniProtIDs &quot;</span>
        <span class="c1">#         f&quot;({len(entity.uniprot_ids)}) &gt; 1. Please remove this or update the code&quot;)</span>
        <span class="c1"># for idx, uniprot_id in enumerate(entity.uniprot_ids):</span>
        <span class="n">evolutionary_profile</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">uniprot_id</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">uniprot_ids</span><span class="p">:</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">api_db</span><span class="o">.</span><span class="n">hhblits_profiles</span><span class="o">.</span><span class="n">retrieve_data</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">uniprot_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">profile</span><span class="p">:</span>
                <span class="n">null_entries</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">create_null_entries</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">number_of_residues</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">entry</span><span class="p">,</span> <span class="n">residue</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">null_entries</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">entity</span><span class="o">.</span><span class="n">residues</span><span class="p">):</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">type1</span>

                <span class="n">evolutionary_profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">null_entries</span><span class="p">)</span>
                <span class="c1"># # Try and add... This would be better at the program level due to memory issues</span>
                <span class="c1"># entity.add_evolutionary_profile(out_dir=self.job.api_db.hhblits_profiles.location)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">evolutionary_profile</span><span class="p">:</span>
                    <span class="c1"># Renumber the profile based on the current length</span>
                    <span class="n">profile</span> <span class="o">=</span> <span class="p">{</span><span class="n">entry_number</span><span class="p">:</span> <span class="n">entry</span>
                               <span class="k">for</span> <span class="n">entry_number</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">profile</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">evolutionary_profile</span><span class="p">))}</span>
                <span class="n">evolutionary_profile</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">evolutionary_profile</span><span class="p">:</span>
            <span class="n">measure_evolution</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">warn</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adding </span><span class="si">{</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.evolutionary_profile&#39;</span><span class="p">)</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">evolutionary_profile</span> <span class="o">=</span> <span class="n">evolutionary_profile</span>

        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">msa</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Fetch the multiple sequence alignment for further processing</span>
        <span class="n">msas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">uniprot_id</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">uniprot_ids</span><span class="p">:</span>
            <span class="n">msa</span> <span class="o">=</span> <span class="n">api_db</span><span class="o">.</span><span class="n">alignments</span><span class="o">.</span><span class="n">retrieve_data</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">uniprot_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">msa</span><span class="p">:</span>
                <span class="n">measure_alignment</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">warn</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adding </span><span class="si">{</span><span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.msa&#39;</span><span class="p">)</span>
                <span class="n">msas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msa</span><span class="p">)</span>
                <span class="c1"># Todo</span>
                <span class="c1">#  The alignment of concatenated evolutionary profiles is sensitive to the length of the internal</span>
                <span class="c1">#  gaps when there is an extend penalty</span>
                <span class="c1">#  modify_alignment_algorithm = True</span>
                <span class="c1">#  query_internal_extend_gap_score=0</span>

        <span class="k">if</span> <span class="n">msas</span><span class="p">:</span>
            <span class="c1"># Combine all</span>
            <span class="n">max_alignment_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">msa_</span><span class="o">.</span><span class="n">length</span> <span class="k">for</span> <span class="n">msa_</span> <span class="ow">in</span> <span class="n">msas</span><span class="p">])</span>
            <span class="n">msa</span><span class="p">,</span> <span class="o">*</span><span class="n">other_msas</span> <span class="o">=</span> <span class="n">msas</span>
            <span class="n">combined_alignment</span> <span class="o">=</span> <span class="n">msa</span><span class="o">.</span><span class="n">alignment</span>
            <span class="c1"># modify_alignment_algorithm = False</span>
            <span class="n">msa_</span><span class="p">:</span> <span class="n">MultipleSequenceAlignment</span>
            <span class="k">for</span> <span class="n">msa_</span> <span class="ow">in</span> <span class="n">other_msas</span><span class="p">:</span>
                <span class="n">length_difference</span> <span class="o">=</span> <span class="n">max_alignment_size</span> <span class="o">-</span> <span class="n">msa_</span><span class="o">.</span><span class="n">length</span>
                <span class="k">if</span> <span class="n">length_difference</span><span class="p">:</span>  <span class="c1"># Not 0</span>
                    <span class="n">msa_</span><span class="o">.</span><span class="n">pad_alignment</span><span class="p">(</span><span class="n">length_difference</span><span class="p">)</span>
                <span class="n">combined_alignment</span> <span class="o">+=</span> <span class="n">msa_</span><span class="o">.</span><span class="n">alignment</span>
            <span class="c1"># To create the full MultipleSequenceAlignment</span>
            <span class="n">entity</span><span class="o">.</span><span class="n">msa</span> <span class="o">=</span> <span class="n">MultipleSequenceAlignment</span><span class="p">(</span><span class="n">combined_alignment</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">warn_metrics</span> <span class="ow">and</span> <span class="n">warn</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">measure_evolution</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">measure_alignment</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metrics relying on evolution aren&#39;t being collected as the required files weren&#39;t &quot;</span>
                        <span class="sa">f</span><span class="s1">&#39;found. These include: </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">all_evolutionary_metrics</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">measure_alignment</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Metrics relying on a multiple sequence alignment including: &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">multiple_sequence_alignment_dependent_metrics</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="s2">&quot;are being calculated with the reference sequence as there was no MSA found&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Metrics relying on an evolutionary profile aren&#39;t being collected as there was no profile &quot;</span>
                        <span class="sa">f</span><span class="s1">&#39;found. These include: </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">profile_dependent_metrics</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># if measure_evolution:</span>
    <span class="n">model</span><span class="o">.</span><span class="n">evolutionary_profile</span> <span class="o">=</span> \
        <span class="n">concatenate_profile</span><span class="p">([</span><span class="n">entity</span><span class="o">.</span><span class="n">evolutionary_profile</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">entities</span><span class="p">])</span>
    <span class="c1"># else:</span>
    <span class="c1">#     self.pose.evolutionary_profile = self.pose.create_null_profile()</span>
    <span class="k">return</span> <span class="n">measure_evolution</span><span class="p">,</span> <span class="n">measure_alignment</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">



<h2 id="protocols.pose.insert_pose_jobs" class="doc doc-heading">
          <span class="doc doc-object-name doc-function-name">insert_pose_jobs</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><span class="n">insert_pose_jobs</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n"><span title="sqlalchemy.orm.Session">Session</span></span><span class="p">,</span> <span class="n">pose_jobs</span><span class="p">:</span> <span class="n"><span title="collections.abc.Iterable">Iterable</span></span><span class="p">[</span><span class="n"><span title="protocols.pose.PoseJob">PoseJob</span></span><span class="p">],</span> <span class="n">project</span><span class="p">:</span> <span class="n">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="p">[</span><span class="n"><span title="protocols.pose.PoseJob">PoseJob</span></span><span class="p">]</span>
</code></pre></div>

  <div class="doc doc-contents ">
  
      <p>Add PoseJobs to the database accounting for existing entries</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b><code>session</code></b>
            (<code><span title="sqlalchemy.orm.Session">Session</span></code>)
        
        <div class="doc-md-description">
          <p>An open sqlalchemy session</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>pose_jobs</code></b>
            (<code><span title="collections.abc.Iterable">Iterable</span>[<span title="protocols.pose.PoseJob">PoseJob</span>]</code>)
        
        <div class="doc-md-description">
          <p>The PoseJob instances which should be inserted</p>
        </div>
      </li>
      <li class="field-body">
        <b><code>project</code></b>
            (<code>str</code>)
        
        <div class="doc-md-description">
          <p>The name of the project which the <code>pose_jobs</code> belong</p>
        </div>
      </li>
  </ul>
      <p>Raises:
    sqlalchemy.exc.IntegrityError
Returns:
    The PoseJob instances that are already present</p>

          <details class="quote">
            <summary>Source code in <code>symdesign/protocols/pose.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">5316</span>
<span class="normal">5317</span>
<span class="normal">5318</span>
<span class="normal">5319</span>
<span class="normal">5320</span>
<span class="normal">5321</span>
<span class="normal">5322</span>
<span class="normal">5323</span>
<span class="normal">5324</span>
<span class="normal">5325</span>
<span class="normal">5326</span>
<span class="normal">5327</span>
<span class="normal">5328</span>
<span class="normal">5329</span>
<span class="normal">5330</span>
<span class="normal">5331</span>
<span class="normal">5332</span>
<span class="normal">5333</span>
<span class="normal">5334</span>
<span class="normal">5335</span>
<span class="normal">5336</span>
<span class="normal">5337</span>
<span class="normal">5338</span>
<span class="normal">5339</span>
<span class="normal">5340</span>
<span class="normal">5341</span>
<span class="normal">5342</span>
<span class="normal">5343</span>
<span class="normal">5344</span>
<span class="normal">5345</span>
<span class="normal">5346</span>
<span class="normal">5347</span>
<span class="normal">5348</span>
<span class="normal">5349</span>
<span class="normal">5350</span>
<span class="normal">5351</span>
<span class="normal">5352</span>
<span class="normal">5353</span>
<span class="normal">5354</span>
<span class="normal">5355</span>
<span class="normal">5356</span>
<span class="normal">5357</span>
<span class="normal">5358</span>
<span class="normal">5359</span>
<span class="normal">5360</span>
<span class="normal">5361</span>
<span class="normal">5362</span>
<span class="normal">5363</span>
<span class="normal">5364</span>
<span class="normal">5365</span>
<span class="normal">5366</span>
<span class="normal">5367</span>
<span class="normal">5368</span>
<span class="normal">5369</span>
<span class="normal">5370</span>
<span class="normal">5371</span>
<span class="normal">5372</span>
<span class="normal">5373</span>
<span class="normal">5374</span>
<span class="normal">5375</span>
<span class="normal">5376</span>
<span class="normal">5377</span>
<span class="normal">5378</span>
<span class="normal">5379</span>
<span class="normal">5380</span>
<span class="normal">5381</span>
<span class="normal">5382</span>
<span class="normal">5383</span>
<span class="normal">5384</span>
<span class="normal">5385</span>
<span class="normal">5386</span>
<span class="normal">5387</span>
<span class="normal">5388</span>
<span class="normal">5389</span>
<span class="normal">5390</span>
<span class="normal">5391</span>
<span class="normal">5392</span>
<span class="normal">5393</span>
<span class="normal">5394</span>
<span class="normal">5395</span>
<span class="normal">5396</span>
<span class="normal">5397</span>
<span class="normal">5398</span>
<span class="normal">5399</span>
<span class="normal">5400</span>
<span class="normal">5401</span>
<span class="normal">5402</span>
<span class="normal">5403</span>
<span class="normal">5404</span>
<span class="normal">5405</span>
<span class="normal">5406</span>
<span class="normal">5407</span>
<span class="normal">5408</span>
<span class="normal">5409</span>
<span class="normal">5410</span>
<span class="normal">5411</span>
<span class="normal">5412</span>
<span class="normal">5413</span>
<span class="normal">5414</span>
<span class="normal">5415</span>
<span class="normal">5416</span>
<span class="normal">5417</span>
<span class="normal">5418</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">insert_pose_jobs</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">pose_jobs</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">PoseJob</span><span class="p">],</span> <span class="n">project</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">PoseJob</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add PoseJobs to the database accounting for existing entries</span>

<span class="sd">    Args:</span>
<span class="sd">        session: An open sqlalchemy session</span>
<span class="sd">        pose_jobs: The PoseJob instances which should be inserted</span>
<span class="sd">        project: The name of the project which the `pose_jobs` belong</span>
<span class="sd">    Raises:</span>
<span class="sd">        sqlalchemy.exc.IntegrityError</span>
<span class="sd">    Returns:</span>
<span class="sd">        The PoseJob instances that are already present</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">error_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># logger.debug(f&quot;Start: {getattr(pose_jobs[0], &#39;id&#39;, &#39;No id&#39;)}&quot;)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">pose_name_to_pose_jobs</span> <span class="o">=</span> <span class="p">{</span><span class="n">pose_job</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">pose_job</span> <span class="k">for</span> <span class="n">pose_job</span> <span class="ow">in</span> <span class="n">pose_jobs</span><span class="p">}</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">pose_jobs</span><span class="p">)</span>
        <span class="c1"># logger.debug(f&quot;ADD ALL: {getattr(pose_jobs[0], &#39;id&#39;, &#39;No id&#39;)}&quot;)</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># Flush PoseJobs to the current session to generate ids</span>
            <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">IntegrityError</span><span class="p">:</span>  <span class="c1"># PoseJob.project/.name already inserted</span>
            <span class="c1"># logger.debug(f&quot;FLUSH: {getattr(pose_jobs[0], &#39;id&#39;, &#39;No id&#39;)}&quot;)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="c1"># logger.debug(f&quot;ROLLBACK: {getattr(pose_jobs[0], &#39;id&#39;, &#39;No id&#39;)}&quot;)</span>
            <span class="n">number_flush_attempts</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">error_count</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rollback() #</span><span class="si">{</span><span class="n">number_flush_attempts</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Find the actual pose_jobs_to_commit and place in session</span>
            <span class="n">pose_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pose_name_to_pose_jobs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">fetch_jobs_stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">PoseJob</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PoseJob</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="n">project</span><span class="p">))</span> \
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PoseJob</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">pose_names</span><span class="p">))</span>
            <span class="n">existing_pose_jobs</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">fetch_jobs_stmt</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="c1"># Note: Values are sorted by alphanumerical, not numerical</span>
            <span class="c1"># ex, design 11 is processed before design 2</span>
            <span class="n">existing_pose_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">pose_job_</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">pose_job_</span> <span class="ow">in</span> <span class="n">existing_pose_jobs</span><span class="p">}</span>
            <span class="n">new_pose_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pose_names</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">existing_pose_names</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">new_pose_names</span><span class="p">:</span>  <span class="c1"># No new PoseJobs</span>
                <span class="k">return</span> <span class="n">existing_pose_jobs</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pose_jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pose_name_to_pose_jobs</span><span class="p">[</span><span class="n">pose_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">pose_name</span> <span class="ow">in</span> <span class="n">new_pose_names</span><span class="p">]</span>
                <span class="c1"># Set each of the primary id to None so they are updated again during the .flush()</span>
                <span class="k">for</span> <span class="n">pose_job</span> <span class="ow">in</span> <span class="n">pose_jobs</span><span class="p">:</span>
                    <span class="n">pose_job</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># logger.debug(f&quot;RESET: {getattr(pose_jobs[0], &#39;id&#39;, &#39;No id&#39;)}&quot;)</span>

                <span class="k">if</span> <span class="n">number_flush_attempts</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;From </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pose_names</span><span class="p">)</span><span class="si">}</span><span class="s1"> pose_jobs:</span><span class="se">\n</span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">pose_names</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">new_pose_names</span><span class="p">)</span><span class="si">}</span><span class="s1"> new_pose_jobs:</span><span class="se">\n</span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">new_pose_names</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;Removing existing docked poses from output: </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">existing_pose_names</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">number_flush_attempts</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># Try to attach existing protein_metadata.entity_id</span>
                    <span class="c1"># possibly_new_uniprot_to_prot_metadata = {}</span>
                    <span class="n">possibly_new_uniprot_to_prot_metadata</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
                    <span class="c1"># pose_name_to_prot_metadata = defaultdict(list)</span>
                    <span class="k">for</span> <span class="n">pose_job</span> <span class="ow">in</span> <span class="n">pose_jobs</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">entity_data</span> <span class="ow">in</span> <span class="n">pose_job</span><span class="o">.</span><span class="n">entity_data</span><span class="p">:</span>
                            <span class="n">possibly_new_uniprot_to_prot_metadata</span><span class="p">[</span>
                                <span class="n">entity_data</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">uniprot_ids</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity_data</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>

                    <span class="n">all_uniprot_id_to_prot_data</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">initialize_metadata</span><span class="p">(</span>
                        <span class="n">session</span><span class="p">,</span> <span class="n">possibly_new_uniprot_to_prot_metadata</span><span class="p">)</span>

                    <span class="c1"># logger.debug([[data.meta.entity_id for data in pose_job.entity_data] for pose_job in pose_jobs])</span>
                    <span class="c1"># Get all uniprot_entities, and fix ProteinMetadata that is already loaded</span>
                    <span class="k">for</span> <span class="n">pose_name</span><span class="p">,</span> <span class="n">pose_job</span> <span class="ow">in</span> <span class="n">pose_name_to_pose_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">entity_data</span> <span class="ow">in</span> <span class="n">pose_job</span><span class="o">.</span><span class="n">entity_data</span><span class="p">:</span>
                            <span class="n">entity_id</span> <span class="o">=</span> <span class="n">entity_data</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">entity_id</span>
                            <span class="c1"># Search the updated ProteinMetadata</span>
                            <span class="k">for</span> <span class="n">protein_metadata</span> <span class="ow">in</span> <span class="n">all_uniprot_id_to_prot_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                                <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">protein_metadata</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">entity_id</span> <span class="o">==</span> <span class="n">data</span><span class="o">.</span><span class="n">entity_id</span><span class="p">:</span>
                                        <span class="c1"># Set with the valid ProteinMetadata</span>
                                        <span class="n">entity_data</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">data</span>
                                        <span class="k">break</span>
                                <span class="k">else</span><span class="p">:</span>  <span class="c1"># No break occurred, continue with outer loop</span>
                                    <span class="k">continue</span>
                                <span class="k">break</span>  <span class="c1"># outer loop too</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">insp</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">entity_data</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s1">&#39;Missing the </span><span class="si">{</span><span class="n">sql</span><span class="o">.</span><span class="n">ProteinMetadata</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> instance for </span><span class="si">{</span><span class="n">entity_data</span><span class="si">}</span><span class="s1"> with &#39;</span>
                                    <span class="sa">f</span><span class="s1">&#39;entity_id </span><span class="si">{</span><span class="n">entity_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">This instance is transient? </span><span class="si">{</span><span class="n">insp</span><span class="o">.</span><span class="n">transient</span><span class="si">}</span><span class="s1">, pending?&#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">insp</span><span class="o">.</span><span class="n">pending</span><span class="si">}</span><span class="s1">, persistent? </span><span class="si">{</span><span class="n">insp</span><span class="o">.</span><span class="n">persistent</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found the newly added Session instances:</span><span class="se">\n</span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">new</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">number_flush_attempts</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">attrs_of_interest</span> <span class="o">=</span> \
                        <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;entity_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reference_sequence&#39;</span><span class="p">,</span> <span class="s1">&#39;thermophilicity&#39;</span><span class="p">,</span> <span class="s1">&#39;symmetry_group&#39;</span><span class="p">,</span> <span class="s1">&#39;model_source&#39;</span><span class="p">]</span>
                    <span class="n">properties</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">pose_job</span> <span class="ow">in</span> <span class="n">pose_jobs</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">entity_data</span> <span class="ow">in</span> <span class="n">pose_job</span><span class="o">.</span><span class="n">entity_data</span><span class="p">:</span>
                            <span class="n">properties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">entity_data</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span><span class="w"> </span><span class="n">attr</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                                                         <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs_of_interest</span><span class="p">]))</span>
                    <span class="n">pose_job_properties</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The remaining PoseJob instances have the following &quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sql</span><span class="o">.</span><span class="n">ProteinMetadata</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> properties:</span><span class="se">\n\t</span><span class="si">{</span><span class="n">pose_job_properties</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># This is another error</span>
                    <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">pose_jobs</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../fragdock/" class="md-footer__link md-footer__link--prev" aria-label="Previous: fragdock">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                fragdock
              </div>
            </div>
          </a>
        
        
          
          <a href="../select/" class="md-footer__link md-footer__link--next" aria-label="Next: select">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                select
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 Kyle Meador
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/kylemeador" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.tracking", "navigation.instant", "navigation.path", "navigation.top", "navigation.footer", "search.suggest", "search.highlight", "toc.follow", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.8fd75fb4.min.js"></script>
      
    
  </body>
</html>